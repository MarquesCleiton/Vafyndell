import{a as d,b as s}from"./chunk-2CFPKSUU.js";import{a as l,b as r,d as e}from"./chunk-DIJLFEPN.js";var m=class{static TAB="Catalogo";static STORE=this.TAB;static META_STORE="metadados";static FOLDER_ID="1zId11Ydti8d0FOQoQjd9lQmPo6GiJx26";static dbPromise=null;static getDb(){return e(this,null,function*(){return this.dbPromise||(console.log("[CatalogoRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=d.create()),this.dbPromise})}static createItem(t){return e(this,null,function*(){console.log("[CatalogoRepository] Criando novo item...",t);let o=yield s.controllerCreate({tab:this.TAB,attrs:t,folderId:this.FOLDER_ID}),a=r(l({},o),{id:Number(o?.id)||Date.now(),index:o?.index});return yield(yield this.getDb()).put(this.STORE,a),console.log("[CatalogoRepository] Item criado e salvo no cache:",a),a})}static updateItem(t){return e(this,null,function*(){console.log("[CatalogoRepository] Atualizando item...",t);let o=yield s.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t,folderId:this.FOLDER_ID}),a=r(l(l({},t),o),{id:Number(o?.id||t.id),index:o?.index||t.index});return yield(yield this.getDb()).put(this.STORE,a),console.log("[CatalogoRepository] Item atualizado no cache local:",a),a})}static getAllItens(){return e(this,null,function*(){console.log("[CatalogoRepository] getAllItens...");let t=yield s.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t.map(o=>r(l({},o),{id:Number(o.id),index:o.index})):[]})}static getLocalItens(){return e(this,null,function*(){return yield(yield this.getDb()).getAll(this.STORE)})}static forceFetchItens(){return e(this,null,function*(){console.log("[CatalogoRepository] Baixando lista online...");let t=yield this.getAllItens();if(!t.length)return console.warn("[CatalogoRepository] Nenhum item encontrado online."),[];let o=t.map(i=>r(l({},i),{id:Number(i.id),index:i.index})),a=yield this.getDb();yield a.clear(this.STORE),yield a.bulkPut(this.STORE,o),console.log("[CatalogoRepository] Cache atualizado com lista online.");let n=yield s.controllerGetAll({tab:"Metadados"});if(Array.isArray(n)){let i=n.find(c=>c.SheetName===this.TAB);i&&(yield a.put(this.META_STORE,{id:this.TAB,UltimaModificacao:i.UltimaModificacao}),console.log("[CatalogoRepository] Metadados locais atualizados:",i))}return o})}static syncItens(){return e(this,null,function*(){console.log("[CatalogoRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let t=yield s.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let o=t.find(c=>c.SheetName===this.TAB);if(!o)return console.warn("[CatalogoRepository] Nenhum metadado online encontrado."),!1;let n=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!n||n.UltimaModificacao!==o.UltimaModificacao?(console.log("[CatalogoRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchItens(),!0):(console.log("[CatalogoRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}static deleteItem(t){return e(this,null,function*(){console.log("[CatalogoRepository] Excluindo item...",t);let o=yield this.getDb(),a=yield o.get(this.STORE,t);return a?(yield s.controllerDeleteByIndex({tab:this.TAB,index:a.index}),yield o.delete(this.STORE,t),console.log("[CatalogoRepository] Item exclu\xEDdo do cache/local:",t),!0):(console.warn("[CatalogoRepository] Item n\xE3o encontrado no cache:",t),!1)})}};export{m as a};
