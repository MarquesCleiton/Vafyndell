import{a as J,b as ne}from"./chunk-R66HVWNJ.js";import{a as Z}from"./chunk-XQNWO7VY.js";import{a as k}from"./chunk-DET3QFJ6.js";import{e as q,f as B,g as Q,j as N,s as U,w as Y}from"./chunk-7SGEPDVZ.js";import{Ab as s,Bb as l,Cb as f,Gb as w,Hb as O,Ib as S,Mb as x,Ob as g,Sb as V,Ta as r,Tb as j,Ub as R,Ya as L,Yb as H,_b as F,a as E,ac as c,b as D,bc as A,cc as y,db as z,f as ie,g as u,ib as b,la as _,lc as $,ma as v,pc as M,vb as T,wb as I,zb as m}from"./chunk-DNZPJZVY.js";var K=ie(ne());var ae=["cyContainer"],oe=n=>({"show d-block":n});function re(n,e){if(n&1){let i=S();s(0,"li",14)(1,"a",15),x("click",function(){let o=_(i).$implicit,d=g();return v(d.selecionarAba(o))}),c(2),l()()}if(n&2){let i=e.$implicit,t=g();r(),F("active",t.abaAtiva===i.id),r(),y(" ",i.caminho," ")}}function le(n,e){n&1&&(s(0,"div",10),f(1,"div",16),s(2,"p",17),c(3,"Carregando habilidades..."),l()())}function de(n,e){if(n&1&&(s(0,"div",19)(1,"h3",20),c(2),l(),f(3,"div",21,0),l()),n&2){let i=e.$implicit;r(2),A(i.arvore)}}function se(n,e){if(n&1&&(s(0,"div",11),b(1,de,5,1,"div",18),l()),n&2){let i=g();r(),m("ngForOf",i.arvoresAtivas)}}function ce(n,e){n&1&&f(0,"div",22)}function me(n,e){if(n&1&&(s(0,"div",36)(1,"span"),c(2,"\u{1F4CC} Requisito:"),l(),f(3,"br"),c(4),l()),n&2){let i=g(2);r(4),y("",i.habilidadeSelecionada.requisitos," ")}}function ge(n,e){n&1&&(w(0),f(1,"span",38),O())}function pe(n,e){n&1&&c(0,"\u274C")}function be(n,e){if(n&1){let i=S();w(0),s(1,"button",37),x("click",function(){_(i);let o=g(2);return v(o.removerHabilidadeJogador(o.habilidadeSelecionada))}),b(2,ge,2,0,"ng-container",35)(3,pe,1,0,"ng-template",null,2,M),l(),O()}if(n&2){let i=H(4),t=g(2);r(),m("disabled",t.processando),r(),m("ngIf",t.processando)("ngIfElse",i)}}function fe(n,e){n&1&&(w(0),f(1,"span",38),O())}function he(n,e){n&1&&c(0,"\u2795")}function ue(n,e){if(n&1){let i=S();s(0,"button",39),x("click",function(){_(i);let o=g(2);return v(o.adicionarHabilidadeJogador(o.habilidadeSelecionada))}),b(1,fe,2,0,"ng-container",35)(2,he,1,0,"ng-template",null,3,M),l()}if(n&2){let i=H(3),t=g(2);m("disabled",t.processando),r(),m("ngIf",t.processando)("ngIfElse",i)}}function _e(n,e){if(n&1){let i=S();s(0,"div",23)(1,"div",24)(2,"div",25)(3,"div",26)(4,"h5",27),c(5),s(6,"span",28),c(7),l()(),s(8,"button",29),x("click",function(){_(i);let o=g();return v(o.fecharModal())}),l()(),s(9,"div",30)(10,"p",31),c(11),l(),b(12,me,5,1,"div",32),l(),s(13,"div",33)(14,"button",34),x("click",function(){_(i);let o=g();return v(o.editarHabilidade(o.habilidadeSelecionada.id))}),c(15," \u270F\uFE0F "),l(),b(16,be,5,3,"ng-container",35)(17,ue,4,3,"ng-template",null,1,M),l()()()()}if(n&2){let i=H(18),t=g();m("ngClass",$(7,oe,t.habilidadeSelecionada)),r(5),y(" ",t.habilidadeSelecionada.habilidade," "),r(2),y("Lv ",t.habilidadeSelecionada.nivel),r(4),A(t.habilidadeSelecionada.descricao),r(),m("ngIf",t.habilidadeSelecionada==null?null:t.habilidadeSelecionada.requisitos),r(4),m("ngIf",t.temHabilidade(t.habilidadeSelecionada==null?null:t.habilidadeSelecionada.id))("ngIfElse",i)}}J.use(K.default);var G=class n{constructor(e){this.router=e}cyContainers;cyInstances={};caminhos=[];arvores=[];habilidades=[];habilidadesJogador=[];carregando=!0;habilidadeSelecionada=null;abaAtiva=null;repoCaminho=new k("Caminhos");repoArvore=new k("Arvores");repoHab=new k("Habilidades");repoHabJog=new k("Habilidades_jogadores");userEmail=null;processando=!1;ngOnInit(){return u(this,null,function*(){this.carregando=!0;try{let e=Y.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado.");this.userEmail=e.email,yield this.loadLocalAndSync(this.userEmail),this.caminhos.length>0&&(this.abaAtiva=this.caminhos[0].id)}catch(e){console.error("[SkillTree] \u274C Erro ao carregar:",e)}finally{this.carregando=!1}})}ngAfterViewInit(){this.cyContainers.changes.subscribe(()=>{this.abaAtiva&&!this.carregando&&this.renderizarArvores()})}get arvoresAtivas(){return this.abaAtiva?this.arvores.filter(e=>String(e.caminho)===String(this.abaAtiva)):[]}normalizeHabJog(e){return e.map(i=>D(E({},i),{habilidade:String(i.habilidade)}))}loadLocalAndSync(e){return u(this,null,function*(){let[i,t,o,d]=yield Promise.all([this.repoCaminho.getLocal(),this.repoArvore.getLocal(),this.repoHab.getLocal(),this.repoHabJog.getLocal()]);this.caminhos=i,this.arvores=t,this.habilidades=o,this.habilidadesJogador=this.normalizeHabJog(d.filter(a=>a.jogador===e)),this.renderizarArvores(),u(this,null,function*(){let[a,h,p,C]=yield Promise.all([this.repoCaminho.sync(),this.repoArvore.sync(),this.repoHab.sync(),this.repoHabJog.sync()]);if(a||h||p||C){let[P,W,X,ee]=yield Promise.all([this.repoCaminho.getLocal(),this.repoArvore.getLocal(),this.repoHab.getLocal(),this.repoHabJog.getLocal()]);this.caminhos=P,this.arvores=W,this.habilidades=X,this.habilidadesJogador=this.normalizeHabJog(ee.filter(te=>te.jogador===e)),this.renderizarArvores()}})})}renderizarArvores(){this.abaAtiva&&this.cyContainers.forEach((e,i)=>{let t=this.arvoresAtivas[i];if(!t)return;let o=this.habilidades.filter(a=>String(a.arvore)===String(t.id)),d=[];o.forEach(a=>{let h=this.temHabilidade(a.id);d.push({data:D(E({},a),{id:String(a.id),label:`${a.habilidade}
Lv ${a.nivel}`}),classes:h?"habilidade-acquired":""}),a.dependencia&&o.some(p=>String(p.id)===String(a.dependencia))&&d.push({data:{source:String(a.dependencia),target:String(a.id)}})}),this.cyInstances[t.id]&&this.cyInstances[t.id].destroy(),this.cyInstances[t.id]=J({container:e.nativeElement,elements:d,layout:{name:"dagre",rankDir:"TB",nodeSep:120,rankSep:100,edgeSep:30,padding:40},style:[{selector:"node",style:{"background-color":"#222","border-color":"#555","border-width":2,label:"data(label)",color:"#eee","text-valign":"center","text-halign":"center",width:"65px",height:"65px","font-size":"10px","text-wrap":"wrap","text-max-width":"90px"}},{selector:"node.habilidade-acquired",style:{"background-color":"#28a745","border-color":"#fff","border-width":3,color:"#fff"}},{selector:"node.selected",style:{"background-color":"#007bff","border-color":"#fff","border-width":3,color:"#fff"}},{selector:"edge",style:{width:2,"line-color":"#666","curve-style":"unbundled-bezier","control-point-distances":[-30,30],"control-point-weights":[.5,.5]}}],userPanningEnabled:!0,userZoomingEnabled:!0,autoungrabify:!0}),this.cyInstances[t.id].on("tap","node",a=>{this.cyInstances[t.id].nodes().removeClass("selected"),a.target.addClass("selected");let p=String(a.target.data("id")),C=this.habilidades.find(P=>String(P.id)===p)||null;this.selecionarHab(C)})})}selecionarAba(e){this.abaAtiva=e.id,setTimeout(()=>this.renderizarArvores(),0)}selecionarHab(e){this.habilidadeSelecionada=e}editarHabilidade(e){e&&this.router.navigate(["/edicao-skilltree",e])}temHabilidade(e){return e?this.habilidadesJogador.some(i=>String(i.habilidade)===String(e)):!1}coletarDependencias(e){let i=[],t=e;for(;t?.dependencia;){let o=this.habilidades.find(d=>String(d.id)===String(t.dependencia));o&&!this.temHabilidade(o.id)&&i.unshift(o),t=o}return i}coletarDependentes(e){let i=[],t=o=>{let d=this.habilidades.filter(a=>String(a.dependencia)===String(o));for(let a of d)i.push(a),t(String(a.id))};return t(String(e.id)),i}adicionarHabilidadeJogador(e){return u(this,null,function*(){if(this.temHabilidade(e.id))return;let t=[...this.coletarDependencias(e),e],o=t.map(d=>`- ${d.habilidade} (Lv ${d.nivel})`).join(`
`);if(confirm(`\u26A0\uFE0F Deseja realmente adicionar a habilidade?

${o}`)){this.processando=!0;try{let d=t.map(a=>({id:Z.generateULID(),jogador:this.userEmail,habilidade:String(a.id),data_aquisicao:new Date().toISOString()}));yield this.repoHabJog.createBatch(d),this.habilidadesJogador=this.normalizeHabJog((yield this.repoHabJog.getLocal()).filter(a=>a.jogador===this.userEmail)),this.renderizarArvores()}finally{this.processando=!1}}})}removerHabilidadeJogador(e){return u(this,null,function*(){let t=this.coletarDependentes(e).filter(a=>this.temHabilidade(a.id)),o=[e,...t],d=o.map(a=>`- ${a.habilidade} (Lv ${a.nivel})`).join(`
`);if(confirm(`\u26A0\uFE0F Deseja realmente remover a habilidade?

${d}`)){this.processando=!0;try{let h=this.habilidadesJogador.filter(p=>o.some(C=>String(C.id)===String(p.habilidade))).map(p=>p.id);yield this.repoHabJog.deleteBatch(h),this.habilidadesJogador=this.normalizeHabJog((yield this.repoHabJog.getLocal()).filter(p=>p.jogador===this.userEmail)),this.renderizarArvores()}finally{this.processando=!1}}})}fecharModal(){this.habilidadeSelecionada=null}static \u0275fac=function(i){return new(i||n)(L(U))};static \u0275cmp=z({type:n,selectors:[["app-skilltree"]],viewQuery:function(i,t){if(i&1&&V(ae,5),i&2){let o;j(o=R())&&(t.cyContainers=o)}},decls:11,vars:5,consts:[["cyContainer",""],["addBtn",""],["removerIcon",""],["addIcon",""],[1,"skilltree-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light","pb-5"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"skilltree-container","w-100"],[1,"page-title"],[1,"nav","nav-tabs","custom-tabs","mb-4"],["class","nav-item",4,"ngFor","ngForOf"],[1,"text-center","py-5"],[1,"arvores-scroll"],["class","modal-backdrop-blur",4,"ngIf"],["class","modal fade","id","habilidadeModal","tabindex","-1","aria-hidden","true",3,"ngClass",4,"ngIf"],[1,"nav-item"],[1,"nav-link",3,"click"],[1,"spinner-border","text-light"],[1,"mt-2"],["class","arvore-card shadow-lg",4,"ngFor","ngForOf"],[1,"arvore-card","shadow-lg"],[1,"arvore-titulo"],[1,"cy-arvore"],[1,"modal-backdrop-blur"],["id","habilidadeModal","tabindex","-1","aria-hidden","true",1,"modal","fade",3,"ngClass"],[1,"modal-dialog","modal-dialog-centered"],[1,"modal-content","bg-dark","text-light","detalhe-card","shadow-lg"],[1,"modal-header","border-0"],[1,"modal-title","fw-bold"],[1,"nivel"],["type","button",1,"btn-close","btn-close-white",3,"click"],[1,"modal-body"],[1,"mb-2"],["class","detalhe-extra",4,"ngIf"],[1,"modal-footer","border-0","d-flex","justify-content-end","gap-2"],[1,"btn","btn-sm","btn-outline-warning",3,"click"],[4,"ngIf","ngIfElse"],[1,"detalhe-extra"],[1,"btn","btn-sm","btn-outline-danger",3,"click","disabled"],[1,"spinner-border","spinner-border-sm"],[1,"btn","btn-sm","btn-outline-success",3,"click","disabled"]],template:function(i,t){i&1&&(s(0,"div",4)(1,"div",5)(2,"div",6)(3,"h2",7),c(4,"\u{1F333} \xC1rvores de Habilidades"),l(),s(5,"ul",8),b(6,re,3,3,"li",9),l(),T(7,le,4,0,"div",10),T(8,se,2,1,"div",11),b(9,ce,1,0,"div",12)(10,_e,19,9,"div",13),l()()()),i&2&&(r(6),m("ngForOf",t.caminhos),r(),I(t.carregando?7:-1),r(),I(!t.carregando&&t.abaAtiva?8:-1),r(),m("ngIf",t.habilidadeSelecionada),r(),m("ngIf",t.habilidadeSelecionada))},dependencies:[N,q,B,Q],styles:[".page-title[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700;margin-bottom:24px;color:#f1f1f1}.nav-tabs[_ngcontent-%COMP%]{border-bottom:1px solid #333}.nav-tabs[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]{color:#bbb;background:transparent;border:none;font-weight:500;padding:8px 14px;transition:color .2s,border-bottom .2s}.nav-tabs[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]:hover{color:#fff}.nav-tabs[_ngcontent-%COMP%]   .nav-link.active[_ngcontent-%COMP%]{color:#fff;background:transparent;border:none;border-bottom:2px solid #007bff;font-weight:600}.arvores-scroll[_ngcontent-%COMP%]{display:flex;gap:20px;overflow-x:auto;padding-bottom:14px;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}.arvores-scroll[_ngcontent-%COMP%]::-webkit-scrollbar{height:6px}.arvores-scroll[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#444;border-radius:4px}.arvore-card[_ngcontent-%COMP%]{flex:0 0 340px;background:#181818;border-radius:12px;padding:16px;scroll-snap-align:center;transition:transform .2s ease}.arvore-card[_ngcontent-%COMP%]:hover{transform:translateY(-4px)}.arvore-titulo[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:600;margin-bottom:10px;color:#eaeaea;text-align:center}.cy-arvore[_ngcontent-%COMP%]{width:100%;height:65vh;background:#0e0e0e;border-radius:8px}.modal-content[_ngcontent-%COMP%]{background:#1f1f1f;color:#f1f1f1}.modal-header[_ngcontent-%COMP%]   .modal-title[_ngcontent-%COMP%]{font-size:1.2rem;font-weight:700}.modal-body[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.95rem;color:#ccc}.modal-footer[_ngcontent-%COMP%]{gap:8px}.modal-backdrop-blur[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#0f0f0f99;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);z-index:1040}#habilidadeModal[_ngcontent-%COMP%]{z-index:1050}.detalhe-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:.75rem;border:1px solid rgba(255,255,255,.05);color:#f1f1f1;white-space:pre-line}.detalhe-extra[_ngcontent-%COMP%]{font-size:.9rem;color:#aaa}.detalhe-extra[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-weight:600;color:#ddd}.modal-header[_ngcontent-%COMP%]   .modal-title[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:700}.modal-footer[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0}.modal-footer[_ngcontent-%COMP%]   .btn-outline-warning[_ngcontent-%COMP%]{border-color:#ffc107;color:#ffc107}.modal-footer[_ngcontent-%COMP%]   .btn-outline-warning[_ngcontent-%COMP%]:hover{background:#ffc107;color:#000}.modal-footer[_ngcontent-%COMP%]   .btn-outline-danger[_ngcontent-%COMP%]{border-color:#ff4d6d;color:#ff4d6d}.modal-footer[_ngcontent-%COMP%]   .btn-outline-danger[_ngcontent-%COMP%]:hover{background:#ff4d6d;color:#fff}.modal-footer[_ngcontent-%COMP%]   .btn-outline-success[_ngcontent-%COMP%]{border-color:#28a745;color:#28a745}.modal-footer[_ngcontent-%COMP%]   .btn-outline-success[_ngcontent-%COMP%]:hover{background:#28a745;color:#fff}"]})};export{G as SkillTree};
