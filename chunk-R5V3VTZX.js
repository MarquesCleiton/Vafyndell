import{b as K,c as X,f as Y,i as Z,r as ee}from"./chunk-GFP7435U.js";import{a as ie,b as R}from"./chunk-UJSUP3BC.js";import{e as B,f as Q,g as G,j as H,s as J,w as P}from"./chunk-WLM7QTUH.js";import{$b as x,Fb as M,Jb as v,Lb as p,Pa as F,Qa as r,Va as k,Xb as V,Yb as L,Zb as l,_ as z,_b as O,a as y,ab as j,ac as U,b as w,cc as D,d as u,dc as q,ec as A,fb as f,fc as T,gc as N,ia as I,ja as S,jc as W,wb as d,xb as s,yb as c,zb as C}from"./chunk-QQSIVCMV.js";var E=class n{catalogoRepo=new R("Catalogo","Catalogo");inventarioRepo=new R("Inventario","Inventario");receitasRepo=new R("Receitas","Receitas");getPossiveisReceitas(){return u(this,null,function*(){let i=P.getUser();if(!i?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");let e=yield this.catalogoRepo.getLocal(),t=(yield this.inventarioRepo.getLocal()).filter(h=>h.jogador===i.email),a=yield this.receitasRepo.getLocal();if(e.length&&t.length&&a.length)return this.sincronizarMulti(i.email).catch(h=>console.error("[OficinaService] Erro ao sincronizar:",h)),this.processar(e,a,t);let o=yield this.catalogoRepo.getAllMulti(["Catalogo","Receitas","Inventario"]),m=o.Catalogo,g=o.Receitas,b=o.Inventario.filter(h=>h.jogador===i.email);return yield Promise.all([this.catalogoRepo.bulkPutLocal(m),this.inventarioRepo.bulkPutLocal(b),this.receitasRepo.bulkPutLocal(g)]),this.processar(m,g,b)})}sincronizarMulti(i){return u(this,null,function*(){let[e,t,a]=yield Promise.all([this.catalogoRepo.sync(),this.inventarioRepo.sync(),this.receitasRepo.sync()]);(e||t||a)&&console.log("[OficinaService] Alguma tabela foi atualizada \u2192 dados locais recarregados")})}processar(i,e,t){let a=new Map;return t.forEach(m=>{let g=String(m.item_catalogo),b=a.get(g)||0;a.set(g,b+(m.quantidade||0))}),i.filter(m=>e.some(g=>String(g.fabricavel)===String(m.id))).map(m=>{let g=e.filter(_=>String(_.fabricavel)===String(m.id)).map(_=>{let ne=a.get(String(_.catalogo))||0,$=i.find(ae=>String(ae.id)===String(_.catalogo));return w(y({},_),{quantidadeInventario:ne,nome:$?.nome,imagem:$?.imagem})}),b=g.every(_=>_.quantidadeInventario>=_.quantidade);return g.some(_=>_.quantidadeInventario>0)?w(y({},m),{fabricavel:b,ingredientes:g}):null}).filter(m=>m!==null)}criarItem(i){return u(this,null,function*(){let e=P.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");for(let a of i.ingredientes)yield this.subtrairQuantidade(e.email,a.catalogo,a.quantidade);let t=i.quantidade_fabricavel||1;yield this.adicionarOuIncrementar(e.email,i.id,t),console.log(`[OficinaService] Item criado: ${i.nome} (x${t} ${i.unidade_medida||"unidade(s)"})`)})}forcarFalha(i){return u(this,null,function*(){let e=P.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");for(let t of i.ingredientes)yield this.subtrairQuantidade(e.email,t.catalogo,t.quantidade);console.log(`[OficinaService] Falha for\xE7ada: ${i.nome}`)})}subtrairQuantidade(i,e,t){return u(this,null,function*(){let o=(yield this.inventarioRepo.getLocal()).filter(m=>m.jogador===i).find(m=>m.item_catalogo===e);o&&(o.quantidade=Math.max(0,(o.quantidade||0)-t),o.quantidade===0?yield this.inventarioRepo.delete(o.index):yield this.inventarioRepo.update(o))})}adicionarOuIncrementar(i,e,t){return u(this,null,function*(){let a=(yield this.inventarioRepo.getLocal()).filter(m=>m.jogador===i),o=a.find(m=>m.item_catalogo===e);o?(o.quantidade+=t,yield this.inventarioRepo.update(o)):yield this.inventarioRepo.create({id:ie.generateULID(),index:a.length+1,jogador:i,item_catalogo:e,quantidade:t})})}static \u0275fac=function(e){return new(e||n)};static \u0275prov=z({token:n,factory:n.\u0275fac,providedIn:"root"})};var ce=(n,i)=>({ok:n,fail:i});function se(n,i){if(n&1){let e=M();s(0,"li",15)(1,"button",16),v("click",function(){let a=I(e).$implicit,o=p();return S(o.selecionarAba(a))}),l(2),c()()}if(n&2){let e=i.$implicit,t=p();r(),V("active",t.abaAtiva===e),r(),x(" ",e==="recursos"?"\u{1F33F} Recursos":e==="equipamentos"?"\u2694\uFE0F Equipamentos":e==="pocoes"?"\u{1F9EA} Po\xE7\xF5es":"\u{1F4E6} Outros"," ")}}function de(n,i){n&1&&(s(0,"div",17),C(1,"div",18),s(2,"p",19),l(3,"Carregando receitas..."),c()())}function le(n,i){n&1&&(s(0,"div",20),l(1," Nenhum item encontrado. "),c())}function me(n,i){if(n&1&&C(0,"img",38),n&2){let e=p().$implicit;d("alt",T(e.nome))("src",e.imagem,F)}}function pe(n,i){n&1&&(s(0,"span"),l(1,"\u2692\uFE0F"),c())}function fe(n,i){if(n&1&&(s(0,"p",39),l(1),c()),n&2){let e=p().$implicit;r(),x("\u2728 ",e.efeito)}}function ge(n,i){if(n&1&&(s(0,"p",40),l(1),c()),n&2){let e=p().$implicit;r(),x("\u26A0\uFE0F ",e.colateral)}}function ue(n,i){if(n&1&&C(0,"img",38),n&2){let e=p().$implicit;d("alt",T(e.nome))("src",e.imagem,F)}}function _e(n,i){n&1&&(s(0,"span"),l(1,"\u{1F9EA}"),c())}function ve(n,i){if(n&1&&(s(0,"div",43)(1,"div",44),f(2,ue,1,3,"img",31)(3,_e,2,0,"span",14),c(),s(4,"div",45)(5,"span",46),l(6),c()(),s(7,"span",47),l(8),c()()),n&2){let e=i.$implicit;d("ngClass",W(6,ce,e.quantidadeInventario>=e.quantidade,e.quantidadeInventario<e.quantidade)),r(2),d("ngIf",e.imagem),r(),d("ngIf",!e.imagem),r(3),O(e.nome),r(2),U(" ",e.quantidadeInventario,"/",e.quantidade," ")}}function xe(n,i){if(n&1&&(s(0,"div",41),f(1,ve,9,9,"div",42),c()),n&2){let e=p().$implicit;r(),d("ngForOf",e.ingredientes)}}function be(n,i){n&1&&C(0,"span",52)}function he(n,i){n&1&&(s(0,"span"),l(1,"\u{1F6E0}\uFE0F"),c())}function Ce(n,i){n&1&&C(0,"span",52)}function Oe(n,i){n&1&&(s(0,"span"),l(1,"\u{1F9E8}"),c())}function ye(n,i){if(n&1){let e=M();s(0,"div",48)(1,"button",49),v("click",function(){I(e);let a=p().$implicit,o=p(4);return S(o.criarItem(a))}),f(2,be,1,0,"span",50)(3,he,2,0,"span",14),c(),s(4,"button",51),v("click",function(){I(e);let a=p().$implicit,o=p(4);return S(o.forcarFalha(a))}),f(5,Ce,1,0,"span",50)(6,Oe,2,0,"span",14),c()()}if(n&2){let e=p().$implicit,t=p(4);r(),d("disabled",t.loadingAction[e.id]),r(),d("ngIf",t.loadingAction[e.id]==="criar"),r(),d("ngIf",t.loadingAction[e.id]!=="criar"),r(),d("disabled",t.loadingAction[e.id]),r(),d("ngIf",t.loadingAction[e.id]==="falha"),r(),d("ngIf",t.loadingAction[e.id]!=="falha")}}function we(n,i){if(n&1&&(s(0,"div",27)(1,"small",28),l(2),c(),s(3,"div",29)(4,"div",30),f(5,me,1,3,"img",31)(6,pe,2,0,"span",14),c(),s(7,"div")(8,"h6",32),l(9),c(),s(10,"small"),l(11),c()()(),f(12,fe,2,1,"p",33)(13,ge,2,1,"p",34)(14,xe,2,1,"div",35),s(15,"div",36),l(16," \u2692\uFE0F Produz: "),s(17,"b"),l(18),c(),l(19),c(),f(20,ye,7,6,"div",37),c()),n&2){let e=i.$implicit,t=p(4);r(),d("ngClass",e.fabricavel?"status-ok":"status-off"),r(),x(" ",e.fabricavel?"\u2714 Dispon.":"\u2716 Indisp."," "),r(3),d("ngIf",e.imagem),r(),d("ngIf",!e.imagem),r(3),O(e.nome),r(),L(N("raridade ",t.getRaridadeClass(e.raridade))),r(),x(" ",e.raridade||"Comum"," "),r(),d("ngIf",e.efeito),r(),d("ngIf",e.colateral),r(),d("ngIf",e.ingredientes==null?null:e.ingredientes.length),r(4),O(e.quantidade_fabricavel||1),r(),x(" ",e.unidade_medida||"unidade(s)"," "),r(),d("ngIf",e.fabricavel)}}function Ie(n,i){if(n&1&&(s(0,"div",25),f(1,we,21,15,"div",26),c()),n&2){let e=p().$implicit;r(),d("ngForOf",e.itens)}}function Se(n,i){if(n&1){let e=M();s(0,"div",22)(1,"button",23),v("click",function(){let a=I(e).$implicit,o=p(2);return S(o.toggleCategoria(a))}),s(2,"span"),l(3),c(),s(4,"span"),l(5),c()(),f(6,Ie,2,1,"div",24),c()}if(n&2){let e=i.$implicit,t=p(2);d("hidden",!t.pertenceAba(e.nome)),r(3),O(e.nome||"Outros"),r(2),O(e.expandido?"\u2212":"+"),r(),d("ngIf",e.expandido)}}function Me(n,i){if(n&1&&(s(0,"div"),f(1,Se,7,4,"div",21),c()),n&2){let e=p();r(),d("ngForOf",e.categoriasFiltradas)}}var te=class n{constructor(i,e){this.router=i;this.oficinaService=e}categorias=[];categoriasFiltradas=[];carregando=!0;filtro="";fabricaveisOnly=!1;abaAtiva="recursos";abas=["recursos","equipamentos","pocoes","outros"];loadingAction={};todasReceitas=[];mapaAbas={recursos:["Recursos bot\xE2nicos","Mineral","Componentes bestiais e animalescos","Tesouro","Moeda"],equipamentos:["Equipamento","Ferramentas","Utilit\xE1rio \u2013 Bombas, armadilhas, luz, som, g\xE1s, adesivos"],pocoes:["Po\xE7\xE3o de Cura \u2013 Regenera vida, cicatriza feridas","Po\xE7\xE3o Mental \u2013 Calmante, foco, mem\xF3ria, sono, esquecimento","Po\xE7\xE3o de Aprimoramento F\xEDsico \u2013 For\xE7a, resist\xEAncia, agilidade","Po\xE7\xE3o Sensorial \u2013 Vis\xE3o, audi\xE7\xE3o, percep\xE7\xE3o, voz, respira\xE7\xE3o","Po\xE7\xE3o de Furtividade \u2013 Camuflagem, passos suaves, sil\xEAncio","Po\xE7\xE3o de Energia \u2013 Percep\xE7\xE3o da energia fundamental","Veneno \u2013 Sonol\xEAncia, confus\xE3o ou morte"],outros:["Outros"]};ngOnInit(){return u(this,null,function*(){try{this.carregando=!0,this.todasReceitas=yield this.oficinaService.getPossiveisReceitas(),this.processarItens(this.todasReceitas)}catch(i){console.error("[Oficina] Erro ao carregar receitas:",i)}finally{this.carregando=!1}})}processarItens(i){let e=new Map(this.categorias.map(a=>[a.nome,a.expandido])),t=new Map;i.forEach(a=>{let o=a.categoria||"Outros";t.has(o)||t.set(o,[]),t.get(o).push(a)}),this.categorias=Array.from(t.entries()).sort(([a],[o])=>a.localeCompare(o)).map(([a,o])=>({nome:a,itens:o,expandido:e.get(a)??!1})),this.categoriasFiltradas=[...this.categorias]}aplicarFiltro(){let i=this.normalize(this.filtro);if(!i&&!this.fabricaveisOnly){this.categoriasFiltradas=[...this.categorias];return}this.categoriasFiltradas=this.categorias.map(e=>{let t=e.itens.filter(a=>(!this.fabricaveisOnly||a.fabricavel)&&(this.normalize(a.nome).includes(i)||this.normalize(a.raridade).includes(i)||this.normalize(a.efeito).includes(i)||this.normalize(a.descricao).includes(i)));return w(y({},e),{itens:t,expandido:t.length>0})}).filter(e=>e.itens.length>0)}normalize(i=""){return i.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}selecionarAba(i){this.abaAtiva=i}pertenceAba(i){return this.mapaAbas[this.abaAtiva].includes(i)}toggleCategoria(i){i.expandido=!i.expandido}getRaridadeClass(i){return i?i.toLowerCase():"comum"}criarItem(i){return u(this,null,function*(){let e=i.quantidade_fabricavel||1,t=i.unidade_medida||"unidade(s)";if(confirm(`\u2692\uFE0F Deseja realmente fabricar "${i.nome}"?

\u27A1 Ingredientes ser\xE3o consumidos.
\u27A1 Voc\xEA receber\xE1 ${e} ${t}.`)){this.loadingAction[i.id]="criar";try{yield this.oficinaService.criarItem(i),alert(`\u2705 Voc\xEA fabricou ${e} ${t} de "${i.nome}"!`),this.todasReceitas=yield this.oficinaService.getPossiveisReceitas(),this.processarItens(this.todasReceitas)}catch(o){console.error("[Oficina] Erro ao criar item:",o),alert("\u274C Erro ao fabricar item!")}finally{this.loadingAction[i.id]=null}}})}forcarFalha(i){return u(this,null,function*(){if(confirm(`\u{1F4A5} Deseja realmente for\xE7ar a falha de "${i.nome}"?

\u27A1 Todos os ingredientes ser\xE3o perdidos.
\u27A1 Nenhum item ser\xE1 fabricado.`)){this.loadingAction[i.id]="falha";try{yield this.oficinaService.forcarFalha(i),alert(`\u{1F4A5} Falha for\xE7ada! Ingredientes de "${i.nome}" foram consumidos.`),this.todasReceitas=yield this.oficinaService.getPossiveisReceitas(),this.processarItens(this.todasReceitas)}catch(t){console.error("[Oficina] Erro ao for\xE7ar falha:",t),alert("\u274C Erro ao processar falha!")}finally{this.loadingAction[i.id]=null}}})}static \u0275fac=function(e){return new(e||n)(k(J),k(E))};static \u0275cmp=j({type:n,selectors:[["app-oficina"]],decls:17,vars:6,consts:[[1,"oficina-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"p-3","top-bar","position-sticky","top-0",2,"z-index","10"],[1,"d-flex","align-items-center","gap-2"],["type","text","placeholder","\u{1F50D} Procurar receitas...",1,"form-control","search-input","rounded-pill","px-3",3,"ngModelChange","input","ngModel"],[1,"form-check","ms-2"],["type","checkbox","id","fabricaveisOnly",1,"form-check-input",3,"ngModelChange","change","ngModel"],["for","fabricaveisOnly",1,"form-check-label","small","text-light"],[1,"nav","nav-tabs","mt-2"],["class","nav-item",4,"ngFor","ngForOf"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"oficina-container","w-100"],[1,"fw-bold","mb-3","title"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[1,"nav-item"],[1,"nav-link",3,"click"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",3,"hidden",4,"ngFor","ngForOf"],[1,"mb-3",3,"hidden"],[1,"categoria-btn",3,"click"],["class","mt-2 d-flex flex-column gap-3",4,"ngIf"],[1,"mt-2","d-flex","flex-column","gap-3"],["class","receita-card",4,"ngFor","ngForOf"],[1,"receita-card"],[1,"status-indicador",3,"ngClass"],[1,"d-flex","align-items-center","mb-2"],[1,"thumb"],[3,"src","alt",4,"ngIf"],[1,"fw-bold","text-white","mb-1"],["class","small text-info mb-1",4,"ngIf"],["class","small text-danger mb-2",4,"ngIf"],["class","ingredientes-grid",4,"ngIf"],[1,"producao-info","mt-2","text-center"],["class","acoes-bottom",4,"ngIf"],[3,"src","alt"],[1,"small","text-info","mb-1"],[1,"small","text-danger","mb-2"],[1,"ingredientes-grid"],["class","ingrediente-pill",3,"ngClass",4,"ngFor","ngForOf"],[1,"ingrediente-pill",3,"ngClass"],[1,"ingrediente-thumb"],[1,"flex-grow-1"],[1,"small"],[1,"small","fw-bold"],[1,"acoes-bottom"],[1,"btn-square","success",3,"click","disabled"],["class","spinner-border spinner-border-sm",4,"ngIf"],[1,"btn-square","danger",3,"click","disabled"],[1,"spinner-border","spinner-border-sm"]],template:function(e,t){e&1&&(s(0,"div",0)(1,"div",1)(2,"div",2)(3,"input",3),A("ngModelChange",function(o){return q(t.filtro,o)||(t.filtro=o),o}),v("input",function(){return t.aplicarFiltro()}),c(),s(4,"div",4)(5,"input",5),A("ngModelChange",function(o){return q(t.fabricaveisOnly,o)||(t.fabricaveisOnly=o),o}),v("change",function(){return t.aplicarFiltro()}),c(),s(6,"label",6),l(7," Apenas fabric\xE1veis "),c()()(),s(8,"ul",7),f(9,se,3,3,"li",8),c()(),s(10,"div",9)(11,"div",10)(12,"h4",11),l(13,"\u2692\uFE0F Oficina"),c(),f(14,de,4,0,"div",12)(15,le,2,0,"div",13)(16,Me,2,1,"div",14),c()()()),e&2&&(r(3),D("ngModel",t.filtro),r(2),D("ngModel",t.fabricaveisOnly),r(4),d("ngForOf",t.abas),r(5),d("ngIf",t.carregando),r(),d("ngIf",!t.carregando&&t.categoriasFiltradas.length===0),r(),d("ngIf",!t.carregando))},dependencies:[H,B,Q,G,ee,X,K,Y,Z],styles:[".oficina-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:center}.oficina-container[_ngcontent-%COMP%]{width:100%;max-width:900px;margin:0 auto}.toast-feedback[_ngcontent-%COMP%]{padding:10px 16px;border-radius:8px;font-weight:500;box-shadow:0 4px 12px #0006}.search-input[_ngcontent-%COMP%]{background:#1e1e1e!important;border:1px solid #444!important;color:#f8f9fa!important}.search-input[_ngcontent-%COMP%]:focus{border-color:#0d6efd!important;box-shadow:0 0 0 .2rem #0d6efd40!important;outline:none!important}.nav-tabs[_ngcontent-%COMP%]{display:flex;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;border-bottom:1px solid #444;scrollbar-width:none}.nav-tabs[_ngcontent-%COMP%]::-webkit-scrollbar{display:none}.nav-tabs[_ngcontent-%COMP%]   .nav-item[_ngcontent-%COMP%]{flex:1 0 auto;text-align:center}.nav-tabs[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]{color:#aaa;background:transparent;border:none;font-weight:600;padding:.5rem .8rem;display:flex;align-items:center;gap:6px;white-space:nowrap}.nav-tabs[_ngcontent-%COMP%]   .nav-link.active[_ngcontent-%COMP%]{color:#fff;background:#2a2a2a;border-radius:8px 8px 0 0}.title[_ngcontent-%COMP%]{color:#f8f9fa}.categoria-btn[_ngcontent-%COMP%]{width:100%;background:#2a2a2a;border:none;border-radius:8px;padding:10px 14px;font-weight:600;color:#f8f9fa;display:flex;justify-content:space-between;align-items:center;transition:background .2s ease}.categoria-btn[_ngcontent-%COMP%]:hover{background:#343a40;color:#fff}.receita-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:10px;padding:14px;position:relative;box-shadow:0 2px 6px #0006;transition:transform .15s ease;color:#f1f1f1}.receita-card[_ngcontent-%COMP%]:hover{transform:scale(1.02);background:#252525}.status-indicador[_ngcontent-%COMP%]{position:absolute;top:8px;right:12px;font-size:.8rem;font-weight:600}.status-ok[_ngcontent-%COMP%]{color:#28a745}.status-off[_ngcontent-%COMP%]{color:#dc3545}.thumb[_ngcontent-%COMP%]{width:55px;height:55px;border-radius:8px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-right:10px}.thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.ingredientes-grid[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:6px}.ingrediente-pill[_ngcontent-%COMP%]{background:#2a2a2a;border-radius:8px;padding:6px 10px;display:flex;align-items:center;gap:8px}.ingrediente-pill.ok[_ngcontent-%COMP%]{border:1px solid #28a745}.ingrediente-pill.fail[_ngcontent-%COMP%]{border:1px solid #dc3545}.ingrediente-thumb[_ngcontent-%COMP%]{width:28px;height:28px;border-radius:6px;background:#1e1e1e;display:flex;align-items:center;justify-content:center;overflow:hidden}.ingrediente-thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.acoes-bottom[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}.btn-square[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;border:none;transition:transform .2s ease}.btn-square[_ngcontent-%COMP%]:hover{transform:scale(1.08)}.btn-square.success[_ngcontent-%COMP%]{background:#198754;color:#fff}.btn-square.success[_ngcontent-%COMP%]:hover{background:#157347}.btn-square.danger[_ngcontent-%COMP%]{background:#dc3545;color:#fff}.btn-square.danger[_ngcontent-%COMP%]:hover{background:#bb2d3b}.raridade[_ngcontent-%COMP%]{font-weight:700;font-size:.85rem}.raridade.comum[_ngcontent-%COMP%]{color:#ccc}.raridade.incomum[_ngcontent-%COMP%]{color:#00bcd4}.raridade.raro[_ngcontent-%COMP%]{color:#673ab7}.raridade.epico[_ngcontent-%COMP%]{color:#9c27b0}.raridade.lendario[_ngcontent-%COMP%]{color:gold}@media (min-width: 992px){.oficina-container[_ngcontent-%COMP%]{padding:0 2rem}.receita-card[_ngcontent-%COMP%]{border-radius:16px}}.producao-info[_ngcontent-%COMP%]{font-size:.9rem;color:#0dcaf0;font-weight:600;background:#2a2a2a;border-radius:6px;padding:4px 8px;display:inline-block}"]})};export{te as Oficina};
