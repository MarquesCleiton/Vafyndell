import{a as O}from"./chunk-X543RNLP.js";import{a as w}from"./chunk-Y6SM3S4N.js";import{b as J,c as Y,f as H,i as K,r as Q}from"./chunk-W45U2HER.js";import{a as Z,b as _}from"./chunk-VZT3XYFG.js";import{Ia as l,Ja as c,Ka as r,La as S,Lb as q,Mb as V,N as F,Nb as W,Qb as $,Ra as k,T as P,Ta as R,U as B,Va as g,Zb as G,a as f,ac as X,b as u,d as m,gb as L,hb as d,ib as C,ja as z,jb as h,ka as o,mb as E,nb as M,oa as D,ob as T,pb as U,qb as j,sa as N,wa as v}from"./chunk-Y44Y2XZC.js";var b=class{static TAB="Receitas";static STORE=this.TAB;static META_STORE="metadados";static dbPromise=null;static getDb(){return m(this,null,function*(){return this.dbPromise||(console.log("[ReceitasRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=Z.create()),this.dbPromise})}static createReceita(t){return m(this,null,function*(){console.log("[ReceitasRepository] Criando nova receita...",t);let e=yield _.controllerCreate({tab:this.TAB,attrs:t}),i=u(f({},e),{id:e?.index||Date.now()});return yield(yield this.getDb()).put(this.STORE,i),console.log("[ReceitasRepository] Receita criada e salva no cache:",i),i})}static updateReceita(t){return m(this,null,function*(){console.log("[ReceitasRepository] Atualizando receita...",t);let e=yield _.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t}),i=f(f({},t),e);return yield(yield this.getDb()).put(this.STORE,i),console.log("[ReceitasRepository] Receita atualizada no cache local:",i),i})}static getAllReceitas(){return m(this,null,function*(){console.log("[ReceitasRepository] getAllReceitas...");let t=yield _.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t:[]})}static getLocalReceitas(){return m(this,null,function*(){return yield(yield this.getDb()).getAll(this.STORE)})}static forceFetchReceitas(){return m(this,null,function*(){console.log("[ReceitasRepository] Baixando lista online...");let t=yield this.getAllReceitas();if(!t.length)return console.warn("[ReceitasRepository] Nenhuma receita encontrada online."),[];let e=t.map(s=>u(f({},s),{id:s.index})),i=yield this.getDb();yield i.clear(this.STORE),yield i.bulkPut(this.STORE,e),console.log("[ReceitasRepository] Cache atualizado com lista online.");let n=yield _.controllerGetAll({tab:"Metadados"});if(Array.isArray(n)){let s=n.find(x=>x.SheetName===this.TAB);s&&(yield i.put(this.META_STORE,{id:this.TAB,UltimaModificacao:s.UltimaModificacao}),console.log("[ReceitasRepository] Metadados locais atualizados:",s))}return e})}static syncReceitas(){return m(this,null,function*(){console.log("[ReceitasRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let t=yield _.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let e=t.find(x=>x.SheetName===this.TAB);if(!e)return console.warn("[ReceitasRepository] Nenhum metadado online encontrado."),!1;let n=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!n||n.UltimaModificacao!==e.UltimaModificacao?(console.log("[ReceitasRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchReceitas(),!0):(console.log("[ReceitasRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}static deleteReceita(t){return m(this,null,function*(){return console.log("[ReceitasRepository] Excluindo receita...",t),yield _.controllerDeleteByIndex({tab:this.TAB,index:t}),yield(yield this.getDb()).delete(this.STORE,t),console.log("[ReceitasRepository] Receita exclu\xEDda do cache/local:",t),!0})}};var I=class a{getPossiveisReceitas(){return m(this,null,function*(){let t=X.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");let[e,i,n]=yield Promise.all([w.getLocalItens(),b.getLocalReceitas(),O.getLocalInventarioByJogador(t.email)]);return(!e.length||!i.length||!n.length)&&(console.log("[OficinaService] Cache incompleto \u2192 carregando dados s\xEDncronos..."),yield w.syncItens(),e=yield w.getLocalItens(),yield O.syncInventario(),n=yield O.getLocalInventarioByJogador(t.email),yield b.syncReceitas(),i=yield b.getLocalReceitas()),this.processar(e,i,n)})}processar(t,e,i){let n=new Map;i.forEach(p=>{let A=n.get(p.item_catalogo)||0;n.set(p.item_catalogo,A+p.quantidade)});let s=new Set(e.map(p=>p.fabricavel));return t.filter(p=>s.has(p.id)).map(p=>{let te=e.filter(y=>y.fabricavel===p.id).every(y=>(n.get(y.catalogo)||0)>=y.quantidade);return u(f({},p),{fabricavel:te})})}static \u0275fac=function(e){return new(e||a)};static \u0275prov=F({token:a,factory:a.\u0275fac,providedIn:"root"})};function ne(a,t){a&1&&(c(0,"div",12),S(1,"div",13),c(2,"p",14),d(3,"Carregando receitas..."),r()())}function oe(a,t){a&1&&(c(0,"div",15),d(1," Nenhum item encontrado. "),r())}function re(a,t){if(a&1&&S(0,"img",34),a&2){let e=g().$implicit;l("alt",U(e.nome||"Item"))("src",e.imagem,z)}}function ce(a,t){a&1&&(c(0,"span",35),d(1,"\u2692\uFE0F"),r())}function se(a,t){if(a&1&&(c(0,"p",36),d(1),r()),a&2){let e=g().$implicit;o(),h(" \u2728 ",e.efeito," ")}}function le(a,t){if(a&1&&(c(0,"p",37),d(1),r()),a&2){let e=g().$implicit;o(),h(" \u26A0\uFE0F ",e.colateral," ")}}function de(a,t){if(a&1&&(c(0,"p",38),d(1),r()),a&2){let e=g().$implicit;o(),h(" \u{1F4DD} ",e.descricao," ")}}function me(a,t){if(a&1&&(c(0,"div",23)(1,"div",24)(2,"span",25),d(3),r(),c(4,"div",26)(5,"div",27),v(6,re,1,3,"img",28)(7,ce,2,0,"span",29),r(),c(8,"div")(9,"h6",30),d(10),r(),c(11,"small"),d(12),r()()(),v(13,se,2,1,"p",31)(14,le,2,1,"p",32)(15,de,2,1,"p",33),r()()),a&2){let e=t.$implicit,i=g(4);o(2),l("ngClass",e.fabricavel?"bg-success":"bg-secondary"),o(),h(" ",e.fabricavel?"\u2705":"\u274C"," "),o(3),l("ngIf",e.imagem),o(),l("ngIf",!e.imagem),o(3),C(e.nome||"Sem nome"),o(),L(j("raridade ",i.getRaridadeClass(e.raridade))),o(),h(" ",e.raridade||"Comum"," "),o(),l("ngIf",e.efeito),o(),l("ngIf",e.colateral),o(),l("ngIf",e.descricao)}}function pe(a,t){if(a&1&&(c(0,"div",14)(1,"div",21),v(2,me,16,12,"div",22),r()()),a&2){let e=g().$implicit;o(2),l("ngForOf",e.itens)}}function fe(a,t){if(a&1){let e=k();c(0,"div",17)(1,"button",18),R("click",function(){let n=P(e).$implicit,s=g(2);return B(s.toggleCategoria(n))}),c(2,"span",19),d(3),r(),c(4,"span"),d(5),r()(),v(6,pe,3,1,"div",20),r()}if(a&2){let e=t.$implicit;o(3),C(e.nome||"Outros"),o(2),C(e.expandido?"\u2212":"+"),o(),l("ngIf",e.expandido)}}function ge(a,t){if(a&1&&(c(0,"div"),v(1,fe,7,3,"div",16),r()),a&2){let e=g();o(),l("ngForOf",e.categoriasFiltradas)}}var ee=class a{constructor(t,e){this.router=t;this.oficinaService=e}categorias=[];categoriasFiltradas=[];carregando=!0;filtro="";fabricaveisOnly=!1;ngOnInit(){return m(this,null,function*(){try{this.carregando=!0;let t=yield this.oficinaService.getPossiveisReceitas();this.processarItens(t),this.carregando=!1}catch(t){console.error("[Oficina] Erro ao carregar receitas:",t),this.carregando=!1}})}processarItens(t){let e=new Map;t.forEach(i=>{let n=i.categoria||"Outros";e.has(n)||e.set(n,[]),e.get(n).push(i)}),this.categorias=Array.from(e.entries()).sort((i,n)=>String(i[0]).localeCompare(String(n[0]))).map(([i,n])=>({nome:i,itens:n,expandido:!1})),this.categoriasFiltradas=[...this.categorias]}toggleCategoria(t){t.expandido=!t.expandido}aplicarFiltro(){let t=this.normalize(this.filtro);if(!t&&!this.fabricaveisOnly){this.categoriasFiltradas=[...this.categorias];return}this.categoriasFiltradas=this.categorias.map(e=>{let i=e.itens.filter(n=>(!this.fabricaveisOnly||n.fabricavel)&&(this.normalize(n.nome).includes(t)||this.normalize(n.raridade).includes(t)||this.normalize(n.efeito).includes(t)||this.normalize(n.descricao).includes(t)));return u(f({},e),{itens:i,expandido:!0})}).filter(e=>e.itens.length>0)}normalize(t=""){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}getRaridadeClass(t){return t?t.toLowerCase():"comum"}static \u0275fac=function(e){return new(e||a)(D(G),D(I))};static \u0275cmp=N({type:a,selectors:[["app-oficina"]],decls:14,vars:5,consts:[[1,"d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"p-3","bg-black","border-bottom","position-sticky","top-0",2,"z-index","10"],[1,"d-flex","align-items-center","gap-2"],["type","text","placeholder","\u{1F50D} Pesquisar receitas...",1,"form-control","bg-dark","text-light","border-light","rounded-pill","px-3",3,"ngModelChange","input","ngModel"],[1,"form-check","ms-2"],["type","checkbox","id","fabricaveisOnly",1,"form-check-input",3,"ngModelChange","change","ngModel"],["for","fabricaveisOnly",1,"form-check-label","small","text-light"],[1,"flex-grow-1","p-3"],[1,"fw-bold","mb-3"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",4,"ngFor","ngForOf"],[1,"mb-3"],[1,"btn","btn-outline-light","w-100","text-start","d-flex","justify-content-between","align-items-center",3,"click"],[1,"fw-bold"],["class","mt-2",4,"ngIf"],[1,"row","row-cols-1","g-2"],["class","col",4,"ngFor","ngForOf"],[1,"col"],[1,"card","catalogo-card","shadow-sm","h-100","p-3","position-relative"],[1,"badge","position-absolute","top-0","end-0","m-2",3,"ngClass"],[1,"d-flex","align-items-center","mb-2"],[1,"rounded","me-3","d-flex","align-items-center","justify-content-center","bg-dark",2,"width","55px","height","55px","overflow","hidden"],["style","width: 100%; height: 100%; object-fit: cover;",3,"src","alt",4,"ngIf"],["class","text-muted",4,"ngIf"],[1,"fw-bold","text-white","mb-1"],["class","small mt-2 text-info",4,"ngIf"],["class","small text-danger",4,"ngIf"],["class","small descricao-text fst-italic",4,"ngIf"],[2,"width","100%","height","100%","object-fit","cover",3,"src","alt"],[1,"text-muted"],[1,"small","mt-2","text-info"],[1,"small","text-danger"],[1,"small","descricao-text","fst-italic"]],template:function(e,i){e&1&&(c(0,"div",0)(1,"div",1)(2,"div",2)(3,"input",3),T("ngModelChange",function(s){return M(i.filtro,s)||(i.filtro=s),s}),R("input",function(){return i.aplicarFiltro()}),r(),c(4,"div",4)(5,"input",5),T("ngModelChange",function(s){return M(i.fabricaveisOnly,s)||(i.fabricaveisOnly=s),s}),R("change",function(){return i.aplicarFiltro()}),r(),c(6,"label",6),d(7," Apenas fabric\xE1veis "),r()()()(),c(8,"div",7)(9,"h4",8),d(10,"\u2692\uFE0F Oficina"),r(),v(11,ne,4,0,"div",9)(12,oe,2,0,"div",10)(13,ge,2,1,"div",11),r()()),e&2&&(o(3),E("ngModel",i.filtro),o(2),E("ngModel",i.fabricaveisOnly),o(6),l("ngIf",i.carregando),o(),l("ngIf",!i.carregando&&i.categoriasFiltradas.length===0),o(),l("ngIf",!i.carregando))},dependencies:[$,q,V,W,Q,Y,J,H,K],styles:[".catalogo-card[_ngcontent-%COMP%]{background:#1e1e1e;border:1px solid #333;border-radius:14px;transition:all .2s ease-in-out}.catalogo-card[_ngcontent-%COMP%]:hover{transform:translateY(-3px);box-shadow:0 6px 14px #00000073}.descricao-text[_ngcontent-%COMP%]{color:#cfcfcf!important}.raridade.comum[_ngcontent-%COMP%]{color:#999}.raridade.incomum[_ngcontent-%COMP%]{color:#6fbf73}.raridade.raro[_ngcontent-%COMP%]{color:#4a90e2}.raridade.\\e9pico[_ngcontent-%COMP%]{color:#9b7ecb}.raridade.lend\\e1rio[_ngcontent-%COMP%]{color:#d4af37}"]})};export{ee as Oficina};
