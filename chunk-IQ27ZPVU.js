import{a as A,b as s}from"./chunk-UM5RQUOR.js";import{a as r,ac as c,b as d,d as o}from"./chunk-Y44Y2XZC.js";var m=class{static TAB="Anotacoes";static STORE=this.TAB;static META_STORE="metadados";static FOLDER_ID="PASTA_ID_DRIVE_ANOTACOES";static dbPromise=null;static getDb(){return o(this,null,function*(){return this.dbPromise||(console.log("[AnotacaoRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=A.create()),this.dbPromise})}static createAnotacao(t){return o(this,null,function*(){t.data||(t.data=new Date().toISOString());let a=yield s.controllerCreate({tab:this.TAB,attrs:t,folderId:this.FOLDER_ID}),i=d(r({},a),{id:a?.index||Date.now()});return yield(yield this.getDb()).put(this.STORE,i),i})}static updateAnotacao(t){return o(this,null,function*(){(!t.data||!t.data.includes("T"))&&(t.data=new Date().toISOString());let a=yield s.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t,folderId:this.FOLDER_ID}),i=r(r({},t),a);return yield(yield this.getDb()).put(this.STORE,i),i})}static getAllAnotacoes(){return o(this,null,function*(){let t=yield s.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t:[]})}static getLocalAnotacoes(){return o(this,null,function*(){let t=c.getUser();return t?(yield(yield this.getDb()).getAll(this.STORE)).filter(e=>e.jogador===t.email):(console.warn("[AnotacaoRepository] Usu\xE1rio n\xE3o autenticado \u2192 retornando []"),[])})}static forceFetchAnotacoes(){return o(this,null,function*(){let t=c.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");let a=yield this.getAllAnotacoes();if(!a.length)return[];let i=a.map(n=>d(r({},n),{id:n.index})),e=yield this.getDb();yield e.clear(this.STORE),yield e.bulkPut(this.STORE,i);let l=yield s.controllerGetAll({tab:"Metadados"});if(Array.isArray(l)){let n=l.find(h=>h.SheetName===this.TAB);n&&(yield e.put(this.META_STORE,{id:this.TAB,UltimaModificacao:n.UltimaModificacao}))}return i.filter(n=>n.jogador===t.email)})}static syncAnotacoes(){return o(this,null,function*(){let t=yield s.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let a=t.find(n=>n.SheetName===this.TAB);if(!a)return!1;let e=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!e||e.UltimaModificacao!==a.UltimaModificacao?(yield this.forceFetchAnotacoes(),!0):!1})}static getCurrentAnotacoes(){return o(this,null,function*(){if(!c.getUser())throw new Error("Usu\xE1rio n\xE3o autenticado.");let a=yield this.getLocalAnotacoes();return a.length>0?(this.syncAnotacoes().then(i=>o(this,null,function*(){i&&(a=yield this.getLocalAnotacoes())})).catch(i=>console.error("[AnotacaoRepository] Erro ao sincronizar:",i)),a):yield this.forceFetchAnotacoes()})}static deleteAnotacao(t){return o(this,null,function*(){return yield s.controllerDeleteByIndex({tab:this.TAB,index:t}),yield(yield this.getDb()).delete(this.STORE,t),!0})}};export{m as a};
