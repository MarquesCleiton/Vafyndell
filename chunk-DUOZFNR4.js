import{a as c}from"./chunk-OZ52KALQ.js";import{a as h,b as g,d as a}from"./chunk-DR7ZYR7E.js";var T=class d{DB_NAME="VafyndellDB";DB_VERSION=1;db=null;storeNames=new Set;static create(){return a(this,null,function*(){let e=new d;return yield e.init(),e})}constructor(){console.log("[IndexedDBClient] Constructor chamado")}init(){return a(this,null,function*(){if(this.db){console.log("[IndexedDBClient] Banco j\xE1 inicializado.");return}let n=(yield indexedDB.databases?.())?.find(r=>r.name===this.DB_NAME);return n?.version&&n.version>this.DB_VERSION&&(this.DB_VERSION=n.version,console.log(`[IndexedDBClient] Ajustando vers\xE3o para ${this.DB_VERSION}`)),new Promise((r,s)=>{console.log(`[IndexedDBClient] Abrindo banco ${this.DB_NAME} v${this.DB_VERSION}...`);let t=indexedDB.open(this.DB_NAME,this.DB_VERSION);t.onerror=()=>s(t.error),t.onsuccess=()=>{this.db=t.result,this.storeNames=new Set(Array.from(this.db.objectStoreNames)),console.log("[IndexedDBClient] Banco aberto com stores:",Array.from(this.storeNames)),r()},t.onupgradeneeded=o=>{let i=o.target.result;console.log("[IndexedDBClient] Upgrade do banco. Stores existentes:",Array.from(i.objectStoreNames))}})})}ensureStore(e){return a(this,null,function*(){if(this.storeNames.has(e))return;console.log(`[IndexedDBClient] Store "${e}" n\xE3o existe \u2192 recriando DB...`),this.db?.close();let s=(yield indexedDB.databases?.())?.find(t=>t.name===this.DB_NAME)?.version??this.DB_VERSION;return this.DB_VERSION=Math.max(this.DB_VERSION,s)+1,new Promise((t,o)=>{let i=indexedDB.open(this.DB_NAME,this.DB_VERSION);i.onerror=()=>o(i.error),i.onupgradeneeded=l=>{let u=l.target.result;u.objectStoreNames.contains(e)||(u.createObjectStore(e,{keyPath:"id"}),console.log(`[IndexedDBClient] Store criada: ${e}`))},i.onsuccess=()=>{this.db=i.result,this.storeNames=new Set(Array.from(this.db.objectStoreNames)),console.log("[IndexedDBClient] Banco reaberto com stores:",Array.from(this.storeNames)),t()}})})}put(e,n){return a(this,null,function*(){return yield this.ensureStore(e),new Promise((r,s)=>{let t=this.db.transaction(e,"readwrite");t.objectStore(e).put(n),t.oncomplete=()=>r(),t.onerror=()=>s(t.error)})})}bulkPut(e,n){return a(this,null,function*(){return yield this.ensureStore(e),new Promise((r,s)=>{let t=this.db.transaction(e,"readwrite"),o=t.objectStore(e);n.forEach(i=>o.put(i)),t.oncomplete=()=>r(),t.onerror=()=>s(t.error)})})}get(e,n){return a(this,null,function*(){return this.storeNames.has(e)?new Promise((r,s)=>{let o=this.db.transaction(e,"readonly").objectStore(e).get(n);o.onsuccess=()=>r(o.result||null),o.onerror=()=>s(o.error)}):null})}getAll(e){return a(this,null,function*(){return this.storeNames.has(e)?new Promise((n,r)=>{let t=this.db.transaction(e,"readonly").objectStore(e).getAll();t.onsuccess=()=>n(t.result),t.onerror=()=>r(t.error)}):[]})}delete(e,n){return a(this,null,function*(){if(this.storeNames.has(e))return new Promise((r,s)=>{let t=this.db.transaction(e,"readwrite");t.objectStore(e).delete(n),t.oncomplete=()=>r(),t.onerror=()=>s(t.error)})})}clear(e){return a(this,null,function*(){if(this.storeNames.has(e))return new Promise((n,r)=>{let s=this.db.transaction(e,"readwrite");s.objectStore(e).clear(),s.oncomplete=()=>n(),s.onerror=()=>r(s.error)})})}deleteDatabase(){return a(this,null,function*(){return console.log("[IndexedDBClient] deleteDatabase \u2192 resetando banco..."),this.db&&(this.db.close(),this.db=null),new Promise((e,n)=>{let r=indexedDB.deleteDatabase(this.DB_NAME);r.onsuccess=()=>{this.storeNames.clear(),this.DB_VERSION=1,console.log("[IndexedDBClient] Banco deletado com sucesso."),e()},r.onerror=()=>n(r.error)})})}};var b=class{static ENDPOINT="https://script.google.com/macros/s/AKfycby-ec_h6sljntLAgoWhpeyBFGTkWygqS7Xx1Yvkx8RKDKiXDHPxtHZ8hhh6vrN91JEL/exec";static SHEET_ID="19B2aMGrajvhPJfOvYXt059-fECytaN38iFsP8GInD_g";static call(e,n,r=!0){return a(this,null,function*(){let s=c.getIdToken();if(!s||!c.isAuthenticated()){let l=yield c.refreshIdToken();if(!l)throw new Error("Usu\xE1rio precisa fazer login novamente.");s=l.idToken}let t={idToken:s,action:e,payload:g(h({},n),{sheetId:this.SHEET_ID})};console.log("\u27A1\uFE0F Enviando para Script:",this.ENDPOINT,t);let o=yield fetch(this.ENDPOINT,{method:"POST",body:JSON.stringify(t)}),i=yield o.text();if(!o.ok){if(console.error("\u274C Erro bruto do Script:",i),o.status===401&&r){if(console.warn("[ScriptClient] Token inv\xE1lido, tentando renovar..."),!(yield c.refreshIdToken()))throw new Error("Usu\xE1rio precisa se autenticar novamente.");return this.call(e,n,!1)}throw new Error(`Erro no Script: ${o.status} - ${o.statusText}
${i}`)}try{return JSON.parse(i)}catch(l){throw console.error("\u274C Resposta n\xE3o-JSON:",i),l}})}static createRow(e){return this.call("sheet.createRow",e)}static getAll(e){return this.call("sheet.getAll",e)}static getByIndex(e){return this.call("sheet.getByIndex",e)}static getCell(e){return this.call("sheet.getCell",e)}static updateByIndex(e){return this.call("sheet.updateByIndex",e)}static updateCell(e){return this.call("sheet.updateCell",e)}static deleteByIndex(e){return this.call("sheet.deleteByIndex",e)}static upload(e){return this.call("drive.upload",e)}static update(e){return this.call("drive.update",e)}static remove(e){return this.call("drive.delete",e)}static controllerCreate(e){return this.call("controller.create",e)}static controllerGetAll(e){return this.call("controller.getAll",e)}static controllerGetByIndex(e){return this.call("controller.getByIndex",e)}static controllerGetCell(e){return this.call("controller.getCell",e)}static controllerUpdateByIndex(e){return this.call("controller.updateByIndex",e)}static controllerUpdateCell(e){return this.call("controller.updateCell",e)}static controllerDeleteByIndex(e){return this.call("controller.deleteByIndex",e)}};export{T as a,b};
