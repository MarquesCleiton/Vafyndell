import{a as Q}from"./chunk-IKGGEFY2.js";import{a as O}from"./chunk-XQNWO7VY.js";import{a as X}from"./chunk-SSYR3IKG.js";import{c as B,f as W,i as J,m as q,n as G,o as H,r as K}from"./chunk-Y76CBAMU.js";import{a as y}from"./chunk-2FJKFAQG.js";import{e as L,f as N,g as U,m as R,v as $,z as w}from"./chunk-QALXKQRA.js";import{Ab as d,Bb as r,Cb as c,Db as S,Hb as M,Ib as E,Jb as b,Nb as _,Pb as m,Sa as P,Ua as s,Za as F,a as C,b as A,bc as l,cc as x,dc as v,eb as j,g as u,gc as T,hc as k,ic as I,jb as g,jc as V,la as f,ma as h,mc as z}from"./chunk-HRDPHWQR.js";var Z=a=>({"show d-block":a});function ee(a,e){a&1&&(r(0,"div",27),S(1,"div",28),r(2,"p",29),l(3,"Carregando anota\xE7\xF5es..."),c()())}function te(a,e){a&1&&(r(0,"div",30),l(1," Nenhuma anota\xE7\xE3o encontrada. "),c())}function ie(a,e){if(a&1){let t=b();r(0,"img",48),_("click",function(n){f(t);let o=m().$implicit,p=m(4);return h(p.abrirImagem(o.imagem,n))}),c()}if(a&2){let t=m().$implicit;d("alt",V(t.titulo||"Anota\xE7\xE3o"))("src",t.imagem,P)}}function ne(a,e){a&1&&(r(0,"span"),l(1,"\u{1F4DD}"),c())}function ae(a,e){if(a&1&&(r(0,"span"),l(1),c()),a&2){let t=m().$implicit;s(),v(" | #",t.tags)}}function oe(a,e){if(a&1){let t=b();r(0,"p",49),_("click",function(){f(t);let n=m().$implicit,o=m(4);return h(o.abrirAnotacao(n))}),l(1),c()}if(a&2){let t=m().$implicit;s(),v(" ",t.descricao," ")}}function re(a,e){if(a&1){let t=b();r(0,"div",38)(1,"div",39)(2,"div",40),_("click",function(){let n=f(t).$implicit,o=m(4);return h(o.abrirAnotacao(n))}),r(3,"div",41),g(4,ie,1,3,"img",42)(5,ne,2,0,"span",8),c(),r(6,"div")(7,"h6",43),l(8),c(),r(9,"small",44),l(10),g(11,ae,2,1,"span",8),c()()(),g(12,oe,2,1,"p",45),r(13,"div",46)(14,"button",47),_("click",function(){let n=f(t).$implicit,o=m(4);return h(o.abrirModalTransferir(n))}),l(15," \u{1F504} compartilhar "),c()()()()}if(a&2){let t=e.$implicit;s(4),d("ngIf",t.imagem&&t.imagem!=="-"),s(),d("ngIf",!t.imagem||t.imagem==="-"),s(3),x(t.titulo||"Sem t\xEDtulo"),s(2),v(" \u270D ",t.autor," "),s(),d("ngIf",t.tags),s(),d("ngIf",t.descricao)}}function ce(a,e){if(a&1&&(r(0,"div",29)(1,"div",36),g(2,re,16,6,"div",37),c()()),a&2){let t=m().$implicit;s(2),d("ngForOf",t.itens)}}function se(a,e){if(a&1){let t=b();r(0,"div",32)(1,"button",33),_("click",function(){let n=f(t).$implicit,o=m(2);return h(o.toggleSecao(n))}),r(2,"span",34),l(3),c(),r(4,"span"),l(5),c()(),g(6,ce,3,1,"div",35),c()}if(a&2){let t=e.$implicit,i=m(2);s(3),v("\u{1F4C5} ",i.formatarData(t.data)),s(2),x(t.expandido?"\u2212":"+"),s(),d("ngIf",t.expandido)}}function le(a,e){if(a&1&&(r(0,"div"),g(1,se,7,3,"div",31),c()),a&2){let t=m();s(),d("ngForOf",t.secoesFiltradas)}}function de(a,e){if(a&1&&(r(0,"div",32)(1,"h6",34),l(2),c(),r(3,"p",50),l(4),c()()),a&2){let t=m();s(2),x(t.anotacaoSelecionada.titulo),s(2),x(t.anotacaoSelecionada.descricao)}}function me(a,e){if(a&1&&(r(0,"option",51),l(1),c()),a&2){let t=e.$implicit;d("value",t.email),s(),v(" \u{1F64D} ",t.personagem," ")}}function pe(a,e){a&1&&(M(0),l(1,"\u{1F4E4} compartilhar"),E())}function _e(a,e){a&1&&(M(0),S(1,"span",52),E())}var Y=class a{constructor(e){this.router=e}secoes=[];secoesFiltradas=[];carregando=!0;filtro="";imagemSelecionada=null;modalAbertoImagem=!1;jogadores=[];modalAberto=!1;anotacaoSelecionada=null;jogadorDestino="";processando=!1;repo=new y("Anotacoes");jogadoresRepo=new y("Personagem");uploadRepo=new y("Upload");ngOnInit(){return u(this,null,function*(){this.carregando=!0;try{yield this.loadLocalAndSync();let e=w.getUser(),t=yield this.jogadoresRepo.getLocal();this.jogadores=t.filter(i=>i.email!==e?.email)}catch(e){console.error("[Anotacoes] Erro ao carregar:",e)}finally{this.carregando=!1}})}loadLocalAndSync(){return u(this,null,function*(){let e=w.getUser();if(!e?.email)return;let i=(yield this.repo.getLocal()).filter(n=>n.jogador===e.email);if(this.processarSecoes(i),this.repo.sync().then(n=>u(this,null,function*(){if(n){let p=(yield this.repo.getLocal()).filter(D=>D.jogador===e.email);this.processarSecoes(p)}})),i.length===0){let o=(yield this.repo.forceFetch()).filter(p=>p.jogador===e.email);this.processarSecoes(o)}})}processarSecoes(e){let t=new Map(this.secoes.map(n=>[n.data,n.expandido])),i=new Map;e.forEach(n=>{let o=n.data||"",p=o.includes("T")?o.split("T")[0]:o;i.has(p)||i.set(p,[]),i.get(p).push(n)}),this.secoes=Array.from(i.entries()).sort(([n],[o])=>new Date(o).getTime()-new Date(n).getTime()).map(([n,o])=>({data:n,itens:o.sort((p,D)=>new Date(D.data||0).getTime()-new Date(p.data||0).getTime()),expandido:t.get(n)??!1})),this.secoesFiltradas=[...this.secoes]}aplicarFiltro(){let e=this.normalizarTexto(this.filtro);if(!e){this.secoesFiltradas=[...this.secoes];return}this.secoesFiltradas=this.secoes.map(t=>A(C({},t),{itens:t.itens.filter(i=>this.normalizarTexto(i.titulo||"").includes(e)||this.normalizarTexto(i.descricao||"").includes(e)||this.normalizarTexto(i.tags||"").includes(e)||this.normalizarTexto(i.autor||"").includes(e)),expandido:!0})).filter(t=>t.itens.length>0)}toggleSecao(e){e.expandido=!e.expandido}formatarData(e){try{return(e.includes("T")?new Date(e):new Date(e+"T00:00:00")).toLocaleDateString("pt-BR")}catch{return e}}novaAnotacao(){this.router.navigate(["/criar-anotacao"])}abrirAnotacao(e){this.router.navigate(["/criar-anotacao",e.id])}abrirModalTransferir(e){this.anotacaoSelecionada=e,this.modalAberto=!0,this.jogadorDestino=""}fecharModal(){this.modalAberto=!1,this.anotacaoSelecionada=null}confirmarTransferencia(){return u(this,null,function*(){if(this.anotacaoSelecionada){if(!this.jogadorDestino){alert("\u26A0\uFE0F Selecione um jogador ou a op\xE7\xE3o Todos!");return}this.processando=!0;try{let e=this.anotacaoSelecionada,t=w.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");let i;if(e.imagem&&e.imagem!=="-")try{let o=yield this.urlToFile(e.imagem,`anotacao-${Date.now()}.jpg`),p=yield X.toOptimizedBase64(o);i=(yield this.uploadRepo.create({id:O.generateULID(),base64:p,nome:o.name}))?.url||e.imagem}catch(o){console.warn("[Transferencia] falha ao duplicar imagem:",o)}let n=[];this.jogadorDestino==="__all__"?n=this.jogadores.map(o=>this.criarCopia(e,o.email,t.email,i)):n=[this.criarCopia(e,this.jogadorDestino,t.email,i)],yield this.repo.createBatch(n),alert("\u2705 Anota\xE7\xE3o transferida com sucesso!"),this.fecharModal()}catch(e){console.error("[Anotacoes] Erro na transfer\xEAncia:",e),alert("\u274C Erro ao transferir anota\xE7\xE3o")}finally{this.processando=!1}}})}criarCopia(e,t,i,n){return A(C({},e),{id:O.generateULID(),jogador:t,autor:i,data:new Date().toISOString(),imagem:n||e.imagem})}urlToFile(e,t){return u(this,null,function*(){let n=yield(yield fetch(e)).blob();return new File([n],t,{type:n.type})})}normalizarTexto(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim():""}abrirImagem(e,t){t&&t.stopPropagation(),this.imagemSelecionada=e,this.modalAbertoImagem=!0}static \u0275fac=function(t){return new(t||a)(F($))};static \u0275cmp=j({type:a,selectors:[["app-anotacoes"]],decls:35,vars:15,consts:[[1,"anotacoes-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"p-3","bg-black","border-bottom","position-sticky","top-0",2,"z-index","10"],["type","text","placeholder","\u{1F50D} Pesquisar anota\xE7\xF5es...",1,"form-control","search-bar","rounded-pill","px-3",3,"ngModelChange","input","ngModel"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"anotacoes-container","w-100"],[1,"fw-bold","mb-3"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[1,"fab-stack"],[1,"fab","fab-primary",3,"click"],["id","modalTransferir","tabindex","-1","aria-hidden","true",1,"modal","fade","modal-backdrop-blur",3,"ngClass"],[1,"modal-dialog"],[1,"modal-content","bg-dark","text-light"],[1,"modal-header","border-secondary"],[1,"modal-title"],["type","button",1,"btn-close","btn-close-white",3,"click"],[1,"modal-body"],["class","mb-3",4,"ngIf"],[1,"form-label"],[1,"form-select","bg-dark","text-light",3,"ngModelChange","ngModel"],["value","__all__"],[3,"value",4,"ngFor","ngForOf"],[1,"modal-footer","border-secondary"],["type","button",1,"btn","btn-outline-light",3,"click"],["type","button",1,"btn","btn-success",3,"click","disabled"],[3,"fecharModal","imagem","aberto"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",4,"ngFor","ngForOf"],[1,"mb-3"],[1,"btn","btn-categoria","w-100","text-start","d-flex","justify-content-between","align-items-center",3,"click"],[1,"fw-bold"],["class","mt-2",4,"ngIf"],[1,"row","row-cols-1","g-2"],["class","col",4,"ngFor","ngForOf"],[1,"col"],[1,"card","anotacao-card","shadow-sm","h-100","p-3"],[1,"d-flex","align-items-center","mb-2",2,"cursor","pointer","flex","1",3,"click"],[1,"item-thumb","me-3"],[3,"src","alt","click",4,"ngIf"],[1,"fw-bold","text-white","mb-1"],[1,"text-light"],["class","small descricao-text fst-italic",3,"click",4,"ngIf"],[1,"d-flex","justify-content-end","mt-2"],[1,"btn","btn-sm","btn-outline-info",3,"click"],[3,"click","src","alt"],[1,"small","descricao-text","fst-italic",3,"click"],[1,"small","fst-italic","descricao-text"],[3,"value"],[1,"spinner-border","spinner-border-sm"]],template:function(t,i){t&1&&(r(0,"div",0)(1,"div",1)(2,"input",2),I("ngModelChange",function(o){return k(i.filtro,o)||(i.filtro=o),o}),_("input",function(){return i.aplicarFiltro()}),c()(),r(3,"div",3)(4,"div",4)(5,"h4",5),l(6,"\u{1F4DD} Minhas Anota\xE7\xF5es"),c(),g(7,ee,4,0,"div",6)(8,te,2,0,"div",7)(9,le,2,1,"div",8),c()(),r(10,"div",9)(11,"button",10),_("click",function(){return i.novaAnotacao()}),l(12,"\uFF0B"),c()()(),r(13,"div",11)(14,"div",12)(15,"div",13)(16,"div",14)(17,"h5",15),l(18,"\u{1F504} compartilhar Anota\xE7\xE3o"),c(),r(19,"button",16),_("click",function(){return i.fecharModal()}),c()(),r(20,"div",17),g(21,de,5,2,"div",18),r(22,"label",19),l(23,"\u{1F64D} Jogador Destinat\xE1rio"),c(),r(24,"select",20),I("ngModelChange",function(o){return k(i.jogadorDestino,o)||(i.jogadorDestino=o),o}),r(25,"option",21),l(26,"Todos os jogadores"),c(),g(27,me,2,2,"option",22),c()(),r(28,"div",23)(29,"button",24),_("click",function(){return i.fecharModal()}),l(30,"Cancelar"),c(),r(31,"button",25),_("click",function(){return i.confirmarTransferencia()}),g(32,pe,2,0,"ng-container",8)(33,_e,2,0,"ng-container",8),c()()()()(),r(34,"app-image-modal",26),_("fecharModal",function(){return i.modalAbertoImagem=!1}),c()),t&2&&(s(2),T("ngModel",i.filtro),s(5),d("ngIf",i.carregando),s(),d("ngIf",!i.carregando&&i.secoesFiltradas.length===0),s(),d("ngIf",!i.carregando),s(4),d("ngClass",z(13,Z,i.modalAberto)),s(8),d("ngIf",i.anotacaoSelecionada),s(3),T("ngModel",i.jogadorDestino),s(3),d("ngForOf",i.jogadores),s(4),d("disabled",i.processando),s(),d("ngIf",!i.processando),s(),d("ngIf",i.processando),s(),d("imagem",i.imagemSelecionada)("aberto",i.modalAbertoImagem))},dependencies:[R,L,N,U,K,G,H,B,q,W,J,Q],styles:[".anotacoes-wrapper[_ngcontent-%COMP%]{display:flex;justify-content:center}.anotacoes-container[_ngcontent-%COMP%]{width:100%;max-width:900px}.search-bar[_ngcontent-%COMP%]{background:#1e1e1e;color:#fff;border:1px solid #444}.search-bar[_ngcontent-%COMP%]:focus{outline:none;border-color:#0d6efd;box-shadow:0 0 0 .2rem #0d6efd40}.btn-categoria[_ngcontent-%COMP%]{background:#2a2a2a;color:#f8f9fa;font-weight:600;border-radius:8px;padding:.6rem 1rem;text-align:left}.btn-categoria[_ngcontent-%COMP%]:hover{background:#343a40;color:#fff}.anotacao-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:10px;transition:transform .15s ease;color:#f1f1f1}.anotacao-card[_ngcontent-%COMP%]:hover{transform:scale(1.02);background:#252525}.item-thumb[_ngcontent-%COMP%]{width:50px;height:50px;border-radius:8px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;overflow:hidden}.item-thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.item-thumb[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:1.4rem;color:#bbb}.anotacao-card[_ngcontent-%COMP%]   h6[_ngcontent-%COMP%]{color:#fff}.anotacao-card[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{color:#ddd}.anotacao-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#e0e0e0;white-space:pre-line}.fab-stack[_ngcontent-%COMP%]{position:fixed;bottom:70px;right:20px;display:flex;flex-direction:column;gap:15px;z-index:1000}.fab[_ngcontent-%COMP%]{width:60px;height:60px;border-radius:50%;font-size:1.6rem;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px #0006;border:none;cursor:pointer;transition:transform .2s ease}.fab[_ngcontent-%COMP%]:hover{transform:scale(1.08)}.fab-primary[_ngcontent-%COMP%]{background:#0d6efd;color:#fff}.fab-primary[_ngcontent-%COMP%]:hover{background:#0b5ed7}.modal-content[_ngcontent-%COMP%]{border-radius:12px}.modal-backdrop-blur[_ngcontent-%COMP%]{background-color:#0009;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}.descricao-text[_ngcontent-%COMP%]{white-space:pre-line}"]})};export{Y as Anotacoes};
