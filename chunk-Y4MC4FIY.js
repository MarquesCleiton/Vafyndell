import{a as p,b as n}from"./chunk-UM5RQUOR.js";import{a as c,ac as d,b as r,d as a}from"./chunk-Y44Y2XZC.js";var N=class{static TAB="Npcs";static STORE=this.TAB;static META_STORE="metadados";static FOLDER_ID="1zId11Ydti8d0FOQoQjd9lQmPo6GiJx26";static dbPromise=null;static getDb(){return a(this,null,function*(){return this.dbPromise||(console.log("[NpcRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=p.create()),this.dbPromise})}static createNpc(t){return a(this,null,function*(){console.log("[NpcRepository] Criando novo NPC...",t);let o=yield n.controllerCreate({tab:this.TAB,attrs:t,folderId:this.FOLDER_ID}),i=r(c({},o),{id:Number(o?.id)||Date.now(),index:o?.index});return yield(yield this.getDb()).put(this.STORE,i),console.log("[NpcRepository] NPC criado e salvo no cache:",i),i})}static updateNpc(t){return a(this,null,function*(){console.log("[NpcRepository] Atualizando NPC...",t);let o=yield n.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t,folderId:this.FOLDER_ID}),i=r(c(c({},t),o),{id:Number(o?.id||t.id),index:o?.index||t.index});return yield(yield this.getDb()).put(this.STORE,i),console.log("[NpcRepository] NPC atualizado no cache local:",i),i})}static deleteNpc(t){return a(this,null,function*(){console.log("[NpcRepository] Deletando NPC...",t);let o=yield this.getDb(),i=yield o.get(this.STORE,t);return i?(yield n.controllerDeleteByIndex({tab:this.TAB,index:i.index}),yield o.delete(this.STORE,t),console.log("[NpcRepository] NPC exclu\xEDdo do cache/local:",t),!0):(console.warn("[NpcRepository] NPC n\xE3o encontrado no cache:",t),!1)})}static getAllNpcs(){return a(this,null,function*(){console.log("[NpcRepository] getAllNpcs...");let t=yield n.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t.map(o=>r(c({},o),{id:Number(o.id),index:o.index})):[]})}static getLocalNpcs(){return a(this,null,function*(){let o=yield(yield this.getDb()).getAll(this.STORE);return console.log("[NpcRepository] getLocalNpcs \u2192 total encontrados:",o.length),o})}static forceFetchNpcs(){return a(this,null,function*(){if(!d.getUser())throw new Error("Usu\xE1rio n\xE3o autenticado.");console.log("[NpcRepository] Baixando lista online...");let o=yield this.getAllNpcs();if(!o.length)return console.warn("[NpcRepository] Nenhum NPC encontrado online."),[];let i=o.map(e=>r(c({},e),{id:Number(e.id),index:e.index})),s=yield this.getDb();yield s.clear(this.STORE),yield s.bulkPut(this.STORE,i),console.log("[NpcRepository] Cache atualizado com lista online.");let l=yield n.controllerGetAll({tab:"Metadados"});if(Array.isArray(l)){let e=l.find(m=>m.SheetName===this.TAB);e&&(yield s.put(this.META_STORE,{id:this.TAB,UltimaModificacao:e.UltimaModificacao}),console.log("[NpcRepository] Metadados locais atualizados:",e))}return i})}static syncNpcs(){return a(this,null,function*(){console.log("[NpcRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let t=yield n.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let o=t.find(e=>e.SheetName===this.TAB);if(!o)return console.warn("[NpcRepository] Nenhum metadado online encontrado."),!1;let s=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!s||s.UltimaModificacao!==o.UltimaModificacao?(console.log("[NpcRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchNpcs(),!0):(console.log("[NpcRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}};export{N as a};
