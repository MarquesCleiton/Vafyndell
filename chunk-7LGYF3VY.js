import{a as l}from"./chunk-32DTNYXP.js";import{a as g,b as u,d as n}from"./chunk-CJJCGQOG.js";var h=class m{DB_NAME="VafyndellDB";DB_VERSION=1;db=null;storeNames=new Set;static create(){return n(this,null,function*(){let t=new m;return yield t.init(),t})}constructor(){console.log("[IndexedDBClient] Constructor chamado")}init(){return n(this,null,function*(){if(this.db){console.log("[IndexedDBClient] Banco j\xE1 inicializado.");return}let o=(yield indexedDB.databases?.())?.find(e=>e.name===this.DB_NAME);return o?.version&&o.version>this.DB_VERSION&&(this.DB_VERSION=o.version,console.log(`[IndexedDBClient] Ajustando vers\xE3o para ${this.DB_VERSION}`)),new Promise((e,a)=>{console.log(`[IndexedDBClient] Abrindo banco ${this.DB_NAME} v${this.DB_VERSION}...`);let r=indexedDB.open(this.DB_NAME,this.DB_VERSION);r.onerror=()=>a(r.error),r.onsuccess=()=>{this.db=r.result,this.storeNames=new Set(Array.from(this.db.objectStoreNames)),console.log("[IndexedDBClient] Banco aberto com stores:",Array.from(this.storeNames)),e()},r.onupgradeneeded=i=>{let s=i.target.result;console.log("[IndexedDBClient] Upgrade do banco. Stores existentes:",Array.from(s.objectStoreNames))}})})}ensureStore(t){return n(this,null,function*(){if(this.storeNames.has(t))return;console.log(`[IndexedDBClient] Store "${t}" n\xE3o existe \u2192 recriando DB...`),this.db?.close();let a=(yield indexedDB.databases?.())?.find(r=>r.name===this.DB_NAME)?.version??this.DB_VERSION;return this.DB_VERSION=Math.max(this.DB_VERSION,a)+1,new Promise((r,i)=>{let s=indexedDB.open(this.DB_NAME,this.DB_VERSION);s.onerror=()=>i(s.error),s.onupgradeneeded=d=>{let y=d.target.result;y.objectStoreNames.contains(t)||(y.createObjectStore(t,{keyPath:"id"}),console.log(`[IndexedDBClient] Store criada: ${t}`))},s.onsuccess=()=>{this.db=s.result,this.storeNames=new Set(Array.from(this.db.objectStoreNames)),console.log("[IndexedDBClient] Banco reaberto com stores:",Array.from(this.storeNames)),r()}})})}put(t,o){return n(this,null,function*(){return yield this.ensureStore(t),new Promise((e,a)=>{let r=this.db.transaction(t,"readwrite");r.objectStore(t).put(o),r.oncomplete=()=>e(),r.onerror=()=>a(r.error)})})}bulkPut(t,o){return n(this,null,function*(){return yield this.ensureStore(t),new Promise((e,a)=>{let r=this.db.transaction(t,"readwrite"),i=r.objectStore(t);o.forEach(s=>i.put(s)),r.oncomplete=()=>e(),r.onerror=()=>a(r.error)})})}get(t,o){return n(this,null,function*(){return this.storeNames.has(t)?new Promise((e,a)=>{let i=this.db.transaction(t,"readonly").objectStore(t).get(o);i.onsuccess=()=>e(i.result||null),i.onerror=()=>a(i.error)}):null})}getAll(t){return n(this,null,function*(){return this.storeNames.has(t)?new Promise((o,e)=>{let r=this.db.transaction(t,"readonly").objectStore(t).getAll();r.onsuccess=()=>o(r.result),r.onerror=()=>e(r.error)}):[]})}delete(t,o){return n(this,null,function*(){if(this.storeNames.has(t))return new Promise((e,a)=>{let r=this.db.transaction(t,"readwrite");r.objectStore(t).delete(o),r.oncomplete=()=>e(),r.onerror=()=>a(r.error)})})}clear(t){return n(this,null,function*(){if(this.storeNames.has(t))return new Promise((o,e)=>{let a=this.db.transaction(t,"readwrite");a.objectStore(t).clear(),a.oncomplete=()=>o(),a.onerror=()=>e(a.error)})})}deleteDatabase(){return n(this,null,function*(){return console.log("[IndexedDBClient] deleteDatabase \u2192 resetando banco..."),this.db&&(this.db.close(),this.db=null),new Promise((t,o)=>{let e=indexedDB.deleteDatabase(this.DB_NAME);e.onsuccess=()=>{this.storeNames.clear(),this.DB_VERSION=1,console.log("[IndexedDBClient] Banco deletado com sucesso."),t()},e.onerror=()=>o(e.error)})})}};var c=class{static ENDPOINT="https://script.google.com/macros/s/AKfycby-ec_h6sljntLAgoWhpeyBFGTkWygqS7Xx1Yvkx8RKDKiXDHPxtHZ8hhh6vrN91JEL/exec";static SHEET_ID="19B2aMGrajvhPJfOvYXt059-fECytaN38iFsP8GInD_g";static call(t,o,e=!0){return n(this,null,function*(){let a=l.getIdToken();if(!a||!l.isAuthenticated()){let d=yield l.refreshIdToken();if(!d)throw new Error("Usu\xE1rio precisa fazer login novamente.");a=d.idToken}let r={idToken:a,action:t,payload:u(g({},o),{sheetId:this.SHEET_ID})};console.log("\u27A1\uFE0F Enviando para Script:",this.ENDPOINT,r);let i=yield fetch(this.ENDPOINT,{method:"POST",body:JSON.stringify(r)}),s=yield i.text();if(!i.ok){if(console.error("\u274C Erro bruto do Script:",s),i.status===401&&e){if(console.warn("[ScriptClient] Token inv\xE1lido, tentando renovar..."),!(yield l.refreshIdToken()))throw new Error("Usu\xE1rio precisa se autenticar novamente.");return this.call(t,o,!1)}throw new Error(`Erro no Script: ${i.status} - ${i.statusText}
${s}`)}try{return JSON.parse(s)}catch(d){throw console.error("\u274C Resposta n\xE3o-JSON:",s),d}})}static createRow(t){return this.call("sheet.createRow",t)}static getAll(t){return this.call("sheet.getAll",t)}static getByIndex(t){return this.call("sheet.getByIndex",t)}static getCell(t){return this.call("sheet.getCell",t)}static updateByIndex(t){return this.call("sheet.updateByIndex",t)}static updateCell(t){return this.call("sheet.updateCell",t)}static deleteByIndex(t){return this.call("sheet.deleteByIndex",t)}static upload(t){return this.call("drive.upload",t)}static update(t){return this.call("drive.update",t)}static remove(t){return this.call("drive.delete",t)}static controllerCreate(t){return this.call("controller.create",t)}static controllerGetAll(t){return this.call("controller.getAll",t)}static controllerGetByIndex(t){return this.call("controller.getByIndex",t)}static controllerGetCell(t){return this.call("controller.getCell",t)}static controllerUpdateByIndex(t){return this.call("controller.updateByIndex",t)}static controllerUpdateCell(t){return this.call("controller.updateCell",t)}static controllerDeleteByIndex(t){return this.call("controller.deleteByIndex",t)}};var b=class{static TAB="Personagem";static STORE=this.TAB;static META_STORE="metadados";static FOLDER_ID="1zId11Ydti8d0FOQoQjd9lQmPo6GiJx26";static dbPromise=null;static getDb(){return n(this,null,function*(){return this.dbPromise||(console.log("[JogadorRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=h.create()),this.dbPromise})}static createJogador(t){return n(this,null,function*(){console.log("[JogadorRepository] Criando novo jogador...",t);let o=yield c.controllerCreate({tab:this.TAB,attrs:t,folderId:this.FOLDER_ID}),e=u(g({},o),{id:o?.index||Date.now()});return yield(yield this.getDb()).put(this.STORE,e),console.log("[JogadorRepository] Jogador criado e salvo no cache:",e),e})}static updateJogador(t){return n(this,null,function*(){console.log("[JogadorRepository] Atualizando jogador...",t);let o=yield c.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t,folderId:this.FOLDER_ID}),e=g(g({},t),o);return yield(yield this.getDb()).put(this.STORE,e),console.log("[JogadorRepository] Jogador atualizado no cache local:",e),e})}static getAllJogadores(){return n(this,null,function*(){console.log("[JogadorRepository] getAllJogadores...");let t=yield c.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t:[]})}static getLocalJogador(){return n(this,null,function*(){let t=l.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");let e=yield(yield this.getDb()).getAll(this.STORE);return console.log("[JogadorRepository] getLocalJogador \u2192 total encontrados:",e.length),e.find(a=>a.email===t.email)||null})}static forceFetchJogador(){return n(this,null,function*(){let t=l.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");console.log("[JogadorRepository] Baixando lista online...");let o=yield this.getAllJogadores();if(!o.length)return console.warn("[JogadorRepository] Nenhum jogador encontrado online."),null;let e=o.map(i=>u(g({},i),{id:i.index})),a=yield this.getDb();yield a.clear(this.STORE),yield a.bulkPut(this.STORE,e),console.log("[JogadorRepository] Cache atualizado com lista online.");let r=yield c.controllerGetAll({tab:"Metadados"});if(Array.isArray(r)){let i=r.find(s=>s.SheetName===this.TAB);i&&(yield a.put(this.META_STORE,{id:this.TAB,UltimaModificacao:i.UltimaModificacao}),console.log("[JogadorRepository] Metadados locais atualizados:",i))}return e.find(i=>i.email===t.email)||null})}static syncJogadores(){return n(this,null,function*(){console.log("[JogadorRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let t=yield c.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let o=t.find(i=>i.SheetName===this.TAB);if(!o)return console.warn("[JogadorRepository] Nenhum metadado online encontrado."),!1;let a=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!a||a.UltimaModificacao!==o.UltimaModificacao?(console.log("[JogadorRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchJogador(),!0):(console.log("[JogadorRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}static getCurrentJogador(){return n(this,null,function*(){if(console.log("[JogadorRepository] getCurrentJogador iniciado."),!l.getUser())throw new Error("Usu\xE1rio n\xE3o autenticado.");let o=yield this.getLocalJogador();return o?(this.syncJogadores().then(e=>n(this,null,function*(){e&&(o=yield this.getLocalJogador())})).catch(e=>console.error("[JogadorRepository] Erro ao sincronizar:",e)),o):yield this.forceFetchJogador()})}};export{b as a};
