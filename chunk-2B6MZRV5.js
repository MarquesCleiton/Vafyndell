import{b as K,c as X,f as Y,i as Z,r as ee}from"./chunk-GFP7435U.js";import{a as te,b as E}from"./chunk-H7VFQHUE.js";import{e as B,f as Q,g as G,j as H,s as J,w as P}from"./chunk-WLM7QTUH.js";import{$b as C,Fb as q,Jb as v,Lb as p,Pa as F,Qa as o,Va as D,Xb as w,Yb as U,Zb as d,_ as L,_b as I,a as O,ab as V,ac as $,b as y,cc as A,d as _,dc as T,ec as z,fb as g,fc as j,gc as N,ia as S,ja as M,jc as W,wb as l,xb as c,yb as s,zb as h}from"./chunk-QQSIVCMV.js";var R=class n{catalogoRepo=new E("Catalogo","Catalogo");inventarioRepo=new E("Inventario","Inventario");receitasRepo=new E("Receitas","Receitas");getPossiveisReceitas(){return _(this,null,function*(){let t=P.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");let e=yield this.catalogoRepo.getLocal(),i=(yield this.inventarioRepo.getLocal()).filter(x=>x.jogador===t.email),a=yield this.receitasRepo.getLocal();if(e.length&&i.length&&a.length)return this.sincronizarMulti(t.email).catch(x=>console.error("[OficinaService] Erro ao sincronizar:",x)),this.processar(e,a,i);let r=yield this.catalogoRepo.getAllMulti(["Catalogo","Receitas","Inventario"]),m=r.Catalogo,f=r.Receitas,b=r.Inventario.filter(x=>x.jogador===t.email);return yield Promise.all([this.catalogoRepo.bulkPutLocal(m),this.inventarioRepo.bulkPutLocal(b),this.receitasRepo.bulkPutLocal(f)]),this.processar(m,f,b)})}sincronizarMulti(t){return _(this,null,function*(){let[e,i,a]=yield Promise.all([this.catalogoRepo.sync(),this.inventarioRepo.sync(),this.receitasRepo.sync()]);console.log(e||i||a?"[OficinaService] Alguma tabela foi atualizada \u2192 dados locais recarregados":"[OficinaService] Nenhuma altera\xE7\xE3o nas tabelas.")})}processar(t,e,i){let a=new Map;i.forEach(m=>{let f=String(m.item_catalogo),b=a.get(f)||0;a.set(f,b+(m.quantidade||0))}),console.log("[OficinaService] Estoque calculado:",Array.from(a.entries()));let r=t.filter(m=>e.some(f=>String(f.fabricavel)===String(m.id)));return console.log("[OficinaService] Fabric\xE1veis encontrados:",r.length),r.map(m=>{let f=e.filter(u=>String(u.fabricavel)===String(m.id)).map(u=>{let ne=a.get(String(u.catalogo))||0,k=t.find(ae=>String(ae.id)===String(u.catalogo));return k||console.warn("[OficinaService] \u2757 Ingrediente n\xE3o encontrado no cat\xE1logo:",u.catalogo),y(O({},u),{quantidadeInventario:ne,nome:k?.nome,imagem:k?.imagem})}),b=f.every(u=>u.quantidadeInventario>=u.quantidade);return f.some(u=>u.quantidadeInventario>0)?y(O({},m),{fabricavel:b,ingredientes:f}):null}).filter(m=>m!==null)}criarItem(t){return _(this,null,function*(){let e=P.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");for(let i of t.ingredientes)yield this.subtrairQuantidade(e.email,i.catalogo,i.quantidade);yield this.adicionarOuIncrementar(e.email,t.id,1),console.log(`[OficinaService] Item criado: ${t.nome}`)})}forcarFalha(t){return _(this,null,function*(){let e=P.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");for(let i of t.ingredientes)yield this.subtrairQuantidade(e.email,i.catalogo,i.quantidade);console.log(`[OficinaService] Falha for\xE7ada: ${t.nome}`)})}subtrairQuantidade(t,e,i){return _(this,null,function*(){let r=(yield this.inventarioRepo.getLocal()).filter(m=>m.jogador===t).find(m=>m.item_catalogo===e);r&&(r.quantidade=Math.max(0,(r.quantidade||0)-i),r.quantidade===0?yield this.inventarioRepo.delete(r.index):yield this.inventarioRepo.update(r))})}adicionarOuIncrementar(t,e,i){return _(this,null,function*(){let a=(yield this.inventarioRepo.getLocal()).filter(m=>m.jogador===t),r=a.find(m=>m.item_catalogo===e);r?(r.quantidade+=i,yield this.inventarioRepo.update(r)):yield this.inventarioRepo.create({id:te.generateULID(),index:a.length+1,jogador:t,item_catalogo:e,quantidade:i})})}static \u0275fac=function(e){return new(e||n)};static \u0275prov=L({token:n,factory:n.\u0275fac,providedIn:"root"})};var ce=(n,t)=>({ok:n,fail:t});function se(n,t){if(n&1&&(c(0,"div",17),d(1),s()),n&2){let e=p();l("ngClass",e.mensagemTipo==="sucesso"?"bg-success text-white":"bg-danger text-white"),o(),C(" ",e.mensagem," ")}}function le(n,t){n&1&&(c(0,"div",18),h(1,"div",19),c(2,"p",20),d(3,"Carregando receitas..."),s()())}function de(n,t){n&1&&(c(0,"div",21),d(1," Nenhum item encontrado. "),s())}function me(n,t){if(n&1&&h(0,"img",38),n&2){let e=p().$implicit;l("alt",j(e.nome))("src",e.imagem,F)}}function pe(n,t){n&1&&(c(0,"span"),d(1,"\u2692\uFE0F"),s())}function ge(n,t){if(n&1&&(c(0,"p",39),d(1),s()),n&2){let e=p().$implicit;o(),C("\u2728 ",e.efeito)}}function fe(n,t){if(n&1&&(c(0,"p",40),d(1),s()),n&2){let e=p().$implicit;o(),C("\u26A0\uFE0F ",e.colateral)}}function ue(n,t){if(n&1&&h(0,"img",38),n&2){let e=p().$implicit;l("alt",j(e.nome))("src",e.imagem,F)}}function _e(n,t){n&1&&(c(0,"span"),d(1,"\u{1F9EA}"),s())}function ve(n,t){if(n&1&&(c(0,"div",43)(1,"div",44),g(2,ue,1,3,"img",32)(3,_e,2,0,"span",16),s(),c(4,"div",45)(5,"span",46),d(6),s()(),c(7,"span",47),d(8),s()()),n&2){let e=t.$implicit;l("ngClass",W(6,ce,e.quantidadeInventario>=e.quantidade,e.quantidadeInventario<e.quantidade)),o(2),l("ngIf",e.imagem),o(),l("ngIf",!e.imagem),o(3),I(e.nome),o(2),$(" ",e.quantidadeInventario,"/",e.quantidade," ")}}function be(n,t){if(n&1&&(c(0,"div",41),g(1,ve,9,9,"div",42),s()),n&2){let e=p().$implicit;o(),l("ngForOf",e.ingredientes)}}function xe(n,t){n&1&&h(0,"span",52)}function he(n,t){n&1&&(c(0,"span"),d(1,"\u{1F6E0}\uFE0F"),s())}function Ce(n,t){n&1&&h(0,"span",52)}function Oe(n,t){n&1&&(c(0,"span"),d(1,"\u{1F9E8}"),s())}function ye(n,t){if(n&1){let e=q();c(0,"div",48)(1,"button",49),v("click",function(){S(e);let a=p().$implicit,r=p(4);return M(r.criarItem(a))}),g(2,xe,1,0,"span",50)(3,he,2,0,"span",16),s(),c(4,"button",51),v("click",function(){S(e);let a=p().$implicit,r=p(4);return M(r.forcarFalha(a))}),g(5,Ce,1,0,"span",50)(6,Oe,2,0,"span",16),s()()}if(n&2){let e=p().$implicit,i=p(4);o(),l("disabled",i.loadingAction[e.id]),o(),l("ngIf",i.loadingAction[e.id]==="criar"),o(),l("ngIf",i.loadingAction[e.id]!=="criar"),o(),l("disabled",i.loadingAction[e.id]),o(),l("ngIf",i.loadingAction[e.id]==="falha"),o(),l("ngIf",i.loadingAction[e.id]!=="falha")}}function we(n,t){if(n&1&&(c(0,"div",28)(1,"small",29),d(2),s(),c(3,"div",30)(4,"div",31),g(5,me,1,3,"img",32)(6,pe,2,0,"span",16),s(),c(7,"div")(8,"h6",33),d(9),s(),c(10,"small"),d(11),s()()(),g(12,ge,2,1,"p",34)(13,fe,2,1,"p",35)(14,be,2,1,"div",36)(15,ye,7,6,"div",37),s()),n&2){let e=t.$implicit,i=p(4);o(),l("ngClass",e.fabricavel?"status-ok":"status-off"),o(),C(" ",e.fabricavel?"\u2714 Dispon.":"\u2716 Indisp."," "),o(3),l("ngIf",e.imagem),o(),l("ngIf",!e.imagem),o(3),I(e.nome),o(),U(N("raridade ",i.getRaridadeClass(e.raridade))),o(),C(" ",e.raridade||"Comum"," "),o(),l("ngIf",e.efeito),o(),l("ngIf",e.colateral),o(),l("ngIf",e.ingredientes==null?null:e.ingredientes.length),o(),l("ngIf",e.fabricavel)}}function Ie(n,t){if(n&1&&(c(0,"div",26),g(1,we,16,13,"div",27),s()),n&2){let e=p().$implicit;o(),l("ngForOf",e.itens)}}function Se(n,t){if(n&1){let e=q();c(0,"div",23)(1,"button",24),v("click",function(){let a=S(e).$implicit,r=p(2);return M(r.toggleCategoria(a))}),c(2,"span"),d(3),s(),c(4,"span"),d(5),s()(),g(6,Ie,2,1,"div",25),s()}if(n&2){let e=t.$implicit,i=p(2);l("hidden",!i.pertenceAba(e.nome)),o(3),I(e.nome||"Outros"),o(2),I(e.expandido?"\u2212":"+"),o(),l("ngIf",e.expandido)}}function Me(n,t){if(n&1&&(c(0,"div"),g(1,Se,7,4,"div",22),s()),n&2){let e=p();o(),l("ngForOf",e.categoriasFiltradas)}}var ie=class n{constructor(t,e){this.router=t;this.oficinaService=e}categorias=[];categoriasFiltradas=[];carregando=!0;filtro="";fabricaveisOnly=!1;abaAtiva="recursos";loadingAction={};mensagem=null;mensagemTipo=null;todasReceitas=[];mapaAbas={recursos:["Recursos bot\xE2nicos","Mineral","Componentes bestiais e animalescos","Tesouro","Moeda"],equipamentos:["Equipamento","Ferramentas","Utilit\xE1rio \u2013 Bombas, armadilhas, luz, som, g\xE1s, adesivos"],pocoes:["Po\xE7\xE3o de Cura \u2013 Regenera vida, cicatriza feridas","Po\xE7\xE3o Mental \u2013 Calmante, foco, mem\xF3ria, sono, esquecimento","Po\xE7\xE3o de Aprimoramento F\xEDsico \u2013 For\xE7a, resist\xEAncia, agilidade","Po\xE7\xE3o Sensorial \u2013 Vis\xE3o, audi\xE7\xE3o, percep\xE7\xE3o, voz, respira\xE7\xE3o","Po\xE7\xE3o de Furtividade \u2013 Camuflagem, passos suaves, sil\xEAncio","Po\xE7\xE3o de Energia \u2013 Percep\xE7\xE3o da energia fundamental","Veneno \u2013 Sonol\xEAncia, confus\xE3o ou morte"],outros:["Outros"]};ngOnInit(){return _(this,null,function*(){try{this.carregando=!0,this.todasReceitas=yield this.oficinaService.getPossiveisReceitas(),this.processarItens(this.todasReceitas)}catch(t){console.error("[Oficina] Erro ao carregar receitas:",t)}finally{this.carregando=!1}})}processarItens(t){let e=new Map(this.categorias.map(a=>[a.nome,a.expandido])),i=new Map;t.forEach(a=>{let r=a.categoria||"Outros";i.has(r)||i.set(r,[]),i.get(r).push(a)}),this.categorias=Array.from(i.entries()).sort(([a],[r])=>a.localeCompare(r)).map(([a,r])=>({nome:a,itens:r,expandido:e.get(a)??!1})),this.categoriasFiltradas=[...this.categorias]}aplicarFiltro(){let t=this.normalize(this.filtro);if(!t&&!this.fabricaveisOnly){this.categoriasFiltradas=[...this.categorias];return}this.categoriasFiltradas=this.categorias.map(e=>{let i=e.itens.filter(a=>(!this.fabricaveisOnly||a.fabricavel)&&(this.normalize(a.nome).includes(t)||this.normalize(a.raridade).includes(t)||this.normalize(a.efeito).includes(t)||this.normalize(a.descricao).includes(t)));return y(O({},e),{itens:i,expandido:i.length>0})}).filter(e=>e.itens.length>0)}normalize(t=""){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}selecionarAba(t){this.abaAtiva=t}pertenceAba(t){return this.mapaAbas[this.abaAtiva].includes(t)}toggleCategoria(t){t.expandido=!t.expandido}getRaridadeClass(t){return t?t.toLowerCase():"comum"}criarItem(t){return _(this,null,function*(){})}forcarFalha(t){return _(this,null,function*(){})}static \u0275fac=function(e){return new(e||n)(D(J),D(R))};static \u0275cmp=V({type:n,selectors:[["app-oficina"]],decls:29,vars:14,consts:[[1,"oficina-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light"],["class","toast-feedback position-fixed bottom-0 end-0 m-3",3,"ngClass",4,"ngIf"],[1,"p-3","top-bar","position-sticky","top-0",2,"z-index","10"],[1,"d-flex","align-items-center","gap-2"],["type","text","placeholder","\u{1F50D} Procurar receitas...",1,"form-control","search-input","rounded-pill","px-3",3,"ngModelChange","input","ngModel"],[1,"form-check","ms-2"],["type","checkbox","id","fabricaveisOnly",1,"form-check-input",3,"ngModelChange","change","ngModel"],["for","fabricaveisOnly",1,"form-check-label","small","text-light"],[1,"nav","nav-tabs","mt-2"],[1,"nav-item"],[1,"nav-link",3,"click"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"oficina-container","w-100"],[1,"fw-bold","mb-3","title"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[1,"toast-feedback","position-fixed","bottom-0","end-0","m-3",3,"ngClass"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",3,"hidden",4,"ngFor","ngForOf"],[1,"mb-3",3,"hidden"],[1,"categoria-btn",3,"click"],["class","mt-2 d-flex flex-column gap-3",4,"ngIf"],[1,"mt-2","d-flex","flex-column","gap-3"],["class","receita-card",4,"ngFor","ngForOf"],[1,"receita-card"],[1,"status-indicador",3,"ngClass"],[1,"d-flex","align-items-center","mb-2"],[1,"thumb"],[3,"src","alt",4,"ngIf"],[1,"fw-bold","text-white","mb-1"],["class","small text-info mb-1",4,"ngIf"],["class","small text-danger mb-2",4,"ngIf"],["class","ingredientes-grid",4,"ngIf"],["class","acoes-bottom",4,"ngIf"],[3,"src","alt"],[1,"small","text-info","mb-1"],[1,"small","text-danger","mb-2"],[1,"ingredientes-grid"],["class","ingrediente-pill",3,"ngClass",4,"ngFor","ngForOf"],[1,"ingrediente-pill",3,"ngClass"],[1,"ingrediente-thumb"],[1,"flex-grow-1"],[1,"small"],[1,"small","fw-bold"],[1,"acoes-bottom"],[1,"btn-square","success",3,"click","disabled"],["class","spinner-border spinner-border-sm",4,"ngIf"],[1,"btn-square","danger",3,"click","disabled"],[1,"spinner-border","spinner-border-sm"]],template:function(e,i){e&1&&(c(0,"div",0),g(1,se,2,2,"div",1),c(2,"div",2)(3,"div",3)(4,"input",4),z("ngModelChange",function(r){return T(i.filtro,r)||(i.filtro=r),r}),v("input",function(){return i.aplicarFiltro()}),s(),c(5,"div",5)(6,"input",6),z("ngModelChange",function(r){return T(i.fabricaveisOnly,r)||(i.fabricaveisOnly=r),r}),v("change",function(){return i.aplicarFiltro()}),s(),c(7,"label",7),d(8," Apenas fabric\xE1veis "),s()()(),c(9,"ul",8)(10,"li",9)(11,"button",10),v("click",function(){return i.selecionarAba("recursos")}),d(12,"\u{1F33F} Recursos"),s()(),c(13,"li",9)(14,"button",10),v("click",function(){return i.selecionarAba("equipamentos")}),d(15,"\u2694\uFE0F Equipamentos"),s()(),c(16,"li",9)(17,"button",10),v("click",function(){return i.selecionarAba("pocoes")}),d(18,"\u{1F9EA} Po\xE7\xF5es"),s()(),c(19,"li",9)(20,"button",10),v("click",function(){return i.selecionarAba("outros")}),d(21,"\u{1F4E6} Outros"),s()()()(),c(22,"div",11)(23,"div",12)(24,"h4",13),d(25,"\u2692\uFE0F Oficina"),s(),g(26,le,4,0,"div",14)(27,de,2,0,"div",15)(28,Me,2,1,"div",16),s()()()),e&2&&(o(),l("ngIf",i.mensagem),o(3),A("ngModel",i.filtro),o(2),A("ngModel",i.fabricaveisOnly),o(5),w("active",i.abaAtiva==="recursos"),o(3),w("active",i.abaAtiva==="equipamentos"),o(3),w("active",i.abaAtiva==="pocoes"),o(3),w("active",i.abaAtiva==="outros"),o(6),l("ngIf",i.carregando),o(),l("ngIf",!i.carregando&&i.categoriasFiltradas.length===0),o(),l("ngIf",!i.carregando))},dependencies:[H,B,Q,G,ee,X,K,Y,Z],styles:[".oficina-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:center}.oficina-container[_ngcontent-%COMP%]{width:100%;max-width:900px;margin:0 auto}.toast-feedback[_ngcontent-%COMP%]{padding:10px 16px;border-radius:8px;font-weight:500;box-shadow:0 4px 12px #0006}.search-input[_ngcontent-%COMP%]{background:#1e1e1e!important;border:1px solid #444!important;color:#f8f9fa!important}.search-input[_ngcontent-%COMP%]:focus{border-color:#0d6efd!important;box-shadow:0 0 0 .2rem #0d6efd40!important;outline:none!important}.nav-tabs[_ngcontent-%COMP%]{display:flex;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;border-bottom:1px solid #444;scrollbar-width:none}.nav-tabs[_ngcontent-%COMP%]::-webkit-scrollbar{display:none}.nav-tabs[_ngcontent-%COMP%]   .nav-item[_ngcontent-%COMP%]{flex:1 0 auto;text-align:center}.nav-tabs[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]{color:#aaa;background:transparent;border:none;font-weight:600;padding:.5rem .8rem;display:flex;align-items:center;gap:6px;white-space:nowrap}.nav-tabs[_ngcontent-%COMP%]   .nav-link.active[_ngcontent-%COMP%]{color:#fff;background:#2a2a2a;border-radius:8px 8px 0 0}.title[_ngcontent-%COMP%]{color:#f8f9fa}.categoria-btn[_ngcontent-%COMP%]{width:100%;background:#2a2a2a;border:none;border-radius:8px;padding:10px 14px;font-weight:600;color:#f8f9fa;display:flex;justify-content:space-between;align-items:center;transition:background .2s ease}.categoria-btn[_ngcontent-%COMP%]:hover{background:#343a40;color:#fff}.receita-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:10px;padding:14px;position:relative;box-shadow:0 2px 6px #0006;transition:transform .15s ease;color:#f1f1f1}.receita-card[_ngcontent-%COMP%]:hover{transform:scale(1.02);background:#252525}.status-indicador[_ngcontent-%COMP%]{position:absolute;top:8px;right:12px;font-size:.8rem;font-weight:600}.status-ok[_ngcontent-%COMP%]{color:#28a745}.status-off[_ngcontent-%COMP%]{color:#dc3545}.thumb[_ngcontent-%COMP%]{width:55px;height:55px;border-radius:8px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-right:10px}.thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.ingredientes-grid[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:6px}.ingrediente-pill[_ngcontent-%COMP%]{background:#2a2a2a;border-radius:8px;padding:6px 10px;display:flex;align-items:center;gap:8px}.ingrediente-pill.ok[_ngcontent-%COMP%]{border:1px solid #28a745}.ingrediente-pill.fail[_ngcontent-%COMP%]{border:1px solid #dc3545}.ingrediente-thumb[_ngcontent-%COMP%]{width:28px;height:28px;border-radius:6px;background:#1e1e1e;display:flex;align-items:center;justify-content:center;overflow:hidden}.ingrediente-thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.acoes-bottom[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}.btn-square[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;border:none;transition:transform .2s ease}.btn-square[_ngcontent-%COMP%]:hover{transform:scale(1.08)}.btn-square.success[_ngcontent-%COMP%]{background:#198754;color:#fff}.btn-square.success[_ngcontent-%COMP%]:hover{background:#157347}.btn-square.danger[_ngcontent-%COMP%]{background:#dc3545;color:#fff}.btn-square.danger[_ngcontent-%COMP%]:hover{background:#bb2d3b}.raridade[_ngcontent-%COMP%]{font-weight:700;font-size:.85rem}.raridade.comum[_ngcontent-%COMP%]{color:#ccc}.raridade.incomum[_ngcontent-%COMP%]{color:#00bcd4}.raridade.raro[_ngcontent-%COMP%]{color:#673ab7}.raridade.epico[_ngcontent-%COMP%]{color:#9c27b0}.raridade.lendario[_ngcontent-%COMP%]{color:gold}@media (min-width: 992px){.oficina-container[_ngcontent-%COMP%]{padding:0 2rem}.receita-card[_ngcontent-%COMP%]{border-radius:16px}}"]})};export{ie as Oficina};
