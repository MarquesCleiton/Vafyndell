import{a as he,d as xe,e as be,h as ve,o as we,p as Ie,q as De,r as Me,u as Ce,v as Te}from"./chunk-WEU74DFO.js";import{A as oe,B as re,K as de,N as se}from"./chunk-SYZO7BGJ.js";import{a as V}from"./chunk-XQNWO7VY.js";import{c as le,f as ce,i as me,k as ue,p as pe,q as ge,s as fe}from"./chunk-IQUV2DCR.js";import{a as y}from"./chunk-SL4CV3BB.js";import{f as ne,h as ae}from"./chunk-XMJCILQE.js";import{e as Z,h as ee,i as te,p as ie,w as _e}from"./chunk-ZOZAG657.js";import{Ab as p,Bb as r,Cb as o,Db as K,Hb as R,Ib as A,Jb as E,Nb as g,Pb as f,Ua as u,Za as k,Zb as J,a as q,b as S,bc as m,cc as Q,dc as X,eb as H,ec as Y,g as L,gc as D,hc as M,ic as C,jb as v,la as l,ma as c}from"./chunk-YAKM3PEZ.js";function Oe(s,t){if(s&1&&(r(0,"mat-option",27),m(1),o()),s&2){let e=t.$implicit;p("value",e),u(),X(" \u{1F64D} ",e.personagem," ")}}function je(s,t){if(s&1){let e=E();r(0,"div",33)(1,"div",34)(2,"span",35),m(3,"\u{1F4E6}"),o(),r(4,"span",36),m(5),o()(),r(6,"div",37)(7,"button",38),g("click",function(){let i=l(e).$implicit,a=f(2);return i.quantidade=a.ajustarQuantidadeMin(i.quantidade-1,1),c(a.atualizarQuantidade(i))}),m(8,"\u2212"),o(),r(9,"input",39),C("ngModelChange",function(i){let a=l(e).$implicit;return M(a.quantidade,i)||(a.quantidade=i),c(i)}),g("blur",function(){let i=l(e).$implicit,a=f(2);return c(a.atualizarQuantidade(i))}),o(),r(10,"button",38),g("click",function(){let i=l(e).$implicit,a=f(2);return i.quantidade=a.ajustarQuantidadeMax(i.quantidade+1,i.item.quantidade),c(a.atualizarQuantidade(i))}),m(11,"\uFF0B"),o()(),r(12,"button",40),g("click",function(){let i=l(e).index,a=f(2);return c(a.removerItem(i))}),m(13,"\u2716"),o()()}if(s&2){let e=t.$implicit;u(5),Q(e.item.itemDetalhe==null?null:e.item.itemDetalhe.nome),u(4),D("ngModel",e.quantidade),p("max",e.item.quantidade)}}function Pe(s,t){if(s&1&&(r(0,"div",28)(1,"div",29)(2,"h5",30),m(3,"\u{1F9FA} Itens Selecionados"),o(),r(4,"span",31),m(5),o()(),v(6,je,14,3,"div",32),o()),s&2){let e=f();u(5),Q(e.itensTroca.length),u(),p("ngForOf",e.itensTroca)}}function $e(s,t){if(s&1&&(r(0,"mat-option",27)(1,"div",41)(2,"span"),m(3,"\u{1F4E6}"),o(),r(4,"span"),m(5),o()()()),s&2){let e=t.$implicit;p("value",e),u(5),Y("",e.itemDetalhe==null?null:e.itemDetalhe.nome," (x",e.quantidade,")")}}function Fe(s,t){if(s&1){let e=E();r(0,"div",42)(1,"div",43)(2,"button",44),g("click",function(){l(e);let i=f();return c(i.decrementar())}),m(3,"\u2212"),o(),r(4,"input",45),C("ngModelChange",function(i){l(e);let a=f();return M(a.quantidade,i)||(a.quantidade=i),c(i)}),g("input",function(){l(e);let i=f();return i.validarQuantidade(),c(i.filtrarItensInventario())})("blur",function(){l(e);let i=f();return i.validarQuantidade(),c(i.filtrarItensInventario())}),o(),r(5,"button",44),g("click",function(){l(e);let i=f();return c(i.incrementar())}),m(6,"\uFF0B"),o()(),r(7,"button",46),g("click",function(){l(e);let i=f();return c(i.adicionarItem())}),m(8,"\u2795"),o()()}if(s&2){let e=f();u(4),D("ngModel",e.quantidade),p("max",(e.itemSelecionado==null?null:e.itemSelecionado.quantidade)??0)}}function Le(s,t){s&1&&(R(0),m(1,"\u{1F4E4}"),A())}function Re(s,t){s&1&&(R(0),K(1,"span",47),A())}var qe=class s{constructor(t,e,n){this.router=t;this.route=e;this.location=n}jogadores=[];jogadoresFiltrados=[];filtroJogador="";jogadorSelecionado=null;inventario=[];inventarioFiltrado=[];filtroItem="";itemSelecionado=null;quantidade=1;itensTroca=[];processando=!1;emailLogado="";jogadoresRepo=new y("Personagem");inventarioRepo=new y("Inventario");catalogoRepo=new y("Catalogo");descricaoTransferencia="";ngOnInit(){return L(this,null,function*(){let t=_e.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");this.emailLogado=t.email,this.jogadores=(yield this.jogadoresRepo.getLocal()).filter(a=>a.email!==this.emailLogado).filter(a=>a.nome_do_jogador!=="NPC"),this.jogadoresFiltrados=[...this.jogadores];let[e,n]=yield Promise.all([this.inventarioRepo.getLocal(),this.catalogoRepo.getLocal()]);this.inventario=e.filter(a=>a.jogador===this.emailLogado).map(a=>S(q({},a),{itemDetalhe:n.find(d=>String(d.id)===String(a.item_catalogo))})),this.inventarioFiltrado=[...this.inventario];let i=this.route.snapshot.paramMap.get("id");if(i){let a=this.inventario.find(d=>String(d.id)===i);a&&(this.itemSelecionado=a,this.filtroItem=a.itemDetalhe?.nome||"",this.quantidade=1)}})}filtrarJogadores(){let t=this.filtroJogador.toLowerCase().trim();this.jogadoresFiltrados=t?this.jogadores.filter(e=>e.personagem.toLowerCase().includes(t)):[...this.jogadores]}selecionarJogador(t){this.jogadorSelecionado=t,this.filtroJogador=t.personagem}filtrarItensInventario(){let t=this.filtroItem.toLowerCase().trim();this.inventarioFiltrado=this.inventario.map(e=>{let n=this.itensTroca.filter(a=>a.item.id===e.id).reduce((a,d)=>a+d.quantidade,0),i=e.quantidade-n;return i>0?S(q({},e),{quantidade:i}):null}).filter(e=>e!==null).filter(e=>t?e.itemDetalhe?.nome?.toLowerCase().includes(t):!0)}adicionarItem(){if(!this.itemSelecionado)return;let t=this.itensTroca.find(e=>e.item.id===this.itemSelecionado.id);t?t.quantidade=Math.min(t.quantidade+this.quantidade,this.itemSelecionado.quantidade+t.quantidade):this.itensTroca.push({item:this.itemSelecionado,quantidade:this.quantidade}),this.itemSelecionado=null,this.filtroItem="",this.quantidade=1,this.filtrarItensInventario()}selecionarItem(t){this.itemSelecionado=t,this.filtroItem=t.itemDetalhe?.nome||"",this.quantidade=1}incrementar(){if(!this.itemSelecionado)return;let t=this.itemSelecionado.quantidade;this.quantidade=Math.min(this.quantidade+1,t)}decrementar(){this.quantidade=Math.max(1,this.quantidade-1)}validarQuantidade(){if(!this.itemSelecionado)return;let t=this.itemSelecionado.quantidade;this.quantidade>t&&(this.quantidade=t),this.quantidade<1&&(this.quantidade=1)}removerItem(t){this.itensTroca.splice(t,1),this.filtrarItensInventario()}confirmarTroca(){return L(this,null,function*(){if(!this.jogadorSelecionado){alert("\u26A0\uFE0F Selecione um jogador destinat\xE1rio!");return}if(this.itensTroca.length===0){alert("\u26A0\uFE0F Adicione ao menos um item para trocar!");return}this.processando=!0;try{let t=(this.descricaoTransferencia||"").trim(),e=this.jogadorSelecionado.email,n=this.jogadorSelecionado.personagem,a=(yield this.jogadoresRepo.getLocal()).find(w=>w.email===this.emailLogado)?.personagem||"Desconhecido",d=yield this.inventarioRepo.getLocal(),O=[],z=[],W=[],j=[],B=[];for(let w of this.itensTroca){let _=w.item,N=_.itemDetalhe?.nome||"Item desconhecido",T=_.itemDetalhe?.unidade_medida||"unidade",h=w.quantidade;h>_.quantidade&&(h=_.quantidade);let P=_.quantidade,$=P-h,U=`Quantidade: ${P} \u2192 ${$} (-${h} ${T})
Transferido para ${n}`+(t?`
${t}`:""),Ee=_.descricao?`${U}
---
${_.descricao.trim()}`:U,G=S(q({},_),{quantidade:$,descricao:Ee});G.quantidade>0?O.push(G):W.push(_.id);let I=d.find(b=>b.jogador===e&&b.item_catalogo===_.item_catalogo),F=0,x=0;if(I){F=I.quantidade,x=I.quantidade+h;let b=`Quantidade: ${F} \u2192 ${x} (+${h} ${T})
Recebido de ${a}`+(t?`
${t}`:""),Ve=I.descricao?`${b}
---
${I.descricao.trim()}`:b;O.push(S(q({},I),{quantidade:x,descricao:Ve}))}else{x=h;let b=`Quantidade: 0 \u2192 ${x} (+${h} ${T})
Recebido de ${a}`+(t?`
${t}`:"");z.push({id:V.generateULID(),index:Date.now(),jogador:e,item_catalogo:_.item_catalogo,quantidade:x,descricao:b})}j.push(`\u{1F392} ${N}: ${P} \u2192 ${$} (-${h} ${T})`),B.push(`\u{1F392} ${N}: ${F} \u2192 ${x} (+${h} ${T})`)}let Se={id:V.generateULID(),jogador:this.emailLogado,alvo:e,tipo:"transferencia",acao:"envio",detalhes:`\u{1F4E6} ${a} transferiu itens para ${n}
`+j.join(`
`)+(t?`
\u{1F4DD} ${t}`:""),data:new Date().toISOString()},ye={id:V.generateULID(),jogador:e,alvo:this.emailLogado,tipo:"transferencia",acao:"recebimento",detalhes:`\u{1F381} ${n} recebeu itens de ${a}
`+B.join(`
`)+(t?`
\u{1F4DD} ${t}`:""),data:new Date().toISOString()};yield y.batch({updateById:{Inventario:O},create:{Inventario:z,Registro:[Se,ye]},deleteById:{Inventario:W.map(w=>({id:w}))}});let ke=`\u{1F381} Voc\xEA transferiu itens para ${n}
`+j.join(`
`)+(t?`
\u{1F4DD} ${t}`:"");alert(ke),this.cancelar()}catch(t){console.error("[TrocaDeItens] Erro na troca:",t),alert("\u274C Erro ao processar a troca")}finally{this.processando=!1}})}cancelar(){this.location.back()}ajustarQuantidade(t,e){let n=this.itensTroca[t],i=n.item.quantidade,a=Math.min(Math.max(1,n.quantidade+e),i);this.itensTroca[t].quantidade=a}validarQuantidadeTroca(t){let e=this.itensTroca[t],n=e.item.quantidade;e.quantidade>n&&(e.quantidade=n),e.quantidade<1&&(e.quantidade=1)}atualizarDisponiveis(){this.filtrarItensInventario()}ajustarQuantidadeMin(t,e){return Math.max(t,e)}ajustarQuantidadeMax(t,e){return Math.min(t,e??t)}atualizarQuantidade(t){let e=t.item.quantidade;t.quantidade>e&&(t.quantidade=e),t.quantidade<1&&(t.quantidade=1),this.filtrarItensInventario()}static \u0275fac=function(e){return new(e||s)(k(ae),k(ne),k(Z))};static \u0275cmp=H({type:s,selectors:[["app-troca-de-itens"]],decls:37,vars:12,consts:[["autoJog","matAutocomplete"],["autoItem","matAutocomplete"],[1,"troca-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light","pb-5","mb-5"],[1,"flex-grow-1","p-3","d-flex","justify-content-center","pb-5","mb-5"],[1,"troca-container","w-100"],[1,"card","detalhe-card","shadow-lg","border-0"],[1,"card-body","p-3","border-bottom","d-flex","align-items-center","gap-2"],[1,"fw-bold","mb-0","text-light"],[1,"card-body"],[1,"mb-3"],[1,"form-label","text-light"],["appearance","fill",1,"w-100","input-dark","compact-select","dropdown-field"],["type","text","matInput","","placeholder","Selecione ou pesquise...","name","filtroJogador",3,"ngModelChange","input","ngModel","matAutocomplete"],[3,"optionSelected"],["class","bg-dark text-light",3,"value",4,"ngFor","ngForOf"],["class","itens-selecionados",4,"ngIf"],[1,"novo-item","bg-dark","rounded","p-2","mb-3","mt-3"],["appearance","fill",1,"w-100","input-dark","compact-select","dropdown-field","mb-2"],["type","text","matInput","","placeholder","Pesquisar item no invent\xE1rio...","name","filtroItem",3,"ngModelChange","input","ngModel","matAutocomplete"],["mat-icon-button","","matSuffix","","disabled","",1,"dropdown-arrow"],["class","d-flex align-items-center justify-content-between mt-2",4,"ngIf"],[1,"mb-3","mt-3"],["rows","3","name","descricaoTransferencia","placeholder","Ex: Entregue em miss\xE3o, troca amig\xE1vel, ajuda ao grupo...",1,"form-control","input-dark","auto-expand",3,"ngModelChange","ngModel"],[1,"fab-stack"],[1,"fab","fab-success",3,"click","disabled"],[4,"ngIf"],[1,"fab","fab-warning",3,"click"],[1,"bg-dark","text-light",3,"value"],[1,"itens-selecionados"],[1,"d-flex","align-items-center","justify-content-between","mb-2"],[1,"fw-bold","text-light","mb-0"],[1,"badge","bg-secondary"],["class","item-card bg-dark rounded p-2 mb-2 d-flex align-items-center justify-content-between gap-2",4,"ngFor","ngForOf"],[1,"item-card","bg-dark","rounded","p-2","mb-2","d-flex","align-items-center","justify-content-between","gap-2"],[1,"d-flex","align-items-center","gap-2","flex-grow-1"],[1,"fs-5"],[1,"fw-semibold","text-light"],[1,"item-quantidade"],["type","button",3,"click"],["type","number","min","1",3,"ngModelChange","blur","ngModel","max"],["type","button",1,"btn","btn-sm","btn-danger","px-2",3,"click"],[1,"d-flex","align-items-center","gap-2"],[1,"d-flex","align-items-center","justify-content-between","mt-2"],[1,"quantidade-box"],["type","button",1,"btn","btn-sm","btn-outline-light",3,"click"],["type","number","min","1",1,"quantidade-input",3,"ngModelChange","input","blur","ngModel","max"],["type","button",1,"btn","btn-success","ms-2",3,"click"],[1,"spinner-border","spinner-border-sm"]],template:function(e,n){if(e&1){let i=E();r(0,"div",2)(1,"div",3)(2,"div",4)(3,"div",5)(4,"div",6)(5,"h4",7),m(6,"\u{1F504} Troca de Itens"),o()(),r(7,"div",8)(8,"div",9)(9,"label",10),m(10,"\u{1F64D} Jogador Destinat\xE1rio *"),o(),r(11,"mat-form-field",11)(12,"input",12),C("ngModelChange",function(d){return l(i),M(n.filtroJogador,d)||(n.filtroJogador=d),c(d)}),g("input",function(){return l(i),c(n.filtrarJogadores())}),o(),r(13,"mat-autocomplete",13,0),g("optionSelected",function(d){return l(i),c(n.selecionarJogador(d.option.value))}),v(15,Oe,2,2,"mat-option",14),o()()(),v(16,Pe,7,2,"div",15),r(17,"div",16)(18,"mat-form-field",17)(19,"input",18),C("ngModelChange",function(d){return l(i),M(n.filtroItem,d)||(n.filtroItem=d),c(d)}),g("input",function(){return l(i),c(n.filtrarItensInventario())}),o(),r(20,"button",19)(21,"mat-icon"),m(22,"arrow_drop_down"),o()(),r(23,"mat-autocomplete",13,1),g("optionSelected",function(d){return l(i),c(n.selecionarItem(d.option.value))}),v(25,$e,6,3,"mat-option",14),o()(),v(26,Fe,9,2,"div",20),o(),r(27,"div",21)(28,"label",10),m(29,"\u{1F4DD} Descri\xE7\xE3o da transfer\xEAncia (opcional)"),o(),r(30,"textarea",22),C("ngModelChange",function(d){return l(i),M(n.descricaoTransferencia,d)||(n.descricaoTransferencia=d),c(d)}),o()()()()()(),r(31,"div",23)(32,"button",24),g("click",function(){return l(i),c(n.confirmarTroca())}),v(33,Le,2,0,"ng-container",25)(34,Re,2,0,"ng-container",25),o(),r(35,"button",26),g("click",function(){return l(i),c(n.cancelar())}),m(36,"\u2B05\uFE0F"),o()()()}if(e&2){let i=J(14),a=J(24);u(12),D("ngModel",n.filtroJogador),p("matAutocomplete",i),u(3),p("ngForOf",n.jogadoresFiltrados),u(),p("ngIf",n.itensTroca.length>0),u(3),D("ngModel",n.filtroItem),p("matAutocomplete",a),u(6),p("ngForOf",n.inventarioFiltrado),u(),p("ngIf",n.itemSelecionado),u(4),D("ngModel",n.descricaoTransferencia),u(2),p("disabled",n.processando||!n.jogadorSelecionado||n.itensTroca.length===0),u(),p("ngIf",!n.processando),u(),p("ngIf",n.processando)}},dependencies:[ie,ee,te,fe,le,ue,ce,ge,pe,me,be,xe,he,Me,Ie,ve,De,Te,Ce,we,se,de,re,oe],styles:[".troca-container[_ngcontent-%COMP%]{width:100%;max-width:900px;margin:0 auto}.detalhe-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:12px;overflow:hidden;box-shadow:0 0 12px #0006}.itens-selecionados[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:10px;padding:14px;margin-bottom:18px;border:1px solid #2e2e2e;overflow:visible}.itens-selecionados[_ngcontent-%COMP%]   h5[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;font-size:1rem}.item-card[_ngcontent-%COMP%]{background:#212529;border:1px solid #333;border-radius:10px;padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px;transition:all .2s ease;overflow:visible;margin-bottom:8px}.item-card[_ngcontent-%COMP%]:hover{border-color:#0d6efd;box-shadow:0 0 10px #0d6efd40}.item-info[_ngcontent-%COMP%]{display:flex;align-items:center;gap:8px;flex:1;min-width:0}.item-info[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{color:#f8f9fa;font-weight:500;font-size:.92rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}.item-quantidade[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.4rem;flex-shrink:0}.item-quantidade[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]{border:none;background:#343a40;color:#f8f9fa;border-radius:6px;width:28px;height:28px;font-weight:700;font-size:1rem;transition:all .2s}.item-quantidade[_ngcontent-%COMP%]   button[_ngcontent-%COMP%]:hover{background:#495057;transform:scale(1.05)}.item-quantidade[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:60px;text-align:center;font-weight:700;border:1px solid #6c757d;border-radius:6px;background:#212529;color:#f8f9fa;padding:3px;font-size:.9rem}.btn-danger[_ngcontent-%COMP%]{background:linear-gradient(135deg,#dc3545,#b02a37);color:#fff;border:none;border-radius:8px;padding:5px 8px;font-size:1rem;flex-shrink:0;transition:all .2s}.btn-danger[_ngcontent-%COMP%]:hover{background:linear-gradient(135deg,#e55363,#c23a46);transform:scale(1.08)}.input-dark[_ngcontent-%COMP%]{background:#1e1e1e!important;border:1px solid #444!important;border-radius:6px;color:#f8f9fa!important;padding:6px 10px}.input-dark[_ngcontent-%COMP%]:focus{border-color:#0d6efd!important;box-shadow:0 0 0 .2rem #0d6efd40!important;outline:none!important}textarea.auto-expand[_ngcontent-%COMP%]{min-height:80px;resize:vertical;background:#1e1e1e;border:1px solid #444;color:#f8f9fa;border-radius:6px;padding:8px 10px}textarea.auto-expand[_ngcontent-%COMP%]:focus{border-color:#0d6efd;outline:none;box-shadow:0 0 0 .2rem #0d6efd40}.novo-item[_ngcontent-%COMP%]{border:1px solid #333;background:#1e1e1e;border-radius:10px;padding:10px}.quantidade-box[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.35rem}.quantidade-input[_ngcontent-%COMP%]{width:60px;text-align:center;font-weight:700;border:1px solid #6c757d;border-radius:4px;background:#212529;color:#f8f9fa;padding:.25rem;font-size:.9rem}.fab-stack[_ngcontent-%COMP%]{position:fixed;bottom:70px;right:20px;display:flex;flex-direction:column;gap:15px;z-index:1000}.fab[_ngcontent-%COMP%]{width:60px;height:60px;border-radius:50%;font-size:1.6rem;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px #0006;transition:transform .2s ease}.fab[_ngcontent-%COMP%]:hover{transform:scale(1.08)}.fab-success[_ngcontent-%COMP%]{background:linear-gradient(135deg,#28a745,#218838);color:#fff}.fab-warning[_ngcontent-%COMP%]{background:linear-gradient(135deg,#ffc107,#e0a800);color:#000}@media (max-width: 480px){.item-card[_ngcontent-%COMP%]{flex-direction:column;align-items:stretch;padding:10px}.item-info[_ngcontent-%COMP%], .item-quantidade[_ngcontent-%COMP%]{justify-content:center;margin-bottom:8px}.btn-danger[_ngcontent-%COMP%]{align-self:center}}"]})};export{qe as TrocaDeItens};
