<div class="edicao-skilltree-wrapper d-flex flex-column min-vh-100 bg-dark text-light pb-5">
  <div class="flex-grow-1 p-3 d-flex justify-content-center">
    <div class="edicao-skilltree-container w-100">

      <!-- TÃ­tulo -->
      <h2 class="page-title">ğŸ› ï¸ EdiÃ§Ã£o da SkillTree</h2>

      <!-- Tabs (somente se nÃ£o estiver editando uma habilidade especÃ­fica) -->
      <ul class="nav nav-tabs custom-tabs mb-4" *ngIf="!editMode">
        <li class="nav-item">
          <a class="nav-link" [class.active]="abaAtiva==='caminhos'" (click)="abaAtiva='caminhos'">ğŸŒ Caminhos</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="abaAtiva==='arvores'" (click)="abaAtiva='arvores'">ğŸŒ³ Ãrvores</a>
        </li>
        <li class="nav-item">
          <a class="nav-link" [class.active]="abaAtiva==='habilidades'" (click)="abaAtiva='habilidades'">â­ Habilidades</a>
        </li>
      </ul>

      <!-- ================= CAMINHOS ================= -->
      <div *ngIf="abaAtiva==='caminhos'">
        <h4 class="mt-3">ğŸŒ Editar Caminho</h4>

        <!-- Selecionar caminho -->
        <select class="form-select input-dark mb-2" [(ngModel)]="caminhoSelecionado" name="caminhoSelecionado">
          <option [ngValue]="null" disabled>Selecione...</option>
          <option *ngFor="let c of caminhos" [ngValue]="c.id">{{ c.caminho }}</option>
        </select>

        <!-- Editar nome -->
        <input type="text" class="form-control input-dark mb-3" [(ngModel)]="caminhoEditNome"
               placeholder="Novo nome do caminho" />

        <!-- PrÃ©via estilo SkillTree -->
        <div class="arvores-scroll">
          <div *ngFor="let arvore of arvoresDoCaminho" class="arvore-card shadow-lg">
            <h3 class="arvore-titulo">{{ arvore.arvore }}</h3>
            <div #cyPreviewCaminho class="cy-arvore"></div>
          </div>
        </div>

        <!-- ExclusÃ£o -->
        <div class="mt-3">
          <label class="form-label">âš ï¸ Digite "excluir" para remover este caminho (inclui TODAS as Ã¡rvores e habilidades)</label>
          <input type="text" class="form-control input-dark" [(ngModel)]="confirmarExclusao" />
          <button class="btn btn-danger mt-2" (click)="excluirCaminho()" [disabled]="confirmarExclusao!=='excluir'">
            Excluir Caminho
          </button>
        </div>
      </div>

      <!-- ================= ÃRVORES ================= -->
      <div *ngIf="abaAtiva==='arvores'">
        <h4 class="mt-3">ğŸŒ³ Editar Ãrvore</h4>

        <!-- Selecionar caminho -->
        <select class="form-select input-dark mb-2" [(ngModel)]="caminhoSelecionado" name="caminhoSelecionadoArvore" (ngModelChange)="onCaminhoChange($event)">
          <option [ngValue]="null" disabled>Selecione Caminho...</option>
          <option *ngFor="let c of caminhos" [ngValue]="c.id">{{ c.caminho }}</option>
        </select>

        <!-- Selecionar Ã¡rvore -->
        <select class="form-select input-dark mb-2" [(ngModel)]="arvoreSelecionada" name="arvoreSelecionada">
          <option [ngValue]="null" disabled>Selecione Ãrvore...</option>
          <option *ngFor="let a of arvoresDoCaminho" [ngValue]="a.id">{{ a.arvore }}</option>
        </select>

        <!-- Editar nome -->
        <input type="text" class="form-control input-dark mb-3" [(ngModel)]="arvoreEditNome"
               placeholder="Novo nome da Ã¡rvore" />

        <!-- PrÃ©via -->
        <div class="arvore-card shadow-lg" *ngIf="arvoreSelecionada">
          <h3 class="arvore-titulo">{{ arvoreSelecionadaNome }}</h3>
          <div #cyPreviewArvore class="cy-arvore"></div>
        </div>

        <!-- ExclusÃ£o -->
        <div class="mt-3">
          <label class="form-label">âš ï¸ Digite "excluir" para remover esta Ã¡rvore (inclui TODAS as habilidades)</label>
          <input type="text" class="form-control input-dark" [(ngModel)]="confirmarExclusao" />
          <button class="btn btn-danger mt-2" (click)="excluirArvore()" [disabled]="confirmarExclusao!=='excluir'">
            Excluir Ãrvore
          </button>
        </div>
      </div>

      <!-- ================= HABILIDADES ================= -->
      <div *ngIf="abaAtiva==='habilidades' || editMode">
        <!-- PrÃ©via -->
        <div class="preview-wrapper mt-4">
          <h4 class="text-light">ğŸ” PrÃ©via â€” {{ arvoreSelecionadaNome }}</h4>
          <div #cyPreview class="cy-preview"></div>
        </div>

        <!-- Detalhe -->
        <div *ngIf="detalheHabilidade" class="detalhe-card shadow-lg mt-4 p-3">
          <h4 class="detalhe-nome">
            {{ detalheHabilidade.habilidade }}
            <span class="nivel">Lv {{ detalheHabilidade.nivel }}</span>
          </h4>
          <p class="detalhe-descricao">{{ detalheHabilidade.descricao }}</p>
          <div class="detalhe-extra" *ngIf="detalheHabilidade.requisitos">
            <span>ğŸ“Œ Requisito:</span> {{ detalheHabilidade.requisitos }}
          </div>
        </div>

        <!-- FormulÃ¡rio de habilidade -->
        <form #formRef="ngForm" (ngSubmit)="salvar(formRef)" id="formSkillTree">
          <!-- Caminho -->
          <div class="mb-3">
            <label class="form-label">ğŸŒ Caminho</label>
            <select class="form-select input-dark" [(ngModel)]="caminhoSelecionado" name="caminhoSelecionado"
              (ngModelChange)="onCaminhoChange($event)" required>
              <option [ngValue]="null" disabled>Selecione...</option>
              <option *ngFor="let c of caminhos" [ngValue]="c.id">{{ c.caminho }}</option>
            </select>
          </div>

          <!-- Ãrvore -->
          <div class="mb-3" *ngIf="caminhoSelecionado">
            <label class="form-label">ğŸŒ³ Ãrvore</label>
            <select class="form-select input-dark" [(ngModel)]="arvoreSelecionada" name="arvoreSelecionada"
              (ngModelChange)="onArvoreChange($event)" required>
              <option [ngValue]="null" disabled>Selecione...</option>
              <option *ngFor="let a of arvoresDoCaminho" [ngValue]="a.id">{{ a.arvore }}</option>
              <option [ngValue]="'nova'">â• Nova Ãrvore</option>
            </select>
            <div *ngIf="arvoreSelecionada === 'nova'" class="mt-2">
              <input type="text" class="form-control input-dark" [(ngModel)]="novaArvoreNome" name="novaArvoreNome"
                placeholder="Digite o nome da nova Ã¡rvore" (input)="atualizarPreview()" />
            </div>
          </div>

          <!-- DependÃªncia -->
          <div class="mb-3" *ngIf="arvoreSelecionada">
            <label class="form-label">ğŸ”— DependÃªncia</label>
            <select class="form-select input-dark" [(ngModel)]="dependenciaSelecionada" name="dependenciaSelecionada"
              (ngModelChange)="onDependenciaChange($event)">
              <option [ngValue]="null">Nenhuma</option>
              <option *ngFor="let h of habilidadesDaArvore" [ngValue]="h.id">
                {{ h.habilidade }} (Lv {{ h.nivel }})
              </option>
            </select>
          </div>

          <!-- Nome -->
          <div class="mb-3" *ngIf="arvoreSelecionada">
            <label class="form-label">ğŸ·ï¸ Nome</label>
            <input type="text" class="form-control input-dark" [(ngModel)]="habilidadeEdit.habilidade" name="habilidade"
              (input)="atualizarPreview()" required />
          </div>

          <!-- NÃ­vel -->
          <div class="mb-3" *ngIf="arvoreSelecionada">
            <label class="form-label">ğŸ“ˆ NÃ­vel</label>
            <input type="number" class="form-control input-dark" [(ngModel)]="habilidadeEdit.nivel" name="nivel"
              (input)="atualizarPreview()" min="1" required />
          </div>

          <!-- Requisitos -->
          <div class="mb-3" *ngIf="arvoreSelecionada">
            <label class="form-label">ğŸ“Œ Requisitos</label>
            <textarea class="form-control input-dark" [(ngModel)]="habilidadeEdit.requisitos" name="requisitos"
              (input)="atualizarPreview()"></textarea>
          </div>

          <!-- DescriÃ§Ã£o -->
          <div class="mb-3" *ngIf="arvoreSelecionada">
            <label class="form-label">ğŸ“ DescriÃ§Ã£o</label>
            <textarea class="form-control input-dark" [(ngModel)]="habilidadeEdit.descricao" name="descricao"
              (input)="atualizarPreview()"></textarea>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- FABs -->
  <div class="fab-stack">
    <button type="submit" form="formSkillTree" class="fab fab-success" [disabled]="formRef?.invalid || salvando">
      <ng-container *ngIf="!salvando">ğŸ’¾</ng-container>
      <ng-container *ngIf="salvando"><span class="spinner-border spinner-border-sm"></span></ng-container>
    </button>

    <button *ngIf="editMode" type="button" class="fab fab-danger" (click)="excluir()" [disabled]="excluindo">
      <ng-container *ngIf="!excluindo">ğŸ—‘ï¸</ng-container>
      <ng-container *ngIf="excluindo"><span class="spinner-border spinner-border-sm"></span></ng-container>
    </button>

    <button type="button" class="fab fab-warning" (click)="router.navigate(['/skilltree'])">â¬…ï¸</button>
  </div>
</div>
