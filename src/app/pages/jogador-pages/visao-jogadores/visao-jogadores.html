<div class="visao-wrapper d-flex flex-column min-vh-100 bg-dark text-light">
  <!-- Abas principais -->
  <ul class="nav nav-tabs bg-dark px-3" role="tablist">
    <li class="nav-item">
      <button class="nav-link" [class.active]="abaAtiva === 'jogador'" (click)="selecionarAba('jogador')">
        <ng-container *ngIf="jogador?.email; else npcLabel">
          ğŸ§™ Jogador
        </ng-container>
        <ng-template #npcLabel>
          <ng-container [ngSwitch]="jogador?.classificacao">
            <span *ngSwitchCase="'Inimigo'">ğŸ‘¹ Inimigo</span>
            <span *ngSwitchCase="'Bestial'">ğŸ¦– Bestial</span>
            <span *ngSwitchDefault>ğŸ‘¤ NPC</span>
          </ng-container>
        </ng-template>
      </button>
    </li>

    <!-- InventÃ¡rio sÃ³ se for jogador -->
    <li class="nav-item" *ngIf="jogador?.email">
      <button class="nav-link" [class.active]="abaAtiva === 'inventario'" (click)="selecionarAba('inventario')">
        ğŸ’ InventÃ¡rio
      </button>
    </li>

    <li class="nav-item" *ngIf="jogador?.email">
      <button class="nav-link" [class.active]="abaAtiva === 'habilidades'" (click)="selecionarAba('habilidades')">
        ğŸŒ³ Habilidades
      </button>
    </li>
  </ul>


  <div class="flex-grow-1 d-flex justify-content-center">
    <div class="visao-container w-100">
      <!-- Loading -->
      <div *ngIf="loading" class="text-center py-5">
        <div class="spinner-border text-light" role="status"></div>
        <p class="mt-2">Carregando...</p>
      </div>

      <!-- Jogador -->
      <div *ngIf="!loading && jogador && abaAtiva === 'jogador'" class="card detalhe-card shadow-lg border-0">
        <!-- Imagem -->
        <div class="position-relative">
          <ng-container *ngIf="jogador.imagem && jogador.imagem !== '-'; else noImagem">
            <img [src]="jogador.imagem" class="card-img-top detalhe-img" alt="Imagem do personagem"
              (click)="abrirImagem(jogador.imagem)" />
          </ng-container>
          <ng-template #noImagem>
            <div class="d-flex align-items-center justify-content-center bg-secondary text-dark detalhe-img"
              style="height:200px; font-size:3rem;">ğŸ‘¤</div>
          </ng-template>
        </div>

        <div class="card-body pb-5">
          <h4 class="fw-bold mb-1 text-light">{{ jogador.email ? 'ğŸ§™' : 'ğŸ‘¹' }} {{ jogador.personagem }}</h4>
          <p class="text-secondary mb-3">âš–ï¸ {{ jogador.alinhamento || 'Sem alinhamento' }}</p>

          <!-- Infos gerais -->
          <ul class="info-list mb-3">
            <li>ğŸ… <span>NÃ­vel:</span> {{ jogador.nivel }}</li>
            <li>â­ XP: {{ jogador.xp }}</li>
            <li>ğŸ€ Sorte: {{ jogador.pontos_de_sorte }}</li> <!-- ğŸ†• -->
            <hr class="my-2 opacity-25" />

            <li>
              â¤ï¸ Vida:
              <span [ngClass]="{
      'text-danger fw-bold': jogador.vida_atual! <= 0,
      'text-warning fw-bold': jogador.vida_atual! > 0 && jogador.vida_atual! < jogador.pontos_de_vida! * 0.5,
      'fw-bold': jogador.vida_atual! >= jogador.pontos_de_vida! * 0.5
    }">
                {{ jogador.vida_atual }}
              </span>
              / {{ jogador.pontos_de_vida }}
            </li>
            <li>ğŸ’” Dano tomado: {{ jogador.dano_tomado }}</li>
            <li>ğŸ›¡ï¸ Armadura: {{ jogador.classe_de_armadura }}</li>
            <li>ğŸ”° Escudo: {{ jogador.escudo }}</li> <!-- ğŸ†• -->
            <hr class="my-2 opacity-25" />
            <li>âœ¨ Fator de cura: {{ jogador.fator_cura }}</li>
            <li>ğŸš¶â€â™‚ï¸ Deslocamento: {{ jogador.deslocamento }}</li>
          </ul>


          <!-- Atributos -->
          <h6 class="fw-bold mt-3 text-light">ğŸ“Š Atributos</h6>
          <div class="atributos-grid compact mb-3">
            <div class="atributo-item" *ngFor="let attr of atributos">
              {{ attr.icon }} <span>{{ attr.label }}</span>
              <b>{{ attr.value }}</b>
              <small class="text-light">({{ attr.mod >= 0 ? '+' + attr.mod : attr.mod }})</small>
            </div>
          </div>

          <!-- Extra sÃ³ para NPC -->
          <div *ngIf="!jogador.email" class="mt-3">
            <h6 class="fw-bold text-light">ğŸ“ DescriÃ§Ã£o</h6>
            <p *ngIf="jogador.descricao" class="descricao-text">{{ jogador.descricao }}</p>

            <h6 *ngIf="jogador.ataques" class="fw-bold text-light mt-3">âš”ï¸ Ataques</h6>
            <p *ngIf="jogador.ataques" class="ataques-text">{{ jogador.ataques }}</p>
          </div>
        </div>
      </div>

      <!-- InventÃ¡rio -->
      <div *ngIf="!loading && jogador?.email && abaAtiva === 'inventario'" class="inventario-container">
        <!-- Abas internas -->
        <ul class="nav nav-tabs bg-dark px-3 mb-3" role="tablist">
          <li class="nav-item" *ngFor="let aba of abasInventario">
            <button class="nav-link" [class.active]="abaInventario === aba.toLowerCase()"
              (click)="selecionarAbaInventario(aba)">
              {{ aba }}
            </button>
          </li>
        </ul>

        <h4 class="fw-bold mb-3">ğŸ’ InventÃ¡rio</h4>

        <!-- Resumo -->
        <div *ngIf="!carregandoInventario && categoriasFiltradas.length > 0"
          class="card resumo-card mb-4 p-3 shadow-sm">
          <p class="mb-1 text-light">
            âš–ï¸ Peso total: <b>{{ resumo.pesoTotal | number:'1.0-2' }} kg</b>
          </p>
        </div>

        <!-- Loading -->
        <div *ngIf="carregandoInventario" class="text-center py-5">
          <div class="spinner-border text-light" role="status"></div>
          <p class="mt-2">Carregando inventÃ¡rio...</p>
        </div>

        <!-- Vazio -->
        <div *ngIf="!carregandoInventario && categoriasFiltradas.length === 0" class="text-center text-secondary py-5">
          Nenhum item encontrado.
        </div>

        <!-- Categorias -->
        <div *ngIf="!carregandoInventario">
          <ng-container *ngFor="let cat of categoriasFiltradas">
            <div class="mb-3" *ngIf="pertenceAbaInventario(cat.nome)">
              <button class="btn btn-categoria w-100 d-flex justify-content-between align-items-center"
                (click)="toggleCategoria(cat)">
                <span>{{ cat.nome }}</span><span>{{ cat.expandido ? 'âˆ’' : '+' }}</span>
              </button>
              <div *ngIf="cat.expandido" class="mt-2">
                <div class="row row-cols-1 g-3">
                  <div class="col" *ngFor="let inv of cat.itens">
                    <div class="card inventario-card h-100 p-3 shadow-sm">
                      <div class="d-flex align-items-center mb-2">
                        <div class="item-thumb me-3">
                          <img *ngIf="inv.itemDetalhe?.imagem && inv.itemDetalhe?.imagem !== '-'"
                            [src]="inv.itemDetalhe?.imagem" alt="{{ inv.itemDetalhe?.nome }}" />
                          <span *ngIf="!inv.itemDetalhe?.imagem || inv.itemDetalhe?.imagem === '-'">ğŸ“¦</span>
                        </div>
                        <div>
                          <h6 class="fw-bold mb-1 text-light">{{ inv.itemDetalhe?.nome || 'Item desconhecido' }}</h6>
                          <small class="item-meta">
                            {{ inv.quantidade }} {{ inv.itemDetalhe?.unidade_medida || '' }} | âš–ï¸
                            {{ inv.itemDetalhe?.peso || 0 }} kg
                          </small>
                        </div>
                      </div>
                      <p *ngIf="inv.itemDetalhe?.efeito" class="small mt-2 text-info">âœ¨ {{ inv.itemDetalhe?.efeito }}
                      </p>
                      <p *ngIf="inv.itemDetalhe?.colateral" class="small text-danger">âš ï¸ {{ inv.itemDetalhe?.colateral
                        }}</p>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </ng-container>
        </div>
      </div>

      <!-- Habilidades -->
      <div *ngIf="!loading && jogador?.email && abaAtiva === 'habilidades'">
        <app-skilltree *ngIf="jogador?.email" [jogadorId]="jogador?.email"></app-skilltree>
      </div>

      <!-- Nenhum encontrado -->
      <div *ngIf="!loading && !jogador" class="alert alert-warning mt-4">
        Nenhum personagem encontrado.
      </div>
    </div>
  </div>

  <!-- FAB Voltar -->
  <div class="fab-stack">
    <button class="fab fab-primary" (click)="voltar()">â¬…ï¸</button>
  </div>
</div>

<!-- Modal de Imagem -->
<app-image-modal [imagem]="imagemSelecionada" [aberto]="modalAberto" (fecharModal)="modalAberto = false">
</app-image-modal>