<div class="batalha-wrapper d-flex flex-column min-vh-100 bg-dark text-light">

  <!-- Abas -->
  <ul class="nav nav-tabs bg-dark border-bottom px-3" role="tablist">
    <li class="nav-item">
      <button class="nav-link" [class.active]="abaAtiva === 'campo'" (click)="selecionarAba('campo')">
        âš”ï¸ Campo de Batalha
      </button>
    </li>
    <li class="nav-item">
      <button class="nav-link" [class.active]="abaAtiva === 'historico'" (click)="selecionarAba('historico')">
        ğŸ“œ HistÃ³rico
      </button>
    </li>
  </ul>

  <!-- ===============================
       âš”ï¸ ABA 1 - CAMPO DE BATALHA
       =============================== -->
  <div *ngIf="abaAtiva === 'campo'" class="flex-grow-1 p-3 d-flex justify-content-center overflow-auto">
    <div class="batalha-container w-100">

      <!-- Loading -->
      <div *ngIf="carregando" class="text-center py-5">
        <div class="spinner-border text-light" role="status"></div>
        <p class="mt-2">Carregando jogadores...</p>
      </div>

      <!-- Filtro -->
      <div class="mb-3">
        <input type="text" class="form-control search-bar rounded-pill px-3" placeholder="ğŸ” Buscar personagem..."
          [(ngModel)]="filtro" (input)="aplicarFiltro()" />
      </div>

      <!-- ==========================
           ğŸ§™ SeÃ§Ã£o Jogadores
           ========================== -->
      <button class="btn-categoria w-100 text-start d-flex justify-content-between align-items-center mb-2"
        (click)="toggleSecaoCampo('jogadores')">
        <span class="fw-bold">ğŸ§™ Jogadores</span>
        <span>{{ secoesExpandidas.jogadores ? 'âˆ’' : '+' }}</span>
      </button>

      <div *ngIf="secoesExpandidas.jogadores">
        <div *ngIf="jogadoresNormais.length > 0; else vazioJogadores">
          <div *ngFor="let j of jogadoresNormais" class="card jogador-card mb-2 shadow-sm p-3"
            (click)="abrirDetalhes(j)">
            <div class="d-flex align-items-center">
              <!-- Imagem -->
              <div class="me-3 d-flex align-items-center justify-content-center bg-dark rounded img-container">
                <span *ngIf="JogadorUtils.estaMorto(j)" class="fs-3">ğŸ’€</span>
                <img *ngIf="j.imagem && j.imagem !== '-' && !JogadorUtils.estaMorto(j)" [src]="j.imagem"
                  class="img-fluid" alt="{{ j.personagem }}" />
                <span *ngIf="(!j.imagem || j.imagem === '-') && !JogadorUtils.estaMorto(j)">ğŸ‘¤</span>
              </div>

              <!-- Dados -->
              <div class="flex-grow-1">
                <h6 class="fw-bold text-light mb-1">{{ j.personagem }}</h6>
                <small class="text-secondary">
                  {{ j.classificacao || 'Jogador' }}
                  <span *ngIf="j.tipo">| {{ j.tipo }}</span>
                </small>
              </div>

              <!-- Status -->
              <div class="d-flex flex-column align-items-end ms-2" (click)="$event.stopPropagation()">
                <div class="d-flex mb-1 align-items-center status-linha">
                  <div class="status-item text-danger fw-bold">
                    â¤ï¸ {{ JogadorUtils.getVidaBase(j) - (j.dano_tomado || 0) }}/{{ JogadorUtils.getVidaBase(j) }}
                  </div>

                  <div class="status-item text-primary fw-bold">
                    ğŸ›¡ï¸ {{ j.classe_de_armadura || 0 }}
                  </div>
                  <div class="status-item text-warning fw-bold">
                    ğŸ”° {{ j.escudo || 0 }}
                  </div>
                </div>

                <div class="text-warning small mb-1">
                  ğŸ’¥ Dano: {{ j.dano_tomado || 0 }}
                </div>

                <!-- BotÃµes -->
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-outline-success" [disabled]="processando[j.id] === 'recuperar'"
                    (click)="acaoRecuperacao(j)">
                    <ng-container *ngIf="processando[j.id] === 'recuperar'; else recupIcon">
                      <span class="spinner-border spinner-border-sm"></span>
                    </ng-container>
                    <ng-template #recupIcon>ğŸ’Š</ng-template>
                  </button>

                  <button class="btn btn-sm btn-outline-light" [disabled]="processando[j.id] === 'espada'"
                    (click)="acaoEspada(j)">
                    <ng-container *ngIf="processando[j.id] === 'espada'; else espIcon">
                      <span class="spinner-border spinner-border-sm"></span>
                    </ng-container>
                    <ng-template #espIcon>âš”ï¸</ng-template>
                  </button>

                  <button *ngIf="j.nome_do_jogador === 'NPC'" class="btn btn-sm btn-outline-danger"
                    [disabled]="processando[j.id] === 'excluir'" (click)="excluirNpcDaBatalha(j)">
                    <ng-container *ngIf="processando[j.id] === 'excluir'; else exclIcon">
                      <span class="spinner-border spinner-border-sm"></span>
                    </ng-container>
                    <ng-template #exclIcon>ğŸ—‘ï¸</ng-template>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <ng-template #vazioJogadores>
          <div class="text-muted small mb-3">Nenhum jogador encontrado.</div>
        </ng-template>
      </div>

      <!-- ==========================
           ğŸ SeÃ§Ã£o Bestiais e Inimigos
           ========================== -->
      <button class="btn-categoria w-100 text-start d-flex justify-content-between align-items-center mt-4 mb-2"
        (click)="toggleSecaoCampo('bestiais')">
        <span class="fw-bold text-danger">ğŸ Bestiais e Inimigos</span>
        <span>{{ secoesExpandidas.bestiais ? 'âˆ’' : '+' }}</span>
      </button>

      <div *ngIf="secoesExpandidas.bestiais">
        <div *ngIf="bestiais.length > 0; else vazioBestiais">
          <div *ngFor="let j of bestiais" class="card jogador-card mb-2 shadow-sm p-3" (click)="abrirDetalhes(j)">
            <div class="d-flex align-items-center">
              <!-- Imagem -->
              <div class="me-3 d-flex align-items-center justify-content-center bg-dark rounded img-container">
                <span *ngIf="JogadorUtils.estaMorto(j)" class="fs-3">ğŸ’€</span>
                <img *ngIf="j.imagem && j.imagem !== '-' && !JogadorUtils.estaMorto(j)" [src]="j.imagem"
                  class="img-fluid" alt="{{ j.personagem }}" />
                <span *ngIf="(!j.imagem || j.imagem === '-') && !JogadorUtils.estaMorto(j)">ğŸ‘¤</span>
              </div>

              <!-- Dados -->
              <div class="flex-grow-1">
                <h6 class="fw-bold text-light mb-1">{{ j.personagem }}</h6>
                <small class="text-secondary">
                  {{ j.classificacao || 'Inimigo' }}
                  <span *ngIf="j.tipo">| {{ j.tipo }}</span>
                </small>
              </div>

              <!-- Status -->
              <div class="d-flex flex-column align-items-end ms-2" (click)="$event.stopPropagation()">
                <div class="d-flex mb-1 align-items-center status-linha">
                  <div class="status-item text-danger fw-bold">
                    â¤ï¸ {{ JogadorUtils.getVidaBase(j) - (j.dano_tomado || 0) }}/{{ JogadorUtils.getVidaBase(j) }}
                  </div>

                  <div class="status-item text-primary fw-bold">
                    ğŸ›¡ï¸ {{ j.classe_de_armadura || 0 }}
                  </div>
                  <div class="status-item text-warning fw-bold">
                    ğŸ”° {{ j.escudo || 0 }}
                  </div>
                </div>

                <div class="text-warning small mb-1">
                  ğŸ’¥ Dano: {{ j.dano_tomado || 0 }}
                </div>

                <!-- BotÃµes -->
                <div class="d-flex gap-1">
                  <button class="btn btn-sm btn-outline-success" [disabled]="processando[j.id] === 'recuperar'"
                    (click)="acaoRecuperacao(j)">
                    <ng-container *ngIf="processando[j.id] === 'recuperar'; else recupInimigo">
                      <span class="spinner-border spinner-border-sm"></span>
                    </ng-container>
                    <ng-template #recupInimigo>ğŸ’Š</ng-template>
                  </button>

                  <button class="btn btn-sm btn-outline-light" [disabled]="processando[j.id] === 'espada'"
                    (click)="acaoEspada(j)">
                    <ng-container *ngIf="processando[j.id] === 'espada'; else espadaInimigo">
                      <span class="spinner-border spinner-border-sm"></span>
                    </ng-container>
                    <ng-template #espadaInimigo>âš”ï¸</ng-template>
                  </button>

                  <button class="btn btn-sm btn-outline-danger" [disabled]="processando[j.id] === 'excluir'"
                    (click)="excluirNpcDaBatalha(j)">
                    <ng-container *ngIf="processando[j.id] === 'excluir'; else exclIcon">
                      <span class="spinner-border spinner-border-sm"></span>
                    </ng-container>
                    <ng-template #exclIcon>ğŸ—‘ï¸</ng-template>
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>

        <ng-template #vazioBestiais>
          <div class="text-muted small">Nenhum inimigo encontrado.</div>
        </ng-template>
      </div>
    </div>
  </div>

  <!-- ===============================
       ğŸ“œ ABA 2 - HISTÃ“RICO
       =============================== -->
  <div *ngIf="abaAtiva === 'historico'" class="flex-grow-1 p-3 d-flex justify-content-center overflow-auto">
    <div class="registro-container w-100">
      <h4 class="fw-bold mb-3">ğŸ“œ HistÃ³rico de Batalha e RecuperaÃ§Ã£o</h4>

      <input type="text" class="form-control search-bar rounded-pill px-3 mb-3"
        placeholder="ğŸ” Pesquisar no histÃ³rico..." [(ngModel)]="filtroHistorico" (input)="aplicarFiltroHistorico()" />

      <div *ngIf="carregandoHistorico" class="text-center py-5">
        <div class="spinner-border text-light" role="status"></div>
        <p class="mt-2">Carregando histÃ³rico...</p>
      </div>

      <div *ngIf="!carregandoHistorico && secoesHistoricoFiltradas.length === 0" class="text-center text-muted py-5">
        Nenhum registro encontrado.
      </div>

      <div *ngIf="!carregandoHistorico">
        <div *ngFor="let secao of secoesHistoricoFiltradas" class="mb-3">
          <button class="btn-categoria w-100 text-start d-flex justify-content-between align-items-center"
            (click)="toggleSecao(secao)">
            <span class="fw-bold">ğŸ“… {{ formatarData(secao.data) }}</span>
            <span>{{ secao.expandido ? 'âˆ’' : '+' }}</span>
          </button>

          <div *ngIf="secao.expandido" class="mt-2">
            <div class="row row-cols-1 g-2">
              <div class="col" *ngFor="let registro of secao.itens">
                <div class="registro-card card shadow-sm p-3 text-light"
                  [style.border-left]="'6px solid ' + (registro.cor || '#666')">
                  <div class="d-flex justify-content-between align-items-center mb-2">
                    <h6 class="fw-bold mb-0">{{ registro.icone }} {{ registro.tipo | titlecase }}</h6>
                    <small class="registro-hora">{{ registro.data | date: 'HH:mm' }}</small>
                  </div>
                  <p class="small descricao-text fst-italic mb-0" style="white-space: pre-line;">
                    {{ registro.detalhes }}
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>