import{a as x}from"./chunk-DU24F7PH.js";import{B as N,a as b,b as p,c as n,e as D,f as g,g as S,h as I,i as B,j as w,k as J,l as _,n as i,o as m,p as E,q as P,r as C,s as R,t as l,u,v as T,w as A}from"./chunk-TVRJFM4P.js";var y=class c{DB_NAME="VafyndellDB";DB_VERSION=1;db=null;storeNames=new Set;static create(){return n(this,null,function*(){let t=new c;return yield t.init(),t})}constructor(){console.log("[IndexedDBClient] Constructor chamado")}init(){return n(this,null,function*(){if(this.db){console.log("[IndexedDBClient] Banco j\xE1 inicializado.");return}let e=(yield indexedDB.databases?.())?.find(o=>o.name===this.DB_NAME);return e?.version&&e.version>this.DB_VERSION&&(this.DB_VERSION=e.version,console.log(`[IndexedDBClient] Ajustando vers\xE3o para ${this.DB_VERSION}`)),new Promise((o,a)=>{console.log(`[IndexedDBClient] Abrindo banco ${this.DB_NAME} v${this.DB_VERSION}...`);let r=indexedDB.open(this.DB_NAME,this.DB_VERSION);r.onerror=()=>a(r.error),r.onsuccess=()=>{this.db=r.result,this.storeNames=new Set(Array.from(this.db.objectStoreNames)),console.log("[IndexedDBClient] Banco aberto com stores:",Array.from(this.storeNames)),o()},r.onupgradeneeded=s=>{let d=s.target.result;console.log("[IndexedDBClient] Upgrade do banco. Stores existentes:",Array.from(d.objectStoreNames))}})})}ensureStore(t){return n(this,null,function*(){if(this.storeNames.has(t))return;console.log(`[IndexedDBClient] Store "${t}" n\xE3o existe \u2192 recriando DB...`),this.db?.close();let a=(yield indexedDB.databases?.())?.find(r=>r.name===this.DB_NAME)?.version??this.DB_VERSION;return this.DB_VERSION=Math.max(this.DB_VERSION,a)+1,new Promise((r,s)=>{let d=indexedDB.open(this.DB_NAME,this.DB_VERSION);d.onerror=()=>s(d.error),d.onupgradeneeded=O=>{let v=O.target.result;v.objectStoreNames.contains(t)||(v.createObjectStore(t,{keyPath:"id"}),console.log(`[IndexedDBClient] Store criada: ${t}`))},d.onsuccess=()=>{this.db=d.result,this.storeNames=new Set(Array.from(this.db.objectStoreNames)),console.log("[IndexedDBClient] Banco reaberto com stores:",Array.from(this.storeNames)),r()}})})}put(t,e){return n(this,null,function*(){return yield this.ensureStore(t),new Promise((o,a)=>{let r=this.db.transaction(t,"readwrite");r.objectStore(t).put(e),r.oncomplete=()=>o(),r.onerror=()=>a(r.error)})})}bulkPut(t,e){return n(this,null,function*(){return yield this.ensureStore(t),new Promise((o,a)=>{let r=this.db.transaction(t,"readwrite"),s=r.objectStore(t);e.forEach(d=>s.put(d)),r.oncomplete=()=>o(),r.onerror=()=>a(r.error)})})}get(t,e){return n(this,null,function*(){return this.storeNames.has(t)?new Promise((o,a)=>{let s=this.db.transaction(t,"readonly").objectStore(t).get(e);s.onsuccess=()=>o(s.result||null),s.onerror=()=>a(s.error)}):null})}getAll(t){return n(this,null,function*(){return this.storeNames.has(t)?new Promise((e,o)=>{let r=this.db.transaction(t,"readonly").objectStore(t).getAll();r.onsuccess=()=>e(r.result),r.onerror=()=>o(r.error)}):[]})}delete(t,e){return n(this,null,function*(){if(this.storeNames.has(t))return new Promise((o,a)=>{let r=this.db.transaction(t,"readwrite");r.objectStore(t).delete(e),r.oncomplete=()=>o(),r.onerror=()=>a(r.error)})})}clear(t){return n(this,null,function*(){if(this.storeNames.has(t))return new Promise((e,o)=>{let a=this.db.transaction(t,"readwrite");a.objectStore(t).clear(),a.oncomplete=()=>e(),a.onerror=()=>o(a.error)})})}deleteDatabase(){return n(this,null,function*(){return console.log("[IndexedDBClient] deleteDatabase \u2192 resetando banco..."),this.db&&(this.db.close(),this.db=null),new Promise((t,e)=>{let o=indexedDB.deleteDatabase(this.DB_NAME);o.onsuccess=()=>{this.storeNames.clear(),this.DB_VERSION=1,console.log("[IndexedDBClient] Banco deletado com sucesso."),t()},o.onerror=()=>e(o.error)})})}};var f=class{static ENDPOINT="https://script.google.com/macros/s/AKfycby-ec_h6sljntLAgoWhpeyBFGTkWygqS7Xx1Yvkx8RKDKiXDHPxtHZ8hhh6vrN91JEL/exec";static SHEET_ID="19B2aMGrajvhPJfOvYXt059-fECytaN38iFsP8GInD_g";static call(t,e){return n(this,null,function*(){let o=x.getIdToken();if(!o)throw new Error("Usu\xE1rio n\xE3o autenticado.");let a={idToken:o,action:t,payload:p(b({},e),{sheetId:this.SHEET_ID})};console.log("\u27A1\uFE0F Enviando para Script:",this.ENDPOINT,a);let r=yield fetch(this.ENDPOINT,{method:"POST",body:JSON.stringify(a)}),s=yield r.text();if(!r.ok)throw console.error("\u274C Erro bruto do Script:",s),new Error(`Erro no Script: ${r.status} - ${r.statusText}
${s}`);try{return JSON.parse(s)}catch(d){throw console.error("\u274C Resposta n\xE3o-JSON:",s),d}})}static createRow(t){return this.call("sheet.createRow",t)}static getAll(t){return this.call("sheet.getAll",t)}static getByIndex(t){return this.call("sheet.getByIndex",t)}static getCell(t){return this.call("sheet.getCell",t)}static updateByIndex(t){return this.call("sheet.updateByIndex",t)}static updateCell(t){return this.call("sheet.updateCell",t)}static deleteByIndex(t){return this.call("sheet.deleteByIndex",t)}static upload(t){return this.call("drive.upload",t)}static update(t){return this.call("drive.update",t)}static remove(t){return this.call("drive.delete",t)}static controllerCreate(t){return this.call("controller.create",t)}static controllerGetAll(t){return this.call("controller.getAll",t)}static controllerGetByIndex(t){return this.call("controller.getByIndex",t)}static controllerGetCell(t){return this.call("controller.getCell",t)}static controllerUpdateByIndex(t){return this.call("controller.updateByIndex",t)}static controllerUpdateCell(t){return this.call("controller.updateCell",t)}static controllerDeleteByIndex(t){return this.call("controller.deleteByIndex",t)}};var h=class{static TAB="Personagem";static STORE=this.TAB;static META_STORE="metadados";static dbPromise=null;static getDb(){return n(this,null,function*(){return this.dbPromise||(console.log("[JogadorRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=y.create()),this.dbPromise})}static getLocalJogador(){return n(this,null,function*(){let t=x.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");let o=yield(yield this.getDb()).getAll(this.STORE);return console.log("[JogadorRepository] getLocalJogador \u2192 total encontrados:",o.length),o.find(a=>a.email===t.email)||null})}static forceFetchJogador(){return n(this,null,function*(){let t=x.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");console.log("[JogadorRepository] Baixando lista online...");let e=yield f.controllerGetAll({tab:this.TAB});if(!e.length)return console.warn("[JogadorRepository] Nenhum jogador encontrado online."),null;let o=e.map(d=>p(b({},d),{id:d.index})),a=yield this.getDb();yield a.clear(this.STORE),yield a.bulkPut(this.STORE,o),console.log("[JogadorRepository] Cache atualizado com lista online.");let s=(yield f.controllerGetAll({tab:"Metadados"})).find(d=>d.SheetName===this.TAB);return s&&(yield a.put(this.META_STORE,{id:this.TAB,UltimaModificacao:s.UltimaModificacao}),console.log("[JogadorRepository] Metadados locais atualizados:",s)),o.find(d=>d.email===t.email)||null})}static syncJogadores(){return n(this,null,function*(){console.log("[JogadorRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let e=(yield f.controllerGetAll({tab:"Metadados"})).find(s=>s.SheetName===this.TAB);if(!e)return console.warn("[JogadorRepository] Nenhum metadado online encontrado."),!1;let a=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!a||a.UltimaModificacao!==e.UltimaModificacao?(console.log("[JogadorRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchJogador(),!0):(console.log("[JogadorRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}static getCurrentJogador(){return n(this,null,function*(){if(console.log("[JogadorRepository] getCurrentJogador iniciado."),!x.getUser())throw console.error("[JogadorRepository] Usu\xE1rio n\xE3o autenticado."),new Error("Usu\xE1rio n\xE3o autenticado.");let e=yield this.getLocalJogador();return e?(console.log("[JogadorRepository] Retornando jogador local:",e),this.syncJogadores().then(o=>n(this,null,function*(){o&&(console.log("[JogadorRepository] Cache atualizado \u2192 recarregando jogador."),e=yield this.getLocalJogador())})).catch(o=>{console.error("[JogadorRepository] Erro ao sincronizar em paralelo:",o)}),e):(console.log("[JogadorRepository] Nenhum jogador local \u2192 buscando online..."),yield this.forceFetchJogador())})}};var M=(c,t)=>t.label;function U(c,t){c&1&&(i(0,"div",2),E(1,"div",6),i(2,"p",7),l(3,"Carregando jogador..."),m()())}function F(c,t){if(c&1&&(i(0,"div",15)(1,"div",16),l(2),m()()),c&2){let e=t.$implicit;g(2),A(" ",e.label,": ",e.value," ")}}function z(c,t){if(c&1&&(i(0,"div",3),E(1,"img",8),i(2,"div",9)(3,"h4",10),l(4),m(),i(5,"p",11),l(6),m(),i(7,"ul",12)(8,"li",13),l(9,"\u{1F3C5} N\xEDvel: "),i(10,"b"),l(11),m()(),i(12,"li",13),l(13,"\u2B50 XP: "),i(14,"b"),l(15),m()(),i(16,"li",13),l(17,"\u{1F496} Vida total: "),i(18,"b"),l(19),m()(),i(20,"li",13),l(21,"\u2764\uFE0F Vida: "),i(22,"b"),l(23),m(),l(24," | \u{1F6E1}\uFE0F Armadura: "),i(25,"b"),l(26),m()(),i(27,"li",13),l(28,"\u{1F494} Dano tomado: "),i(29,"b"),l(30),m()(),i(31,"li",13),l(32,"\u2728 Fator de cura: "),i(33,"b"),l(34),m()()(),i(35,"div",14),J(36,F,3,2,"div",15,M),m()()()),c&2){let e=R();g(),P("src",e.jogador.imagem,D),g(3),T("\u{1F9D9} ",e.jogador.personagem),g(2),T("\u2696\uFE0F ",e.jogador.alinhamento),g(5),u(e.jogador.nivel),g(4),u(e.jogador.xp),g(4),u(e.jogador.vida_total),g(4),u(e.jogador.pontos_de_vida),g(3),u(e.jogador.classe_de_armadura),g(4),u(e.jogador.dano_tomado),g(4),u(e.jogador.fator_cura),g(2),_(e.atributos)}}function L(c,t){c&1&&(i(0,"div",4),l(1,"Nenhum jogador encontrado. V\xE1 para o cadastro."),m())}var j=class c{constructor(t){this.router=t}jogador=null;atributos=[];loading=!0;ngOnInit(){return n(this,null,function*(){console.log("[Jogador] ngOnInit \u2192 carregando jogador...");try{let t=yield h.getLocalJogador();if(t)console.log("[Jogador] Jogador local encontrado:",t),this.setJogador(t),h.syncJogadores().then(e=>n(this,null,function*(){if(e){console.log("[Jogador] Cache atualizado. Recarregando jogador...");let o=yield h.getLocalJogador();o&&this.setJogador(o)}}));else{console.log("[Jogador] Nenhum jogador local. Tentando buscar online...");let e=yield h.forceFetchJogador();e?this.setJogador(e):(console.warn("[Jogador] Nenhum jogador encontrado online \u2192 redirecionando para o cadastro"),this.router.navigate(["/cadastro_jogador"]))}}catch(t){console.error("[Jogador] Erro ao carregar Jogador:",t),this.router.navigate(["/login"])}})}setJogador(t){let e=t.energia+t.constituicao,o=Math.floor(t.energia/3),a=e+t.classe_de_armadura,r=Math.floor(t.destreza/3);this.jogador=p(b({},t),{pontos_de_vida:e,fator_cura:o,vida_total:a,deslocamento:r}),this.atributos=[{label:"For\xE7a",value:t.forca,icon:"bi bi-hand-thumbs-up"},{label:"Destreza",value:t.destreza,icon:"bi bi-lightning"},{label:"Constitui\xE7\xE3o",value:t.constituicao,icon:"bi bi-shield"},{label:"Intelig\xEAncia",value:t.inteligencia,icon:"bi bi-motherboard"},{label:"Sabedoria",value:t.sabedoria,icon:"bi bi-eye"},{label:"Carisma",value:t.carisma,icon:"bi bi-emoji-smile"},{label:"Energia",value:t.energia,icon:"bi bi-lightning-charge"},{label:"Deslocamento",value:r,icon:"bi bi-arrow-right"}],this.loading=!1}editarJogador(){this.router.navigate(["/editar-jogador"])}static \u0275fac=function(e){return new(e||c)(S(N))};static \u0275cmp=I({type:c,selectors:[["app-jogador"]],decls:7,vars:1,consts:[[1,"d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"flex-grow-1","pb-5"],[1,"text-center","py-5"],[1,"card","bg-dark","text-light","border-0","shadow-lg"],[1,"alert","alert-warning","mt-4"],[1,"btn","btn-primary","rounded-circle","shadow-lg","d-flex","align-items-center","justify-content-center",2,"position","fixed","bottom","25px","right","25px","width","60px","height","60px","font-size","1.5rem","z-index","1050",3,"click"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],["alt","Imagem do jogador",1,"card-img-top","object-fit-cover",2,"max-height","300px",3,"src"],[1,"card-body","pb-5"],[1,"card-title","fw-bold"],[1,"card-subtitle","text-light","mb-3"],[1,"list-group","list-group-flush"],[1,"list-group-item","bg-dark","text-light","border-0"],[1,"row","row-cols-2","g-2","mt-3"],[1,"col"],[1,"p-2","rounded","bg-secondary","text-light","text-center","fw-bold"]],template:function(e,o){e&1&&(i(0,"div",0)(1,"div",1),B(2,U,4,0,"div",2)(3,z,38,10,"div",3)(4,L,2,0,"div",4),m(),i(5,"button",5),C("click",function(){return o.editarJogador()}),l(6," \u270F\uFE0F "),m()()),e&2&&(g(2),w(o.loading?2:o.jogador?3:4))},encapsulation:2})};export{j as Jogador};
