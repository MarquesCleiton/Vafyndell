import{a as g,b as s}from"./chunk-2P6BNU5L.js";import{v as c}from"./chunk-HRLERFBW.js";import{a as d,b as l,d as r}from"./chunk-QQSIVCMV.js";var m=class{static TAB="Personagem";static STORE=this.TAB;static META_STORE="metadados";static FOLDER_ID="1zId11Ydti8d0FOQoQjd9lQmPo6GiJx26";static dbPromise=null;static getDb(){return r(this,null,function*(){return this.dbPromise||(console.log("[JogadorRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=g.create()),this.dbPromise})}static createJogador(o){return r(this,null,function*(){console.log("[JogadorRepository] Criando novo jogador...",o);let a=yield s.controllerCreate({tab:this.TAB,attrs:o,folderId:this.FOLDER_ID}),t=l(d({},a),{id:Number(a?.id)||Date.now(),index:a?.index});return yield(yield this.getDb()).put(this.STORE,t),console.log("[JogadorRepository] Jogador criado e salvo no cache:",t),t})}static updateJogador(o){return r(this,null,function*(){console.log("[JogadorRepository] Atualizando jogador...",o);let a=yield s.controllerUpdateByIndex({tab:this.TAB,index:o.index,attrs:o,folderId:this.FOLDER_ID}),t=l(d(d({},o),a),{id:Number(a?.id||o.id),index:a?.index||o.index});return yield(yield this.getDb()).put(this.STORE,t),console.log("[JogadorRepository] Jogador atualizado no cache local:",t),t})}static getAllJogadores(){return r(this,null,function*(){console.log("[JogadorRepository] getAllJogadores...");let o=yield s.controllerGetAll({tab:this.TAB});return Array.isArray(o)?o.map(a=>l(d({},a),{id:Number(a.id),index:a.index})):[]})}static getLocalJogador(){return r(this,null,function*(){let o=c.getUser();if(!o)throw new Error("Usu\xE1rio n\xE3o autenticado.");let t=yield(yield this.getDb()).getAll(this.STORE);return console.log("[JogadorRepository] getLocalJogador \u2192 total encontrados:",t.length),t.find(i=>i.email===o.email)||null})}static forceFetchJogador(){return r(this,null,function*(){let o=c.getUser();if(!o)throw new Error("Usu\xE1rio n\xE3o autenticado.");console.log("[JogadorRepository] Baixando lista online...");let a=yield this.getAllJogadores();if(!a.length)return console.warn("[JogadorRepository] Nenhum jogador encontrado online."),null;let t=a.map(e=>l(d({},e),{id:Number(e.id),index:e.index})),i=yield this.getDb();yield i.clear(this.STORE),yield i.bulkPut(this.STORE,t),console.log("[JogadorRepository] Cache atualizado com lista online.");let n=yield s.controllerGetAll({tab:"Metadados"});if(Array.isArray(n)){let e=n.find(h=>h.SheetName===this.TAB);e&&(yield i.put(this.META_STORE,{id:this.TAB,UltimaModificacao:e.UltimaModificacao}),console.log("[JogadorRepository] Metadados locais atualizados:",e))}return t.find(e=>e.email===o.email)||null})}static getLocalJogadores(){return r(this,null,function*(){let a=yield(yield this.getDb()).getAll(this.STORE);return console.log("[JogadorRepository] getLocalJogadores \u2192 total encontrados:",a.length),a})}static syncJogadores(){return r(this,null,function*(){console.log("[JogadorRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let o=yield s.controllerGetAll({tab:"Metadados"});if(!Array.isArray(o))return!1;let a=o.find(e=>e.SheetName===this.TAB);if(!a)return console.warn("[JogadorRepository] Nenhum metadado online encontrado."),!1;let i=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!i||i.UltimaModificacao!==a.UltimaModificacao?(console.log("[JogadorRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchJogador(),!0):(console.log("[JogadorRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}static getCurrentJogador(){return r(this,null,function*(){if(console.log("[JogadorRepository] getCurrentJogador iniciado."),!c.getUser())throw new Error("Usu\xE1rio n\xE3o autenticado.");let a=yield this.getLocalJogador();return a?(console.log("[JogadorRepository] Jogador local encontrado."),this.syncJogadores().then(t=>r(this,null,function*(){t&&(console.log("[JogadorRepository] Jogador atualizado ap\xF3s sync."),a=yield this.getLocalJogador())})).catch(t=>console.error("[JogadorRepository] Erro ao sincronizar:",t)),a):yield this.forceFetchJogador()})}static deleteJogador(o){return r(this,null,function*(){console.log("[JogadorRepository] Excluindo jogador...",o);let a=yield this.getDb(),t=yield a.get(this.STORE,o);return t?(yield s.controllerDeleteByIndex({tab:this.TAB,index:t.index}),yield a.delete(this.STORE,o),console.log("[JogadorRepository] Jogador exclu\xEDdo do cache/local:",o),!0):(console.warn("[JogadorRepository] Jogador n\xE3o encontrado no cache:",o),!1)})}static forceFetchJogadores(){return r(this,null,function*(){console.log("[JogadorRepository] Baixando lista online (todos jogadores)...");let o=yield this.getAllJogadores();if(!o.length)return console.warn("[JogadorRepository] Nenhum jogador encontrado online."),[];let a=o.map(n=>l(d({},n),{id:Number(n.id),index:n.index})),t=yield this.getDb();yield t.clear(this.STORE),yield t.bulkPut(this.STORE,a),console.log("[JogadorRepository] Cache atualizado com lista online (todos jogadores).");let i=yield s.controllerGetAll({tab:"Metadados"});if(Array.isArray(i)){let n=i.find(e=>e.SheetName===this.TAB);n&&(yield t.put(this.META_STORE,{id:this.TAB,UltimaModificacao:n.UltimaModificacao}),console.log("[JogadorRepository] Metadados locais atualizados:",n))}return a})}};export{m as a};
