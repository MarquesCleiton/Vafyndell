import{a as y}from"./chunk-PR2XBUWE.js";import{a as x}from"./chunk-N3BXCGYD.js";import{b as J,c as Y,f as H,i as K,r as Q}from"./chunk-W45U2HER.js";import{a as Z,b as _}from"./chunk-UM5RQUOR.js";import{Ia as d,Ja as s,Ka as r,La as D,Lb as q,Mb as V,N as F,Nb as W,Qb as $,Ra as k,T as P,Ta as C,U as z,Va as g,Zb as G,a as f,ac as X,b as u,d as l,gb as L,hb as m,ib as O,ja as B,jb as b,ka as o,mb as E,nb as M,oa as S,ob as T,pb as U,qb as j,sa as N,wa as v}from"./chunk-Y44Y2XZC.js";var h=class{static TAB="Receitas";static STORE=this.TAB;static META_STORE="metadados";static dbPromise=null;static getDb(){return l(this,null,function*(){return this.dbPromise||(console.log("[ReceitasRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=Z.create()),this.dbPromise})}static createReceita(t){return l(this,null,function*(){console.log("[ReceitasRepository] Criando nova receita...",t);let e=yield _.controllerCreate({tab:this.TAB,attrs:t}),i=u(f({},e),{id:e?.index||Date.now()});return yield(yield this.getDb()).put(this.STORE,i),console.log("[ReceitasRepository] Receita criada e salva no cache:",i),i})}static updateReceita(t){return l(this,null,function*(){console.log("[ReceitasRepository] Atualizando receita...",t);let e=yield _.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t}),i=f(f({},t),e);return yield(yield this.getDb()).put(this.STORE,i),console.log("[ReceitasRepository] Receita atualizada no cache local:",i),i})}static getAllReceitas(){return l(this,null,function*(){console.log("[ReceitasRepository] getAllReceitas...");let t=yield _.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t:[]})}static getLocalReceitas(){return l(this,null,function*(){return yield(yield this.getDb()).getAll(this.STORE)})}static forceFetchReceitas(){return l(this,null,function*(){console.log("[ReceitasRepository] Baixando lista online...");let t=yield this.getAllReceitas();if(!t.length)return console.warn("[ReceitasRepository] Nenhuma receita encontrada online."),[];let e=t.map(c=>u(f({},c),{id:c.index})),i=yield this.getDb();yield i.clear(this.STORE),yield i.bulkPut(this.STORE,e),console.log("[ReceitasRepository] Cache atualizado com lista online.");let a=yield _.controllerGetAll({tab:"Metadados"});if(Array.isArray(a)){let c=a.find(R=>R.SheetName===this.TAB);c&&(yield i.put(this.META_STORE,{id:this.TAB,UltimaModificacao:c.UltimaModificacao}),console.log("[ReceitasRepository] Metadados locais atualizados:",c))}return e})}static syncReceitas(){return l(this,null,function*(){console.log("[ReceitasRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let t=yield _.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let e=t.find(R=>R.SheetName===this.TAB);if(!e)return console.warn("[ReceitasRepository] Nenhum metadado online encontrado."),!1;let a=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!a||a.UltimaModificacao!==e.UltimaModificacao?(console.log("[ReceitasRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchReceitas(),!0):(console.log("[ReceitasRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}static deleteReceita(t){return l(this,null,function*(){return console.log("[ReceitasRepository] Excluindo receita...",t),yield _.controllerDeleteByIndex({tab:this.TAB,index:t}),yield(yield this.getDb()).delete(this.STORE,t),console.log("[ReceitasRepository] Receita exclu\xEDda do cache/local:",t),!0})}};var I=class n{getPossiveisReceitas(){return l(this,null,function*(){let t=X.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");let[e,i,a]=yield Promise.all([x.getLocalItens(),y.getLocalInventarioByJogador(t.email),h.getLocalReceitas()]);return e.length&&i.length&&a.length?(this.sincronizar(t.email).catch(c=>console.error("[OficinaService] Erro ao sincronizar:",c)),this.processar(e,a,i)):(console.log("[OficinaService] Cache incompleto \u2192 carregando dados s\xEDncronos..."),yield x.syncItens(),e=yield x.getLocalItens(),yield y.syncInventario(),i=yield y.getLocalInventarioByJogador(t.email),yield h.syncReceitas(),a=yield h.getLocalReceitas(),this.processar(e,a,i))})}sincronizar(t){return l(this,null,function*(){let[e,i,a]=yield Promise.all([x.syncItens(),y.syncInventario(),h.syncReceitas()]);console.log(e||i||a?"[OficinaService] Alguma tabela foi atualizada \u2192 dados locais recarregados":"[OficinaService] Nenhuma altera\xE7\xE3o nas tabelas.")})}processar(t,e,i){let a=new Map;i.forEach(p=>{let A=a.get(p.item_catalogo)||0;a.set(p.item_catalogo,A+p.quantidade)});let c=new Set(e.map(p=>p.fabricavel));return t.filter(p=>c.has(p.id)).map(p=>{let te=e.filter(w=>w.fabricavel===p.id).every(w=>(a.get(w.catalogo)||0)>=w.quantidade);return u(f({},p),{fabricavel:te})})}static \u0275fac=function(e){return new(e||n)};static \u0275prov=F({token:n,factory:n.\u0275fac,providedIn:"root"})};function ne(n,t){n&1&&(s(0,"div",12),D(1,"div",13),s(2,"p",14),m(3,"Carregando receitas..."),r()())}function oe(n,t){n&1&&(s(0,"div",15),m(1," Nenhum item encontrado. "),r())}function re(n,t){if(n&1&&D(0,"img",34),n&2){let e=g().$implicit;d("alt",U(e.nome||"Item"))("src",e.imagem,B)}}function ce(n,t){n&1&&(s(0,"span",35),m(1,"\u2692\uFE0F"),r())}function se(n,t){if(n&1&&(s(0,"p",36),m(1),r()),n&2){let e=g().$implicit;o(),b(" \u2728 ",e.efeito," ")}}function le(n,t){if(n&1&&(s(0,"p",37),m(1),r()),n&2){let e=g().$implicit;o(),b(" \u26A0\uFE0F ",e.colateral," ")}}function de(n,t){if(n&1&&(s(0,"p",38),m(1),r()),n&2){let e=g().$implicit;o(),b(" \u{1F4DD} ",e.descricao," ")}}function me(n,t){if(n&1&&(s(0,"div",23)(1,"div",24)(2,"span",25),m(3),r(),s(4,"div",26)(5,"div",27),v(6,re,1,3,"img",28)(7,ce,2,0,"span",29),r(),s(8,"div")(9,"h6",30),m(10),r(),s(11,"small"),m(12),r()()(),v(13,se,2,1,"p",31)(14,le,2,1,"p",32)(15,de,2,1,"p",33),r()()),n&2){let e=t.$implicit,i=g(4);o(2),d("ngClass",e.fabricavel?"bg-success":"bg-secondary"),o(),b(" ",e.fabricavel?"\u2705":"\u274C"," "),o(3),d("ngIf",e.imagem),o(),d("ngIf",!e.imagem),o(3),O(e.nome||"Sem nome"),o(),L(j("raridade ",i.getRaridadeClass(e.raridade))),o(),b(" ",e.raridade||"Comum"," "),o(),d("ngIf",e.efeito),o(),d("ngIf",e.colateral),o(),d("ngIf",e.descricao)}}function pe(n,t){if(n&1&&(s(0,"div",14)(1,"div",21),v(2,me,16,12,"div",22),r()()),n&2){let e=g().$implicit;o(2),d("ngForOf",e.itens)}}function fe(n,t){if(n&1){let e=k();s(0,"div",17)(1,"button",18),C("click",function(){let a=P(e).$implicit,c=g(2);return z(c.toggleCategoria(a))}),s(2,"span",19),m(3),r(),s(4,"span"),m(5),r()(),v(6,pe,3,1,"div",20),r()}if(n&2){let e=t.$implicit;o(3),O(e.nome||"Outros"),o(2),O(e.expandido?"\u2212":"+"),o(),d("ngIf",e.expandido)}}function ge(n,t){if(n&1&&(s(0,"div"),v(1,fe,7,3,"div",16),r()),n&2){let e=g();o(),d("ngForOf",e.categoriasFiltradas)}}var ee=class n{constructor(t,e){this.router=t;this.oficinaService=e}categorias=[];categoriasFiltradas=[];carregando=!0;filtro="";fabricaveisOnly=!1;ngOnInit(){return l(this,null,function*(){try{this.carregando=!0;let t=yield this.oficinaService.getPossiveisReceitas();this.processarItens(t),this.carregando=!1}catch(t){console.error("[Oficina] Erro ao carregar receitas:",t),this.carregando=!1}})}processarItens(t){let e=new Map;t.forEach(i=>{let a=i.categoria||"Outros";e.has(a)||e.set(a,[]),e.get(a).push(i)}),this.categorias=Array.from(e.entries()).sort((i,a)=>String(i[0]).localeCompare(String(a[0]))).map(([i,a])=>({nome:i,itens:a,expandido:!1})),this.categoriasFiltradas=[...this.categorias]}toggleCategoria(t){t.expandido=!t.expandido}aplicarFiltro(){let t=this.normalize(this.filtro);if(!t&&!this.fabricaveisOnly){this.categoriasFiltradas=[...this.categorias];return}this.categoriasFiltradas=this.categorias.map(e=>{let i=e.itens.filter(a=>(!this.fabricaveisOnly||a.fabricavel)&&(this.normalize(a.nome).includes(t)||this.normalize(a.raridade).includes(t)||this.normalize(a.efeito).includes(t)||this.normalize(a.descricao).includes(t)));return u(f({},e),{itens:i,expandido:!0})}).filter(e=>e.itens.length>0)}normalize(t=""){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}getRaridadeClass(t){return t?t.toLowerCase():"comum"}static \u0275fac=function(e){return new(e||n)(S(G),S(I))};static \u0275cmp=N({type:n,selectors:[["app-oficina"]],decls:14,vars:5,consts:[[1,"d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"p-3","bg-black","border-bottom","position-sticky","top-0",2,"z-index","10"],[1,"d-flex","align-items-center","gap-2"],["type","text","placeholder","\u{1F50D} Pesquisar receitas...",1,"form-control","bg-dark","text-light","border-light","rounded-pill","px-3",3,"ngModelChange","input","ngModel"],[1,"form-check","ms-2"],["type","checkbox","id","fabricaveisOnly",1,"form-check-input",3,"ngModelChange","change","ngModel"],["for","fabricaveisOnly",1,"form-check-label","small","text-light"],[1,"flex-grow-1","p-3"],[1,"fw-bold","mb-3"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",4,"ngFor","ngForOf"],[1,"mb-3"],[1,"btn","btn-outline-light","w-100","text-start","d-flex","justify-content-between","align-items-center",3,"click"],[1,"fw-bold"],["class","mt-2",4,"ngIf"],[1,"row","row-cols-1","g-2"],["class","col",4,"ngFor","ngForOf"],[1,"col"],[1,"card","catalogo-card","shadow-sm","h-100","p-3","position-relative"],[1,"badge","position-absolute","top-0","end-0","m-2",3,"ngClass"],[1,"d-flex","align-items-center","mb-2"],[1,"rounded","me-3","d-flex","align-items-center","justify-content-center","bg-dark",2,"width","55px","height","55px","overflow","hidden"],["style","width: 100%; height: 100%; object-fit: cover;",3,"src","alt",4,"ngIf"],["class","text-muted",4,"ngIf"],[1,"fw-bold","text-white","mb-1"],["class","small mt-2 text-info",4,"ngIf"],["class","small text-danger",4,"ngIf"],["class","small descricao-text fst-italic",4,"ngIf"],[2,"width","100%","height","100%","object-fit","cover",3,"src","alt"],[1,"text-muted"],[1,"small","mt-2","text-info"],[1,"small","text-danger"],[1,"small","descricao-text","fst-italic"]],template:function(e,i){e&1&&(s(0,"div",0)(1,"div",1)(2,"div",2)(3,"input",3),T("ngModelChange",function(c){return M(i.filtro,c)||(i.filtro=c),c}),C("input",function(){return i.aplicarFiltro()}),r(),s(4,"div",4)(5,"input",5),T("ngModelChange",function(c){return M(i.fabricaveisOnly,c)||(i.fabricaveisOnly=c),c}),C("change",function(){return i.aplicarFiltro()}),r(),s(6,"label",6),m(7," Apenas fabric\xE1veis "),r()()()(),s(8,"div",7)(9,"h4",8),m(10,"\u2692\uFE0F Oficina"),r(),v(11,ne,4,0,"div",9)(12,oe,2,0,"div",10)(13,ge,2,1,"div",11),r()()),e&2&&(o(3),E("ngModel",i.filtro),o(2),E("ngModel",i.fabricaveisOnly),o(6),d("ngIf",i.carregando),o(),d("ngIf",!i.carregando&&i.categoriasFiltradas.length===0),o(),d("ngIf",!i.carregando))},dependencies:[$,q,V,W,Q,Y,J,H,K],styles:[".catalogo-card[_ngcontent-%COMP%]{background:#1e1e1e;border:1px solid #333;border-radius:14px;transition:all .2s ease-in-out}.catalogo-card[_ngcontent-%COMP%]:hover{transform:translateY(-3px);box-shadow:0 6px 14px #00000073}.descricao-text[_ngcontent-%COMP%]{color:#cfcfcf!important}.raridade.comum[_ngcontent-%COMP%]{color:#999}.raridade.incomum[_ngcontent-%COMP%]{color:#6fbf73}.raridade.raro[_ngcontent-%COMP%]{color:#4a90e2}.raridade.\\e9pico[_ngcontent-%COMP%]{color:#9b7ecb}.raridade.lend\\e1rio[_ngcontent-%COMP%]{color:#d4af37}"]})};export{ee as Oficina};
