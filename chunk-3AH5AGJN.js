import{a as ne}from"./chunk-XQNWO7VY.js";import{b as Y,c as Z,f as ee,i as ie,r as te}from"./chunk-63E4UXQ5.js";import{a as F}from"./chunk-34ZGBLOX.js";import{e as G,f as H,g as J,j as K,s as X,w as E}from"./chunk-S65SB5BW.js";import{$b as h,Fb as R,Jb as x,Lb as p,Pa as q,Qa as o,Va as A,Xb as U,Yb as N,Zb as m,_ as V,_b as C,a as y,ab as L,ac as W,b as w,cc as T,d as _,dc as $,ec as z,fb as u,fc as j,gc as B,ia as I,ja as P,jc as Q,wb as d,xb as s,yb as c,zb as b}from"./chunk-QQSIVCMV.js";var k=class t{catalogoRepo=new F("Catalogo");inventarioRepo=new F("Inventario");receitasRepo=new F("Receitas");getPossiveisReceitas(){return _(this,null,function*(){let i=E.getUser();if(!i?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");let[e,n,a]=yield Promise.all([this.catalogoRepo.getLocal(),this.inventarioRepo.getLocal(),this.receitasRepo.getLocal()]),r=n.filter(f=>f.jogador===i.email),l=this.processar(e,a,r);if(_(this,null,function*(){let[f,v,S]=yield Promise.all([this.catalogoRepo.sync(),this.inventarioRepo.sync(),this.receitasRepo.sync()]);if(f||v||S){let[g,O,M]=yield Promise.all([this.catalogoRepo.getLocal(),this.inventarioRepo.getLocal(),this.receitasRepo.getLocal()]),D=O.filter(oe=>oe.jogador===i.email);l=this.processar(g,M,D)}}),!l.length){let[f,v,S]=yield Promise.all([this.catalogoRepo.forceFetch(),this.inventarioRepo.forceFetch(),this.receitasRepo.forceFetch()]),g=v.filter(O=>O.jogador===i.email);l=this.processar(f,S,g)}return l})}processar(i,e,n){let a=new Map;return n.forEach(l=>{let f=String(l.item_catalogo),v=a.get(f)||0;a.set(f,v+(l.quantidade||0))}),i.filter(l=>e.some(f=>String(f.fabricavel)===String(l.id))).map(l=>{let f=e.filter(g=>String(g.fabricavel)===String(l.id)).map(g=>{let O=a.get(String(g.catalogo))||0,M=i.find(D=>String(D.id)===String(g.catalogo));return w(y({},g),{quantidadeInventario:O,nome:M?.nome,imagem:M?.imagem})}),v=f.every(g=>g.quantidadeInventario>=g.quantidade);return f.some(g=>g.quantidadeInventario>0)?w(y({},l),{fabricavel:v,ingredientes:f}):null}).filter(l=>l!==null)}criarItem(i){return _(this,null,function*(){let e=E.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");for(let a of i.ingredientes)yield this.subtrairQuantidade(e.email,a.catalogo,a.quantidade);let n=i.quantidade_fabricavel||1;yield this.adicionarOuIncrementar(e.email,i.id,n),console.log(`[OficinaService] Item criado: ${i.nome} (x${n} ${i.unidade_medida||"unidade(s)"})`)})}forcarFalha(i){return _(this,null,function*(){let e=E.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");for(let n of i.ingredientes)yield this.subtrairQuantidade(e.email,n.catalogo,n.quantidade);console.log(`[OficinaService] Falha for\xE7ada: ${i.nome}`)})}subtrairQuantidade(i,e,n){return _(this,null,function*(){let r=(yield this.inventarioRepo.getLocal()).filter(l=>l.jogador===i).find(l=>l.item_catalogo===e);r&&(r.quantidade=Math.max(0,(r.quantidade||0)-n),r.quantidade===0?yield this.inventarioRepo.delete(r.id):yield this.inventarioRepo.update(r))})}adicionarOuIncrementar(i,e,n){return _(this,null,function*(){let r=(yield this.inventarioRepo.getLocal()).filter(l=>l.jogador===i).find(l=>l.item_catalogo===e);if(r)r.quantidade+=n,yield this.inventarioRepo.update(r);else{let l={id:ne.generateULID(),index:Date.now(),jogador:i,item_catalogo:e,quantidade:n};yield this.inventarioRepo.create(l)}})}static \u0275fac=function(e){return new(e||t)};static \u0275prov=V({token:t,factory:t.\u0275fac,providedIn:"root"})};var se=(t,i)=>({ok:t,fail:i});function de(t,i){if(t&1){let e=R();s(0,"li",15)(1,"button",16),x("click",function(){let a=I(e).$implicit,r=p();return P(r.selecionarAba(a))}),m(2),c()()}if(t&2){let e=i.$implicit,n=p();o(),U("active",n.abaAtiva===e),o(),h(" ",e==="recursos"?"\u{1F33F} Recursos":e==="equipamentos"?"\u2694\uFE0F Equipamentos":e==="pocoes"?"\u{1F9EA} Po\xE7\xF5es":"\u{1F4E6} Outros"," ")}}function le(t,i){t&1&&(s(0,"div",17),b(1,"div",18),s(2,"p",19),m(3,"Carregando receitas..."),c()())}function me(t,i){t&1&&(s(0,"div",20),m(1," Nenhum item encontrado. "),c())}function pe(t,i){if(t&1&&b(0,"img",38),t&2){let e=p().$implicit;d("alt",j(e.nome))("src",e.imagem,q)}}function fe(t,i){t&1&&(s(0,"span"),m(1,"\u2692\uFE0F"),c())}function ge(t,i){if(t&1&&(s(0,"p",39),m(1),c()),t&2){let e=p().$implicit;o(),h("\u2728 ",e.efeito)}}function ue(t,i){if(t&1&&(s(0,"p",40),m(1),c()),t&2){let e=p().$implicit;o(),h("\u26A0\uFE0F ",e.colateral)}}function _e(t,i){if(t&1&&b(0,"img",38),t&2){let e=p().$implicit;d("alt",j(e.nome))("src",e.imagem,q)}}function ve(t,i){t&1&&(s(0,"span"),m(1,"\u{1F9EA}"),c())}function xe(t,i){if(t&1&&(s(0,"div",43)(1,"div",44),u(2,_e,1,3,"img",31)(3,ve,2,0,"span",14),c(),s(4,"div",45)(5,"span",46),m(6),c()(),s(7,"span",47),m(8),c()()),t&2){let e=i.$implicit;d("ngClass",Q(6,se,e.quantidadeInventario>=e.quantidade,e.quantidadeInventario<e.quantidade)),o(2),d("ngIf",e.imagem),o(),d("ngIf",!e.imagem),o(3),C(e.nome),o(2),W(" ",e.quantidadeInventario,"/",e.quantidade," ")}}function he(t,i){if(t&1&&(s(0,"div",41),u(1,xe,9,9,"div",42),c()),t&2){let e=p().$implicit;o(),d("ngForOf",e.ingredientes)}}function be(t,i){t&1&&b(0,"span",52)}function Ce(t,i){t&1&&(s(0,"span"),m(1,"\u{1F6E0}\uFE0F"),c())}function Oe(t,i){t&1&&b(0,"span",52)}function ye(t,i){t&1&&(s(0,"span"),m(1,"\u{1F9E8}"),c())}function we(t,i){if(t&1){let e=R();s(0,"div",48)(1,"button",49),x("click",function(){I(e);let a=p().$implicit,r=p(4);return P(r.criarItem(a))}),u(2,be,1,0,"span",50)(3,Ce,2,0,"span",14),c(),s(4,"button",51),x("click",function(){I(e);let a=p().$implicit,r=p(4);return P(r.forcarFalha(a))}),u(5,Oe,1,0,"span",50)(6,ye,2,0,"span",14),c()()}if(t&2){let e=p().$implicit,n=p(4);o(),d("disabled",n.loadingAction[e.id]),o(),d("ngIf",n.loadingAction[e.id]==="criar"),o(),d("ngIf",n.loadingAction[e.id]!=="criar"),o(),d("disabled",n.loadingAction[e.id]),o(),d("ngIf",n.loadingAction[e.id]==="falha"),o(),d("ngIf",n.loadingAction[e.id]!=="falha")}}function Ie(t,i){if(t&1&&(s(0,"div",27)(1,"small",28),m(2),c(),s(3,"div",29)(4,"div",30),u(5,pe,1,3,"img",31)(6,fe,2,0,"span",14),c(),s(7,"div")(8,"h6",32),m(9),c(),s(10,"small"),m(11),c()()(),u(12,ge,2,1,"p",33)(13,ue,2,1,"p",34)(14,he,2,1,"div",35),s(15,"div",36),m(16," \u2692\uFE0F Produz: "),s(17,"b"),m(18),c(),m(19),c(),u(20,we,7,6,"div",37),c()),t&2){let e=i.$implicit,n=p(4);o(),d("ngClass",e.fabricavel?"status-ok":"status-off"),o(),h(" ",e.fabricavel?"\u2714 Dispon.":"\u2716 Indisp."," "),o(3),d("ngIf",e.imagem),o(),d("ngIf",!e.imagem),o(3),C(e.nome),o(),N(B("raridade ",n.getRaridadeClass(e.raridade))),o(),h(" ",e.raridade||"Comum"," "),o(),d("ngIf",e.efeito),o(),d("ngIf",e.colateral),o(),d("ngIf",e.ingredientes==null?null:e.ingredientes.length),o(4),C(e.quantidade_fabricavel||1),o(),h(" ",e.unidade_medida||"unidade(s)"," "),o(),d("ngIf",e.fabricavel)}}function Pe(t,i){if(t&1&&(s(0,"div",25),u(1,Ie,21,15,"div",26),c()),t&2){let e=p().$implicit;o(),d("ngForOf",e.itens)}}function Se(t,i){if(t&1){let e=R();s(0,"div",22)(1,"button",23),x("click",function(){let a=I(e).$implicit,r=p(2);return P(r.toggleCategoria(a))}),s(2,"span"),m(3),c(),s(4,"span"),m(5),c()(),u(6,Pe,2,1,"div",24),c()}if(t&2){let e=i.$implicit,n=p(2);d("hidden",!n.pertenceAba(e.nome)),o(3),C(e.nome||"Outros"),o(2),C(e.expandido?"\u2212":"+"),o(),d("ngIf",e.expandido)}}function Me(t,i){if(t&1&&(s(0,"div"),u(1,Se,7,4,"div",21),c()),t&2){let e=p();o(),d("ngForOf",e.categoriasFiltradas)}}var ae=class t{constructor(i,e){this.router=i;this.oficinaService=e}categorias=[];categoriasFiltradas=[];carregando=!0;filtro="";fabricaveisOnly=!1;abaAtiva="recursos";abas=["recursos","equipamentos","pocoes","outros"];loadingAction={};todasReceitas=[];mapaAbas={recursos:["Recursos bot\xE2nicos","Mineral","Componentes bestiais e animalescos","Tesouro","Moeda"],equipamentos:["Equipamento","Ferramentas","Utilit\xE1rio \u2013 Bombas, armadilhas, luz, som, g\xE1s, adesivos"],pocoes:["Po\xE7\xE3o de Cura \u2013 Regenera vida, cicatriza feridas","Po\xE7\xE3o Mental \u2013 Calmante, foco, mem\xF3ria, sono, esquecimento","Po\xE7\xE3o de Aprimoramento F\xEDsico \u2013 For\xE7a, resist\xEAncia, agilidade","Po\xE7\xE3o Sensorial \u2013 Vis\xE3o, audi\xE7\xE3o, percep\xE7\xE3o, voz, respira\xE7\xE3o","Po\xE7\xE3o de Furtividade \u2013 Camuflagem, passos suaves, sil\xEAncio","Po\xE7\xE3o de Energia \u2013 Percep\xE7\xE3o da energia fundamental","Veneno \u2013 Sonol\xEAncia, confus\xE3o ou morte"],outros:["Outros"]};ngOnInit(){return _(this,null,function*(){try{this.carregando=!0,this.todasReceitas=yield this.oficinaService.getPossiveisReceitas(),this.processarItens(this.todasReceitas)}catch(i){console.error("[Oficina] Erro ao carregar receitas:",i)}finally{this.carregando=!1}})}processarItens(i){let e=new Map(this.categorias.map(a=>[a.nome,a.expandido])),n=new Map;i.forEach(a=>{let r=a.categoria||"Outros";n.has(r)||n.set(r,[]),n.get(r).push(a)}),this.categorias=Array.from(n.entries()).sort(([a],[r])=>a.localeCompare(r)).map(([a,r])=>({nome:a,itens:r,expandido:e.get(a)??!1})),this.categoriasFiltradas=[...this.categorias]}aplicarFiltro(){let i=this.normalize(this.filtro);if(!i&&!this.fabricaveisOnly){this.categoriasFiltradas=[...this.categorias];return}this.categoriasFiltradas=this.categorias.map(e=>{let n=e.itens.filter(a=>(!this.fabricaveisOnly||a.fabricavel)&&(this.normalize(a.nome).includes(i)||this.normalize(a.raridade).includes(i)||this.normalize(a.efeito).includes(i)||this.normalize(a.descricao).includes(i)));return w(y({},e),{itens:n,expandido:n.length>0})}).filter(e=>e.itens.length>0)}normalize(i=""){return i.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}selecionarAba(i){this.abaAtiva=i}pertenceAba(i){return this.mapaAbas[this.abaAtiva].includes(i)}toggleCategoria(i){i.expandido=!i.expandido}getRaridadeClass(i){return i?i.toLowerCase():"comum"}criarItem(i){return _(this,null,function*(){let e=i.quantidade_fabricavel||1,n=i.unidade_medida||"unidade(s)";if(confirm(`\u2692\uFE0F Deseja realmente fabricar "${i.nome}"?

\u27A1 Ingredientes ser\xE3o consumidos.
\u27A1 Voc\xEA receber\xE1 ${e} ${n}.`)){this.loadingAction[i.id]="criar";try{yield this.oficinaService.criarItem(i),alert(`\u2705 Voc\xEA fabricou ${e} ${n} de "${i.nome}"!`),this.todasReceitas=yield this.oficinaService.getPossiveisReceitas(),this.processarItens(this.todasReceitas)}catch(r){console.error("[Oficina] Erro ao criar item:",r),alert("\u274C Erro ao fabricar item!")}finally{this.loadingAction[i.id]=null}}})}forcarFalha(i){return _(this,null,function*(){if(confirm(`\u{1F4A5} Deseja realmente for\xE7ar a falha de "${i.nome}"?

\u27A1 Todos os ingredientes ser\xE3o perdidos.
\u27A1 Nenhum item ser\xE1 fabricado.`)){this.loadingAction[i.id]="falha";try{yield this.oficinaService.forcarFalha(i),alert(`\u{1F4A5} Falha for\xE7ada! Ingredientes de "${i.nome}" foram consumidos.`),this.todasReceitas=yield this.oficinaService.getPossiveisReceitas(),this.processarItens(this.todasReceitas)}catch(n){console.error("[Oficina] Erro ao for\xE7ar falha:",n),alert("\u274C Erro ao processar falha!")}finally{this.loadingAction[i.id]=null}}})}static \u0275fac=function(e){return new(e||t)(A(X),A(k))};static \u0275cmp=L({type:t,selectors:[["app-oficina"]],decls:17,vars:6,consts:[[1,"oficina-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"p-3","top-bar","position-sticky","top-0",2,"z-index","10"],[1,"d-flex","align-items-center","gap-2"],["type","text","placeholder","\u{1F50D} Procurar receitas...",1,"form-control","search-input","rounded-pill","px-3",3,"ngModelChange","input","ngModel"],[1,"form-check","ms-2"],["type","checkbox","id","fabricaveisOnly",1,"form-check-input",3,"ngModelChange","change","ngModel"],["for","fabricaveisOnly",1,"form-check-label","small","text-light"],[1,"nav","nav-tabs","mt-2"],["class","nav-item",4,"ngFor","ngForOf"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"oficina-container","w-100"],[1,"fw-bold","mb-3","title"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[1,"nav-item"],[1,"nav-link",3,"click"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",3,"hidden",4,"ngFor","ngForOf"],[1,"mb-3",3,"hidden"],[1,"categoria-btn",3,"click"],["class","mt-2 d-flex flex-column gap-3",4,"ngIf"],[1,"mt-2","d-flex","flex-column","gap-3"],["class","receita-card",4,"ngFor","ngForOf"],[1,"receita-card"],[1,"status-indicador",3,"ngClass"],[1,"d-flex","align-items-center","mb-2"],[1,"thumb"],[3,"src","alt",4,"ngIf"],[1,"fw-bold","text-white","mb-1"],["class","small text-info mb-1",4,"ngIf"],["class","small text-danger mb-2",4,"ngIf"],["class","ingredientes-grid",4,"ngIf"],[1,"producao-info","mt-2","text-center"],["class","acoes-bottom",4,"ngIf"],[3,"src","alt"],[1,"small","text-info","mb-1"],[1,"small","text-danger","mb-2"],[1,"ingredientes-grid"],["class","ingrediente-pill",3,"ngClass",4,"ngFor","ngForOf"],[1,"ingrediente-pill",3,"ngClass"],[1,"ingrediente-thumb"],[1,"flex-grow-1"],[1,"small"],[1,"small","fw-bold"],[1,"acoes-bottom"],[1,"btn-square","success",3,"click","disabled"],["class","spinner-border spinner-border-sm",4,"ngIf"],[1,"btn-square","danger",3,"click","disabled"],[1,"spinner-border","spinner-border-sm"]],template:function(e,n){e&1&&(s(0,"div",0)(1,"div",1)(2,"div",2)(3,"input",3),z("ngModelChange",function(r){return $(n.filtro,r)||(n.filtro=r),r}),x("input",function(){return n.aplicarFiltro()}),c(),s(4,"div",4)(5,"input",5),z("ngModelChange",function(r){return $(n.fabricaveisOnly,r)||(n.fabricaveisOnly=r),r}),x("change",function(){return n.aplicarFiltro()}),c(),s(6,"label",6),m(7," Apenas fabric\xE1veis "),c()()(),s(8,"ul",7),u(9,de,3,3,"li",8),c()(),s(10,"div",9)(11,"div",10)(12,"h4",11),m(13,"\u2692\uFE0F Oficina"),c(),u(14,le,4,0,"div",12)(15,me,2,0,"div",13)(16,Me,2,1,"div",14),c()()()),e&2&&(o(3),T("ngModel",n.filtro),o(2),T("ngModel",n.fabricaveisOnly),o(4),d("ngForOf",n.abas),o(5),d("ngIf",n.carregando),o(),d("ngIf",!n.carregando&&n.categoriasFiltradas.length===0),o(),d("ngIf",!n.carregando))},dependencies:[K,G,H,J,te,Z,Y,ee,ie],styles:[".oficina-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column;justify-content:center}.oficina-container[_ngcontent-%COMP%]{width:100%;max-width:900px;margin:0 auto}.toast-feedback[_ngcontent-%COMP%]{padding:10px 16px;border-radius:8px;font-weight:500;box-shadow:0 4px 12px #0006}.search-input[_ngcontent-%COMP%]{background:#1e1e1e!important;border:1px solid #444!important;color:#f8f9fa!important}.search-input[_ngcontent-%COMP%]:focus{border-color:#0d6efd!important;box-shadow:0 0 0 .2rem #0d6efd40!important;outline:none!important}.nav-tabs[_ngcontent-%COMP%]{display:flex;flex-wrap:nowrap;overflow-x:auto;-webkit-overflow-scrolling:touch;border-bottom:1px solid #444;scrollbar-width:none}.nav-tabs[_ngcontent-%COMP%]::-webkit-scrollbar{display:none}.nav-tabs[_ngcontent-%COMP%]   .nav-item[_ngcontent-%COMP%]{flex:1 0 auto;text-align:center}.nav-tabs[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]{color:#aaa;background:transparent;border:none;font-weight:600;padding:.5rem .8rem;display:flex;align-items:center;gap:6px;white-space:nowrap}.nav-tabs[_ngcontent-%COMP%]   .nav-link.active[_ngcontent-%COMP%]{color:#fff;background:#2a2a2a;border-radius:8px 8px 0 0}.title[_ngcontent-%COMP%]{color:#f8f9fa}.categoria-btn[_ngcontent-%COMP%]{width:100%;background:#2a2a2a;border:none;border-radius:8px;padding:10px 14px;font-weight:600;color:#f8f9fa;display:flex;justify-content:space-between;align-items:center;transition:background .2s ease}.categoria-btn[_ngcontent-%COMP%]:hover{background:#343a40;color:#fff}.receita-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:10px;padding:14px;position:relative;box-shadow:0 2px 6px #0006;transition:transform .15s ease;color:#f1f1f1}.receita-card[_ngcontent-%COMP%]:hover{transform:scale(1.02);background:#252525}.status-indicador[_ngcontent-%COMP%]{position:absolute;top:8px;right:12px;font-size:.8rem;font-weight:600}.status-ok[_ngcontent-%COMP%]{color:#28a745}.status-off[_ngcontent-%COMP%]{color:#dc3545}.thumb[_ngcontent-%COMP%]{width:55px;height:55px;border-radius:8px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-right:10px}.thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.ingredientes-grid[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:6px}.ingrediente-pill[_ngcontent-%COMP%]{background:#2a2a2a;border-radius:8px;padding:6px 10px;display:flex;align-items:center;gap:8px}.ingrediente-pill.ok[_ngcontent-%COMP%]{border:1px solid #28a745}.ingrediente-pill.fail[_ngcontent-%COMP%]{border:1px solid #dc3545}.ingrediente-thumb[_ngcontent-%COMP%]{width:28px;height:28px;border-radius:6px;background:#1e1e1e;display:flex;align-items:center;justify-content:center;overflow:hidden}.ingrediente-thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.acoes-bottom[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:10px;margin-top:12px}.btn-square[_ngcontent-%COMP%]{width:40px;height:40px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;border:none;transition:transform .2s ease}.btn-square[_ngcontent-%COMP%]:hover{transform:scale(1.08)}.btn-square.success[_ngcontent-%COMP%]{background:#198754;color:#fff}.btn-square.success[_ngcontent-%COMP%]:hover{background:#157347}.btn-square.danger[_ngcontent-%COMP%]{background:#dc3545;color:#fff}.btn-square.danger[_ngcontent-%COMP%]:hover{background:#bb2d3b}.raridade[_ngcontent-%COMP%]{font-weight:700;font-size:.85rem}.raridade.comum[_ngcontent-%COMP%]{color:#ccc}.raridade.incomum[_ngcontent-%COMP%]{color:#00bcd4}.raridade.raro[_ngcontent-%COMP%]{color:#673ab7}.raridade.epico[_ngcontent-%COMP%]{color:#9c27b0}.raridade.lendario[_ngcontent-%COMP%]{color:gold}@media (min-width: 992px){.oficina-container[_ngcontent-%COMP%]{padding:0 2rem}.receita-card[_ngcontent-%COMP%]{border-radius:16px}}.producao-info[_ngcontent-%COMP%]{font-size:.9rem;color:#0dcaf0;font-weight:600;background:#2a2a2a;border-radius:6px;padding:4px 8px;display:inline-block}"]})};export{ae as Oficina};
