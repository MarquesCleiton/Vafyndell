import{a as D,b as te}from"./chunk-AEFGH6HF.js";import{a as U}from"./chunk-XQNWO7VY.js";import{a as y}from"./chunk-J5FBOTGS.js";import{h as Q}from"./chunk-SEBSZRO5.js";import{g as F,h as q,i as B,q as $,x as N}from"./chunk-IJWXOQAR.js";import{$b as j,Ab as s,Bb as c,Cb as r,Db as b,Hb as k,Ib as w,Jb as x,Nb as C,Pb as m,Tb as z,Ua as d,Ub as V,Vb as L,Za as A,Zb as O,a as M,b as P,bc as g,cc as T,dc as H,eb as J,f as ee,g as u,jb as f,la as _,ma as v,mc as R,rc as I}from"./chunk-O42C4TWY.js";var Z=ee(te());var ie=["cyContainer"],ne=n=>({"show d-block":n});function ae(n,t){if(n&1){let e=x();c(0,"li",14)(1,"a",15),C("click",function(){let a=_(e).$implicit,l=m();return v(l.selecionarAba(a))}),g(2),r()()}if(n&2){let e=t.$implicit,i=m();d(),j("active",i.abaAtiva===e.id),d(),H(" ",e.caminho," ")}}function oe(n,t){n&1&&(c(0,"div",16),b(1,"div",17),c(2,"p",18),g(3,"Carregando habilidades..."),r()())}function re(n,t){if(n&1&&(c(0,"div",21)(1,"h3",22),g(2),r(),b(3,"div",23,0),r()),n&2){let e=t.$implicit;d(2),T(e.arvore)}}function de(n,t){if(n&1&&(c(0,"div",19),f(1,re,5,1,"div",20),r()),n&2){let e=m();d(),s("ngForOf",e.arvoresAtivas)}}function le(n,t){n&1&&b(0,"div",24)}function se(n,t){if(n&1&&(c(0,"div",35)(1,"span"),g(2,"\u{1F4CC} Requisito:"),r(),b(3,"br"),g(4),r()),n&2){let e=m(2);d(4),H("",e.habilidadeSelecionada.requisitos," ")}}function ce(n,t){n&1&&(k(0),b(1,"span",40),w())}function me(n,t){n&1&&g(0,"\u274C")}function ge(n,t){if(n&1){let e=x();k(0),c(1,"button",39),C("click",function(){_(e);let a=m(3);return v(a.removerHabilidadeJogador(a.habilidadeSelecionada))}),f(2,ce,2,0,"ng-container",38)(3,me,1,0,"ng-template",null,2,I),r(),w()}if(n&2){let e=O(4),i=m(3);d(),s("disabled",i.processando),d(),s("ngIf",i.processando)("ngIfElse",e)}}function pe(n,t){n&1&&(k(0),b(1,"span",40),w())}function fe(n,t){n&1&&g(0,"\u2795")}function be(n,t){if(n&1){let e=x();c(0,"button",41),C("click",function(){_(e);let a=m(3);return v(a.adicionarHabilidadeJogador(a.habilidadeSelecionada))}),f(1,pe,2,0,"ng-container",38)(2,fe,1,0,"ng-template",null,3,I),r()}if(n&2){let e=O(3),i=m(3);s("disabled",i.processando),d(),s("ngIf",i.processando)("ngIfElse",e)}}function he(n,t){if(n&1){let e=x();c(0,"div",36)(1,"button",37),C("click",function(){_(e);let a=m(2);return v(a.editarHabilidade(a.habilidadeSelecionada.id))}),g(2," \u270F\uFE0F "),r(),f(3,ge,5,3,"ng-container",38)(4,be,4,3,"ng-template",null,1,I),r()}if(n&2){let e=O(5),i=m(2);d(3),s("ngIf",i.temHabilidade(i.habilidadeSelecionada==null?null:i.habilidadeSelecionada.id))("ngIfElse",e)}}function ue(n,t){if(n&1){let e=x();c(0,"div",25)(1,"div",26)(2,"div",27)(3,"div",28)(4,"h5",29),g(5),r(),c(6,"button",30),C("click",function(){_(e);let a=m();return v(a.fecharModal())}),r()(),c(7,"div",31)(8,"p",32),g(9),r(),f(10,se,5,1,"div",33),r(),f(11,he,6,2,"div",34),r()()()}if(n&2){let e=m();s("ngClass",R(5,ne,e.habilidadeSelecionada)),d(5),H(" ",e.habilidadeSelecionada.habilidade," "),d(4),T(e.habilidadeSelecionada.descricao),d(),s("ngIf",e.habilidadeSelecionada==null?null:e.habilidadeSelecionada.requisitos),d(),s("ngIf",!e.somenteVisualizacao)}}D.use(Z.default);var Y=class n{constructor(t){this.router=t}jogadorId;cyContainers;cyInstances={};caminhos=[];arvores=[];habilidades=[];habilidadesJogador=[];carregando=!0;habilidadeSelecionada=null;abaAtiva=null;somenteVisualizacao=!1;repoCaminho=new y("Caminhos");repoArvore=new y("Arvores");repoHab=new y("Habilidades");repoHabJog=new y("Habilidades_jogadores");userEmail=null;processando=!1;ngOnInit(){return u(this,null,function*(){this.carregando=!0;try{if(this.jogadorId)this.somenteVisualizacao=!0,this.userEmail=this.jogadorId;else{let t=N.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado.");this.userEmail=t.email}if(!this.userEmail)throw new Error("Email do jogador n\xE3o definido.");yield this.loadLocalAndSync(this.userEmail),this.caminhos.length>0&&(this.abaAtiva=this.caminhos[0].id)}catch(t){console.error("[SkillTree] \u274C Erro ao carregar:",t)}finally{this.carregando=!1}})}ngAfterViewInit(){this.cyContainers.changes.subscribe(()=>{this.abaAtiva&&!this.carregando&&this.renderizarArvores()})}get arvoresAtivas(){return this.abaAtiva?this.arvores.filter(t=>String(t.caminho)===String(this.abaAtiva)):[]}normalizeHabJog(t){return t.map(e=>P(M({},e),{habilidade:String(e.habilidade)}))}loadLocalAndSync(t){return u(this,null,function*(){let[e,i,a,l]=yield Promise.all([this.repoCaminho.getLocal(),this.repoArvore.getLocal(),this.repoHab.getLocal(),this.repoHabJog.getLocal()]);this.caminhos=e,this.arvores=i,this.habilidades=a,this.habilidadesJogador=this.normalizeHabJog(l.filter(o=>o.jogador===t)),this.renderizarArvores(),u(this,null,function*(){let[o,h,p,S]=yield Promise.all([this.repoCaminho.sync(),this.repoArvore.sync(),this.repoHab.sync(),this.repoHabJog.sync()]);if(o||h||p||S){let[E,G,K,W]=yield Promise.all([this.repoCaminho.getLocal(),this.repoArvore.getLocal(),this.repoHab.getLocal(),this.repoHabJog.getLocal()]);this.caminhos=E,this.arvores=G,this.habilidades=K,this.habilidadesJogador=this.normalizeHabJog(W.filter(X=>X.jogador===t)),this.renderizarArvores()}})})}renderizarArvores(){this.abaAtiva&&this.cyContainers.forEach((t,e)=>{let i=this.arvoresAtivas[e];if(!i)return;let a=this.habilidades.filter(o=>String(o.arvore)===String(i.id)),l=[];a.forEach(o=>{let h=this.temHabilidade(o.id);l.push({data:P(M({},o),{id:String(o.id),label:`${o.habilidade}`}),classes:h?"habilidade-acquired":""}),o.dependencia&&a.some(p=>String(p.id)===String(o.dependencia))&&l.push({data:{source:String(o.dependencia),target:String(o.id)}})}),this.cyInstances[i.id]&&this.cyInstances[i.id].destroy(),this.cyInstances[i.id]=D({container:t.nativeElement,elements:l,layout:{name:"dagre",rankDir:"TB",nodeSep:120,rankSep:100,edgeSep:30,padding:40},style:[{selector:"node",style:{"background-color":"#222","border-color":"#555","border-width":2,label:"data(label)",color:"#eee","text-valign":"center","text-halign":"center",width:"65px",height:"65px","font-size":"10px","text-wrap":"wrap","text-max-width":"90px"}},{selector:"node.habilidade-acquired",style:{"background-color":"#28a745","border-color":"#fff","border-width":3,color:"#fff"}},{selector:"node.selected",style:{"background-color":"#007bff","border-color":"#fff","border-width":3,color:"#fff"}},{selector:"edge",style:{width:2,"line-color":"#666","curve-style":"unbundled-bezier","control-point-distances":[-30,30],"control-point-weights":[.5,.5]}}],userPanningEnabled:!0,userZoomingEnabled:!0,autoungrabify:!0}),this.cyInstances[i.id].on("tap","node",o=>{this.cyInstances[i.id].nodes().removeClass("selected"),o.target.addClass("selected");let p=String(o.target.data("id")),S=this.habilidades.find(E=>String(E.id)===p)||null;this.selecionarHab(S)})})}selecionarAba(t){this.abaAtiva=t.id,setTimeout(()=>this.renderizarArvores(),0)}selecionarHab(t){this.habilidadeSelecionada=t}editarHabilidade(t){!t||this.somenteVisualizacao||this.router.navigate(["/edicao-skilltree",t])}temHabilidade(t){return t?this.habilidadesJogador.some(e=>String(e.habilidade)===String(t)):!1}coletarDependencias(t){let e=[],i=t;for(;i?.dependencia;){let a=this.habilidades.find(l=>String(l.id)===String(i.dependencia));a&&!this.temHabilidade(a.id)&&e.unshift(a),i=a}return e}coletarDependentes(t){let e=[],i=a=>{let l=this.habilidades.filter(o=>String(o.dependencia)===String(a));for(let o of l)e.push(o),i(String(o.id))};return i(String(t.id)),e}adicionarHabilidadeJogador(t){return u(this,null,function*(){if(this.somenteVisualizacao||this.temHabilidade(t.id))return;let i=[...this.coletarDependencias(t),t],a=i.map(l=>`- ${l.habilidade}`).join(`
`);if(confirm(`\u26A0\uFE0F Deseja realmente adicionar a habilidade?

${a}`)){this.processando=!0;try{let l=i.map(o=>({id:U.generateULID(),jogador:this.userEmail,habilidade:String(o.id),data_aquisicao:new Date().toISOString()}));yield this.repoHabJog.createBatch(l),this.habilidadesJogador=this.normalizeHabJog((yield this.repoHabJog.getLocal()).filter(o=>o.jogador===this.userEmail)),this.renderizarArvores()}finally{this.processando=!1}}})}removerHabilidadeJogador(t){return u(this,null,function*(){if(this.somenteVisualizacao)return;let i=this.coletarDependentes(t).filter(o=>this.temHabilidade(o.id)),a=[t,...i],l=a.map(o=>`- ${o.habilidade}`).join(`
`);if(confirm(`\u26A0\uFE0F Deseja realmente remover a habilidade?

${l}`)){this.processando=!0;try{let h=this.habilidadesJogador.filter(p=>a.some(S=>String(S.id)===String(p.habilidade))).map(p=>p.id);yield this.repoHabJog.deleteBatch(h),this.habilidadesJogador=this.normalizeHabJog((yield this.repoHabJog.getLocal()).filter(p=>p.jogador===this.userEmail)),this.renderizarArvores()}finally{this.processando=!1}}})}fecharModal(){this.habilidadeSelecionada=null}static \u0275fac=function(e){return new(e||n)(A(Q))};static \u0275cmp=J({type:n,selectors:[["app-skilltree"]],viewQuery:function(e,i){if(e&1&&z(ie,5),e&2){let a;V(a=L())&&(i.cyContainers=a)}},inputs:{jogadorId:"jogadorId"},decls:11,vars:5,consts:[["cyContainer",""],["addBtn",""],["removerIcon",""],["addIcon",""],[1,"skilltree-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light","pb-5"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"skilltree-container","w-100"],[1,"page-title"],[1,"nav","nav-tabs","custom-tabs","mb-4"],["class","nav-item",4,"ngFor","ngForOf"],["class","text-center py-5",4,"ngIf"],["class","arvores-scroll",4,"ngIf"],["class","modal-backdrop-blur",4,"ngIf"],["class","modal fade","id","habilidadeModal","tabindex","-1","aria-hidden","true",3,"ngClass",4,"ngIf"],[1,"nav-item"],[1,"nav-link",3,"click"],[1,"text-center","py-5"],[1,"spinner-border","text-light"],[1,"mt-2"],[1,"arvores-scroll"],["class","arvore-card shadow-lg",4,"ngFor","ngForOf"],[1,"arvore-card","shadow-lg"],[1,"arvore-titulo"],[1,"cy-arvore"],[1,"modal-backdrop-blur"],["id","habilidadeModal","tabindex","-1","aria-hidden","true",1,"modal","fade",3,"ngClass"],[1,"modal-dialog","modal-dialog-centered"],[1,"modal-content","bg-dark","text-light","detalhe-card","shadow-lg"],[1,"modal-header","border-0"],[1,"modal-title","fw-bold"],["type","button",1,"btn-close","btn-close-white",3,"click"],[1,"modal-body"],[1,"mb-2"],["class","detalhe-extra",4,"ngIf"],["class","modal-footer border-0 d-flex justify-content-end gap-2",4,"ngIf"],[1,"detalhe-extra"],[1,"modal-footer","border-0","d-flex","justify-content-end","gap-2"],[1,"btn","btn-sm","btn-outline-warning",3,"click"],[4,"ngIf","ngIfElse"],[1,"btn","btn-sm","btn-outline-danger",3,"click","disabled"],[1,"spinner-border","spinner-border-sm"],[1,"btn","btn-sm","btn-outline-success",3,"click","disabled"]],template:function(e,i){e&1&&(c(0,"div",4)(1,"div",5)(2,"div",6)(3,"h2",7),g(4,"\u{1F333} \xC1rvores de Habilidades"),r(),c(5,"ul",8),f(6,ae,3,3,"li",9),r(),f(7,oe,4,0,"div",10)(8,de,2,1,"div",11)(9,le,1,0,"div",12)(10,ue,12,7,"div",13),r()()()),e&2&&(d(6),s("ngForOf",i.caminhos),d(),s("ngIf",i.carregando),d(),s("ngIf",!i.carregando&&i.abaAtiva),d(),s("ngIf",i.habilidadeSelecionada),d(),s("ngIf",i.habilidadeSelecionada))},dependencies:[$,F,q,B],styles:[".page-title[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700;margin-bottom:24px;color:#f1f1f1}.nav-tabs[_ngcontent-%COMP%]{border-bottom:1px solid #333}.nav-tabs[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]{color:#bbb;background:transparent;border:none;font-weight:500;padding:8px 14px;transition:color .2s,border-bottom .2s}.nav-tabs[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]:hover{color:#fff}.nav-tabs[_ngcontent-%COMP%]   .nav-link.active[_ngcontent-%COMP%]{color:#fff;background:transparent;border:none;border-bottom:2px solid #007bff;font-weight:600}.arvores-scroll[_ngcontent-%COMP%]{display:flex;gap:20px;overflow-x:auto;padding-bottom:14px;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}.arvores-scroll[_ngcontent-%COMP%]::-webkit-scrollbar{height:6px}.arvores-scroll[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#444;border-radius:4px}.arvore-card[_ngcontent-%COMP%]{flex:0 0 340px;background:#181818;border-radius:12px;padding:16px;scroll-snap-align:center;transition:transform .2s ease}.arvore-card[_ngcontent-%COMP%]:hover{transform:translateY(-4px)}.arvore-titulo[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:600;margin-bottom:10px;color:#eaeaea;text-align:center}.cy-arvore[_ngcontent-%COMP%]{width:100%;height:65vh;background:#0e0e0e;border-radius:8px}.modal-content[_ngcontent-%COMP%]{background:#1f1f1f;color:#f1f1f1}.modal-header[_ngcontent-%COMP%]   .modal-title[_ngcontent-%COMP%]{font-size:1.2rem;font-weight:700}.modal-body[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.95rem;color:#ccc}.modal-footer[_ngcontent-%COMP%]{gap:8px}.modal-backdrop-blur[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#0f0f0f99;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);z-index:1040}#habilidadeModal[_ngcontent-%COMP%]{z-index:1050}.detalhe-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:.75rem;border:1px solid rgba(255,255,255,.05);color:#f1f1f1;white-space:pre-line}.detalhe-extra[_ngcontent-%COMP%]{font-size:.9rem;color:#aaa}.detalhe-extra[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-weight:600;color:#ddd}.modal-header[_ngcontent-%COMP%]   .modal-title[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:700}.modal-footer[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0}.modal-footer[_ngcontent-%COMP%]   .btn-outline-warning[_ngcontent-%COMP%]{border-color:#ffc107;color:#ffc107}.modal-footer[_ngcontent-%COMP%]   .btn-outline-warning[_ngcontent-%COMP%]:hover{background:#ffc107;color:#000}.modal-footer[_ngcontent-%COMP%]   .btn-outline-danger[_ngcontent-%COMP%]{border-color:#ff4d6d;color:#ff4d6d}.modal-footer[_ngcontent-%COMP%]   .btn-outline-danger[_ngcontent-%COMP%]:hover{background:#ff4d6d;color:#fff}.modal-footer[_ngcontent-%COMP%]   .btn-outline-success[_ngcontent-%COMP%]{border-color:#28a745;color:#28a745}.modal-footer[_ngcontent-%COMP%]   .btn-outline-success[_ngcontent-%COMP%]:hover{background:#28a745;color:#fff}"]})};export{Y as a};
