import{a as D,b as ie}from"./chunk-R66HVWNJ.js";import{a as U}from"./chunk-XQNWO7VY.js";import{a as k}from"./chunk-V3YZ2GSY.js";import{e as F,f as $,g as q,m as B,v as Q,z as N}from"./chunk-7ENCPJQF.js";import{Ab as s,Bb as d,Cb as b,Gb as w,Hb as O,Ib as x,Mb as C,Ob as m,Sb as z,Ta as r,Tb as L,Ub as V,Ya as A,Yb as I,_b as j,a as M,ac as g,b as P,bc as T,cc as y,db as J,f as ee,g as u,ib as f,la as _,lc as R,ma as v,pc as H,zb as c}from"./chunk-DNZPJZVY.js";var Z=ee(ie());var te=["cyContainer"],ne=n=>({"show d-block":n});function ae(n,i){if(n&1){let e=x();s(0,"li",14)(1,"a",15),C("click",function(){let o=_(e).$implicit,l=m();return v(l.selecionarAba(o))}),g(2),d()()}if(n&2){let e=i.$implicit,t=m();r(),j("active",t.abaAtiva===e.id),r(),y(" ",e.caminho," ")}}function oe(n,i){n&1&&(s(0,"div",16),b(1,"div",17),s(2,"p",18),g(3,"Carregando habilidades..."),d()())}function re(n,i){if(n&1&&(s(0,"div",21)(1,"h3",22),g(2),d(),b(3,"div",23,0),d()),n&2){let e=i.$implicit;r(2),T(e.arvore)}}function de(n,i){if(n&1&&(s(0,"div",19),f(1,re,5,1,"div",20),d()),n&2){let e=m();r(),c("ngForOf",e.arvoresAtivas)}}function le(n,i){n&1&&b(0,"div",24)}function se(n,i){if(n&1&&(s(0,"div",36)(1,"span"),g(2,"\u{1F4CC} Requisito:"),d(),b(3,"br"),g(4),d()),n&2){let e=m(2);r(4),y("",e.habilidadeSelecionada.requisitos," ")}}function ce(n,i){n&1&&(w(0),b(1,"span",41),O())}function me(n,i){n&1&&g(0,"\u274C")}function ge(n,i){if(n&1){let e=x();w(0),s(1,"button",40),C("click",function(){_(e);let o=m(3);return v(o.removerHabilidadeJogador(o.habilidadeSelecionada))}),f(2,ce,2,0,"ng-container",39)(3,me,1,0,"ng-template",null,2,H),d(),O()}if(n&2){let e=I(4),t=m(3);r(),c("disabled",t.processando),r(),c("ngIf",t.processando)("ngIfElse",e)}}function pe(n,i){n&1&&(w(0),b(1,"span",41),O())}function fe(n,i){n&1&&g(0,"\u2795")}function be(n,i){if(n&1){let e=x();s(0,"button",42),C("click",function(){_(e);let o=m(3);return v(o.adicionarHabilidadeJogador(o.habilidadeSelecionada))}),f(1,pe,2,0,"ng-container",39)(2,fe,1,0,"ng-template",null,3,H),d()}if(n&2){let e=I(3),t=m(3);c("disabled",t.processando),r(),c("ngIf",t.processando)("ngIfElse",e)}}function he(n,i){if(n&1){let e=x();s(0,"div",37)(1,"button",38),C("click",function(){_(e);let o=m(2);return v(o.editarHabilidade(o.habilidadeSelecionada.id))}),g(2," \u270F\uFE0F "),d(),f(3,ge,5,3,"ng-container",39)(4,be,4,3,"ng-template",null,1,H),d()}if(n&2){let e=I(5),t=m(2);r(3),c("ngIf",t.temHabilidade(t.habilidadeSelecionada==null?null:t.habilidadeSelecionada.id))("ngIfElse",e)}}function ue(n,i){if(n&1){let e=x();s(0,"div",25)(1,"div",26)(2,"div",27)(3,"div",28)(4,"h5",29),g(5),s(6,"span",30),g(7),d()(),s(8,"button",31),C("click",function(){_(e);let o=m();return v(o.fecharModal())}),d()(),s(9,"div",32)(10,"p",33),g(11),d(),f(12,se,5,1,"div",34),d(),f(13,he,6,2,"div",35),d()()()}if(n&2){let e=m();c("ngClass",R(6,ne,e.habilidadeSelecionada)),r(5),y(" ",e.habilidadeSelecionada.habilidade," "),r(2),y("Lv ",e.habilidadeSelecionada.nivel),r(4),T(e.habilidadeSelecionada.descricao),r(),c("ngIf",e.habilidadeSelecionada==null?null:e.habilidadeSelecionada.requisitos),r(),c("ngIf",!e.somenteVisualizacao)}}D.use(Z.default);var Y=class n{constructor(i){this.router=i}jogadorId;cyContainers;cyInstances={};caminhos=[];arvores=[];habilidades=[];habilidadesJogador=[];carregando=!0;habilidadeSelecionada=null;abaAtiva=null;somenteVisualizacao=!1;repoCaminho=new k("Caminhos");repoArvore=new k("Arvores");repoHab=new k("Habilidades");repoHabJog=new k("Habilidades_jogadores");userEmail=null;processando=!1;ngOnInit(){return u(this,null,function*(){this.carregando=!0;try{if(this.jogadorId)this.somenteVisualizacao=!0,this.userEmail=this.jogadorId;else{let i=N.getUser();if(!i?.email)throw new Error("Usu\xE1rio n\xE3o autenticado.");this.userEmail=i.email}if(!this.userEmail)throw new Error("Email do jogador n\xE3o definido.");yield this.loadLocalAndSync(this.userEmail),this.caminhos.length>0&&(this.abaAtiva=this.caminhos[0].id)}catch(i){console.error("[SkillTree] \u274C Erro ao carregar:",i)}finally{this.carregando=!1}})}ngAfterViewInit(){this.cyContainers.changes.subscribe(()=>{this.abaAtiva&&!this.carregando&&this.renderizarArvores()})}get arvoresAtivas(){return this.abaAtiva?this.arvores.filter(i=>String(i.caminho)===String(this.abaAtiva)):[]}normalizeHabJog(i){return i.map(e=>P(M({},e),{habilidade:String(e.habilidade)}))}loadLocalAndSync(i){return u(this,null,function*(){let[e,t,o,l]=yield Promise.all([this.repoCaminho.getLocal(),this.repoArvore.getLocal(),this.repoHab.getLocal(),this.repoHabJog.getLocal()]);this.caminhos=e,this.arvores=t,this.habilidades=o,this.habilidadesJogador=this.normalizeHabJog(l.filter(a=>a.jogador===i)),this.renderizarArvores(),u(this,null,function*(){let[a,h,p,S]=yield Promise.all([this.repoCaminho.sync(),this.repoArvore.sync(),this.repoHab.sync(),this.repoHabJog.sync()]);if(a||h||p||S){let[E,G,K,W]=yield Promise.all([this.repoCaminho.getLocal(),this.repoArvore.getLocal(),this.repoHab.getLocal(),this.repoHabJog.getLocal()]);this.caminhos=E,this.arvores=G,this.habilidades=K,this.habilidadesJogador=this.normalizeHabJog(W.filter(X=>X.jogador===i)),this.renderizarArvores()}})})}renderizarArvores(){this.abaAtiva&&this.cyContainers.forEach((i,e)=>{let t=this.arvoresAtivas[e];if(!t)return;let o=this.habilidades.filter(a=>String(a.arvore)===String(t.id)),l=[];o.forEach(a=>{let h=this.temHabilidade(a.id);l.push({data:P(M({},a),{id:String(a.id),label:`${a.habilidade}
Lv ${a.nivel}`}),classes:h?"habilidade-acquired":""}),a.dependencia&&o.some(p=>String(p.id)===String(a.dependencia))&&l.push({data:{source:String(a.dependencia),target:String(a.id)}})}),this.cyInstances[t.id]&&this.cyInstances[t.id].destroy(),this.cyInstances[t.id]=D({container:i.nativeElement,elements:l,layout:{name:"dagre",rankDir:"TB",nodeSep:120,rankSep:100,edgeSep:30,padding:40},style:[{selector:"node",style:{"background-color":"#222","border-color":"#555","border-width":2,label:"data(label)",color:"#eee","text-valign":"center","text-halign":"center",width:"65px",height:"65px","font-size":"10px","text-wrap":"wrap","text-max-width":"90px"}},{selector:"node.habilidade-acquired",style:{"background-color":"#28a745","border-color":"#fff","border-width":3,color:"#fff"}},{selector:"node.selected",style:{"background-color":"#007bff","border-color":"#fff","border-width":3,color:"#fff"}},{selector:"edge",style:{width:2,"line-color":"#666","curve-style":"unbundled-bezier","control-point-distances":[-30,30],"control-point-weights":[.5,.5]}}],userPanningEnabled:!0,userZoomingEnabled:!0,autoungrabify:!0}),this.cyInstances[t.id].on("tap","node",a=>{this.cyInstances[t.id].nodes().removeClass("selected"),a.target.addClass("selected");let p=String(a.target.data("id")),S=this.habilidades.find(E=>String(E.id)===p)||null;this.selecionarHab(S)})})}selecionarAba(i){this.abaAtiva=i.id,setTimeout(()=>this.renderizarArvores(),0)}selecionarHab(i){this.habilidadeSelecionada=i}editarHabilidade(i){!i||this.somenteVisualizacao||this.router.navigate(["/edicao-skilltree",i])}temHabilidade(i){return i?this.habilidadesJogador.some(e=>String(e.habilidade)===String(i)):!1}coletarDependencias(i){let e=[],t=i;for(;t?.dependencia;){let o=this.habilidades.find(l=>String(l.id)===String(t.dependencia));o&&!this.temHabilidade(o.id)&&e.unshift(o),t=o}return e}coletarDependentes(i){let e=[],t=o=>{let l=this.habilidades.filter(a=>String(a.dependencia)===String(o));for(let a of l)e.push(a),t(String(a.id))};return t(String(i.id)),e}adicionarHabilidadeJogador(i){return u(this,null,function*(){if(this.somenteVisualizacao||this.temHabilidade(i.id))return;let t=[...this.coletarDependencias(i),i],o=t.map(l=>`- ${l.habilidade} (Lv ${l.nivel})`).join(`
`);if(confirm(`\u26A0\uFE0F Deseja realmente adicionar a habilidade?

${o}`)){this.processando=!0;try{let l=t.map(a=>({id:U.generateULID(),jogador:this.userEmail,habilidade:String(a.id),data_aquisicao:new Date().toISOString()}));yield this.repoHabJog.createBatch(l),this.habilidadesJogador=this.normalizeHabJog((yield this.repoHabJog.getLocal()).filter(a=>a.jogador===this.userEmail)),this.renderizarArvores()}finally{this.processando=!1}}})}removerHabilidadeJogador(i){return u(this,null,function*(){if(this.somenteVisualizacao)return;let t=this.coletarDependentes(i).filter(a=>this.temHabilidade(a.id)),o=[i,...t],l=o.map(a=>`- ${a.habilidade} (Lv ${a.nivel})`).join(`
`);if(confirm(`\u26A0\uFE0F Deseja realmente remover a habilidade?

${l}`)){this.processando=!0;try{let h=this.habilidadesJogador.filter(p=>o.some(S=>String(S.id)===String(p.habilidade))).map(p=>p.id);yield this.repoHabJog.deleteBatch(h),this.habilidadesJogador=this.normalizeHabJog((yield this.repoHabJog.getLocal()).filter(p=>p.jogador===this.userEmail)),this.renderizarArvores()}finally{this.processando=!1}}})}fecharModal(){this.habilidadeSelecionada=null}static \u0275fac=function(e){return new(e||n)(A(Q))};static \u0275cmp=J({type:n,selectors:[["app-skilltree"]],viewQuery:function(e,t){if(e&1&&z(te,5),e&2){let o;L(o=V())&&(t.cyContainers=o)}},inputs:{jogadorId:"jogadorId"},decls:11,vars:5,consts:[["cyContainer",""],["addBtn",""],["removerIcon",""],["addIcon",""],[1,"skilltree-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light","pb-5"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"skilltree-container","w-100"],[1,"page-title"],[1,"nav","nav-tabs","custom-tabs","mb-4"],["class","nav-item",4,"ngFor","ngForOf"],["class","text-center py-5",4,"ngIf"],["class","arvores-scroll",4,"ngIf"],["class","modal-backdrop-blur",4,"ngIf"],["class","modal fade","id","habilidadeModal","tabindex","-1","aria-hidden","true",3,"ngClass",4,"ngIf"],[1,"nav-item"],[1,"nav-link",3,"click"],[1,"text-center","py-5"],[1,"spinner-border","text-light"],[1,"mt-2"],[1,"arvores-scroll"],["class","arvore-card shadow-lg",4,"ngFor","ngForOf"],[1,"arvore-card","shadow-lg"],[1,"arvore-titulo"],[1,"cy-arvore"],[1,"modal-backdrop-blur"],["id","habilidadeModal","tabindex","-1","aria-hidden","true",1,"modal","fade",3,"ngClass"],[1,"modal-dialog","modal-dialog-centered"],[1,"modal-content","bg-dark","text-light","detalhe-card","shadow-lg"],[1,"modal-header","border-0"],[1,"modal-title","fw-bold"],[1,"nivel"],["type","button",1,"btn-close","btn-close-white",3,"click"],[1,"modal-body"],[1,"mb-2"],["class","detalhe-extra",4,"ngIf"],["class","modal-footer border-0 d-flex justify-content-end gap-2",4,"ngIf"],[1,"detalhe-extra"],[1,"modal-footer","border-0","d-flex","justify-content-end","gap-2"],[1,"btn","btn-sm","btn-outline-warning",3,"click"],[4,"ngIf","ngIfElse"],[1,"btn","btn-sm","btn-outline-danger",3,"click","disabled"],[1,"spinner-border","spinner-border-sm"],[1,"btn","btn-sm","btn-outline-success",3,"click","disabled"]],template:function(e,t){e&1&&(s(0,"div",4)(1,"div",5)(2,"div",6)(3,"h2",7),g(4,"\u{1F333} \xC1rvores de Habilidades"),d(),s(5,"ul",8),f(6,ae,3,3,"li",9),d(),f(7,oe,4,0,"div",10)(8,de,2,1,"div",11)(9,le,1,0,"div",12)(10,ue,14,8,"div",13),d()()()),e&2&&(r(6),c("ngForOf",t.caminhos),r(),c("ngIf",t.carregando),r(),c("ngIf",!t.carregando&&t.abaAtiva),r(),c("ngIf",t.habilidadeSelecionada),r(),c("ngIf",t.habilidadeSelecionada))},dependencies:[B,F,$,q],styles:[".page-title[_ngcontent-%COMP%]{font-size:1.5rem;font-weight:700;margin-bottom:24px;color:#f1f1f1}.nav-tabs[_ngcontent-%COMP%]{border-bottom:1px solid #333}.nav-tabs[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]{color:#bbb;background:transparent;border:none;font-weight:500;padding:8px 14px;transition:color .2s,border-bottom .2s}.nav-tabs[_ngcontent-%COMP%]   .nav-link[_ngcontent-%COMP%]:hover{color:#fff}.nav-tabs[_ngcontent-%COMP%]   .nav-link.active[_ngcontent-%COMP%]{color:#fff;background:transparent;border:none;border-bottom:2px solid #007bff;font-weight:600}.arvores-scroll[_ngcontent-%COMP%]{display:flex;gap:20px;overflow-x:auto;padding-bottom:14px;scroll-snap-type:x mandatory;-webkit-overflow-scrolling:touch}.arvores-scroll[_ngcontent-%COMP%]::-webkit-scrollbar{height:6px}.arvores-scroll[_ngcontent-%COMP%]::-webkit-scrollbar-thumb{background:#444;border-radius:4px}.arvore-card[_ngcontent-%COMP%]{flex:0 0 340px;background:#181818;border-radius:12px;padding:16px;scroll-snap-align:center;transition:transform .2s ease}.arvore-card[_ngcontent-%COMP%]:hover{transform:translateY(-4px)}.arvore-titulo[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:600;margin-bottom:10px;color:#eaeaea;text-align:center}.cy-arvore[_ngcontent-%COMP%]{width:100%;height:65vh;background:#0e0e0e;border-radius:8px}.modal-content[_ngcontent-%COMP%]{background:#1f1f1f;color:#f1f1f1}.modal-header[_ngcontent-%COMP%]   .modal-title[_ngcontent-%COMP%]{font-size:1.2rem;font-weight:700}.modal-body[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{font-size:.95rem;color:#ccc}.modal-footer[_ngcontent-%COMP%]{gap:8px}.modal-backdrop-blur[_ngcontent-%COMP%]{position:fixed;top:0;left:0;width:100%;height:100%;background:#0f0f0f99;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px);z-index:1040}#habilidadeModal[_ngcontent-%COMP%]{z-index:1050}.detalhe-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:.75rem;border:1px solid rgba(255,255,255,.05);color:#f1f1f1;white-space:pre-line}.detalhe-extra[_ngcontent-%COMP%]{font-size:.9rem;color:#aaa}.detalhe-extra[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-weight:600;color:#ddd}.modal-header[_ngcontent-%COMP%]   .modal-title[_ngcontent-%COMP%]{font-size:1.1rem;font-weight:700}.modal-footer[_ngcontent-%COMP%]   .btn[_ngcontent-%COMP%]{width:32px;height:32px;display:flex;align-items:center;justify-content:center;padding:0}.modal-footer[_ngcontent-%COMP%]   .btn-outline-warning[_ngcontent-%COMP%]{border-color:#ffc107;color:#ffc107}.modal-footer[_ngcontent-%COMP%]   .btn-outline-warning[_ngcontent-%COMP%]:hover{background:#ffc107;color:#000}.modal-footer[_ngcontent-%COMP%]   .btn-outline-danger[_ngcontent-%COMP%]{border-color:#ff4d6d;color:#ff4d6d}.modal-footer[_ngcontent-%COMP%]   .btn-outline-danger[_ngcontent-%COMP%]:hover{background:#ff4d6d;color:#fff}.modal-footer[_ngcontent-%COMP%]   .btn-outline-success[_ngcontent-%COMP%]{border-color:#28a745;color:#28a745}.modal-footer[_ngcontent-%COMP%]   .btn-outline-success[_ngcontent-%COMP%]:hover{background:#28a745;color:#fff}"]})};export{Y as a};
