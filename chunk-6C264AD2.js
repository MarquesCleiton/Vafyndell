import{a as p}from"./chunk-DU24F7PH.js";import{a as E,b as y,c as s,e as S,f as c,g as B,h as j,i as T,j as f,l as g,m as a,n as P,o as w,q as I,r as i,s as v,t as u,y as J}from"./chunk-DNBBXYBI.js";var b=class m{DB_NAME="VafyndellDB";DB_VERSION=1;db=null;storeNames=new Set;static create(){return s(this,null,function*(){let t=new m;return yield t.init(),t})}constructor(){console.log("[IndexedDBClient] Constructor chamado")}init(){return s(this,null,function*(){if(this.db){console.log("[IndexedDBClient] Banco j\xE1 inicializado.");return}let e=(yield indexedDB.databases?.())?.find(r=>r.name===this.DB_NAME);return e?.version&&e.version>this.DB_VERSION&&(this.DB_VERSION=e.version,console.log(`[IndexedDBClient] Ajustando vers\xE3o para ${this.DB_VERSION}`)),new Promise((r,n)=>{console.log(`[IndexedDBClient] Abrindo banco ${this.DB_NAME} v${this.DB_VERSION}...`);let o=indexedDB.open(this.DB_NAME,this.DB_VERSION);o.onerror=()=>n(o.error),o.onsuccess=()=>{this.db=o.result,this.storeNames=new Set(Array.from(this.db.objectStoreNames)),console.log("[IndexedDBClient] Banco aberto com stores:",Array.from(this.storeNames)),r()},o.onupgradeneeded=l=>{let d=l.target.result;console.log("[IndexedDBClient] Upgrade do banco. Stores existentes:",Array.from(d.objectStoreNames))}})})}ensureStore(t){return s(this,null,function*(){if(this.storeNames.has(t))return;console.log(`[IndexedDBClient] Store "${t}" n\xE3o existe \u2192 recriando DB...`),this.db?.close();let n=(yield indexedDB.databases?.())?.find(o=>o.name===this.DB_NAME)?.version??this.DB_VERSION;return this.DB_VERSION=Math.max(this.DB_VERSION,n)+1,new Promise((o,l)=>{let d=indexedDB.open(this.DB_NAME,this.DB_VERSION);d.onerror=()=>l(d.error),d.onupgradeneeded=R=>{let D=R.target.result;D.objectStoreNames.contains(t)||(D.createObjectStore(t,{keyPath:"id"}),console.log(`[IndexedDBClient] Store criada: ${t}`))},d.onsuccess=()=>{this.db=d.result,this.storeNames=new Set(Array.from(this.db.objectStoreNames)),console.log("[IndexedDBClient] Banco reaberto com stores:",Array.from(this.storeNames)),o()}})})}put(t,e){return s(this,null,function*(){return yield this.ensureStore(t),new Promise((r,n)=>{let o=this.db.transaction(t,"readwrite");o.objectStore(t).put(e),o.oncomplete=()=>r(),o.onerror=()=>n(o.error)})})}bulkPut(t,e){return s(this,null,function*(){return yield this.ensureStore(t),new Promise((r,n)=>{let o=this.db.transaction(t,"readwrite"),l=o.objectStore(t);e.forEach(d=>l.put(d)),o.oncomplete=()=>r(),o.onerror=()=>n(o.error)})})}get(t,e){return s(this,null,function*(){return this.storeNames.has(t)?new Promise((r,n)=>{let l=this.db.transaction(t,"readonly").objectStore(t).get(e);l.onsuccess=()=>r(l.result||null),l.onerror=()=>n(l.error)}):null})}getAll(t){return s(this,null,function*(){return this.storeNames.has(t)?new Promise((e,r)=>{let o=this.db.transaction(t,"readonly").objectStore(t).getAll();o.onsuccess=()=>e(o.result),o.onerror=()=>r(o.error)}):[]})}delete(t,e){return s(this,null,function*(){if(this.storeNames.has(t))return new Promise((r,n)=>{let o=this.db.transaction(t,"readwrite");o.objectStore(t).delete(e),o.oncomplete=()=>r(),o.onerror=()=>n(o.error)})})}clear(t){return s(this,null,function*(){if(this.storeNames.has(t))return new Promise((e,r)=>{let n=this.db.transaction(t,"readwrite");n.objectStore(t).clear(),n.oncomplete=()=>e(),n.onerror=()=>r(n.error)})})}deleteDatabase(){return s(this,null,function*(){return console.log("[IndexedDBClient] deleteDatabase \u2192 resetando banco..."),this.db&&(this.db.close(),this.db=null),new Promise((t,e)=>{let r=indexedDB.deleteDatabase(this.DB_NAME);r.onsuccess=()=>{this.storeNames.clear(),this.DB_VERSION=1,console.log("[IndexedDBClient] Banco deletado com sucesso."),t()},r.onerror=()=>e(r.error)})})}};var x=class{static ENDPOINT="https://script.google.com/macros/s/AKfycby-ec_h6sljntLAgoWhpeyBFGTkWygqS7Xx1Yvkx8RKDKiXDHPxtHZ8hhh6vrN91JEL/exec";static SHEET_ID="19B2aMGrajvhPJfOvYXt059-fECytaN38iFsP8GInD_g";static call(t,e){return s(this,null,function*(){let r=p.getIdToken();if(!r)throw new Error("Usu\xE1rio n\xE3o autenticado.");let n={idToken:r,action:t,payload:y(E({},e),{sheetId:this.SHEET_ID})};console.log("\u27A1\uFE0F Enviando para Script:",this.ENDPOINT,n);let o=yield fetch(this.ENDPOINT,{method:"POST",body:JSON.stringify(n)}),l=yield o.text();if(!o.ok)throw console.error("\u274C Erro bruto do Script:",l),new Error(`Erro no Script: ${o.status} - ${o.statusText}
${l}`);try{return JSON.parse(l)}catch(d){throw console.error("\u274C Resposta n\xE3o-JSON:",l),d}})}static createRow(t){return this.call("sheet.createRow",t)}static getAll(t){return this.call("sheet.getAll",t)}static getByIndex(t){return this.call("sheet.getByIndex",t)}static getCell(t){return this.call("sheet.getCell",t)}static updateByIndex(t){return this.call("sheet.updateByIndex",t)}static updateCell(t){return this.call("sheet.updateCell",t)}static deleteByIndex(t){return this.call("sheet.deleteByIndex",t)}static upload(t){return this.call("drive.upload",t)}static update(t){return this.call("drive.update",t)}static remove(t){return this.call("drive.delete",t)}static controllerCreate(t){return this.call("controller.create",t)}static controllerGetAll(t){return this.call("controller.getAll",t)}static controllerGetByIndex(t){return this.call("controller.getByIndex",t)}static controllerGetCell(t){return this.call("controller.getCell",t)}static controllerUpdateByIndex(t){return this.call("controller.updateByIndex",t)}static controllerUpdateCell(t){return this.call("controller.updateCell",t)}static controllerDeleteByIndex(t){return this.call("controller.deleteByIndex",t)}};var h=class{static TAB="Personagem";static STORE=this.TAB;static META_STORE="metadados";static dbPromise=null;static getDb(){return s(this,null,function*(){return this.dbPromise||(console.log("[JogadorRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=b.create()),this.dbPromise})}static getLocalJogador(){return s(this,null,function*(){let t=p.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");let r=yield(yield this.getDb()).getAll(this.STORE);return console.log("[JogadorRepository] getLocalJogador \u2192 total encontrados:",r.length),r.find(n=>n.email===t.email)||null})}static forceFetchJogador(){return s(this,null,function*(){let t=p.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");console.log("[JogadorRepository] Baixando lista online...");let e=yield x.controllerGetAll({tab:this.TAB});if(!e.length)return console.warn("[JogadorRepository] Nenhum jogador encontrado online."),null;let r=e.map(d=>y(E({},d),{id:d.index})),n=yield this.getDb();yield n.clear(this.STORE),yield n.bulkPut(this.STORE,r),console.log("[JogadorRepository] Cache atualizado com lista online.");let l=(yield x.controllerGetAll({tab:"Metadados"})).find(d=>d.SheetName===this.TAB);return l&&(yield n.put(this.META_STORE,{id:this.TAB,UltimaModificacao:l.UltimaModificacao}),console.log("[JogadorRepository] Metadados locais atualizados:",l)),r.find(d=>d.email===t.email)||null})}static syncJogadores(){return s(this,null,function*(){console.log("[JogadorRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let e=(yield x.controllerGetAll({tab:"Metadados"})).find(l=>l.SheetName===this.TAB);if(!e)return console.warn("[JogadorRepository] Nenhum metadado online encontrado."),!1;let n=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!n||n.UltimaModificacao!==e.UltimaModificacao?(console.log("[JogadorRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchJogador(),!0):(console.log("[JogadorRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}static getCurrentJogador(){return s(this,null,function*(){if(console.log("[JogadorRepository] getCurrentJogador iniciado."),!p.getUser())throw console.error("[JogadorRepository] Usu\xE1rio n\xE3o autenticado."),new Error("Usu\xE1rio n\xE3o autenticado.");let e=yield this.getLocalJogador();return e?(console.log("[JogadorRepository] Retornando jogador local:",e),this.syncJogadores().then(r=>s(this,null,function*(){r&&(console.log("[JogadorRepository] Cache atualizado \u2192 recarregando jogador."),e=yield this.getLocalJogador())})).catch(r=>{console.error("[JogadorRepository] Erro ao sincronizar em paralelo:",r)}),e):(console.log("[JogadorRepository] Nenhum jogador local \u2192 buscando online..."),yield this.forceFetchJogador())})}};function A(m,t){if(m&1&&P(0,"img",4),m&2){let e=I(2);w("src",e.jogador==null?null:e.jogador.imagem,S)}}function _(m,t){if(m&1&&(g(0,"h2",2),i(1),a(),g(2,"p",3),i(3),a(),T(4,A,1,1,"img",4),g(5,"div",5)(6,"div",6)(7,"p")(8,"strong"),i(9,"Personagem:"),a(),i(10),a(),g(11,"p")(12,"strong"),i(13,"Classe de Armadura:"),a(),i(14),a(),g(15,"p")(16,"strong"),i(17,"Pontos de Vida:"),a(),i(18),a(),g(19,"p")(20,"strong"),i(21,"N\xEDvel:"),a(),i(22),a(),g(23,"p")(24,"strong"),i(25,"XP:"),a(),i(26),a(),g(27,"p")(28,"strong"),i(29,"For\xE7a:"),a(),i(30),a(),g(31,"p")(32,"strong"),i(33,"Destreza:"),a(),i(34),a(),g(35,"p")(36,"strong"),i(37,"Constitui\xE7\xE3o:"),a(),i(38),a(),g(39,"p")(40,"strong"),i(41,"Intelig\xEAncia:"),a(),i(42),a(),g(43,"p")(44,"strong"),i(45,"Sabedoria:"),a(),i(46),a(),g(47,"p")(48,"strong"),i(49,"Carisma:"),a(),i(50),a()()()),m&2){let e=I();c(),v(e.jogador==null?null:e.jogador.nome_do_jogador),c(2),v(e.jogador==null?null:e.jogador.email),c(),f(e.jogador!=null&&e.jogador.imagem?4:-1),c(6),u(" ",e.jogador==null?null:e.jogador.personagem),c(4),u(" ",e.jogador==null?null:e.jogador.classe_de_armadura),c(4),u(" ",e.jogador==null?null:e.jogador.pontos_de_vida),c(4),u(" ",e.jogador==null?null:e.jogador.nivel),c(4),u(" ",e.jogador==null?null:e.jogador.xp),c(4),u(" ",e.jogador==null?null:e.jogador.forca),c(4),u(" ",e.jogador==null?null:e.jogador.destreza),c(4),u(" ",e.jogador==null?null:e.jogador.constituicao),c(4),u(" ",e.jogador==null?null:e.jogador.inteligencia),c(4),u(" ",e.jogador==null?null:e.jogador.sabedoria),c(4),u(" ",e.jogador==null?null:e.jogador.carisma)}}function N(m,t){m&1&&(g(0,"div",1)(1,"div",7)(2,"span",8),i(3,"Carregando..."),a()()())}var C=class m{constructor(t){this.router=t}jogador=null;loading=!0;ngOnInit(){return s(this,null,function*(){console.log("[Jogador] ngOnInit \u2192 carregando jogador...");try{let t=yield h.getLocalJogador();if(console.log(t),t)console.log("[Jogador] Jogador local encontrado:",t),this.jogador=t,this.loading=!1,h.syncJogadores().then(e=>s(this,null,function*(){e&&(console.log("[Jogador] Cache atualizado. Recarregando jogador..."),this.jogador=yield h.getLocalJogador())}));else{console.log("[Jogador] Nenhum jogador local. Tentando buscar online...");let e=yield h.forceFetchJogador();e?(this.jogador=e,this.loading=!1):(console.warn("[Jogador] Nenhum jogador encontrado online \u2192 redirecionando para o cadastro"),this.router.navigate(["/cadastro_jogador"]))}}catch(t){console.error("[Jogador] Erro ao carregar Jogador:",t),this.router.navigate(["/login"])}})}static \u0275fac=function(e){return new(e||m)(B(J))};static \u0275cmp=j({type:m,selectors:[["app-jogador"]],decls:3,vars:1,consts:[[1,"container","mt-5"],[1,"text-center","mt-5"],[1,"text-center"],[1,"text-center","text-muted"],["alt","Avatar",1,"img-thumbnail","mb-3",2,"max-width","150px","display","block","margin","auto",3,"src"],[1,"card","mt-4","shadow-sm"],[1,"card-body"],["role","status",1,"spinner-border","text-primary"],[1,"visually-hidden"]],template:function(e,r){e&1&&(g(0,"div",0),T(1,_,51,14)(2,N,4,0,"div",1),a()),e&2&&(c(),f(r.loading?2:1))},encapsulation:2})};export{C as Jogador};
