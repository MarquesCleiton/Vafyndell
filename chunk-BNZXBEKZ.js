import{a as he,d as ve,e as be,h as Ie,o as De,p as xe,q as we,r as Te,u as Me,v as qe}from"./chunk-TLUVVG3W.js";import{A as oe,B as re,K as de,N as se}from"./chunk-UM67JOGK.js";import{a as j}from"./chunk-XQNWO7VY.js";import{c as le,f as ce,i as me,k as ue,p as pe,q as ge,s as fe}from"./chunk-AE35642N.js";import{a as y}from"./chunk-J5FBOTGS.js";import{f as ne,h as ae}from"./chunk-SEBSZRO5.js";import{e as Z,h as ee,i as te,q as ie,x as _e}from"./chunk-IJWXOQAR.js";import{Ab as p,Bb as r,Cb as o,Db as H,Hb as P,Ib as A,Jb as V,Nb as g,Pb as f,Ua as u,Za as E,Zb as J,a as S,b as C,bc as m,cc as Q,dc as K,eb as G,ec as X,g as O,gc as w,hc as T,ic as M,jb as I,la as l,ma as c}from"./chunk-O42C4TWY.js";function ke(s,t){if(s&1&&(r(0,"mat-option",27),m(1),o()),s&2){let e=t.$implicit;p("value",e),u(),K(" \u{1F64D} ",e.personagem," ")}}function $e(s,t){if(s&1){let e=V();r(0,"div",33)(1,"div",34)(2,"span",35),m(3,"\u{1F4E6}"),o(),r(4,"span",36),m(5),o()(),r(6,"div",37)(7,"button",38),g("click",function(){let i=l(e).$implicit,a=f(2);return i.quantidade=a.ajustarQuantidadeMin(i.quantidade-1,1),c(a.atualizarQuantidade(i))}),m(8,"\u2212"),o(),r(9,"input",39),M("ngModelChange",function(i){let a=l(e).$implicit;return T(a.quantidade,i)||(a.quantidade=i),c(i)}),g("blur",function(){let i=l(e).$implicit,a=f(2);return c(a.atualizarQuantidade(i))}),o(),r(10,"button",38),g("click",function(){let i=l(e).$implicit,a=f(2);return i.quantidade=a.ajustarQuantidadeMax(i.quantidade+1,i.item.quantidade),c(a.atualizarQuantidade(i))}),m(11,"\uFF0B"),o()(),r(12,"button",40),g("click",function(){let i=l(e).index,a=f(2);return c(a.removerItem(i))}),m(13,"\u2716"),o()()}if(s&2){let e=t.$implicit;u(5),Q(e.item.itemDetalhe==null?null:e.item.itemDetalhe.nome),u(4),w("ngModel",e.quantidade),p("max",e.item.quantidade)}}function Fe(s,t){if(s&1&&(r(0,"div",28)(1,"div",29)(2,"h5",30),m(3,"\u{1F9FA} Itens Selecionados"),o(),r(4,"span",31),m(5),o()(),I(6,$e,14,3,"div",32),o()),s&2){let e=f();u(5),Q(e.itensTroca.length),u(),p("ngForOf",e.itensTroca)}}function Le(s,t){if(s&1&&(r(0,"mat-option",27)(1,"div",41)(2,"span"),m(3,"\u{1F4E6}"),o(),r(4,"span"),m(5),o()()()),s&2){let e=t.$implicit;p("value",e),u(5),X("",e.itemDetalhe==null?null:e.itemDetalhe.nome," (x",e.quantidade,")")}}function Re(s,t){if(s&1){let e=V();r(0,"div",42)(1,"div",43)(2,"button",44),g("click",function(){l(e);let i=f();return c(i.decrementar())}),m(3,"\u2212"),o(),r(4,"input",45),M("ngModelChange",function(i){l(e);let a=f();return T(a.quantidade,i)||(a.quantidade=i),c(i)}),g("input",function(){l(e);let i=f();return i.validarQuantidade(),c(i.filtrarItensInventario())})("blur",function(){l(e);let i=f();return i.validarQuantidade(),c(i.filtrarItensInventario())}),o(),r(5,"button",44),g("click",function(){l(e);let i=f();return c(i.incrementar())}),m(6,"\uFF0B"),o()(),r(7,"button",46),g("click",function(){l(e);let i=f();return c(i.adicionarItem())}),m(8,"\u2795"),o()()}if(s&2){let e=f();u(4),w("ngModel",e.quantidade),p("max",e.itemSelecionado?e.itemSelecionado.quantidade:0)}}function Oe(s,t){s&1&&(P(0),m(1,"\u{1F4E4}"),A())}function Pe(s,t){s&1&&(P(0),H(1,"span",47),A())}var Se=class s{constructor(t,e,n){this.router=t;this.route=e;this.location=n}jogadores=[];jogadoresFiltrados=[];filtroJogador="";jogadorSelecionado=null;inventario=[];inventarioFiltrado=[];filtroItem="";itemSelecionado=null;quantidade=1;itensTroca=[];processando=!1;emailLogado="";jogadoresRepo=new y("Personagem");inventarioRepo=new y("Inventario");catalogoRepo=new y("Catalogo");descricaoTransferencia="";ngOnInit(){return O(this,null,function*(){let t=_e.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");this.emailLogado=t.email,this.jogadores=(yield this.jogadoresRepo.getLocal()).filter(a=>a.email!==this.emailLogado).filter(a=>a.nome_do_jogador!=="NPC"),this.jogadoresFiltrados=[...this.jogadores];let[e,n]=yield Promise.all([this.inventarioRepo.getLocal(),this.catalogoRepo.getLocal()]);this.inventario=e.filter(a=>a.jogador===this.emailLogado).map(a=>C(S({},a),{itemDetalhe:n.find(d=>String(d.id)===String(a.item_catalogo))})),this.inventarioFiltrado=[...this.inventario];let i=this.route.snapshot.paramMap.get("id");if(i){let a=this.inventario.find(d=>String(d.id)===i);a&&(this.itemSelecionado=a,this.filtroItem=a.itemDetalhe?.nome||"",this.quantidade=1)}})}filtrarJogadores(){let t=this.filtroJogador.toLowerCase().trim();this.jogadoresFiltrados=t?this.jogadores.filter(e=>e.personagem.toLowerCase().includes(t)):[...this.jogadores]}selecionarJogador(t){this.jogadorSelecionado=t,this.filtroJogador=t.personagem}filtrarItensInventario(){let t=this.filtroItem.toLowerCase().trim();this.inventarioFiltrado=this.inventario.map(e=>{let n=this.itensTroca.filter(a=>a.item.id===e.id).reduce((a,d)=>a+d.quantidade,0),i=e.quantidade-n;return i>0?C(S({},e),{quantidade:i}):null}).filter(e=>e!==null).filter(e=>t?e.itemDetalhe?.nome?.toLowerCase().includes(t):!0)}adicionarItem(){if(!this.itemSelecionado)return;let t=this.itensTroca.find(e=>e.item.id===this.itemSelecionado.id);t?t.quantidade=Math.min(t.quantidade+this.quantidade,this.itemSelecionado.quantidade+t.quantidade):this.itensTroca.push({item:this.itemSelecionado,quantidade:this.quantidade}),this.itemSelecionado=null,this.filtroItem="",this.quantidade=1,this.filtrarItensInventario()}selecionarItem(t){this.itemSelecionado=t,this.filtroItem=t.itemDetalhe?.nome||"",this.quantidade=1}incrementar(){if(!this.itemSelecionado)return;let t=this.itemSelecionado.quantidade;this.quantidade=Math.min(this.quantidade+1,t)}decrementar(){this.quantidade=Math.max(1,this.quantidade-1)}validarQuantidade(){if(!this.itemSelecionado)return;let t=this.itemSelecionado.quantidade;this.quantidade>t&&(this.quantidade=t),this.quantidade<1&&(this.quantidade=1)}removerItem(t){this.itensTroca.splice(t,1),this.filtrarItensInventario()}confirmarTroca(){return O(this,null,function*(){if(!this.jogadorSelecionado){alert("\u26A0\uFE0F Selecione um jogador destinat\xE1rio!");return}if(this.itensTroca.length===0){alert("\u26A0\uFE0F Adicione ao menos um item para trocar!");return}this.processando=!0;try{let t=(this.descricaoTransferencia||"").trim(),e=this.jogadorSelecionado.email,n=this.jogadorSelecionado.personagem,a=(yield this.jogadoresRepo.getLocal()).find(D=>D.email===this.emailLogado)?.personagem||"Desconhecido",d=yield this.inventarioRepo.getLocal(),k=[],W=[],B=[],$=[],N=[];for(let D of this.itensTroca){let _=D.item,z=_.itemDetalhe?.nome||"Item desconhecido",q=_.itemDetalhe?.unidade_medida||"unidade",h=D.quantidade;h>_.quantidade&&(h=_.quantidade);let F=_.quantidade,L=F-h,U=`Quantidade: ${F} \u2192 ${L} (-${h} ${q})
Transferido para ${n}`+(t?`
${t}`:""),Ve=_.descricao?`${U}
---
${_.descricao.trim()}`:U,Y=C(S({},_),{quantidade:L,descricao:Ve});Y.quantidade>0?k.push(Y):B.push(_.id);let x=d.find(b=>b.jogador===e&&b.item_catalogo===_.item_catalogo),R=0,v=0;if(x){R=x.quantidade,v=x.quantidade+h;let b=`Quantidade: ${R} \u2192 ${v} (+${h} ${q})
Recebido de ${a}`+(t?`
${t}`:""),je=x.descricao?`${b}
---
${x.descricao.trim()}`:b;k.push(C(S({},x),{quantidade:v,descricao:je}))}else{v=h;let b=`Quantidade: 0 \u2192 ${v} (+${h} ${q})
Recebido de ${a}`+(t?`
${t}`:"");W.push({id:j.generateULID(),index:Date.now(),jogador:e,item_catalogo:_.item_catalogo,quantidade:v,descricao:b})}$.push(`\u{1F392} ${z}: ${F} \u2192 ${L} (-${h} ${q})`),N.push(`\u{1F392} ${z}: ${R} \u2192 ${v} (+${h} ${q})`)}let Ce={id:j.generateULID(),jogador:this.emailLogado,alvo:e,tipo:"transferencia",acao:"envio",detalhes:`\u{1F4E6} ${a} transferiu itens para ${n}
`+$.join(`
`)+(t?`
\u{1F4DD} ${t}`:""),data:new Date().toISOString()},ye={id:j.generateULID(),jogador:e,alvo:this.emailLogado,tipo:"transferencia",acao:"recebimento",detalhes:`\u{1F381} ${n} recebeu itens de ${a}
`+N.join(`
`)+(t?`
\u{1F4DD} ${t}`:""),data:new Date().toISOString()};yield y.batch({updateById:{Inventario:k},create:{Inventario:W,Registro:[Ce,ye]},deleteById:{Inventario:B.map(D=>({id:D}))}});let Ee=`\u{1F381} Voc\xEA transferiu itens para ${n}
`+$.join(`
`)+(t?`
\u{1F4DD} ${t}`:"");alert(Ee),this.cancelar()}catch(t){console.error("[TrocaDeItens] Erro na troca:",t),alert("\u274C Erro ao processar a troca")}finally{this.processando=!1}})}cancelar(){this.location.back()}ajustarQuantidade(t,e){let n=this.itensTroca[t],i=n.item.quantidade,a=Math.min(Math.max(1,n.quantidade+e),i);this.itensTroca[t].quantidade=a}validarQuantidadeTroca(t){let e=this.itensTroca[t],n=e.item.quantidade;e.quantidade>n&&(e.quantidade=n),e.quantidade<1&&(e.quantidade=1)}atualizarDisponiveis(){this.filtrarItensInventario()}ajustarQuantidadeMin(t,e){return Math.max(t,e)}ajustarQuantidadeMax(t,e){return Math.min(t,e??t)}atualizarQuantidade(t){let e=t.item.quantidade;t.quantidade>e&&(t.quantidade=e),t.quantidade<1&&(t.quantidade=1),this.filtrarItensInventario()}static \u0275fac=function(e){return new(e||s)(E(ae),E(ne),E(Z))};static \u0275cmp=G({type:s,selectors:[["app-troca-de-itens"]],decls:37,vars:12,consts:[["autoJog","matAutocomplete"],["autoItem","matAutocomplete"],[1,"troca-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light","pb-5","mb-5"],[1,"flex-grow-1","p-3","d-flex","justify-content-center","pb-5","mb-5"],[1,"troca-container","w-100"],[1,"card","detalhe-card","shadow-lg","border-0"],[1,"card-body","p-3","border-bottom","d-flex","align-items-center","gap-2"],[1,"fw-bold","mb-0","text-light"],[1,"card-body"],[1,"mb-3"],[1,"form-label","text-light"],["appearance","fill",1,"w-100","input-dark","compact-select","dropdown-field"],["type","text","matInput","","placeholder","Selecione ou pesquise...","name","filtroJogador",3,"ngModelChange","input","ngModel","matAutocomplete"],[3,"optionSelected"],["class","bg-dark text-light",3,"value",4,"ngFor","ngForOf"],["class","itens-selecionados",4,"ngIf"],[1,"novo-item","bg-dark","rounded","p-2","mb-3","mt-3"],["appearance","fill",1,"w-100","input-dark","compact-select","dropdown-field","mb-2"],["type","text","matInput","","placeholder","Pesquisar item no invent\xE1rio...","name","filtroItem",3,"ngModelChange","input","ngModel","matAutocomplete"],["mat-icon-button","","matSuffix","","disabled","",1,"dropdown-arrow"],["class","d-flex align-items-center justify-content-between mt-2",4,"ngIf"],[1,"mb-3","mt-3"],["rows","3","name","descricaoTransferencia","placeholder","Ex: Entregue em miss\xE3o, troca amig\xE1vel, ajuda ao grupo...",1,"form-control","input-dark","auto-expand",3,"ngModelChange","ngModel"],[1,"fab-stack"],[1,"fab","fab-success",3,"click","disabled"],[4,"ngIf"],[1,"fab","fab-warning",3,"click"],[1,"bg-dark","text-light",3,"value"],[1,"itens-selecionados"],[1,"d-flex","align-items-center","justify-content-between","mb-2"],[1,"fw-bold","text-light","mb-0"],[1,"badge","bg-secondary"],["class","item-card bg-dark rounded p-2 mb-2 d-flex align-items-center justify-content-between gap-2",4,"ngFor","ngForOf"],[1,"item-card","bg-dark","rounded","p-2","mb-2","d-flex","align-items-center","justify-content-between","gap-2"],[1,"d-flex","align-items-center","gap-2","flex-grow-1"],[1,"fs-5"],[1,"fw-semibold","text-light"],[1,"item-quantidade"],["type","button",3,"click"],["type","number","min","1",3,"ngModelChange","blur","ngModel","max"],["type","button",1,"btn","btn-sm","btn-danger","px-2",3,"click"],[1,"d-flex","align-items-center","gap-2"],[1,"d-flex","align-items-center","justify-content-between","mt-2"],[1,"quantidade-box"],["type","button",1,"btn","btn-sm","btn-outline-light",3,"click"],["type","number","min","1",1,"quantidade-input",3,"ngModelChange","input","blur","ngModel","max"],["type","button",1,"btn","btn-success","ms-2",3,"click"],[1,"spinner-border","spinner-border-sm"]],template:function(e,n){if(e&1){let i=V();r(0,"div",2)(1,"div",3)(2,"div",4)(3,"div",5)(4,"div",6)(5,"h4",7),m(6,"\u{1F504} Troca de Itens"),o()(),r(7,"div",8)(8,"div",9)(9,"label",10),m(10,"\u{1F64D} Jogador Destinat\xE1rio *"),o(),r(11,"mat-form-field",11)(12,"input",12),M("ngModelChange",function(d){return l(i),T(n.filtroJogador,d)||(n.filtroJogador=d),c(d)}),g("input",function(){return l(i),c(n.filtrarJogadores())}),o(),r(13,"mat-autocomplete",13,0),g("optionSelected",function(d){return l(i),c(n.selecionarJogador(d.option.value))}),I(15,ke,2,2,"mat-option",14),o()()(),I(16,Fe,7,2,"div",15),r(17,"div",16)(18,"mat-form-field",17)(19,"input",18),M("ngModelChange",function(d){return l(i),T(n.filtroItem,d)||(n.filtroItem=d),c(d)}),g("input",function(){return l(i),c(n.filtrarItensInventario())}),o(),r(20,"button",19)(21,"mat-icon"),m(22,"arrow_drop_down"),o()(),r(23,"mat-autocomplete",13,1),g("optionSelected",function(d){return l(i),c(n.selecionarItem(d.option.value))}),I(25,Le,6,3,"mat-option",14),o()(),I(26,Re,9,2,"div",20),o(),r(27,"div",21)(28,"label",10),m(29,"\u{1F4DD} Descri\xE7\xE3o da transfer\xEAncia (opcional)"),o(),r(30,"textarea",22),M("ngModelChange",function(d){return l(i),T(n.descricaoTransferencia,d)||(n.descricaoTransferencia=d),c(d)}),o()()()()()(),r(31,"div",23)(32,"button",24),g("click",function(){return l(i),c(n.confirmarTroca())}),I(33,Oe,2,0,"ng-container",25)(34,Pe,2,0,"ng-container",25),o(),r(35,"button",26),g("click",function(){return l(i),c(n.cancelar())}),m(36,"\u2B05\uFE0F"),o()()()}if(e&2){let i=J(14),a=J(24);u(12),w("ngModel",n.filtroJogador),p("matAutocomplete",i),u(3),p("ngForOf",n.jogadoresFiltrados),u(),p("ngIf",n.itensTroca.length>0),u(3),w("ngModel",n.filtroItem),p("matAutocomplete",a),u(6),p("ngForOf",n.inventarioFiltrado),u(),p("ngIf",n.itemSelecionado),u(4),w("ngModel",n.descricaoTransferencia),u(2),p("disabled",n.processando||!n.jogadorSelecionado||n.itensTroca.length===0),u(),p("ngIf",!n.processando),u(),p("ngIf",n.processando)}},dependencies:[ie,ee,te,fe,le,ue,ce,ge,pe,me,be,ve,he,Te,xe,Ie,we,qe,Me,De,se,de,re,oe],styles:[".registro-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:10px;border:1px solid #333;margin-bottom:.75rem;transition:transform .15s ease,box-shadow .15s ease}.registro-card[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 12px #0000004d}.btn-categoria[_ngcontent-%COMP%]{background:#2a2a2a;border:1px solid #444;border-radius:8px;padding:8px 12px;color:#fff;font-weight:700}.btn-categoria[_ngcontent-%COMP%]:hover{background:#333}.registro-hora[_ngcontent-%COMP%]{color:#ccc;font-size:.85rem}.descricao-text[_ngcontent-%COMP%]{line-height:1.5;color:#eee}.filtro-visao[_ngcontent-%COMP%]{background:#111;border:1px solid #333;color:#eee;font-weight:500;border-radius:8px;padding:6px 10px}.filtro-visao[_ngcontent-%COMP%]   option[_ngcontent-%COMP%]{background:#222;color:#fff}.search-bar[_ngcontent-%COMP%]{background:#111;color:#fff;border:1px solid #333}.search-bar[_ngcontent-%COMP%]::placeholder{color:#aaa}"]})};export{Se as TrocaDeItens};
