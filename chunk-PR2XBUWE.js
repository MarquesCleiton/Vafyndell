import{a as v,b as r}from"./chunk-UM5RQUOR.js";import{a as s,ac as d,b as c,d as n}from"./chunk-Y44Y2XZC.js";var m=class{static TAB="Inventario";static STORE=this.TAB;static META_STORE="metadados";static dbPromise=null;static getDb(){return n(this,null,function*(){return this.dbPromise||(console.log("[InventarioRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=v.create()),this.dbPromise})}static createInventario(t){return n(this,null,function*(){console.log("[InventarioRepository] Criando novo registro de invent\xE1rio...",t);let a=yield r.controllerCreate({tab:this.TAB,attrs:t}),o=c(s({},a),{id:a?.index||Date.now()});return yield(yield this.getDb()).put(this.STORE,o),console.log("[InventarioRepository] Registro criado e salvo no cache:",o),o})}static updateInventario(t){return n(this,null,function*(){console.log("[InventarioRepository] Atualizando invent\xE1rio...",t);let a=yield r.controllerUpdateByIndex({tab:this.TAB,index:t.id,attrs:t}),o=s(s({},t),a);return yield(yield this.getDb()).put(this.STORE,o),console.log("[InventarioRepository] Invent\xE1rio atualizado no cache local:",o),o})}static deleteInventario(t){return n(this,null,function*(){return console.log("[InventarioRepository] Deletando invent\xE1rio...",t),yield r.controllerDeleteByIndex({tab:this.TAB,index:t}),yield(yield this.getDb()).delete(this.STORE,t),console.log("[InventarioRepository] Registro exclu\xEDdo do cache/local:",t),!0})}static getAllInventario(){return n(this,null,function*(){console.log("[InventarioRepository] getAllInventario...");let t=yield r.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t:[]})}static getLocalInventarioByJogador(t){return n(this,null,function*(){let o=yield(yield this.getDb()).getAll(this.STORE);return console.log("[InventarioRepository] getLocalInventarioByJogador \u2192 total encontrados:",o.length),o.filter(e=>e.jogador===t)})}static forceFetchInventario(){return n(this,null,function*(){let t=d.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");console.log("[InventarioRepository] Baixando lista online...");let o=(yield this.getAllInventario()).map(i=>c(s({},i),{id:i.index??i.id})),e=yield this.getDb();yield e.clear(this.STORE),yield e.bulkPut(this.STORE,o),console.log("[InventarioRepository] Cache atualizado com lista online.");let l=yield r.controllerGetAll({tab:"Metadados"});if(Array.isArray(l)){let i=l.find(I=>I.SheetName===this.TAB);i&&(yield e.put(this.META_STORE,{id:this.TAB,UltimaModificacao:i.UltimaModificacao}),console.log("[InventarioRepository] Metadados locais atualizados:",i))}return o.filter(i=>i.jogador===t.email)})}static syncInventario(){return n(this,null,function*(){console.log("[InventarioRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let t=yield r.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let a=t.find(i=>i.SheetName===this.TAB);if(!a)return console.warn("[InventarioRepository] Nenhum metadado online encontrado."),!1;let e=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!e||e.UltimaModificacao!==a.UltimaModificacao?(console.log("[InventarioRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchInventario(),!0):(console.log("[InventarioRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}};export{m as a};
