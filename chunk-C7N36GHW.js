import{a as x}from"./chunk-QSXRPDPU.js";import{a as I}from"./chunk-HXJSPHLL.js";import{b as K,c as X,f as Z,i as ee,r as ie}from"./chunk-2MTP6EBK.js";import{a as te,b as h}from"./chunk-2P6BNU5L.js";import{e as G,f as J,g as Q,j as Y,s as H,v as E}from"./chunk-HRLERFBW.js";import{$b as R,Fb as F,Jb as O,Lb as p,Pa as T,Qa as o,Va as A,Yb as $,Zb as m,_ as U,_b as w,a as _,ab as L,ac as j,b as v,cc as k,d,dc as z,ec as q,fb as g,fc as N,gc as V,ia as S,ja as M,jc as W,wb as l,xb as r,yb as c,zb as C}from"./chunk-QQSIVCMV.js";var b=class{static TAB="Receitas";static STORE=this.TAB;static META_STORE="metadados";static dbPromise=null;static getDb(){return d(this,null,function*(){return this.dbPromise||(console.log("[ReceitasRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=te.create()),this.dbPromise})}static createReceita(i){return d(this,null,function*(){console.log("[ReceitasRepository] Criando nova receita...",i);let e=yield h.controllerCreate({tab:this.TAB,attrs:i}),t=v(_({},e),{id:Number(e?.id)||Date.now(),index:e?.index});return yield(yield this.getDb()).put(this.STORE,t),console.log("[ReceitasRepository] Receita criada e salva no cache:",t),t})}static updateReceita(i){return d(this,null,function*(){console.log("[ReceitasRepository] Atualizando receita...",i);let e=yield h.controllerUpdateByIndex({tab:this.TAB,index:i.index,attrs:i}),t=v(_(_({},i),e),{id:Number(e?.id||i.id),index:e?.index||i.index});return yield(yield this.getDb()).put(this.STORE,t),console.log("[ReceitasRepository] Receita atualizada no cache local:",t),t})}static getAllReceitas(){return d(this,null,function*(){console.log("[ReceitasRepository] getAllReceitas...");let i=yield h.controllerGetAll({tab:this.TAB});return Array.isArray(i)?i.map(e=>v(_({},e),{id:Number(e.id),index:e.index})):[]})}static getLocalReceitas(){return d(this,null,function*(){return yield(yield this.getDb()).getAll(this.STORE)})}static forceFetchReceitas(){return d(this,null,function*(){console.log("[ReceitasRepository] Baixando lista online...");let i=yield this.getAllReceitas();if(!i.length)return console.warn("[ReceitasRepository] Nenhuma receita encontrada online."),[];let e=i.map(s=>v(_({},s),{id:Number(s.id),index:s.index})),t=yield this.getDb();yield t.clear(this.STORE),yield t.bulkPut(this.STORE,e),console.log("[ReceitasRepository] Cache atualizado com lista online.");let n=yield h.controllerGetAll({tab:"Metadados"});if(Array.isArray(n)){let s=n.find(f=>f.SheetName===this.TAB);s&&(yield t.put(this.META_STORE,{id:this.TAB,UltimaModificacao:s.UltimaModificacao}),console.log("[ReceitasRepository] Metadados locais atualizados:",s))}return e})}static syncReceitas(){return d(this,null,function*(){console.log("[ReceitasRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let i=yield h.controllerGetAll({tab:"Metadados"});if(!Array.isArray(i))return!1;let e=i.find(f=>f.SheetName===this.TAB);if(!e)return console.warn("[ReceitasRepository] Nenhum metadado online encontrado."),!1;let n=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!n||n.UltimaModificacao!==e.UltimaModificacao?(console.log("[ReceitasRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchReceitas(),!0):(console.log("[ReceitasRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}static deleteReceita(i){return d(this,null,function*(){console.log("[ReceitasRepository] Excluindo receita...",i);let e=yield this.getDb(),t=yield e.get(this.STORE,i);return t?(yield h.controllerDeleteByIndex({tab:this.TAB,index:t.index}),yield e.delete(this.STORE,i),console.log("[ReceitasRepository] Receita exclu\xEDda do cache/local:",i),!0):(console.warn("[ReceitasRepository] Receita n\xE3o encontrada no cache:",i),!1)})}};var D=class a{getPossiveisReceitas(){return d(this,null,function*(){let i=E.getUser();if(!i?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");let[e,t,n]=yield Promise.all([I.getLocalItens(),x.getLocalInventarioByJogador(i.email),b.getLocalReceitas()]);return e.length&&t.length&&n.length?(this.sincronizar(i.email).catch(s=>console.error("[OficinaService] Erro ao sincronizar:",s)),this.processar(e,n,t)):(console.log("[OficinaService] Cache incompleto \u2192 carregando dados s\xEDncronos..."),yield I.syncItens(),e=yield I.getLocalItens(),yield x.syncInventario(),t=yield x.getLocalInventarioByJogador(i.email),yield b.syncReceitas(),n=yield b.getLocalReceitas(),this.processar(e,n,t))})}sincronizar(i){return d(this,null,function*(){let[e,t,n]=yield Promise.all([I.syncItens(),x.syncInventario(),b.syncReceitas()]);console.log(e||t||n?"[OficinaService] Alguma tabela foi atualizada \u2192 dados locais recarregados":"[OficinaService] Nenhuma altera\xE7\xE3o nas tabelas.")})}processar(i,e,t){let n=new Map;return t.forEach(f=>{let y=n.get(f.item_catalogo)||0;n.set(f.item_catalogo,y+f.quantidade)}),i.filter(f=>e.filter(P=>P.fabricavel===f.id).length>0).map(f=>{let y=e.filter(u=>u.fabricavel===f.id).map(u=>{let ne=n.get(u.catalogo)||0,B=i.find(oe=>oe.id===u.catalogo);return v(_({},u),{quantidadeInventario:ne,nome:B?.nome,imagem:B?.imagem})}),P=y.every(u=>u.quantidadeInventario>=u.quantidade);return y.some(u=>u.quantidadeInventario>0)?v(_({},f),{fabricavel:P,ingredientes:y}):null}).filter(f=>f!==null)}criarItem(i){return d(this,null,function*(){let e=E.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");for(let t of i.ingredientes)yield x.subtrairQuantidade(e.email,t.catalogo,t.quantidade);yield x.adicionarOuIncrementar(e.email,i.id,1),console.log(`[OficinaService] Item criado: ${i.nome}`)})}forcarFalha(i){return d(this,null,function*(){let e=E.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");for(let t of i.ingredientes)yield x.subtrairQuantidade(e.email,t.catalogo,t.quantidade);console.log(`[OficinaService] Falha for\xE7ada ao fabricar: ${i.nome}`)})}static \u0275fac=function(e){return new(e||a)};static \u0275prov=U({token:a,factory:a.\u0275fac,providedIn:"root"})};var se=(a,i)=>({ok:a,fail:i});function le(a,i){if(a&1&&(r(0,"div",13),m(1),c()),a&2){let e=p();l("ngClass",e.mensagemTipo==="sucesso"?"bg-success text-white":"bg-danger text-white"),o(),R(" ",e.mensagem," ")}}function de(a,i){a&1&&(r(0,"div",14),C(1,"div",15),r(2,"p",16),m(3,"Carregando receitas..."),c()())}function me(a,i){a&1&&(r(0,"div",17),m(1," Nenhum item encontrado. "),c())}function pe(a,i){if(a&1&&C(0,"img",34),a&2){let e=p().$implicit;l("alt",N(e.nome))("src",e.imagem,T)}}function fe(a,i){a&1&&(r(0,"span"),m(1,"\u2692\uFE0F"),c())}function ge(a,i){if(a&1&&(r(0,"p",35),m(1),c()),a&2){let e=p().$implicit;o(),R("\u2728 ",e.efeito)}}function _e(a,i){if(a&1&&(r(0,"p",36),m(1),c()),a&2){let e=p().$implicit;o(),R("\u26A0\uFE0F ",e.colateral)}}function ue(a,i){if(a&1&&C(0,"img",34),a&2){let e=p().$implicit;l("alt",N(e.nome))("src",e.imagem,T)}}function ve(a,i){a&1&&(r(0,"span"),m(1,"\u{1F9EA}"),c())}function xe(a,i){if(a&1&&(r(0,"div",39)(1,"div",40),g(2,ue,1,3,"img",28)(3,ve,2,0,"span",12),c(),r(4,"div",41)(5,"span",42),m(6),c()(),r(7,"span",43),m(8),c()()),a&2){let e=i.$implicit;l("ngClass",W(6,se,e.quantidadeInventario>=e.quantidade,e.quantidadeInventario<e.quantidade)),o(2),l("ngIf",e.imagem),o(),l("ngIf",!e.imagem),o(3),w(e.nome),o(2),j(" ",e.quantidadeInventario,"/",e.quantidade," ")}}function he(a,i){if(a&1&&(r(0,"div",37),g(1,xe,9,9,"div",38),c()),a&2){let e=p().$implicit;o(),l("ngForOf",e.ingredientes)}}function be(a,i){a&1&&C(0,"span",48)}function ye(a,i){a&1&&(r(0,"span"),m(1,"\u{1F6E0}\uFE0F"),c())}function Ce(a,i){a&1&&C(0,"span",48)}function Oe(a,i){a&1&&(r(0,"span"),m(1,"\u{1F9E8}"),c())}function Re(a,i){if(a&1){let e=F();r(0,"div",44)(1,"button",45),O("click",function(){S(e);let n=p().$implicit,s=p(4);return M(s.criarItem(n))}),g(2,be,1,0,"span",46)(3,ye,2,0,"span",12),c(),r(4,"button",47),O("click",function(){S(e);let n=p().$implicit,s=p(4);return M(s.forcarFalha(n))}),g(5,Ce,1,0,"span",46)(6,Oe,2,0,"span",12),c()()}if(a&2){let e=p().$implicit,t=p(4);o(),l("disabled",t.loadingAction[e.id]),o(),l("ngIf",t.loadingAction[e.id]==="criar"),o(),l("ngIf",t.loadingAction[e.id]!=="criar"),o(),l("disabled",t.loadingAction[e.id]),o(),l("ngIf",t.loadingAction[e.id]==="falha"),o(),l("ngIf",t.loadingAction[e.id]!=="falha")}}function we(a,i){if(a&1&&(r(0,"div",24)(1,"small",25),m(2),c(),r(3,"div",26)(4,"div",27),g(5,pe,1,3,"img",28)(6,fe,2,0,"span",12),c(),r(7,"div")(8,"h6",29),m(9),c(),r(10,"small"),m(11),c()()(),g(12,ge,2,1,"p",30)(13,_e,2,1,"p",31)(14,he,2,1,"div",32)(15,Re,7,6,"div",33),c()),a&2){let e=i.$implicit,t=p(4);o(),l("ngClass",e.fabricavel?"status-ok":"status-off"),o(),R(" ",e.fabricavel?"\u2714 Dispon.":"\u2716 Indisp."," "),o(3),l("ngIf",e.imagem),o(),l("ngIf",!e.imagem),o(3),w(e.nome),o(),$(V("raridade ",t.getRaridadeClass(e.raridade))),o(),R(" ",e.raridade||"Comum"," "),o(),l("ngIf",e.efeito),o(),l("ngIf",e.colateral),o(),l("ngIf",e.ingredientes==null?null:e.ingredientes.length),o(),l("ngIf",e.fabricavel)}}function Ie(a,i){if(a&1&&(r(0,"div",22),g(1,we,16,13,"div",23),c()),a&2){let e=p().$implicit;o(),l("ngForOf",e.itens)}}function Se(a,i){if(a&1){let e=F();r(0,"div",19)(1,"button",20),O("click",function(){let n=S(e).$implicit,s=p(2);return M(s.toggleCategoria(n))}),r(2,"span"),m(3),c(),r(4,"span"),m(5),c()(),g(6,Ie,2,1,"div",21),c()}if(a&2){let e=i.$implicit;o(3),w(e.nome||"Outros"),o(2),w(e.expandido?"\u2212":"+"),o(),l("ngIf",e.expandido)}}function Me(a,i){if(a&1&&(r(0,"div"),g(1,Se,7,3,"div",18),c()),a&2){let e=p();o(),l("ngForOf",e.categoriasFiltradas)}}var ae=class a{constructor(i,e){this.router=i;this.oficinaService=e}categorias=[];categoriasFiltradas=[];carregando=!0;filtro="";fabricaveisOnly=!1;loadingAction={};mensagem=null;mensagemTipo=null;ngOnInit(){return d(this,null,function*(){try{this.carregando=!0;let i=yield this.oficinaService.getPossiveisReceitas();this.processarItens(i),this.carregando=!1}catch(i){console.error("[Oficina] Erro ao carregar receitas:",i),this.carregando=!1}})}processarItens(i){let e=new Map;i.forEach(t=>{let n=t.categoria||"Outros";e.has(n)||e.set(n,[]),e.get(n).push(t)}),this.categorias=Array.from(e.entries()).sort((t,n)=>String(t[0]).localeCompare(String(n[0]))).map(([t,n])=>({nome:t,itens:n,expandido:!1})),this.categoriasFiltradas=[...this.categorias]}toggleCategoria(i){i.expandido=!i.expandido}aplicarFiltro(){let i=this.normalize(this.filtro);if(!i&&!this.fabricaveisOnly){this.categoriasFiltradas=[...this.categorias];return}this.categoriasFiltradas=this.categorias.map(e=>{let t=e.itens.filter(n=>(!this.fabricaveisOnly||n.fabricavel)&&(this.normalize(n.nome).includes(i)||this.normalize(n.raridade).includes(i)||this.normalize(n.efeito).includes(i)||this.normalize(n.descricao).includes(i)));return v(_({},e),{itens:t,expandido:!0})}).filter(e=>e.itens.length>0)}normalize(i=""){return i.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}getRaridadeClass(i){return i?i.toLowerCase():"comum"}criarItem(i){return d(this,null,function*(){this.loadingAction[i.id]="criar";try{yield this.oficinaService.criarItem(i),alert(`\u2705 ${i.nome} criado com sucesso!`),yield this.atualizarItem(i.id)}catch(e){console.error(e),alert(`\u274C N\xE3o foi poss\xEDvel criar ${i.nome}.`)}finally{this.loadingAction[i.id]=null}})}forcarFalha(i){return d(this,null,function*(){this.loadingAction[i.id]="falha";try{yield this.oficinaService.forcarFalha(i),alert(`\u26A0\uFE0F Falha simulada em ${i.nome}. Ingredientes consumidos.`),yield this.atualizarItem(i.id)}catch(e){console.error(e),alert(`\u274C N\xE3o foi poss\xEDvel for\xE7ar falha em ${i.nome}.`)}finally{this.loadingAction[i.id]=null}})}atualizarItem(i){return d(this,null,function*(){try{let t=(yield this.oficinaService.getPossiveisReceitas()).find(n=>n.id===i);if(!t)return;this.categorias.forEach(n=>{let s=n.itens.findIndex(f=>f.id===i);s!==-1&&(n.itens[s]=t)}),this.aplicarFiltro()}catch(e){console.error("[Oficina] Erro ao atualizar item:",e)}})}showMensagem(i,e){this.mensagem=i,this.mensagemTipo=e,setTimeout(()=>{this.mensagem=null,this.mensagemTipo=null},3e3)}static \u0275fac=function(e){return new(e||a)(A(H),A(D))};static \u0275cmp=L({type:a,selectors:[["app-oficina"]],decls:15,vars:6,consts:[[1,"oficina-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light"],["class","toast-feedback position-fixed bottom-0 end-0 m-3",3,"ngClass",4,"ngIf"],[1,"p-3","top-bar","position-sticky","top-0",2,"z-index","10"],[1,"d-flex","align-items-center","gap-2"],["type","text","placeholder","\u{1F50D} Procurar receitas...",1,"form-control","search-input","rounded-pill","px-3",3,"ngModelChange","input","ngModel"],[1,"form-check","ms-2"],["type","checkbox","id","fabricaveisOnly",1,"form-check-input",3,"ngModelChange","change","ngModel"],["for","fabricaveisOnly",1,"form-check-label","small","text-light"],[1,"flex-grow-1","p-3"],[1,"fw-bold","mb-3","title"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[1,"toast-feedback","position-fixed","bottom-0","end-0","m-3",3,"ngClass"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",4,"ngFor","ngForOf"],[1,"mb-3"],[1,"categoria-btn",3,"click"],["class","mt-2 d-flex flex-column gap-3",4,"ngIf"],[1,"mt-2","d-flex","flex-column","gap-3"],["class","receita-card",4,"ngFor","ngForOf"],[1,"receita-card"],[1,"status-indicador",3,"ngClass"],[1,"d-flex","align-items-center","mb-2"],[1,"thumb"],[3,"src","alt",4,"ngIf"],[1,"fw-bold","text-white","mb-1"],["class","small text-info mb-1",4,"ngIf"],["class","small text-danger mb-2",4,"ngIf"],["class","ingredientes-grid",4,"ngIf"],["class","acoes-bottom",4,"ngIf"],[3,"src","alt"],[1,"small","text-info","mb-1"],[1,"small","text-danger","mb-2"],[1,"ingredientes-grid"],["class","ingrediente-pill",3,"ngClass",4,"ngFor","ngForOf"],[1,"ingrediente-pill",3,"ngClass"],[1,"ingrediente-thumb"],[1,"flex-grow-1"],[1,"small"],[1,"small","fw-bold"],[1,"acoes-bottom"],[1,"btn-square","success",3,"click","disabled"],["class","spinner-border spinner-border-sm",4,"ngIf"],[1,"btn-square","danger",3,"click","disabled"],[1,"spinner-border","spinner-border-sm"]],template:function(e,t){e&1&&(r(0,"div",0),g(1,le,2,2,"div",1),r(2,"div",2)(3,"div",3)(4,"input",4),q("ngModelChange",function(s){return z(t.filtro,s)||(t.filtro=s),s}),O("input",function(){return t.aplicarFiltro()}),c(),r(5,"div",5)(6,"input",6),q("ngModelChange",function(s){return z(t.fabricaveisOnly,s)||(t.fabricaveisOnly=s),s}),O("change",function(){return t.aplicarFiltro()}),c(),r(7,"label",7),m(8," Apenas fabric\xE1veis "),c()()()(),r(9,"div",8)(10,"h4",9),m(11,"\u2692\uFE0F Oficina"),c(),g(12,de,4,0,"div",10)(13,me,2,0,"div",11)(14,Me,2,1,"div",12),c()()),e&2&&(o(),l("ngIf",t.mensagem),o(3),k("ngModel",t.filtro),o(2),k("ngModel",t.fabricaveisOnly),o(6),l("ngIf",t.carregando),o(),l("ngIf",!t.carregando&&t.categoriasFiltradas.length===0),o(),l("ngIf",!t.carregando))},dependencies:[Y,G,J,Q,ie,X,K,Z,ee],styles:["body[_ngcontent-%COMP%], .bg-dark[_ngcontent-%COMP%]{background:radial-gradient(circle at top left,#141414,#0a0a0a);font-family:Roboto,sans-serif;color:#eee}.top-bar[_ngcontent-%COMP%]{background:#111;border-bottom:1px solid #333}.search-input[_ngcontent-%COMP%]{border:1px solid #222!important;background:#161616!important;color:#fff!important}.search-input[_ngcontent-%COMP%]::placeholder{color:#aaa!important}.categoria-btn[_ngcontent-%COMP%]{background:#1a1a1a;border:1px solid #333;border-radius:10px;color:#eee;font-weight:600;padding:6px 10px;width:100%;display:flex;justify-content:space-between}.receita-card[_ngcontent-%COMP%]{background:#1c1c1c;border:1px solid #2c2c2c;border-radius:12px;padding:14px;position:relative}.receita-card[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 12px #00000080}.status-indicador[_ngcontent-%COMP%]{position:absolute;top:6px;right:10px;font-size:.7rem;font-weight:600}.status-ok[_ngcontent-%COMP%]{color:#6fbf73}.status-off[_ngcontent-%COMP%]{color:#ff6f6f}.thumb[_ngcontent-%COMP%]{width:50px;height:50px;border-radius:8px;background:#0f0f0f;border:1px solid #333;display:flex;align-items:center;justify-content:center;overflow:hidden;margin-right:10px}.thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.ingredientes-grid[_ngcontent-%COMP%]{display:flex;flex-direction:column;gap:4px}.ingrediente-pill[_ngcontent-%COMP%]{display:flex;align-items:center;gap:6px;padding:4px 6px;border-radius:6px;font-size:.75rem;background:#1a1a1a;border:1px solid #333}.ingrediente-pill.ok[_ngcontent-%COMP%]{border-color:#355d3c;color:#6fbf73}.ingrediente-pill.fail[_ngcontent-%COMP%]{border-color:#5d3535;color:#ff6f6f}.ingrediente-thumb[_ngcontent-%COMP%]{width:20px;height:20px;border-radius:4px;border:1px solid #444;background:#0f0f0f;display:flex;align-items:center;justify-content:center;overflow:hidden}.ingrediente-thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.acoes[_ngcontent-%COMP%]{position:absolute;top:10px;right:10px;display:flex;gap:6px}.btn-square[_ngcontent-%COMP%]{width:32px;height:32px;border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:.9rem;border:none;transition:.2s}.toast-feedback[_ngcontent-%COMP%]{padding:8px 14px;border-radius:8px;font-size:.85rem;box-shadow:0 4px 12px #0006}.acoes-bottom[_ngcontent-%COMP%]{display:flex;justify-content:flex-end;gap:8px;margin-top:10px}.btn-square[_ngcontent-%COMP%]{width:34px;height:34px;border-radius:8px;display:flex;align-items:center;justify-content:center;font-size:.9rem;border:none;transition:.2s}.btn-square.success[_ngcontent-%COMP%]{background:#2e7d32;color:#fff}.btn-square.success[_ngcontent-%COMP%]:hover:enabled{background:#388e3c}.btn-square.danger[_ngcontent-%COMP%]{background:#b71c1c;color:#fff}.btn-square.danger[_ngcontent-%COMP%]:hover:enabled{background:#d32f2f}.btn-square[_ngcontent-%COMP%]:disabled{opacity:.5;cursor:not-allowed}"]})};export{ae as Oficina};
