import{a as C}from"./chunk-PR2XBUWE.js";import{a as R}from"./chunk-N3BXCGYD.js";import{b as J,c as Y,f as H,i as K,r as Q}from"./chunk-W45U2HER.js";import{a as Z,b as _}from"./chunk-UM5RQUOR.js";import{Ia as m,Ja as c,Ka as r,La as D,Lb as j,Mb as V,N as F,Nb as W,Qb as $,Ra as k,T as P,Ta as w,U as z,Va as g,Zb as G,a as f,ac as X,b as u,d,gb as L,hb as p,ib as O,ja as B,jb as x,ka as o,mb as E,nb as M,oa as S,ob as T,pb as q,qb as U,sa as N,wa as v}from"./chunk-Y44Y2XZC.js";var h=class{static TAB="Receitas";static STORE=this.TAB;static META_STORE="metadados";static dbPromise=null;static getDb(){return d(this,null,function*(){return this.dbPromise||(console.log("[ReceitasRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=Z.create()),this.dbPromise})}static createReceita(t){return d(this,null,function*(){console.log("[ReceitasRepository] Criando nova receita...",t);let e=yield _.controllerCreate({tab:this.TAB,attrs:t}),i=u(f({},e),{id:e?.index||Date.now()});return yield(yield this.getDb()).put(this.STORE,i),console.log("[ReceitasRepository] Receita criada e salva no cache:",i),i})}static updateReceita(t){return d(this,null,function*(){console.log("[ReceitasRepository] Atualizando receita...",t);let e=yield _.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t}),i=f(f({},t),e);return yield(yield this.getDb()).put(this.STORE,i),console.log("[ReceitasRepository] Receita atualizada no cache local:",i),i})}static getAllReceitas(){return d(this,null,function*(){console.log("[ReceitasRepository] getAllReceitas...");let t=yield _.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t:[]})}static getLocalReceitas(){return d(this,null,function*(){return yield(yield this.getDb()).getAll(this.STORE)})}static forceFetchReceitas(){return d(this,null,function*(){console.log("[ReceitasRepository] Baixando lista online...");let t=yield this.getAllReceitas();if(!t.length)return console.warn("[ReceitasRepository] Nenhuma receita encontrada online."),[];let e=t.map(s=>u(f({},s),{id:s.index})),i=yield this.getDb();yield i.clear(this.STORE),yield i.bulkPut(this.STORE,e),console.log("[ReceitasRepository] Cache atualizado com lista online.");let a=yield _.controllerGetAll({tab:"Metadados"});if(Array.isArray(a)){let s=a.find(l=>l.SheetName===this.TAB);s&&(yield i.put(this.META_STORE,{id:this.TAB,UltimaModificacao:s.UltimaModificacao}),console.log("[ReceitasRepository] Metadados locais atualizados:",s))}return e})}static syncReceitas(){return d(this,null,function*(){console.log("[ReceitasRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let t=yield _.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let e=t.find(l=>l.SheetName===this.TAB);if(!e)return console.warn("[ReceitasRepository] Nenhum metadado online encontrado."),!1;let a=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!a||a.UltimaModificacao!==e.UltimaModificacao?(console.log("[ReceitasRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchReceitas(),!0):(console.log("[ReceitasRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}static deleteReceita(t){return d(this,null,function*(){return console.log("[ReceitasRepository] Excluindo receita...",t),yield _.controllerDeleteByIndex({tab:this.TAB,index:t}),yield(yield this.getDb()).delete(this.STORE,t),console.log("[ReceitasRepository] Receita exclu\xEDda do cache/local:",t),!0})}};var I=class n{getPossiveisReceitas(){return d(this,null,function*(){let t=X.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");let[e,i,a]=yield Promise.all([R.getLocalItens(),C.getLocalInventarioByJogador(t.email),h.getLocalReceitas()]);return e.length&&i.length&&a.length?(this.sincronizar(t.email).catch(s=>console.error("[OficinaService] Erro ao sincronizar:",s)),this.processar(e,a,i)):(console.log("[OficinaService] Cache incompleto \u2192 carregando dados s\xEDncronos..."),yield R.syncItens(),e=yield R.getLocalItens(),yield C.syncInventario(),i=yield C.getLocalInventarioByJogador(t.email),yield h.syncReceitas(),a=yield h.getLocalReceitas(),this.processar(e,a,i))})}sincronizar(t){return d(this,null,function*(){let[e,i,a]=yield Promise.all([R.syncItens(),C.syncInventario(),h.syncReceitas()]);console.log(e||i||a?"[OficinaService] Alguma tabela foi atualizada \u2192 dados locais recarregados":"[OficinaService] Nenhuma altera\xE7\xE3o nas tabelas.")})}processar(t,e,i){let a=new Map;return i.forEach(l=>{let y=a.get(l.item_catalogo)||0;a.set(l.item_catalogo,y+l.quantidade)}),t.filter(l=>e.filter(A=>A.fabricavel===l.id).length>0).map(l=>{let y=e.filter(b=>b.fabricavel===l.id);if(!y.some(b=>(a.get(b.catalogo)||0)>0))return null;let te=y.every(b=>(a.get(b.catalogo)||0)>=b.quantidade);return u(f({},l),{fabricavel:te})}).filter(l=>l!==null)}static \u0275fac=function(e){return new(e||n)};static \u0275prov=F({token:n,factory:n.\u0275fac,providedIn:"root"})};function oe(n,t){n&1&&(c(0,"div",12),D(1,"div",13),c(2,"p",14),p(3,"Carregando receitas..."),r()())}function re(n,t){n&1&&(c(0,"div",15),p(1," Nenhum item encontrado. "),r())}function ce(n,t){if(n&1&&D(0,"img",34),n&2){let e=g().$implicit;m("alt",q(e.nome||"Item"))("src",e.imagem,B)}}function se(n,t){n&1&&(c(0,"span",35),p(1,"\u2692\uFE0F"),r())}function le(n,t){if(n&1&&(c(0,"p",36),p(1),r()),n&2){let e=g().$implicit;o(),x(" \u2728 ",e.efeito," ")}}function de(n,t){if(n&1&&(c(0,"p",37),p(1),r()),n&2){let e=g().$implicit;o(),x(" \u26A0\uFE0F ",e.colateral," ")}}function me(n,t){if(n&1&&(c(0,"p",38),p(1),r()),n&2){let e=g().$implicit;o(),x(" \u{1F4DD} ",e.descricao," ")}}function pe(n,t){if(n&1&&(c(0,"div",23)(1,"div",24)(2,"span",25),p(3),r(),c(4,"div",26)(5,"div",27),v(6,ce,1,3,"img",28)(7,se,2,0,"span",29),r(),c(8,"div")(9,"h6",30),p(10),r(),c(11,"small"),p(12),r()()(),v(13,le,2,1,"p",31)(14,de,2,1,"p",32)(15,me,2,1,"p",33),r()()),n&2){let e=t.$implicit,i=g(4);o(2),m("ngClass",e.fabricavel?"bg-success":"bg-secondary"),o(),x(" ",e.fabricavel?"\u2705":"\u274C"," "),o(3),m("ngIf",e.imagem),o(),m("ngIf",!e.imagem),o(3),O(e.nome||"Sem nome"),o(),L(U("raridade ",i.getRaridadeClass(e.raridade))),o(),x(" ",e.raridade||"Comum"," "),o(),m("ngIf",e.efeito),o(),m("ngIf",e.colateral),o(),m("ngIf",e.descricao)}}function fe(n,t){if(n&1&&(c(0,"div",14)(1,"div",21),v(2,pe,16,12,"div",22),r()()),n&2){let e=g().$implicit;o(2),m("ngForOf",e.itens)}}function ge(n,t){if(n&1){let e=k();c(0,"div",17)(1,"button",18),w("click",function(){let a=P(e).$implicit,s=g(2);return z(s.toggleCategoria(a))}),c(2,"span",19),p(3),r(),c(4,"span"),p(5),r()(),v(6,fe,3,1,"div",20),r()}if(n&2){let e=t.$implicit;o(3),O(e.nome||"Outros"),o(2),O(e.expandido?"\u2212":"+"),o(),m("ngIf",e.expandido)}}function ue(n,t){if(n&1&&(c(0,"div"),v(1,ge,7,3,"div",16),r()),n&2){let e=g();o(),m("ngForOf",e.categoriasFiltradas)}}var ee=class n{constructor(t,e){this.router=t;this.oficinaService=e}categorias=[];categoriasFiltradas=[];carregando=!0;filtro="";fabricaveisOnly=!1;ngOnInit(){return d(this,null,function*(){try{this.carregando=!0;let t=yield this.oficinaService.getPossiveisReceitas();this.processarItens(t),this.carregando=!1}catch(t){console.error("[Oficina] Erro ao carregar receitas:",t),this.carregando=!1}})}processarItens(t){let e=new Map;t.forEach(i=>{let a=i.categoria||"Outros";e.has(a)||e.set(a,[]),e.get(a).push(i)}),this.categorias=Array.from(e.entries()).sort((i,a)=>String(i[0]).localeCompare(String(a[0]))).map(([i,a])=>({nome:i,itens:a,expandido:!1})),this.categoriasFiltradas=[...this.categorias]}toggleCategoria(t){t.expandido=!t.expandido}aplicarFiltro(){let t=this.normalize(this.filtro);if(!t&&!this.fabricaveisOnly){this.categoriasFiltradas=[...this.categorias];return}this.categoriasFiltradas=this.categorias.map(e=>{let i=e.itens.filter(a=>(!this.fabricaveisOnly||a.fabricavel)&&(this.normalize(a.nome).includes(t)||this.normalize(a.raridade).includes(t)||this.normalize(a.efeito).includes(t)||this.normalize(a.descricao).includes(t)));return u(f({},e),{itens:i,expandido:!0})}).filter(e=>e.itens.length>0)}normalize(t=""){return t.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"")}getRaridadeClass(t){return t?t.toLowerCase():"comum"}static \u0275fac=function(e){return new(e||n)(S(G),S(I))};static \u0275cmp=N({type:n,selectors:[["app-oficina"]],decls:14,vars:5,consts:[[1,"d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"p-3","bg-black","border-bottom","position-sticky","top-0",2,"z-index","10"],[1,"d-flex","align-items-center","gap-2"],["type","text","placeholder","\u{1F50D} Pesquisar receitas...",1,"form-control","bg-dark","text-light","border-light","rounded-pill","px-3",3,"ngModelChange","input","ngModel"],[1,"form-check","ms-2"],["type","checkbox","id","fabricaveisOnly",1,"form-check-input",3,"ngModelChange","change","ngModel"],["for","fabricaveisOnly",1,"form-check-label","small","text-light"],[1,"flex-grow-1","p-3"],[1,"fw-bold","mb-3"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",4,"ngFor","ngForOf"],[1,"mb-3"],[1,"btn","btn-outline-light","w-100","text-start","d-flex","justify-content-between","align-items-center",3,"click"],[1,"fw-bold"],["class","mt-2",4,"ngIf"],[1,"row","row-cols-1","g-2"],["class","col",4,"ngFor","ngForOf"],[1,"col"],[1,"card","catalogo-card","shadow-sm","h-100","p-3","position-relative"],[1,"badge","position-absolute","top-0","end-0","m-2",3,"ngClass"],[1,"d-flex","align-items-center","mb-2"],[1,"rounded","me-3","d-flex","align-items-center","justify-content-center","bg-dark",2,"width","55px","height","55px","overflow","hidden"],["style","width: 100%; height: 100%; object-fit: cover;",3,"src","alt",4,"ngIf"],["class","text-muted",4,"ngIf"],[1,"fw-bold","text-white","mb-1"],["class","small mt-2 text-info",4,"ngIf"],["class","small text-danger",4,"ngIf"],["class","small descricao-text fst-italic",4,"ngIf"],[2,"width","100%","height","100%","object-fit","cover",3,"src","alt"],[1,"text-muted"],[1,"small","mt-2","text-info"],[1,"small","text-danger"],[1,"small","descricao-text","fst-italic"]],template:function(e,i){e&1&&(c(0,"div",0)(1,"div",1)(2,"div",2)(3,"input",3),T("ngModelChange",function(s){return M(i.filtro,s)||(i.filtro=s),s}),w("input",function(){return i.aplicarFiltro()}),r(),c(4,"div",4)(5,"input",5),T("ngModelChange",function(s){return M(i.fabricaveisOnly,s)||(i.fabricaveisOnly=s),s}),w("change",function(){return i.aplicarFiltro()}),r(),c(6,"label",6),p(7," Apenas fabric\xE1veis "),r()()()(),c(8,"div",7)(9,"h4",8),p(10,"\u2692\uFE0F Oficina"),r(),v(11,oe,4,0,"div",9)(12,re,2,0,"div",10)(13,ue,2,1,"div",11),r()()),e&2&&(o(3),E("ngModel",i.filtro),o(2),E("ngModel",i.fabricaveisOnly),o(6),m("ngIf",i.carregando),o(),m("ngIf",!i.carregando&&i.categoriasFiltradas.length===0),o(),m("ngIf",!i.carregando))},dependencies:[$,j,V,W,Q,Y,J,H,K],styles:[".catalogo-card[_ngcontent-%COMP%]{background:#1e1e1e;border:1px solid #333;border-radius:14px;transition:all .2s ease-in-out}.catalogo-card[_ngcontent-%COMP%]:hover{transform:translateY(-3px);box-shadow:0 6px 14px #00000073}.descricao-text[_ngcontent-%COMP%]{color:#cfcfcf!important}.raridade.comum[_ngcontent-%COMP%]{color:#999}.raridade.incomum[_ngcontent-%COMP%]{color:#6fbf73}.raridade.raro[_ngcontent-%COMP%]{color:#4a90e2}.raridade.\\e9pico[_ngcontent-%COMP%]{color:#9b7ecb}.raridade.lend\\e1rio[_ngcontent-%COMP%]{color:#d4af37}"]})};export{ee as Oficina};
