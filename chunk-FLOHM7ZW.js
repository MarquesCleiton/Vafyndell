import{v as m,w as p}from"./chunk-WLM7QTUH.js";import{a as c,b as h,c as y,d as r}from"./chunk-QQSIVCMV.js";var u=class{static ENCODING="0123456789ABCDEFGHJKMNPQRSTVWXYZ";static TIME_LEN=10;static RAND_LEN=16;static generateULID(t=new Date){let a=this.encodeTime(t.getTime(),this.TIME_LEN),e=this.encodeRandom(this.RAND_LEN);return a+e}static encodeTime(t,a){let e="";for(let s=a-1;s>=0;s--)e=this.ENCODING[t%32]+e,t=Math.floor(t/32);return e}static encodeRandom(t){let a="";for(let e=0;e<t;e++){let s=Math.floor(Math.random()*32);a+=this.ENCODING[s]}return a}};var n=class{static BASE_URL="https://script.google.com/macros/s/AKfycbz6KlBkfWzEFEkHOVtCyMWD83aqi3oKVXdLtCY93XCUA24BBP3BO9aINqGIj5_R1LRX/exec";static SHEET_ID="19B2aMGrajvhPJfOvYXt059-fECytaN38iFsP8GInD_g";static FOLDER_ID="1zId11Ydti8d0FOQoQjd9lQmPo6GiJx26";static call(t,a,e=!0){return r(this,null,function*(){let s=p.getIdToken();if(!s||!p.isAuthenticated()){let l=yield p.refreshIdToken();if(!l)throw new Error("Usu\xE1rio precisa fazer login novamente.");s=l.idToken}let o=c({idToken:s,action:t,sheetId:this.SHEET_ID,folderId:this.FOLDER_ID},a);console.log(`\u27A1\uFE0F [ScriptClientV2:${t}] Enviando \u2192`,o);let i=yield fetch(this.BASE_URL,{method:"POST",body:JSON.stringify(o)}),d=yield i.text();if(!i.ok){if(console.error(`\u274C [ScriptClientV2:${t}] Erro bruto do Script:`,d),i.status===401&&e){if(console.warn(`[ScriptClientV2:${t}] Token inv\xE1lido, tentando renovar...`),!(yield p.refreshIdToken()))throw new Error("Usu\xE1rio precisa se autenticar novamente.");return this.call(t,a,!1)}throw new Error(`[ScriptClientV2] HTTP ${i.status} - ${i.statusText}
${d}`)}try{let l=JSON.parse(d);return console.log(`\u2B05\uFE0F [ScriptClientV2:${t}] Resposta \u2192`,l),l}catch(l){throw console.error(`\u274C [ScriptClientV2:${t}] Resposta n\xE3o-JSON:`,d),l}})}static controllerCreate(t){return this.call("controller.create",{payload:t})}static controllerGetAll(t){return this.call("controller.getAll",{payload:t})}static controllerGetByIndex(t){return this.call("controller.getByIndex",{payload:t})}static controllerGetCell(t){return this.call("controller.getCell",{payload:t})}static controllerUpdateByIndex(t){return this.call("controller.updateByIndex",{payload:t})}static controllerUpdateCell(t){return this.call("controller.updateCell",{payload:t})}static controllerDeleteByIndex(t){return this.call("controller.deleteByIndex",{payload:t})}static controllerCreateBatch(t){return this.call("controller.create",{payloads:t})}static controllerUpdateBatch(t){return this.call("controller.updateByIndex",{payloads:t})}static controllerDeleteBatch(t){return this.call("controller.deleteByIndex",{payloads:t})}static driveUpload(t){return this.call("drive.upload",{payload:t})}static driveUpdate(t){return this.call("drive.update",{payload:t})}static driveDelete(t){return this.call("drive.delete",{payload:t})}static normalizeResponse(t,a){return(t?.[a]||[]).map(e=>h(c({},e),{id:String(e.id),index:e.index}))}};var T=class g{constructor(t,a=t){this.tab=t;this.store=a}static META_STORE="Metadados";static dbPromise=null;getDb(){return r(this,null,function*(){return g.dbPromise||(g.dbPromise=m.create()),g.dbPromise})}create(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u25B6\uFE0F create \u2192`,t);let a=yield n.controllerCreate(c({tab:this.tab},t));console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F create result`,a);let e=n.normalizeResponse(a,this.tab)[0],s=h(c(c({},t),e),{id:e?.id||u.generateULID(),index:e?.index??Date.now()});if("imagem"in(e||{})){let o=e.imagem;(o||"").startsWith("http")&&(s.imagem=o)}return yield(yield this.getDb()).put(this.store,s),console.log(`[BaseRepository:${this.tab}] \u{1F4BE} create persistido localmente \u2192`,s),s})}update(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u25B6\uFE0F update \u2192`,t);let d=t,{index:a}=d,e=y(d,["index"]),s=yield n.controllerUpdateByIndex(c({tab:this.tab,index:a},e));console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F update result`,s);let o=n.normalizeResponse(s,this.tab)[0],i=h(c(c({},t),o),{id:o?.id||t.id,index:o?.index??t.index});if("imagem"in(o||{})){let l=o.imagem;(l||"").startsWith("http")&&(i.imagem=l)}return yield(yield this.getDb()).put(this.store,i),console.log(`[BaseRepository:${this.tab}] \u{1F4BE} update persistido localmente \u2192`,i),i})}delete(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u25B6\uFE0F delete \u2192 index=${t}`);let a=yield this.getDb(),e=yield a.get(this.store,t);return e?(yield n.controllerDeleteByIndex({tab:this.tab,index:e.index}),yield a.delete(this.store,t),console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F delete conclu\xEDdo \u2192 index=${t}`),!0):(console.warn(`[BaseRepository:${this.tab}] \u26A0\uFE0F entidade index=${t} n\xE3o encontrada localmente`),!1)})}getLocal(){return r(this,null,function*(){let a=yield(yield this.getDb()).getAll(this.store);return console.log(`[BaseRepository:${this.tab}] \u{1F4C2} getLocal \u2192`,a),a})}getAllOnline(){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F310} getAllOnline iniciado`);let t=yield n.controllerGetAll({tab:this.tab});return console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F getAllOnline result`,t),n.normalizeResponse(t,this.tab)})}forceFetch(){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F310} forceFetch iniciado`);let t=yield n.controllerGetAll({tabs:[this.tab,"Metadados"]});console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F forceFetch result`,t);let a=n.normalizeResponse(t,this.tab),e=yield this.getDb();yield e.clear(this.store),yield e.bulkPut(this.store,a),console.log(`[BaseRepository:${this.tab}] \u{1F4BE} forceFetch persistiu ${a.length} registros`);let s=t.Metadados?.find(o=>o.SheetName===this.tab);return s&&(yield e.put(g.META_STORE,{index:this.tab,SheetName:this.tab,UltimaModificacao:s.UltimaModificacao}),console.log(`[BaseRepository:${this.tab}] \u{1F4DD} metadados atualizados \u2192`,s)),a})}sync(){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F504} sync iniciado`);let t=yield n.controllerGetAll({tabs:["Metadados"]});console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F sync result`,t);let a=t.Metadados?.find(i=>i.SheetName===this.tab);if(!a)return console.warn(`[BaseRepository:${this.tab}] \u26A0\uFE0F Nenhum metadado encontrado online`),!1;let s=yield(yield this.getDb()).get(g.META_STORE,this.tab);return!s||s.UltimaModificacao!==a.UltimaModificacao?(console.log(`[BaseRepository:${this.tab}] \u26A0\uFE0F Atualiza\xE7\xE3o necess\xE1ria \u2192 executando forceFetch()`),yield this.forceFetch(),!0):(console.log(`[BaseRepository:${this.tab}] \u2705 Nada para atualizar`),!1)})}createBatch(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u25B6\uFE0F createBatch \u2192`,t);let a=yield n.controllerCreateBatch({[this.tab]:t});console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F createBatch result`,a);let s=n.normalizeResponse(a,this.tab).map((o,i)=>h(c(c({},t[i]),o),{id:o.id||u.generateULID(),index:o.index??Date.now()+i}));return yield(yield this.getDb()).bulkPut(this.store,s),console.log(`[BaseRepository:${this.tab}] \u{1F4BE} createBatch persistiu ${s.length} registros`),s})}updateBatch(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u25B6\uFE0F updateBatch \u2192`,t);let a=t.map(l=>{var b=l,{index:i}=b,d=y(b,["index"]);return c({index:i},d)}),e=yield n.controllerUpdateBatch({[this.tab]:a});console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F updateBatch result`,e);let s=e[this.tab]||[],o=[];for(let i=0;i<t.length;i++){let d=t[i],l=s[i]||{};if(l.error==="Linha apagada"){console.warn(`[BaseRepository:${this.tab}] \u26A0\uFE0F index ${d.index} apagado \u2192 recriando`);let[b]=yield this.createBatch([d]);o.push(b)}else o.push(h(c(c({},d),l),{id:l.id||d.id,index:l.index??d.index}))}return yield(yield this.getDb()).bulkPut(this.store,o),console.log(`[BaseRepository:${this.tab}] \u{1F4BE} updateBatch persistiu ${o.length} registros`),o})}deleteBatch(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u25B6\uFE0F deleteBatch \u2192`,t),yield n.controllerDeleteBatch({[this.tab]:t.map(e=>({index:e}))});let a=yield this.getDb();return yield Promise.all(t.map(e=>a.delete(this.store,e))),console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F deleteBatch conclu\xEDdo \u2192`,t),!0})}getAllMulti(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F310} getAllMulti \u2192`,t);let a=yield n.controllerGetAll({tabs:t});console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F getAllMulti result`,a);let e={};return t.forEach(s=>{e[s]=(a[s]||[]).map(o=>h(c({},o),{id:String(o.id),index:o.index}))}),console.log(`[BaseRepository:${this.tab}] \u{1F4CA} getAllMulti mapeado \u2192`,e),e})}putLocal(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F4BE} putLocal \u2192`,t),yield(yield this.getDb()).put(this.store,t)})}bulkPutLocal(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F4BE} bulkPutLocal \u2192`,t),yield(yield this.getDb()).bulkPut(this.store,t)})}clearLocal(){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F9F9} clearLocal`),yield(yield this.getDb()).clear(this.store)})}deleteLocal(t){return r(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F5D1}\uFE0F deleteLocal \u2192 index=${t}`),yield(yield this.getDb()).delete(this.store,t)})}};export{u as a,T as b};
