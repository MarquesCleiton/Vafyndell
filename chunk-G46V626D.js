import{a as p,b as c}from"./chunk-W7DVKRY2.js";import{a as d}from"./chunk-HS244SCX.js";import{a as n,b as l,d as e}from"./chunk-ILJPX4RU.js";var m=class{static TAB="Npcs";static STORE=this.TAB;static META_STORE="metadados";static FOLDER_ID="1zId11Ydti8d0FOQoQjd9lQmPo6GiJx26";static dbPromise=null;static getDb(){return e(this,null,function*(){return this.dbPromise||(console.log("[NpcRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=p.create()),this.dbPromise})}static createNpc(t){return e(this,null,function*(){console.log("[NpcRepository] Criando novo NPC...",t);let o=yield c.controllerCreate({tab:this.TAB,attrs:t,folderId:this.FOLDER_ID}),i=l(n({},o),{id:o?.index||Date.now()});return yield(yield this.getDb()).put(this.STORE,i),console.log("[NpcRepository] NPC criado e salvo no cache:",i),i})}static updateNpc(t){return e(this,null,function*(){console.log("[NpcRepository] Atualizando NPC...",t);let o=yield c.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t,folderId:this.FOLDER_ID}),i=n(n({},t),o);return yield(yield this.getDb()).put(this.STORE,i),console.log("[NpcRepository] NPC atualizado no cache local:",i),i})}static deleteNpc(t){return e(this,null,function*(){return console.log("[NpcRepository] Deletando NPC...",t),yield c.controllerDeleteByIndex({tab:this.TAB,index:t}),yield(yield this.getDb()).delete(this.STORE,t),console.log("[NpcRepository] NPC exclu\xEDdo do cache/local:",t),!0})}static getAllNpcs(){return e(this,null,function*(){console.log("[NpcRepository] getAllNpcs...");let t=yield c.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t:[]})}static getLocalNpcs(){return e(this,null,function*(){let o=yield(yield this.getDb()).getAll(this.STORE);return console.log("[NpcRepository] getLocalNpcs \u2192 total encontrados:",o.length),o})}static forceFetchNpcs(){return e(this,null,function*(){if(!d.getUser())throw new Error("Usu\xE1rio n\xE3o autenticado.");console.log("[NpcRepository] Baixando lista online...");let o=yield this.getAllNpcs();if(!o.length)return console.warn("[NpcRepository] Nenhum NPC encontrado online."),[];let i=o.map(a=>l(n({},a),{id:a.index??a.id})),s=yield this.getDb();yield s.clear(this.STORE),yield s.bulkPut(this.STORE,i),console.log("[NpcRepository] Cache atualizado com lista online.");let r=yield c.controllerGetAll({tab:"Metadados"});if(Array.isArray(r)){let a=r.find(N=>N.SheetName===this.TAB);a&&(yield s.put(this.META_STORE,{id:this.TAB,UltimaModificacao:a.UltimaModificacao}),console.log("[NpcRepository] Metadados locais atualizados:",a))}return i})}static syncNpcs(){return e(this,null,function*(){console.log("[NpcRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let t=yield c.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let o=t.find(a=>a.SheetName===this.TAB);if(!o)return console.warn("[NpcRepository] Nenhum metadado online encontrado."),!1;let s=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!s||s.UltimaModificacao!==o.UltimaModificacao?(console.log("[NpcRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchNpcs(),!0):(console.log("[NpcRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}};export{m as a};
