import{d as $,e as ee,h as te,o as ie,p as ne,q as oe,r as ae,u as re,v as le}from"./chunk-ZXTQJ65T.js";import{L as U}from"./chunk-KJ4G7NM6.js";import{c as z,f as Q,i as G,k as H,p as K,r as X}from"./chunk-GFP7435U.js";import{a as Z,b as M}from"./chunk-FLOHM7ZW.js";import{c as L,f as P,g as R,j as B,q as W,s as N,w as Y}from"./chunk-WLM7QTUH.js";import{$b as A,Db as V,Eb as E,Fb as w,Jb as f,Lb as _,Qa as u,Va as b,Vb as j,Zb as p,a as I,ab as O,ac as k,b as D,cc as T,d as q,dc as S,ec as C,fb as v,ia as c,ja as m,wb as g,xb as d,yb as l,zb as J}from"./chunk-QQSIVCMV.js";function ce(r,t){if(r&1&&(d(0,"mat-option",22),p(1),l()),r&2){let e=t.$implicit;g("value",e),u(),A(" \u{1F64D} ",e.personagem," ")}}function me(r,t){if(r&1&&(d(0,"mat-option",22)(1,"div",23)(2,"span"),p(3,"\u{1F4E6}"),l(),d(4,"span"),p(5),l()()()),r&2){let e=t.$implicit;g("value",e),u(5),k("",e.itemDetalhe==null?null:e.itemDetalhe.nome," (x",e.quantidade,")")}}function ue(r,t){if(r&1){let e=w();d(0,"div",24)(1,"button",25),f("click",function(){c(e);let n=_();return m(n.decrementar())}),p(2,"\u2212"),l(),d(3,"input",26),C("ngModelChange",function(n){c(e);let o=_();return S(o.quantidade,n)||(o.quantidade=n),m(n)}),f("blur",function(){c(e);let n=_();return m(n.validarQuantidade())}),l(),d(4,"button",25),f("click",function(){c(e);let n=_();return m(n.incrementar())}),p(5,"\uFF0B"),l(),d(6,"button",27),f("click",function(){c(e);let n=_();return m(n.adicionarItem())}),p(7,"\u2795 Adicionar"),l()()}if(r&2){let e=_();u(3),T("ngModel",e.quantidade)}}function pe(r,t){if(r&1){let e=w();d(0,"div",30)(1,"span",31),p(2),l(),d(3,"button",32),f("click",function(){let n=c(e).index,o=_(2);return m(o.removerItem(n))}),p(4,"\u2716"),l()()}if(r&2){let e=t.$implicit;u(2),k("\u{1F4E6} ",e.item.itemDetalhe==null?null:e.item.itemDetalhe.nome," \u2014 x",e.quantidade)}}function ge(r,t){if(r&1&&(d(0,"div",28),v(1,pe,5,2,"div",29),l()),r&2){let e=_();u(),g("ngForOf",e.itensTroca)}}function fe(r,t){r&1&&(V(0),p(1,"\u2714\uFE0F"),E())}function _e(r,t){r&1&&(V(0),J(1,"span",33),E())}var de=class r{constructor(t,e,i){this.router=t;this.route=e;this.location=i}jogadores=[];jogadoresFiltrados=[];filtroJogador="";jogadorSelecionado=null;inventario=[];inventarioFiltrado=[];filtroItem="";itemSelecionado=null;quantidade=1;itensTroca=[];processando=!1;emailLogado="";jogadoresRepo=new M("Personagem","Personagem");inventarioRepo=new M("Inventario","Inventario");catalogoRepo=new M("Catalogo","Catalogo");ngOnInit(){return q(this,null,function*(){let t=Y.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");this.emailLogado=t.email,this.jogadores=(yield this.jogadoresRepo.getLocal()).filter(o=>o.email!==this.emailLogado),this.jogadoresFiltrados=[...this.jogadores];let[e,i]=yield Promise.all([this.inventarioRepo.getLocal(),this.catalogoRepo.getLocal()]);this.inventario=e.filter(o=>o.jogador===this.emailLogado).map(o=>D(I({},o),{itemDetalhe:i.find(a=>String(a.id)===String(o.item_catalogo))})),this.inventarioFiltrado=[...this.inventario];let n=this.route.snapshot.paramMap.get("id");if(n){let o=this.inventario.find(a=>String(a.id)===n);o&&(this.itemSelecionado=o,this.filtroItem=o.itemDetalhe?.nome||"",this.quantidade=1)}})}filtrarJogadores(){let t=this.filtroJogador.toLowerCase().trim();this.jogadoresFiltrados=t?this.jogadores.filter(e=>e.personagem.toLowerCase().includes(t)):[...this.jogadores]}selecionarJogador(t){this.jogadorSelecionado=t,this.filtroJogador=t.personagem}filtrarItensInventario(){let t=this.filtroItem.toLowerCase().trim();this.inventarioFiltrado=this.inventario.map(e=>{let i=this.itensTroca.filter(o=>o.item.id===e.id).reduce((o,a)=>o+a.quantidade,0),n=e.quantidade-i;return n>0?D(I({},e),{quantidade:n}):null}).filter(e=>e!==null).filter(e=>t?e.itemDetalhe?.nome?.toLowerCase().includes(t):!0)}adicionarItem(){if(!this.itemSelecionado)return;let t=this.itensTroca.find(e=>e.item.id===this.itemSelecionado.id);t?t.quantidade=Math.min(t.quantidade+this.quantidade,this.itemSelecionado.quantidade+t.quantidade):this.itensTroca.push({item:this.itemSelecionado,quantidade:this.quantidade}),this.itemSelecionado=null,this.filtroItem="",this.quantidade=1,this.filtrarItensInventario()}selecionarItem(t){this.itemSelecionado=t,this.filtroItem=t.itemDetalhe?.nome||"",this.quantidade=1}incrementar(){if(!this.itemSelecionado)return;let t=this.itemSelecionado.quantidade;this.quantidade=Math.min(this.quantidade+1,t)}decrementar(){this.quantidade=Math.max(1,this.quantidade-1)}validarQuantidade(){if(!this.itemSelecionado)return;let t=this.itemSelecionado.quantidade;this.quantidade>t&&(this.quantidade=t),this.quantidade<1&&(this.quantidade=1)}removerItem(t){this.itensTroca.splice(t,1),this.filtrarItensInventario()}confirmarTroca(){return q(this,null,function*(){if(!this.jogadorSelecionado){alert("\u26A0\uFE0F Selecione um jogador destinat\xE1rio!");return}if(this.itensTroca.length===0){alert("\u26A0\uFE0F Adicione ao menos um item para trocar!");return}this.processando=!0;try{let t=this.jogadorSelecionado.email,e=yield this.inventarioRepo.getLocal(),i=[],n=[],o=[];for(let a of this.itensTroca){let s=a.item,h=a.quantidade;h>s.quantidade&&(h=s.quantidade);let F=D(I({},s),{quantidade:s.quantidade-h});F.quantidade>0?i.push(F):o.push(s.index);let y=e.find(x=>x.jogador===t&&x.item_catalogo===s.item_catalogo);if(y)i.push(D(I({},y),{quantidade:y.quantidade+h}));else{let x=e.length>0?Math.max(...e.map(se=>se.index||0)):0;n.push({id:Z.generateULID(),index:x+1,jogador:t,item_catalogo:s.item_catalogo,quantidade:h})}}if(i.length){let a=yield this.inventarioRepo.updateBatch(i);e=[...e.filter(s=>!i.some(h=>h.index===s.index)),...a]}if(n.length){let a=yield this.inventarioRepo.createBatch(n.map(s=>({jogador:s.jogador,item_catalogo:s.item_catalogo,quantidade:s.quantidade,id:s.id,index:s.index})));e=[...e,...a]}o.length&&(yield this.inventarioRepo.deleteBatch(o),e=e.filter(a=>!o.includes(a.index))),alert("\u2705 Troca realizada com sucesso!"),this.cancelar()}catch(t){console.error("[TrocaDeItens] Erro na troca:",t),alert("\u274C Erro ao processar a troca")}finally{this.processando=!1}})}cancelar(){this.location.back()}static \u0275fac=function(e){return new(e||r)(b(N),b(W),b(L))};static \u0275cmp=O({type:r,selectors:[["app-troca-de-itens"]],decls:32,vars:11,consts:[["autoJog","matAutocomplete"],["autoItem","matAutocomplete"],[1,"troca-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"troca-container","w-100"],[1,"card","detalhe-card","shadow-lg","border-0"],[1,"card-body","p-3","border-bottom","d-flex","align-items-center","justify-content-between"],[1,"fw-bold","mb-0","text-light"],[1,"btn","btn-outline-light","btn-sm",3,"click"],[1,"card-body"],[1,"mb-3"],[1,"form-label","text-light"],["appearance","fill",1,"w-100","input-dark","compact-select","dropdown-field"],["type","text","matInput","","placeholder","Selecione ou pesquise...","name","filtroJogador",3,"ngModelChange","input","ngModel","matAutocomplete"],[3,"optionSelected"],["class","bg-dark text-light",3,"value",4,"ngFor","ngForOf"],["type","text","matInput","","placeholder","Pesquisar item no invent\xE1rio...","name","filtroItem",3,"ngModelChange","input","ngModel","matAutocomplete"],["class","d-flex align-items-center gap-2 mb-3",4,"ngIf"],["class","itens-selecionados",4,"ngIf"],[1,"fab-stack"],[1,"fab","fab-success",3,"click","disabled"],[4,"ngIf"],[1,"bg-dark","text-light",3,"value"],[1,"d-flex","align-items-center","gap-2"],[1,"d-flex","align-items-center","gap-2","mb-3"],["type","button",1,"btn","btn-outline-light","btn-sm",3,"click"],["type","number","min","1",1,"form-control","quantidade-input",3,"ngModelChange","blur","ngModel"],["type","button",1,"btn","btn-success","ms-2",3,"click"],[1,"itens-selecionados"],["class","item-card",4,"ngFor","ngForOf"],[1,"item-card"],[1,"preview-item"],["type","button",1,"btn","btn-sm","btn-danger",3,"click"],[1,"spinner-border","spinner-border-sm"]],template:function(e,i){if(e&1){let n=w();d(0,"div",2)(1,"div",3)(2,"div",4)(3,"div",5)(4,"div",6)(5,"h4",7),p(6,"\u{1F504} Troca de Itens"),l(),d(7,"button",8),f("click",function(){return c(n),m(i.cancelar())}),p(8,"\u2B05 Voltar"),l()(),d(9,"div",9)(10,"div",10)(11,"label",11),p(12,"\u{1F64D} Jogador Destinat\xE1rio *"),l(),d(13,"mat-form-field",12)(14,"input",13),C("ngModelChange",function(a){return c(n),S(i.filtroJogador,a)||(i.filtroJogador=a),m(a)}),f("input",function(){return c(n),m(i.filtrarJogadores())}),l(),d(15,"mat-autocomplete",14,0),f("optionSelected",function(a){return c(n),m(i.selecionarJogador(a.option.value))}),v(17,ce,2,2,"mat-option",15),l()()(),d(18,"div",10)(19,"label",11),p(20,"\u{1F4E6} Adicionar Item"),l(),d(21,"mat-form-field",12)(22,"input",16),C("ngModelChange",function(a){return c(n),S(i.filtroItem,a)||(i.filtroItem=a),m(a)}),f("input",function(){return c(n),m(i.filtrarItensInventario())}),l(),d(23,"mat-autocomplete",14,1),f("optionSelected",function(a){return c(n),m(i.selecionarItem(a.option.value))}),v(25,me,6,3,"mat-option",15),l()()(),v(26,ue,8,1,"div",17)(27,ge,2,1,"div",18),l()()()(),d(28,"div",19)(29,"button",20),f("click",function(){return c(n),m(i.confirmarTroca())}),v(30,fe,2,0,"ng-container",21)(31,_e,2,0,"ng-container",21),l()()()}if(e&2){let n=j(16),o=j(24);u(14),T("ngModel",i.filtroJogador),g("matAutocomplete",n),u(3),g("ngForOf",i.jogadoresFiltrados),u(5),T("ngModel",i.filtroItem),g("matAutocomplete",o),u(3),g("ngForOf",i.inventarioFiltrado),u(),g("ngIf",i.itemSelecionado),u(),g("ngIf",i.itensTroca.length>0),u(2),g("disabled",i.processando||!i.jogadorSelecionado||i.itensTroca.length===0),u(),g("ngIf",!i.processando),u(),g("ngIf",i.processando)}},dependencies:[B,P,R,X,z,H,Q,K,G,ee,$,ae,ne,te,oe,le,re,ie,U],styles:[".troca-container[_ngcontent-%COMP%]{width:100%;max-width:800px}.detalhe-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:12px}.input-dark[_ngcontent-%COMP%]{background:#1e1e1e!important;color:#f8f9fa!important}.quantidade-input[_ngcontent-%COMP%]{width:80px;text-align:center;font-weight:700;background:#1e1e1e;border:1px solid #444;color:#f8f9fa}.itens-selecionados[_ngcontent-%COMP%]{margin-top:1rem;display:flex;flex-direction:column;gap:6px}.item-card[_ngcontent-%COMP%]{background:#2a2a2a;padding:8px 12px;border-radius:6px;display:flex;justify-content:space-between;align-items:center}.preview-item[_ngcontent-%COMP%]{color:#f8f9fa;font-weight:500}.fab-stack[_ngcontent-%COMP%]{position:fixed;bottom:70px;right:20px;display:flex;flex-direction:column;gap:15px}.fab[_ngcontent-%COMP%]{width:60px;height:60px;border-radius:50%;font-size:1.6rem;display:flex;align-items:center;justify-content:center;transition:transform .2s}.fab-success[_ngcontent-%COMP%]{background:linear-gradient(135deg,#28a745,#218838);color:#fff}.fab[_ngcontent-%COMP%]:hover{transform:scale(1.08)}"]})};export{de as TrocaDeItens};
