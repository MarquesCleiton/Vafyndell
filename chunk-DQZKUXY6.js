import{a as I}from"./chunk-XQNWO7VY.js";import{a as Q}from"./chunk-GYUQKXYZ.js";import{c as B,f as W,i as J,m as q,n as G,o as H,r as K}from"./chunk-7HYCYAOW.js";import{a as C}from"./chunk-DET3QFJ6.js";import{e as L,f as N,g as U,j as R,s as $,w as y}from"./chunk-7SGEPDVZ.js";import{Ab as r,Bb as c,Cb as D,Gb as M,Hb as T,Ib as w,Mb as g,Ob as m,Sa as P,Ta as s,Ya as F,a as A,ac as l,b as S,bc as b,cc as f,db as j,fc as E,g as u,gc as k,hc as O,ib as _,ic as z,la as h,lc as V,ma as v,zb as d}from"./chunk-DNZPJZVY.js";var Y=i=>({"show d-block":i});function Z(i,e){i&1&&(r(0,"div",26),D(1,"div",27),r(2,"p",28),l(3,"Carregando anota\xE7\xF5es..."),c()())}function ee(i,e){i&1&&(r(0,"div",29),l(1," Nenhuma anota\xE7\xE3o encontrada. "),c())}function te(i,e){if(i&1&&D(0,"img",47),i&2){let t=m().$implicit;d("alt",z(t.titulo||"Anota\xE7\xE3o"))("src",t.imagem,P)}}function ne(i,e){i&1&&(r(0,"span"),l(1,"\u{1F4DD}"),c())}function ie(i,e){if(i&1&&(r(0,"span"),l(1),c()),i&2){let t=m().$implicit;s(),f(" | #",t.tags)}}function oe(i,e){if(i&1){let t=w();r(0,"p",48),g("click",function(){h(t);let o=m().$implicit,a=m(4);return v(a.abrirAnotacao(o))}),l(1),c()}if(i&2){let t=m().$implicit;s(),f(" ",t.descricao," ")}}function ae(i,e){if(i&1){let t=w();r(0,"div",37)(1,"div",38)(2,"div",39),g("click",function(){let o=h(t).$implicit,a=m(4);return v(a.abrirAnotacao(o))}),r(3,"div",40),_(4,te,1,3,"img",41)(5,ne,2,0,"span",8),c(),r(6,"div")(7,"h6",42),l(8),c(),r(9,"small",43),l(10),_(11,ie,2,1,"span",8),c()()(),_(12,oe,2,1,"p",44),r(13,"div",45)(14,"button",46),g("click",function(){let o=h(t).$implicit,a=m(4);return v(a.abrirModalTransferir(o))}),l(15," \u{1F504} compartilhar "),c()()()()}if(i&2){let t=e.$implicit;s(4),d("ngIf",t.imagem&&t.imagem!=="-"),s(),d("ngIf",!t.imagem||t.imagem==="-"),s(3),b(t.titulo||"Sem t\xEDtulo"),s(2),f(" \u270D ",t.autor," "),s(),d("ngIf",t.tags),s(),d("ngIf",t.descricao)}}function re(i,e){if(i&1&&(r(0,"div",28)(1,"div",35),_(2,ae,16,6,"div",36),c()()),i&2){let t=m().$implicit;s(2),d("ngForOf",t.itens)}}function ce(i,e){if(i&1){let t=w();r(0,"div",31)(1,"button",32),g("click",function(){let o=h(t).$implicit,a=m(2);return v(a.toggleSecao(o))}),r(2,"span",33),l(3),c(),r(4,"span"),l(5),c()(),_(6,re,3,1,"div",34),c()}if(i&2){let t=e.$implicit,n=m(2);s(3),f("\u{1F4C5} ",n.formatarData(t.data)),s(2),b(t.expandido?"\u2212":"+"),s(),d("ngIf",t.expandido)}}function se(i,e){if(i&1&&(r(0,"div"),_(1,ce,7,3,"div",30),c()),i&2){let t=m();s(),d("ngForOf",t.secoesFiltradas)}}function le(i,e){if(i&1&&(r(0,"div",31)(1,"h6",33),l(2),c(),r(3,"p",49),l(4),c()()),i&2){let t=m();s(2),b(t.anotacaoSelecionada.titulo),s(2),b(t.anotacaoSelecionada.descricao)}}function de(i,e){if(i&1&&(r(0,"option",50),l(1),c()),i&2){let t=e.$implicit;d("value",t.email),s(),f(" \u{1F64D} ",t.personagem," ")}}function me(i,e){i&1&&(M(0),l(1,"\u{1F4E4} compartilhar"),T())}function pe(i,e){i&1&&(M(0),D(1,"span",51),T())}var X=class i{constructor(e){this.router=e}secoes=[];secoesFiltradas=[];carregando=!0;filtro="";jogadores=[];modalAberto=!1;anotacaoSelecionada=null;jogadorDestino="";processando=!1;repo=new C("Anotacoes");jogadoresRepo=new C("Personagem");uploadRepo=new C("Upload");ngOnInit(){return u(this,null,function*(){this.carregando=!0;try{yield this.loadLocalAndSync();let e=y.getUser(),t=yield this.jogadoresRepo.getLocal();this.jogadores=t.filter(n=>n.email!==e?.email)}catch(e){console.error("[Anotacoes] Erro ao carregar:",e)}finally{this.carregando=!1}})}loadLocalAndSync(){return u(this,null,function*(){let e=y.getUser();if(!e?.email)return;let n=(yield this.repo.getLocal()).filter(o=>o.jogador===e.email);if(this.processarSecoes(n),this.repo.sync().then(o=>u(this,null,function*(){if(o){let p=(yield this.repo.getLocal()).filter(x=>x.jogador===e.email);this.processarSecoes(p)}})),n.length===0){let a=(yield this.repo.forceFetch()).filter(p=>p.jogador===e.email);this.processarSecoes(a)}})}processarSecoes(e){let t=new Map(this.secoes.map(o=>[o.data,o.expandido])),n=new Map;e.forEach(o=>{let a=o.data||"",p=a.includes("T")?a.split("T")[0]:a;n.has(p)||n.set(p,[]),n.get(p).push(o)}),this.secoes=Array.from(n.entries()).sort(([o],[a])=>new Date(a).getTime()-new Date(o).getTime()).map(([o,a])=>({data:o,itens:a.sort((p,x)=>new Date(x.data||0).getTime()-new Date(p.data||0).getTime()),expandido:t.get(o)??!1})),this.secoesFiltradas=[...this.secoes]}aplicarFiltro(){let e=this.normalizarTexto(this.filtro);if(!e){this.secoesFiltradas=[...this.secoes];return}this.secoesFiltradas=this.secoes.map(t=>S(A({},t),{itens:t.itens.filter(n=>this.normalizarTexto(n.titulo||"").includes(e)||this.normalizarTexto(n.descricao||"").includes(e)||this.normalizarTexto(n.tags||"").includes(e)||this.normalizarTexto(n.autor||"").includes(e)),expandido:!0})).filter(t=>t.itens.length>0)}toggleSecao(e){e.expandido=!e.expandido}formatarData(e){try{return(e.includes("T")?new Date(e):new Date(e+"T00:00:00")).toLocaleDateString("pt-BR")}catch{return e}}novaAnotacao(){this.router.navigate(["/criar-anotacao"])}abrirAnotacao(e){this.router.navigate(["/criar-anotacao",e.id])}abrirModalTransferir(e){this.anotacaoSelecionada=e,this.modalAberto=!0,this.jogadorDestino=""}fecharModal(){this.modalAberto=!1,this.anotacaoSelecionada=null}confirmarTransferencia(){return u(this,null,function*(){if(this.anotacaoSelecionada){if(!this.jogadorDestino){alert("\u26A0\uFE0F Selecione um jogador ou a op\xE7\xE3o Todos!");return}this.processando=!0;try{let e=this.anotacaoSelecionada,t=y.getUser();if(!t?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");let n;if(e.imagem&&e.imagem!=="-")try{let a=yield this.urlToFile(e.imagem,`anotacao-${Date.now()}.jpg`),p=yield Q.toOptimizedBase64(a);n=(yield this.uploadRepo.create({id:I.generateULID(),base64:p,nome:a.name}))?.url||e.imagem}catch(a){console.warn("[Transferencia] falha ao duplicar imagem:",a)}let o=[];this.jogadorDestino==="__all__"?o=this.jogadores.map(a=>this.criarCopia(e,a.email,t.email,n)):o=[this.criarCopia(e,this.jogadorDestino,t.email,n)],yield this.repo.createBatch(o),alert("\u2705 Anota\xE7\xE3o transferida com sucesso!"),this.fecharModal()}catch(e){console.error("[Anotacoes] Erro na transfer\xEAncia:",e),alert("\u274C Erro ao transferir anota\xE7\xE3o")}finally{this.processando=!1}}})}criarCopia(e,t,n,o){return S(A({},e),{id:I.generateULID(),jogador:t,autor:n,data:new Date().toISOString(),imagem:o||e.imagem})}urlToFile(e,t){return u(this,null,function*(){let o=yield(yield fetch(e)).blob();return new File([o],t,{type:o.type})})}normalizarTexto(e){return e?e.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim():""}static \u0275fac=function(t){return new(t||i)(F($))};static \u0275cmp=j({type:i,selectors:[["app-anotacoes"]],decls:34,vars:13,consts:[[1,"anotacoes-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"p-3","bg-black","border-bottom","position-sticky","top-0",2,"z-index","10"],["type","text","placeholder","\u{1F50D} Pesquisar anota\xE7\xF5es...",1,"form-control","search-bar","rounded-pill","px-3",3,"ngModelChange","input","ngModel"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"anotacoes-container","w-100"],[1,"fw-bold","mb-3"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[1,"fab-stack"],[1,"fab","fab-primary",3,"click"],["id","modalTransferir","tabindex","-1","aria-hidden","true",1,"modal","fade","modal-backdrop-blur",3,"ngClass"],[1,"modal-dialog"],[1,"modal-content","bg-dark","text-light"],[1,"modal-header","border-secondary"],[1,"modal-title"],["type","button",1,"btn-close","btn-close-white",3,"click"],[1,"modal-body"],["class","mb-3",4,"ngIf"],[1,"form-label"],[1,"form-select","bg-dark","text-light",3,"ngModelChange","ngModel"],["value","__all__"],[3,"value",4,"ngFor","ngForOf"],[1,"modal-footer","border-secondary"],["type","button",1,"btn","btn-outline-light",3,"click"],["type","button",1,"btn","btn-success",3,"click","disabled"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",4,"ngFor","ngForOf"],[1,"mb-3"],[1,"btn","btn-categoria","w-100","text-start","d-flex","justify-content-between","align-items-center",3,"click"],[1,"fw-bold"],["class","mt-2",4,"ngIf"],[1,"row","row-cols-1","g-2"],["class","col",4,"ngFor","ngForOf"],[1,"col"],[1,"card","anotacao-card","shadow-sm","h-100","p-3"],[1,"d-flex","align-items-center","mb-2",2,"cursor","pointer","flex","1",3,"click"],[1,"item-thumb","me-3"],[3,"src","alt",4,"ngIf"],[1,"fw-bold","text-white","mb-1"],[1,"text-light"],["class","small descricao-text fst-italic",3,"click",4,"ngIf"],[1,"d-flex","justify-content-end","mt-2"],[1,"btn","btn-sm","btn-outline-info",3,"click"],[3,"src","alt"],[1,"small","descricao-text","fst-italic",3,"click"],[1,"small","fst-italic","descricao-text"],[3,"value"],[1,"spinner-border","spinner-border-sm"]],template:function(t,n){t&1&&(r(0,"div",0)(1,"div",1)(2,"input",2),O("ngModelChange",function(a){return k(n.filtro,a)||(n.filtro=a),a}),g("input",function(){return n.aplicarFiltro()}),c()(),r(3,"div",3)(4,"div",4)(5,"h4",5),l(6,"\u{1F4DD} Minhas Anota\xE7\xF5es"),c(),_(7,Z,4,0,"div",6)(8,ee,2,0,"div",7)(9,se,2,1,"div",8),c()(),r(10,"div",9)(11,"button",10),g("click",function(){return n.novaAnotacao()}),l(12,"\uFF0B"),c()()(),r(13,"div",11)(14,"div",12)(15,"div",13)(16,"div",14)(17,"h5",15),l(18,"\u{1F504} compartilhar Anota\xE7\xE3o"),c(),r(19,"button",16),g("click",function(){return n.fecharModal()}),c()(),r(20,"div",17),_(21,le,5,2,"div",18),r(22,"label",19),l(23,"\u{1F64D} Jogador Destinat\xE1rio"),c(),r(24,"select",20),O("ngModelChange",function(a){return k(n.jogadorDestino,a)||(n.jogadorDestino=a),a}),r(25,"option",21),l(26,"Todos os jogadores"),c(),_(27,de,2,2,"option",22),c()(),r(28,"div",23)(29,"button",24),g("click",function(){return n.fecharModal()}),l(30,"Cancelar"),c(),r(31,"button",25),g("click",function(){return n.confirmarTransferencia()}),_(32,me,2,0,"ng-container",8)(33,pe,2,0,"ng-container",8),c()()()()()),t&2&&(s(2),E("ngModel",n.filtro),s(5),d("ngIf",n.carregando),s(),d("ngIf",!n.carregando&&n.secoesFiltradas.length===0),s(),d("ngIf",!n.carregando),s(4),d("ngClass",V(11,Y,n.modalAberto)),s(8),d("ngIf",n.anotacaoSelecionada),s(3),E("ngModel",n.jogadorDestino),s(3),d("ngForOf",n.jogadores),s(4),d("disabled",n.processando),s(),d("ngIf",!n.processando),s(),d("ngIf",n.processando))},dependencies:[R,L,N,U,K,G,H,B,q,W,J],styles:[".anotacoes-wrapper[_ngcontent-%COMP%]{display:flex;justify-content:center}.anotacoes-container[_ngcontent-%COMP%]{width:100%;max-width:900px}.search-bar[_ngcontent-%COMP%]{background:#1e1e1e;color:#fff;border:1px solid #444}.search-bar[_ngcontent-%COMP%]:focus{outline:none;border-color:#0d6efd;box-shadow:0 0 0 .2rem #0d6efd40}.btn-categoria[_ngcontent-%COMP%]{background:#2a2a2a;color:#f8f9fa;font-weight:600;border-radius:8px;padding:.6rem 1rem;text-align:left}.btn-categoria[_ngcontent-%COMP%]:hover{background:#343a40;color:#fff}.anotacao-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:10px;transition:transform .15s ease;color:#f1f1f1}.anotacao-card[_ngcontent-%COMP%]:hover{transform:scale(1.02);background:#252525}.item-thumb[_ngcontent-%COMP%]{width:50px;height:50px;border-radius:8px;background:#2a2a2a;display:flex;align-items:center;justify-content:center;overflow:hidden}.item-thumb[_ngcontent-%COMP%]   img[_ngcontent-%COMP%]{width:100%;height:100%;object-fit:cover}.item-thumb[_ngcontent-%COMP%]   span[_ngcontent-%COMP%]{font-size:1.4rem;color:#bbb}.anotacao-card[_ngcontent-%COMP%]   h6[_ngcontent-%COMP%]{color:#fff}.anotacao-card[_ngcontent-%COMP%]   small[_ngcontent-%COMP%]{color:#ddd}.anotacao-card[_ngcontent-%COMP%]   p[_ngcontent-%COMP%]{color:#e0e0e0;white-space:pre-line}.fab-stack[_ngcontent-%COMP%]{position:fixed;bottom:70px;right:20px;display:flex;flex-direction:column;gap:15px;z-index:1000}.fab[_ngcontent-%COMP%]{width:60px;height:60px;border-radius:50%;font-size:1.6rem;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px #0006;border:none;cursor:pointer;transition:transform .2s ease}.fab[_ngcontent-%COMP%]:hover{transform:scale(1.08)}.fab-primary[_ngcontent-%COMP%]{background:#0d6efd;color:#fff}.fab-primary[_ngcontent-%COMP%]:hover{background:#0b5ed7}.modal-content[_ngcontent-%COMP%]{border-radius:12px}.modal-backdrop-blur[_ngcontent-%COMP%]{background-color:#0009;-webkit-backdrop-filter:blur(6px);backdrop-filter:blur(6px)}.descricao-text[_ngcontent-%COMP%]{white-space:pre-line}"]})};export{X as Anotacoes};
