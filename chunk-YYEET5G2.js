import{c as A,f as B,i as W,m as H,n as U,o as q,s as Y}from"./chunk-NOURQFKT.js";import{a as S}from"./chunk-W2L5F7JW.js";import{h as J,i as z,n as L,o as V,q as N,x as T}from"./chunk-UNL43WIN.js";import{Ab as g,Bb as s,Cb as l,Db as E,Jb as I,Nb as u,Pb as m,Ua as a,_b as P,a as x,b as h,bc as c,cc as v,dc as b,eb as F,ec as w,g as f,gc as C,hc as y,ic as D,jb as p,la as M,ma as O,pc as R,qc as j,rc as k}from"./chunk-XPYPFFIJ.js";function G(n,t){if(n&1&&(s(0,"option",13),c(1),l()),n&2){let e=t.$implicit,i=m();g("value",e.email),a(),w(" ",i.getEmoji(e)," ",e.personagem," ")}}function K(n,t){n&1&&(s(0,"div",14),E(1,"div",15),s(2,"p",16),c(3,"Carregando registros..."),l()())}function Q(n,t){n&1&&(s(0,"div",17),c(1," Nenhum registro encontrado. "),l())}function X(n,t){if(n&1&&(s(0,"div",25)(1,"div",26)(2,"div",27)(3,"h6",28),c(4),R(5,"titlecase"),l(),s(6,"small",29),c(7),R(8,"date"),l()(),s(9,"p",30),c(10),l()()()),n&2){let e=t.$implicit;a(),P("border-left","6px solid "+(e.cor||"#666")),a(3),w("",e.icone," ",j(5,6,e.tipo)),a(3),v(k(8,8,e.data,"HH:mm")),a(3),b(" ",e.detalhes," ")}}function Z(n,t){if(n&1&&(s(0,"div",16)(1,"div",23),p(2,X,11,11,"div",24),l()()),n&2){let e=m().$implicit;a(2),g("ngForOf",e.itens)}}function ee(n,t){if(n&1){let e=I();s(0,"div",19)(1,"button",20),u("click",function(){let o=M(e).$implicit,r=m(2);return O(r.toggleSecao(o))}),s(2,"span",21),c(3),l(),s(4,"span"),c(5),l()(),p(6,Z,3,1,"div",22),l()}if(n&2){let e=t.$implicit,i=m(2);a(3),b("\u{1F4C5} ",i.formatarData(e.data)),a(2),v(e.expandido?"\u2212":"+"),a(),g("ngIf",e.expandido)}}function te(n,t){if(n&1&&(s(0,"div"),p(1,ee,7,3,"div",18),l()),n&2){let e=m();a(),g("ngForOf",e.secoesFiltradas)}}var $=class n{secoes=[];secoesFiltradas=[];carregando=!0;filtro="";filtroVisao="todos";meuPersonagem=null;outrosJogadores=[];repo=new S("Registro");jogadoresRepo=new S("Personagem");ngOnInit(){return f(this,null,function*(){this.carregando=!0;try{yield this.loadLocalAndSync()}catch(t){console.error("[Registro] Erro ao carregar:",t)}finally{this.carregando=!1}})}loadLocalAndSync(){return f(this,null,function*(){let t=T.getUser(),e=yield this.jogadoresRepo.getLocal();this.meuPersonagem=e.find(o=>o.email===t?.email)||null,this.outrosJogadores=(yield this.jogadoresRepo.getLocal()).filter(o=>o.nome_do_jogador?.trim().toLowerCase()!=="npc");let i=yield this.repo.getLocal();if(yield this.resolveJogadores(i,e),this.processarSecoes(i),this.repo.sync().then(o=>f(this,null,function*(){if(o){let r=yield this.repo.getLocal();yield this.resolveJogadores(r,e),this.processarSecoes(r)}})),i.length===0){let o=yield this.repo.forceFetch();yield this.resolveJogadores(o,e),this.processarSecoes(o)}})}resolveJogadores(t,e){return f(this,null,function*(){t.forEach(i=>{i.ofensor=e.find(o=>o.email===i.jogador)||null,i.vitima=e.find(o=>o.email===i.alvo)||null})})}processarSecoes(t){let e=new Map(this.secoes.map(o=>[o.data,o.expandido])),i=new Map;t.forEach(o=>{let r=o.data||"",d=r.includes("T")?r.split("T")[0]:r,_=h(x({},o),{icone:this.getIconeTipo(o.tipo),cor:this.getCorTipo(o.tipo)});i.has(d)||i.set(d,[]),i.get(d).push(_)}),this.secoes=Array.from(i.entries()).sort(([o],[r])=>new Date(r).getTime()-new Date(o).getTime()).map(([o,r])=>({data:o,itens:r.sort((d,_)=>new Date(_.data||0).getTime()-new Date(d.data||0).getTime()),expandido:e.get(o)??!0})),this.aplicarFiltro()}aplicarFiltro(){let t=this.normalizarTexto(this.filtro),e=this.filtroVisao,i=T.getUser();this.secoesFiltradas=this.secoes.map(o=>h(x({},o),{itens:o.itens.filter(r=>{let d=!t||this.normalizarTexto(r.detalhes).includes(t)||this.normalizarTexto(r.tipo).includes(t)||this.normalizarTexto(r.acao).includes(t)||this.normalizarTexto(r.ofensor?.personagem||"").includes(t)||this.normalizarTexto(r.vitima?.personagem||"").includes(t)||this.normalizarTexto(r.ofensor?.nome_do_jogador||"").includes(t)||this.normalizarTexto(r.vitima?.nome_do_jogador||"").includes(t);return e==="todos"?d:e==="meu"&&i?.email?d&&(r.jogador===i.email||r.alvo===i.email):e!=="todos"&&e!=="meu"?d&&(r.jogador===e||r.alvo===e):!1})})).filter(o=>o.itens.length>0)}getEmoji(t){let e={mestre:"\u{1F9D1}\u200D\u{1F3EB}",npc:"\u{1F40D}",bestial:"\u{1F409}",jogador:"\u{1F9DD}\u200D\u2642\uFE0F"},i=(t.classificacao||t.tipo_jogador||"").toLowerCase();return i.includes("mestre")?e.mestre:i.includes("npc")||i.includes("inimigo")||i.includes("bestial")?e.npc:i.includes("bestial")?e.bestial:e.jogador}toggleSecao(t){t.expandido=!t.expandido}normalizarTexto(t){return t?t.normalize("NFD").replace(/[\u0300-\u036f]/g,"").toLowerCase().trim():""}formatarData(t){try{return(t.includes("T")?new Date(t):new Date(t+"T00:00:00")).toLocaleDateString("pt-BR")}catch{return t}}getIconeTipo(t=""){return{batalha:"\u2694\uFE0F",recuperacao:"\u{1F48A}",inventario:"\u{1F392}",transferencia:"\u{1F4E6}",fabricacao:"\u2692\uFE0F"}[t]||"\u{1FAB6}"}getCorTipo(t=""){return{batalha:"#f87171",recuperacao:"#4ade80",inventario:"#60a5fa",transferencia:"#fbbf24",fabricacao:"#a78bfa"}[t]||"#9ca3af"}static \u0275fac=function(e){return new(e||n)};static \u0275cmp=F({type:n,selectors:[["app-registro"]],decls:15,vars:6,consts:[[1,"registro-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light"],[1,"p-3","bg-black","border-bottom","position-sticky","top-0",2,"z-index","10"],["type","text","placeholder","\u{1F50D} Pesquisar registros...",1,"form-control","search-bar","rounded-pill","px-3","mb-2",3,"ngModelChange","input","ngModel"],[1,"d-flex","flex-column","gap-2"],[1,"form-select","filtro-visao",3,"ngModelChange","change","ngModel"],["value","todos"],[3,"value",4,"ngFor","ngForOf"],[1,"flex-grow-1","p-3","d-flex","justify-content-center"],[1,"registro-container","w-100"],[1,"fw-bold","mb-3"],["class","text-center py-5",4,"ngIf"],["class","text-center text-muted py-5",4,"ngIf"],[4,"ngIf"],[3,"value"],[1,"text-center","py-5"],["role","status",1,"spinner-border","text-light"],[1,"mt-2"],[1,"text-center","text-muted","py-5"],["class","mb-3",4,"ngFor","ngForOf"],[1,"mb-3"],[1,"btn-categoria","w-100","text-start","d-flex","justify-content-between","align-items-center",3,"click"],[1,"fw-bold"],["class","mt-2",4,"ngIf"],[1,"row","row-cols-1","g-2"],["class","col ",4,"ngFor","ngForOf"],[1,"col"],[1,"text-light","registro-card","card","shadow-sm","p-3"],[1,"d-flex","justify-content-between","align-items-center","mb-2"],[1,"fw-bold","mb-0"],[1,"registro-hora"],[1,"small","descricao-text","fst-italic","mb-0",2,"white-space","pre-line"]],template:function(e,i){e&1&&(s(0,"div",0)(1,"div",1)(2,"input",2),D("ngModelChange",function(r){return y(i.filtro,r)||(i.filtro=r),r}),u("input",function(){return i.aplicarFiltro()}),l(),s(3,"div",3)(4,"select",4),D("ngModelChange",function(r){return y(i.filtroVisao,r)||(i.filtroVisao=r),r}),u("change",function(){return i.aplicarFiltro()}),s(5,"option",5),c(6,"Todos"),l(),p(7,G,2,3,"option",6),l()()(),s(8,"div",7)(9,"div",8)(10,"h4",9),c(11,"\u{1F4DC} Registro de Jogo"),l(),p(12,K,4,0,"div",10)(13,Q,2,0,"div",11)(14,te,2,1,"div",12),l()()()),e&2&&(a(2),C("ngModel",i.filtro),a(2),C("ngModel",i.filtroVisao),a(3),g("ngForOf",i.outrosJogadores),a(5),g("ngIf",i.carregando),a(),g("ngIf",!i.carregando&&i.secoesFiltradas.length===0),a(),g("ngIf",!i.carregando))},dependencies:[N,J,z,Y,U,q,A,H,B,W,L,V],styles:[".registro-wrapper[_ngcontent-%COMP%]{background:#121212;color:#fff}.filtro-select[_ngcontent-%COMP%]{background:#1e1e1e;color:#fff;border:1px solid #444;font-weight:500}.filtro-select[_ngcontent-%COMP%]:focus{box-shadow:0 0 0 2px #4b5563;border-color:#666}.registro-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:10px;border:1px solid #333;border-left:6px solid #666;transition:transform .15s ease,box-shadow .15s ease}.registro-card[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 12px #0000004d}.btn-categoria[_ngcontent-%COMP%]{background:#2a2a2a;border:1px solid #444;border-radius:8px;padding:8px 12px;color:#fff;font-weight:700;margin-bottom:5px}.btn-categoria[_ngcontent-%COMP%]:hover{background:#333}.btn-tipo[_ngcontent-%COMP%]{background:#1e1e1e;border:1px solid #444;border-left:6px solid #666;border-radius:6px;padding:6px 12px;color:#fff;font-weight:500;transition:background .2s}.btn-tipo[_ngcontent-%COMP%]:hover{background:#262626}.registro-hora[_ngcontent-%COMP%]{color:#ccc;font-size:.85rem}.descricao-text[_ngcontent-%COMP%]{line-height:1.5;color:#eee}"]})};export{$ as Registro};
