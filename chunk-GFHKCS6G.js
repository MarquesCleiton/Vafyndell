import{a as ve,d as De,e as Ie,h as xe,o as we,p as Me,q as Te,r as Ce,u as Se,v as qe}from"./chunk-CG2SQOMH.js";import{A as de,B as se,K as le,N as ce}from"./chunk-DI5MEB7V.js";import{a as O}from"./chunk-XQNWO7VY.js";import{c as me,f as ue,i as pe,k as ge,p as fe,q as he,s as _e}from"./chunk-NOURQFKT.js";import{a as y}from"./chunk-W2L5F7JW.js";import{f as oe,h as re}from"./chunk-P5XSKUQX.js";import{e as te,h as ie,i as ne,q as ae,x as be}from"./chunk-UNL43WIN.js";import{Ab as p,Bb as r,Cb as o,Db as ee,Hb as J,Ib as Q,Jb as z,Nb as g,Pb as v,Ua as s,Za as k,Zb as W,a as j,b as $,bc as l,cc as B,dc as N,eb as Z,ec as U,g as A,gc as C,hc as S,ic as q,jb as M,la as m,ma as u}from"./chunk-XPYPFFIJ.js";function Ve(c,e){if(c&1&&(r(0,"mat-option",28),l(1),o()),c&2){let t=e.$implicit;p("value",t),s(),N(" \u{1F64D} ",t.personagem," ")}}function Pe(c,e){if(c&1){let t=z();r(0,"div",34)(1,"div",35)(2,"span",36),l(3,"\u{1F4E6}"),o(),r(4,"div",37)(5,"span",38),l(6),o(),r(7,"small",39),l(8),o()()(),r(9,"div",40)(10,"button",41),g("click",function(){let a=m(t).$implicit,i=v(2);return a.quantidade=i.ajustarQuantidadeMin(a.quantidade-1,1),u(i.atualizarQuantidade(a))}),l(11,"\u2212"),o(),r(12,"input",42),q("ngModelChange",function(a){let i=m(t).$implicit;return S(i.quantidade,a)||(i.quantidade=a),u(a)}),g("blur",function(){let a=m(t).$implicit,i=v(2);return u(i.atualizarQuantidade(a))}),o(),r(13,"button",41),g("click",function(){let a=m(t).$implicit,i=v(2);return a.quantidade=i.ajustarQuantidadeMax(a.quantidade+1,a.item.quantidade),u(i.atualizarQuantidade(a))}),l(14,"\uFF0B"),o()(),r(15,"button",43),g("click",function(){let a=m(t).index,i=v(2);return u(i.removerItem(a))}),l(16,"\u2716"),o()()}if(c&2){let t=e.$implicit,n=v(2);s(6),B(t.item.itemDetalhe==null?null:t.item.itemDetalhe.nome),s(2),U(" (restam ",n.getRestante(t)," ",(t.item.itemDetalhe==null?null:t.item.itemDetalhe.unidade_medida)||"un.",") "),s(4),C("ngModel",t.quantidade),p("max",t.item.quantidade)}}function Re(c,e){if(c&1&&(r(0,"div",29)(1,"div",30)(2,"h5",31),l(3,"\u{1F9FA} Itens Selecionados"),o(),r(4,"span",32),l(5),o()(),M(6,Pe,17,5,"div",33),o()),c&2){let t=v();s(5),B(t.itensTroca.length),s(),p("ngForOf",t.itensTroca)}}function Fe(c,e){if(c&1&&(r(0,"mat-option",28)(1,"div",37)(2,"div"),l(3),o(),r(4,"small",39),l(5),o()()()),c&2){let t=e.$implicit;p("value",t),s(3),N("\u{1F4E6} ",t.itemDetalhe==null?null:t.itemDetalhe.nome),s(2),U(" (restam ",t.quantidade," ",(t.itemDetalhe==null?null:t.itemDetalhe.unidade_medida)||"un.",") ")}}function Le(c,e){c&1&&(J(0),l(1,"\u{1F4E4}"),Q())}function Ae(c,e){c&1&&(J(0),ee(1,"span",44),Q())}var ye=class c{constructor(e,t,n){this.router=e;this.route=t;this.location=n}jogadores=[];jogadoresFiltrados=[];filtroJogador="";jogadorSelecionado=null;inventario=[];inventarioFiltrado=[];filtroItem="";itemSelecionado=null;quantidade=1;itensTroca=[];processando=!1;emailLogado="";jogadoresRepo=new y("Personagem");inventarioRepo=new y("Inventario");catalogoRepo=new y("Catalogo");descricaoTransferencia="";ngOnInit(){return A(this,null,function*(){let e=be.getUser();if(!e?.email)throw new Error("Usu\xE1rio n\xE3o autenticado");this.emailLogado=e.email,this.jogadores=(yield this.jogadoresRepo.getLocal()).filter(i=>i.email!==this.emailLogado).filter(i=>i.nome_do_jogador!=="NPC"),this.jogadoresFiltrados=[...this.jogadores];let[t,n]=yield Promise.all([this.inventarioRepo.getLocal(),this.catalogoRepo.getLocal()]);this.inventario=t.filter(i=>i.jogador===this.emailLogado).map(i=>$(j({},i),{itemDetalhe:n.find(d=>String(d.id)===String(i.item_catalogo))})),this.inventarioFiltrado=[...this.inventario];let a=this.route.snapshot.paramMap.get("id");if(a){let i=this.inventario.find(d=>String(d.id)===a);i&&(this.itemSelecionado=i,this.filtroItem=i.itemDetalhe?.nome||"",this.quantidade=1)}})}filtrarJogadores(){let e=this.filtroJogador.toLowerCase().trim();this.jogadoresFiltrados=e?this.jogadores.filter(t=>t.personagem.toLowerCase().includes(e)):[...this.jogadores]}selecionarJogador(e){this.jogadorSelecionado=e,this.filtroJogador=e.personagem}filtrarItensInventario(){let e=this.filtroItem.toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"");this.inventarioFiltrado=this.inventario.map(t=>this.itensTroca.some(a=>a.item.id===t.id)?null:t).filter(t=>t!==null).filter(t=>e?(t.itemDetalhe?.nome||"").toLowerCase().normalize("NFD").replace(/[\u0300-\u036f]/g,"").includes(e):!0)}adicionarItem(){this.itemSelecionado&&(this.itensTroca.push({item:this.itemSelecionado,quantidade:1}),this.itemSelecionado=null,this.filtroItem="",this.filtrarItensInventario())}selecionarItem(e){this.itemSelecionado=e,this.filtroItem=e.itemDetalhe?.nome||"",this.quantidade=1}incrementar(){if(!this.itemSelecionado)return;let e=this.itemSelecionado.quantidade;this.quantidade=Math.min(this.quantidade+1,e)}decrementar(){this.quantidade=Math.max(1,this.quantidade-1)}validarQuantidade(){if(!this.itemSelecionado)return;let e=this.itemSelecionado.quantidade;this.quantidade>e&&(this.quantidade=e),this.quantidade<1&&(this.quantidade=1)}removerItem(e){this.itensTroca.splice(e,1),this.filtrarItensInventario()}confirmarTroca(){return A(this,null,function*(){if(!this.jogadorSelecionado){alert("\u26A0\uFE0F Selecione um jogador destinat\xE1rio!");return}if(this.itensTroca.length===0){alert("\u26A0\uFE0F Adicione ao menos um item para trocar!");return}let e=(this.descricaoTransferencia||"").trim(),t=this.jogadorSelecionado.personagem,n=`\u{1F381} Confirme a transfer\xEAncia para ${t}

`;for(let i of this.itensTroca){let d=i.item.itemDetalhe,D=d?.nome||"Item desconhecido",V=d?.unidade_medida||"un.",I=i.item.quantidade,E=I-i.quantidade;n+=`\u{1F4E6} ${D}: ${I} \u2192 ${E} (-${i.quantidade} ${V})
`}if(e&&(n+=`
\u{1F4DD} ${e}
`),n+=`
Deseja realmente confirmar a transfer\xEAncia?`,!!confirm(n)){this.processando=!0;try{let i=this.jogadorSelecionado.email,D=(yield this.jogadoresRepo.getLocal()).find(x=>x.email===this.emailLogado)?.personagem||"Desconhecido",V=yield this.inventarioRepo.getLocal(),I=[],E=[],Y=[],P=[],G=[];for(let x of this.itensTroca){let f=x.item,H=f.itemDetalhe?.nome||"Item desconhecido",T=f.itemDetalhe?.unidade_medida||"unidade",h=x.quantidade;h>f.quantidade&&(h=f.quantidade);let R=f.quantidade,F=R-h,K=`Quantidade: ${R} \u2192 ${F} (-${h} ${T})
Transferido para ${t}`+(e?`
${e}`:""),ke=f.descricao?`${K}
---
${f.descricao.trim()}`:K,X=$(j({},f),{quantidade:F,descricao:ke});X.quantidade>0?I.push(X):Y.push(f.id);let w=V.find(b=>b.jogador===i&&b.item_catalogo===f.item_catalogo),L=0,_=0;if(w){L=w.quantidade,_=w.quantidade+h;let b=`Quantidade: ${L} \u2192 ${_} (+${h} ${T})
Recebido de ${D}`+(e?`
${e}`:""),Oe=w.descricao?`${b}
---
${w.descricao.trim()}`:b;I.push($(j({},w),{quantidade:_,descricao:Oe}))}else{_=h;let b=`Quantidade: 0 \u2192 ${_} (+${h} ${T})
Recebido de ${D}`+(e?`
${e}`:"");E.push({id:O.generateULID(),index:Date.now(),jogador:i,item_catalogo:f.item_catalogo,quantidade:_,descricao:b})}P.push(`\u{1F392} ${H}: ${R} \u2192 ${F} (-${h} ${T})`),G.push(`\u{1F392} ${H}: ${L} \u2192 ${_} (+${h} ${T})`)}let Ee={id:O.generateULID(),jogador:this.emailLogado,alvo:i,tipo:"transferencia",acao:"envio",detalhes:`\u{1F4E6} ${D} transferiu itens para ${t}
`+P.join(`
`)+(e?`
\u{1F4DD} ${e}`:""),data:new Date().toISOString()},je={id:O.generateULID(),jogador:i,alvo:this.emailLogado,tipo:"transferencia",acao:"recebimento",detalhes:`\u{1F381} ${t} recebeu itens de ${D}
`+G.join(`
`)+(e?`
\u{1F4DD} ${e}`:""),data:new Date().toISOString()};yield y.batch({updateById:{Inventario:I},create:{Inventario:E,Registro:[Ee,je]},deleteById:{Inventario:Y.map(x=>({id:x}))}});let $e=`\u{1F381} Voc\xEA transferiu itens para ${t}
`+P.join(`
`)+(e?`
\u{1F4DD} ${e}`:"");alert($e),this.cancelar()}catch(i){console.error("[TrocaDeItens] Erro na troca:",i),alert("\u274C Erro ao processar a troca")}finally{this.processando=!1}}})}cancelar(){this.location.back()}ajustarQuantidade(e,t){let n=this.itensTroca[e],a=n.item.quantidade,i=Math.min(Math.max(1,n.quantidade+t),a);this.itensTroca[e].quantidade=i}validarQuantidadeTroca(e){let t=this.itensTroca[e],n=t.item.quantidade;t.quantidade>n&&(t.quantidade=n),t.quantidade<1&&(t.quantidade=1)}atualizarDisponiveis(){this.filtrarItensInventario()}ajustarQuantidadeMin(e,t){return Math.max(e,t)}ajustarQuantidadeMax(e,t){return Math.min(e,t??e)}atualizarQuantidade(e){let t=e.item.quantidade;e.quantidade>t&&(e.quantidade=t),e.quantidade<1&&(e.quantidade=1),this.filtrarItensInventario()}getRestante(e){return Math.max(0,e.item.quantidade-e.quantidade)}static \u0275fac=function(t){return new(t||c)(k(re),k(oe),k(te))};static \u0275cmp=Z({type:c,selectors:[["app-troca-de-itens"]],decls:39,vars:12,consts:[["autoJog","matAutocomplete"],["autoItem","matAutocomplete"],[1,"troca-wrapper","d-flex","flex-column","min-vh-100","bg-dark","text-light","pb-5","mb-5"],[1,"flex-grow-1","p-3","d-flex","justify-content-center","pb-5","mb-5"],[1,"troca-container","w-100"],[1,"card","detalhe-card","shadow-lg","border-0"],[1,"card-body","p-3","border-bottom","d-flex","align-items-center","gap-2"],[1,"fw-bold","mb-0","text-light"],[1,"card-body"],[1,"mb-3"],[1,"form-label","text-light"],["appearance","fill",1,"w-100","input-dark","compact-select","dropdown-field"],["type","text","matInput","","placeholder","Selecione ou pesquise...","name","filtroJogador",3,"ngModelChange","input","ngModel","matAutocomplete"],[3,"optionSelected"],["class","bg-dark text-light",3,"value",4,"ngFor","ngForOf"],["class","itens-selecionados",4,"ngIf"],[1,"novo-item","bg-dark","rounded","p-2","mb-3","mt-3"],[1,"d-flex","align-items-center","gap-2"],["appearance","fill",1,"flex-grow-1","input-dark","compact-select","dropdown-field","mb-0"],["type","text","matInput","","placeholder","Pesquisar item no invent\xE1rio...","name","filtroItem",3,"ngModelChange","input","ngModel","matAutocomplete"],["mat-icon-button","","matSuffix","","disabled","",1,"dropdown-arrow"],["type","button",1,"btn","btn-success","btn-add",3,"click","disabled"],[1,"mb-3","mt-3"],["rows","3","name","descricaoTransferencia","placeholder","Ex: Entregue em miss\xE3o, troca amig\xE1vel, ajuda ao grupo...",1,"form-control","input-dark","auto-expand",3,"ngModelChange","ngModel"],[1,"fab-stack"],[1,"fab","fab-warning",3,"click"],[1,"fab","fab-success",3,"click","disabled"],[4,"ngIf"],[1,"bg-dark","text-light",3,"value"],[1,"itens-selecionados"],[1,"d-flex","align-items-center","justify-content-between","mb-2"],[1,"fw-bold","text-light","mb-0"],[1,"badge","bg-secondary"],["class","item-card bg-dark rounded p-2 mb-2 d-flex align-items-center justify-content-between gap-2",4,"ngFor","ngForOf"],[1,"item-card","bg-dark","rounded","p-2","mb-2","d-flex","align-items-center","justify-content-between","gap-2"],[1,"d-flex","align-items-center","gap-2","flex-grow-1"],[1,"fs-5"],[1,"d-flex","flex-column"],[1,"fw-semibold","text-light"],[1,"text-secondary"],[1,"item-quantidade"],["type","button",1,"btn","btn-sm","btn-outline-light",3,"click"],["type","number","min","1",3,"ngModelChange","blur","ngModel","max"],["type","button",1,"btn","btn-sm","btn-danger","px-2",3,"click"],[1,"spinner-border","spinner-border-sm"]],template:function(t,n){if(t&1){let a=z();r(0,"div",2)(1,"div",3)(2,"div",4)(3,"div",5)(4,"div",6)(5,"h4",7),l(6,"\u{1F504} Troca de Itens"),o()(),r(7,"div",8)(8,"div",9)(9,"label",10),l(10,"\u{1F64D} Jogador Destinat\xE1rio *"),o(),r(11,"mat-form-field",11)(12,"input",12),q("ngModelChange",function(d){return m(a),S(n.filtroJogador,d)||(n.filtroJogador=d),u(d)}),g("input",function(){return m(a),u(n.filtrarJogadores())}),o(),r(13,"mat-autocomplete",13,0),g("optionSelected",function(d){return m(a),u(n.selecionarJogador(d.option.value))}),M(15,Ve,2,2,"mat-option",14),o()()(),M(16,Re,7,2,"div",15),r(17,"div",16)(18,"div",17)(19,"mat-form-field",18)(20,"input",19),q("ngModelChange",function(d){return m(a),S(n.filtroItem,d)||(n.filtroItem=d),u(d)}),g("input",function(){return m(a),u(n.filtrarItensInventario())}),o(),r(21,"button",20)(22,"mat-icon"),l(23,"arrow_drop_down"),o()(),r(24,"mat-autocomplete",13,1),g("optionSelected",function(d){return m(a),u(n.selecionarItem(d.option.value))}),M(26,Fe,6,4,"mat-option",14),o()(),r(27,"button",21),g("click",function(){return m(a),u(n.adicionarItem())}),l(28," \u2795 "),o()()(),r(29,"div",22)(30,"label",10),l(31,"\u{1F4DD} Descri\xE7\xE3o da transfer\xEAncia (opcional)"),o(),r(32,"textarea",23),q("ngModelChange",function(d){return m(a),S(n.descricaoTransferencia,d)||(n.descricaoTransferencia=d),u(d)}),o()()()()()(),r(33,"div",24)(34,"button",25),g("click",function(){return m(a),u(n.cancelar())}),l(35,"\u2B05\uFE0F"),o(),r(36,"button",26),g("click",function(){return m(a),u(n.confirmarTroca())}),M(37,Le,2,0,"ng-container",27)(38,Ae,2,0,"ng-container",27),o()()()}if(t&2){let a=W(14),i=W(25);s(12),C("ngModel",n.filtroJogador),p("matAutocomplete",a),s(3),p("ngForOf",n.jogadoresFiltrados),s(),p("ngIf",n.itensTroca.length>0),s(4),C("ngModel",n.filtroItem),p("matAutocomplete",i),s(6),p("ngForOf",n.inventarioFiltrado),s(),p("disabled",!n.itemSelecionado),s(5),C("ngModel",n.descricaoTransferencia),s(4),p("disabled",n.processando||!n.jogadorSelecionado||n.itensTroca.length===0),s(),p("ngIf",!n.processando),s(),p("ngIf",n.processando)}},dependencies:[ae,ie,ne,_e,me,ge,ue,he,fe,pe,Ie,De,ve,Ce,Me,xe,Te,qe,Se,we,ce,le,se,de],styles:[".troca-wrapper[_ngcontent-%COMP%]{display:flex;flex-direction:column}.troca-container[_ngcontent-%COMP%]{width:100%;max-width:900px;margin:0 auto}.detalhe-card[_ngcontent-%COMP%]{background:#1e1e1e;border-radius:12px;overflow:hidden;border:1px solid rgba(255,255,255,.05)}.input-dark[_ngcontent-%COMP%]{background:#1e1e1e!important;border-radius:6px;color:#f8f9fa!important}.input-dark[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{color:#f8f9fa!important}.input-dark[_ngcontent-%COMP%]::placeholder, textarea.input-dark[_ngcontent-%COMP%]::placeholder{color:#ccc!important;opacity:1}.compact-select[_ngcontent-%COMP%]   .mat-mdc-form-field-flex[_ngcontent-%COMP%]{padding:.25rem .5rem}.dropdown-arrow[_ngcontent-%COMP%]   mat-icon[_ngcontent-%COMP%]{font-size:1.4rem;color:#bbb}.item-card[_ngcontent-%COMP%]{background:#242424;border:1px solid #333;border-radius:10px;transition:transform .2s ease,box-shadow .2s ease}.item-card[_ngcontent-%COMP%]:hover{transform:translateY(-2px);box-shadow:0 4px 10px #0006}.item-quantidade[_ngcontent-%COMP%]{display:flex;align-items:center;gap:.25rem}.item-quantidade[_ngcontent-%COMP%]   input[_ngcontent-%COMP%]{width:60px;text-align:center;font-weight:700;border:1px solid #6c757d;border-radius:.4rem;background:#212529;color:#f8f9fa;padding:.25rem}.novo-item[_ngcontent-%COMP%]{background:#181818;border:1px solid #333;border-radius:10px;padding:.75rem}.btn-add[_ngcontent-%COMP%]{height:100%;font-size:1.4rem;border-radius:8px;padding:0 12px}.fab-stack[_ngcontent-%COMP%]{position:fixed;bottom:70px;right:20px;display:flex;flex-direction:column-reverse;gap:15px;z-index:1000}.fab[_ngcontent-%COMP%]{width:60px;height:60px;border-radius:50%;font-size:1.6rem;display:flex;align-items:center;justify-content:center;box-shadow:0 4px 14px #0006;transition:transform .2s ease}.fab[_ngcontent-%COMP%]:hover{transform:scale(1.08)}.fab-success[_ngcontent-%COMP%]{background:#198754;color:#fff}.fab-warning[_ngcontent-%COMP%]{background:#ffc107;color:#000}@media (min-width: 992px){.fab-stack[_ngcontent-%COMP%]{right:calc(50% - 430px)}}"]})};export{ye as TrocaDeItens};
