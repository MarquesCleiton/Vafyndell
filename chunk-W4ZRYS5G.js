import{a as v,b as r}from"./chunk-2CFPKSUU.js";import{v as d}from"./chunk-YWTK67XE.js";import{a as s,b as l,d as a}from"./chunk-DIJLFEPN.js";var m=class{static TAB="Inventario";static STORE=this.TAB;static META_STORE="metadados";static dbPromise=null;static getDb(){return a(this,null,function*(){return this.dbPromise||(console.log("[InventarioRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=v.create()),this.dbPromise})}static createInventario(t){return a(this,null,function*(){console.log("[InventarioRepository] Criando novo registro de invent\xE1rio...",t);let o=yield r.controllerCreate({tab:this.TAB,attrs:t}),i=l(s({},o),{id:Number(o?.id)||Date.now(),index:o?.index});return yield(yield this.getDb()).put(this.STORE,i),console.log("[InventarioRepository] Registro criado e salvo no cache:",i),i})}static updateInventario(t){return a(this,null,function*(){console.log("[InventarioRepository] Atualizando invent\xE1rio...",t);let o=yield r.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t}),i=l(s(s({},t),o),{id:Number(o?.id||t.id),index:o?.index||t.index});return yield(yield this.getDb()).put(this.STORE,i),console.log("[InventarioRepository] Invent\xE1rio atualizado no cache local:",i),i})}static deleteInventario(t){return a(this,null,function*(){console.log("[InventarioRepository] Deletando invent\xE1rio...",t);let o=yield this.getDb(),i=yield o.get(this.STORE,t);return i?(yield r.controllerDeleteByIndex({tab:this.TAB,index:i.index}),yield o.delete(this.STORE,t),console.log("[InventarioRepository] Registro exclu\xEDdo do cache/local:",t),!0):(console.warn("[InventarioRepository] Item n\xE3o encontrado no cache:",t),!1)})}static getAllInventario(){return a(this,null,function*(){console.log("[InventarioRepository] getAllInventario...");let t=yield r.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t.map(o=>l(s({},o),{id:Number(o.id),index:o.index})):[]})}static getLocalInventarioByJogador(t){return a(this,null,function*(){let i=yield(yield this.getDb()).getAll(this.STORE);return console.log("[InventarioRepository] getLocalInventarioByJogador \u2192 total encontrados:",i.length),i.filter(n=>n.jogador===t)})}static forceFetchInventario(){return a(this,null,function*(){let t=d.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");console.log("[InventarioRepository] Baixando lista online...");let o=yield this.getAllInventario();if(!o.length)return console.warn("[InventarioRepository] Nenhum invent\xE1rio encontrado online."),[];let i=o.map(e=>l(s({},e),{id:Number(e.id),index:e.index})),n=yield this.getDb();yield n.clear(this.STORE),yield n.bulkPut(this.STORE,i),console.log("[InventarioRepository] Cache atualizado com lista online.");let c=yield r.controllerGetAll({tab:"Metadados"});if(Array.isArray(c)){let e=c.find(I=>I.SheetName===this.TAB);e&&(yield n.put(this.META_STORE,{id:this.TAB,UltimaModificacao:e.UltimaModificacao}),console.log("[InventarioRepository] Metadados locais atualizados:",e))}return i.filter(e=>e.jogador===t.email)})}static syncInventario(){return a(this,null,function*(){console.log("[InventarioRepository] Verificando necessidade de sincroniza\xE7\xE3o...");let t=yield r.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let o=t.find(e=>e.SheetName===this.TAB);if(!o)return console.warn("[InventarioRepository] Nenhum metadado online encontrado."),!1;let n=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!n||n.UltimaModificacao!==o.UltimaModificacao?(console.log("[InventarioRepository] Cache desatualizado \u2192 sincronizando..."),yield this.forceFetchInventario(),!0):(console.log("[InventarioRepository] Cache j\xE1 est\xE1 atualizado."),!1)})}};export{m as a};
