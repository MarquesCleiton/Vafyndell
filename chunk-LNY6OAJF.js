import{v as p,w as u}from"./chunk-WLM7QTUH.js";import{a as n,b as d,c as b,d as o}from"./chunk-QQSIVCMV.js";var y=class{static ENCODING="0123456789ABCDEFGHJKMNPQRSTVWXYZ";static TIME_LEN=10;static RAND_LEN=16;static generateULID(t=new Date){let e=this.encodeTime(t.getTime(),this.TIME_LEN),a=this.encodeRandom(this.RAND_LEN);return e+a}static encodeTime(t,e){let a="";for(let i=e-1;i>=0;i--)a=this.ENCODING[t%32]+a,t=Math.floor(t/32);return a}static encodeRandom(t){let e="";for(let a=0;a<t;a++){let i=Math.floor(Math.random()*32);e+=this.ENCODING[i]}return e}};var l=class{static BASE_URL="https://script.google.com/macros/s/AKfycbz6KlBkfWzEFEkHOVtCyMWD83aqi3oKVXdLtCY93XCUA24BBP3BO9aINqGIj5_R1LRX/exec";static SHEET_ID="19B2aMGrajvhPJfOvYXt059-fECytaN38iFsP8GInD_g";static FOLDER_ID="1zId11Ydti8d0FOQoQjd9lQmPo6GiJx26";static call(t,e,a=!0){return o(this,null,function*(){let i=u.getIdToken();if(!i||!u.isAuthenticated()){let g=yield u.refreshIdToken();if(!g)throw new Error("Usu\xE1rio precisa fazer login novamente.");i=g.idToken}let s={idToken:i,action:t,sheetId:this.SHEET_ID,folderId:this.FOLDER_ID,payload:e};console.log("\u27A1\uFE0F [ScriptClientV2] Enviando:",this.BASE_URL,s);let r=yield fetch(this.BASE_URL,{method:"POST",body:JSON.stringify(s)}),c=yield r.text();if(!r.ok){if(console.error("\u274C [ScriptClientV2] Erro bruto do Script:",c),r.status===401&&a){if(console.warn("[ScriptClientV2] Token inv\xE1lido, tentando renovar..."),!(yield u.refreshIdToken()))throw new Error("Usu\xE1rio precisa se autenticar novamente.");return this.call(t,e,!1)}throw new Error(`[ScriptClientV2] HTTP ${r.status} - ${r.statusText}
${c}`)}try{return JSON.parse(c)}catch(g){throw console.error("\u274C [ScriptClientV2] Resposta n\xE3o-JSON:",c),g}})}static controllerCreate(t){return this.call("controller.create",d(n({},t),{folderId:this.FOLDER_ID}))}static controllerGetAll(t){return this.call("controller.getAll",t)}static controllerGetByIndex(t){return this.call("controller.getByIndex",t)}static controllerGetCell(t){return this.call("controller.getCell",t)}static controllerUpdateByIndex(t){return this.call("controller.updateByIndex",d(n({},t),{folderId:this.FOLDER_ID}))}static controllerUpdateCell(t){return this.call("controller.updateCell",t)}static controllerDeleteByIndex(t){return this.call("controller.deleteByIndex",t)}static controllerCreateBatch(t){return this.call("controller.create",{payloads:t,folderId:this.FOLDER_ID})}static controllerUpdateBatch(t){return this.call("controller.updateByIndex",{payloads:t,folderId:this.FOLDER_ID})}static controllerDeleteBatch(t){return this.call("controller.deleteByIndex",{payloads:t})}static driveUpload(t){return this.call("drive.upload",t)}static driveUpdate(t){return this.call("drive.update",t)}static driveDelete(t){return this.call("drive.delete",t)}};var m=class h{constructor(t,e=t){this.tab=t;this.store=e}static META_STORE="Metadados";static dbPromise=null;getDb(){return o(this,null,function*(){return h.dbPromise||(h.dbPromise=p.create()),h.dbPromise})}create(t){return o(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u25B6\uFE0F create \u2192`,t);let e=yield l.controllerCreate(n({tab:this.tab},t));console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F create result`,e);let a=e[this.tab]?.[0],i=d(n(n({},t),a),{id:a?.id?String(a.id):y.generateULID(),index:a?.index??Date.now()});return(a?.imagem||"").startsWith("http")&&(i.imagem=a.imagem),yield(yield this.getDb()).put(this.store,i),i})}update(t){return o(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u25B6\uFE0F update \u2192`,t);let c=t,{index:e}=c,a=b(c,["index"]),i=yield l.controllerUpdateByIndex(n({tab:this.tab,index:e},a));console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F update result`,i);let s=i[this.tab]?.[0],r=d(n(n({},t),s),{id:s?.id?String(s.id):t.id,index:s?.index||t.index});return(s?.imagem||"").startsWith("http")&&(r.imagem=s.imagem),yield(yield this.getDb()).put(this.store,r),r})}delete(t){return o(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u25B6\uFE0F delete \u2192 index=${t}`);let e=yield this.getDb(),a=yield e.get(this.store,t);return a?(yield l.controllerDeleteByIndex({tab:this.tab,index:a.index}),yield e.delete(this.store,t),console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F delete conclu\xEDdo para index=${t}`),!0):!1})}getLocal(){return o(this,null,function*(){let e=yield(yield this.getDb()).getAll(this.store);return console.log(`[BaseRepository:${this.tab}] \u{1F4C2} getLocal \u2192`,e),e})}getAllOnline(){return o(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F310} getAllOnline`);let t=yield l.controllerGetAll({tab:this.tab});return console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F getAllOnline result`,t),(t[this.tab]||[]).map(e=>d(n({},e),{id:String(e.id),index:e.index}))})}forceFetch(){return o(this,null,function*(){if(console.log(`[BaseRepository:${this.tab}] \u{1F310} forceFetch`),!u.getUser())throw new Error("Usu\xE1rio n\xE3o autenticado.");let e=yield l.controllerGetAll({tabs:[this.tab,"Metadados"]});console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F forceFetch result`,e);let a=(e[this.tab]||[]).map(r=>d(n({},r),{id:String(r.id),index:r.index})),i=yield this.getDb();yield i.clear(this.store),yield i.bulkPut(this.store,a);let s=e.Metadados?.find(r=>r.SheetName===this.tab);return s&&(yield i.put(h.META_STORE,{index:this.tab,SheetName:this.tab,UltimaModificacao:s.UltimaModificacao})),a})}sync(){return o(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F504} sync iniciado`);let t=yield l.controllerGetAll({tabs:["Metadados"]});console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F sync result`,t);let a=(t.Metadados||[]).find(c=>c.SheetName===this.tab);if(!a)return console.warn(`[BaseRepository:${this.tab}] Nenhum metadado encontrado`),!1;let s=yield(yield this.getDb()).get(h.META_STORE,this.tab);return console.log(`[BaseRepository:${this.tab}] localMeta`,s,"onlineMeta",a),!s||s.UltimaModificacao!==a.UltimaModificacao?(console.log(`[BaseRepository:${this.tab}] \u26A0\uFE0F Atualiza\xE7\xE3o necess\xE1ria \u2192 executando forceFetch()`),yield this.forceFetch(),!0):(console.log(`[BaseRepository:${this.tab}] \u2705 Nada para atualizar`),!1)})}getAllMulti(t){return o(this,null,function*(){console.log(`[BaseRepository:${this.tab}] \u{1F310} getAllMulti \u2192`,t);let e=yield l.controllerGetAll({tabs:t});console.log(`[BaseRepository:${this.tab}] \u25C0\uFE0F getAllMulti result`,e);let a={};return t.forEach(i=>{a[i]=(e[i]||[]).map(s=>d(n({},s),{id:String(s.id),index:s.index}))}),a})}putLocal(t){return o(this,null,function*(){yield(yield this.getDb()).put(this.store,t)})}bulkPutLocal(t){return o(this,null,function*(){yield(yield this.getDb()).bulkPut(this.store,t)})}clearLocal(){return o(this,null,function*(){yield(yield this.getDb()).clear(this.store)})}deleteLocal(t){return o(this,null,function*(){yield(yield this.getDb()).delete(this.store,t)})}};export{y as a,m as b};
