import{a as A,b as s}from"./chunk-MPFUFSQ6.js";import{v as d}from"./chunk-HRLERFBW.js";import{a as r,b as c,d as e}from"./chunk-QQSIVCMV.js";var m=class{static TAB="Anotacoes";static STORE=this.TAB;static META_STORE="metadados";static FOLDER_ID="PASTA_ID_DRIVE_ANOTACOES";static dbPromise=null;static getDb(){return e(this,null,function*(){return this.dbPromise||(console.log("[AnotacaoRepository] Criando inst\xE2ncia IndexedDBClient..."),this.dbPromise=A.create()),this.dbPromise})}static createAnotacao(t){return e(this,null,function*(){t.data||(t.data=new Date().toISOString());let a=yield s.controllerCreate({tab:this.TAB,attrs:t,folderId:this.FOLDER_ID}),i=c(r({},a),{id:Number(a?.id)||Date.now(),index:a?.index});return yield(yield this.getDb()).put(this.STORE,i),i})}static updateAnotacao(t){return e(this,null,function*(){(!t.data||!t.data.includes("T"))&&(t.data=new Date().toISOString());let a=yield s.controllerUpdateByIndex({tab:this.TAB,index:t.index,attrs:t,folderId:this.FOLDER_ID}),i=c(r(r({},t),a),{id:Number(a?.id||t.id),index:a?.index||t.index});return yield(yield this.getDb()).put(this.STORE,i),i})}static getAllAnotacoes(){return e(this,null,function*(){let t=yield s.controllerGetAll({tab:this.TAB});return Array.isArray(t)?t.map(a=>c(r({},a),{id:Number(a.id),index:a.index})):[]})}static getLocalAnotacoes(){return e(this,null,function*(){let t=d.getUser();return t?(yield(yield this.getDb()).getAll(this.STORE)).filter(o=>o.jogador===t.email):(console.warn("[AnotacaoRepository] Usu\xE1rio n\xE3o autenticado \u2192 retornando []"),[])})}static forceFetchAnotacoes(){return e(this,null,function*(){let t=d.getUser();if(!t)throw new Error("Usu\xE1rio n\xE3o autenticado.");let a=yield this.getAllAnotacoes();if(!a.length)return[];let i=a.map(n=>c(r({},n),{id:Number(n.id),index:n.index})),o=yield this.getDb();yield o.clear(this.STORE),yield o.bulkPut(this.STORE,i);let l=yield s.controllerGetAll({tab:"Metadados"});if(Array.isArray(l)){let n=l.find(h=>h.SheetName===this.TAB);n&&(yield o.put(this.META_STORE,{id:this.TAB,UltimaModificacao:n.UltimaModificacao}))}return i.filter(n=>n.jogador===t.email)})}static syncAnotacoes(){return e(this,null,function*(){let t=yield s.controllerGetAll({tab:"Metadados"});if(!Array.isArray(t))return!1;let a=t.find(n=>n.SheetName===this.TAB);if(!a)return!1;let o=yield(yield this.getDb()).get(this.META_STORE,this.TAB);return!o||o.UltimaModificacao!==a.UltimaModificacao?(yield this.forceFetchAnotacoes(),!0):!1})}static getCurrentAnotacoes(){return e(this,null,function*(){if(!d.getUser())throw new Error("Usu\xE1rio n\xE3o autenticado.");let a=yield this.getLocalAnotacoes();return a.length>0?(this.syncAnotacoes().then(i=>e(this,null,function*(){i&&(a=yield this.getLocalAnotacoes())})).catch(i=>console.error("[AnotacaoRepository] Erro ao sincronizar:",i)),a):yield this.forceFetchAnotacoes()})}static deleteAnotacao(t){return e(this,null,function*(){let a=yield this.getDb(),i=yield a.get(this.STORE,t);return i?(yield s.controllerDeleteByIndex({tab:this.TAB,index:i.index}),yield a.delete(this.STORE,t),!0):(console.warn("[AnotacaoRepository] Anota\xE7\xE3o n\xE3o encontrada no cache:",t),!1)})}};export{m as a};
